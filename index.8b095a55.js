function t(t,e,n,i){Object.defineProperty(t,e,{get:n,set:i,enumerable:!0,configurable:!0})}var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{};function n(t){return t&&t.__esModule?t.default:t}var i={},r={},a=e.parcelRequire94c2;null==a&&((a=function(t){if(t in i)return i[t].exports;if(t in r){var e=r[t];delete r[t];var n={id:t,exports:{}};return i[t]=n,e.call(n.exports,n,n.exports),n.exports}var a=new Error("Cannot find module '"+t+"'");throw a.code="MODULE_NOT_FOUND",a}).register=function(t,e){r[t]=e},e.parcelRequire94c2=a),a.register("kb8hZ",(function(e,n){var i,r;t(e.exports,"register",(function(){return i}),(function(t){return i=t})),t(e.exports,"resolve",(function(){return r}),(function(t){return r=t}));var a={};i=function(t){for(var e=Object.keys(t),n=0;n<e.length;n++)a[e[n]]=t[e[n]]},r=function(t){var e=a[t];if(null==e)throw new Error("Could not resolve bundle with id "+t);return e}})),a.register("dwTKp",(function(e,n){var i;t(e.exports,"getBundleURL",(function(){return i}),(function(t){return i=t}));var r={};function a(t){return(""+t).replace(/^((?:https?|file|ftp):\/\/.+)\/[^/]+$/,"$1")+"/"}i=function(t){var e=r[t];return e||(e=function(){try{throw new Error}catch(e){var t=(""+e.stack).match(/(https?|file|ftp):\/\/[^)\n]+/g);if(t)return a(t[2])}return"/"}(),r[t]=e),e}})),a.register("gpPe5",(function(t,e){t.exports=a("fKq5I")(a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("6OT74")).then((()=>a("11sRX")))})),a.register("fKq5I",(function(t,n){var i=a("20Uq9");t.exports=i((function(t){return new Promise((function(n,i){var r="i".concat((""+Math.random()).slice(2));e[r]=function(t){n(t),a()};var a=function(){delete e[r],o.onerror=null,o.remove()},o=document.createElement("script");o.async=!0,o.type="module",o.charset="utf-8",o.textContent="import * as m from '".concat(t,"'; ").concat(r,"(m);"),o.onerror=function(t){i(t),a()},document.head.appendChild(o)}))}))})),a.register("20Uq9",(function(t,e){var n={},i={},r={};function a(t){switch(t){case"preload":return i;case"prefetch":return r;default:return n}}t.exports=function(t,e){return function(n){var i=a(e);return i[n]?i[n]:i[n]=t.apply(null,arguments).catch((function(t){throw delete i[n],t}))}}})),a.register("bOQHI",(function(t,e){t.exports=a("fKq5I")(a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("hUIiR")).then((()=>a("2BQEx")))})),a.register("7F5d9",(function(t,e){t.exports=a("fKq5I")(a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("eiNJp")).then((()=>a("2C9ch")))})),a.register("1MJD7",(function(t,e){t.exports=a("fKq5I")(a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("4tKUq")).then((()=>a("duojR")))})),a.register("dYA4n",(function(t,e){t.exports=a("fKq5I")(a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("78RX7")).then((()=>a("aeoOn")))})),a("kb8hZ").register(JSON.parse('{"lrLBb":"index.8b095a55.js","iDK6N":"check.8d706b11.svg","8gElo":"cancel.17aa34ea.svg","6OT74":"de.34f83aa6.js","hUIiR":"ja.02b6624e.js","eiNJp":"zh-CN.6f3b125f.js","kav7s":"brush-pressure.f4437531.svg","43nfB":"copy.4adadd0c.svg","9Vqzx":"tool-picker.d0e69c3a.svg","vALcr":"angle.f0b557ac.svg","gShQZ":"add-layer.ce1078bb.svg","ldqtT":"duplicate-layer.3314e3c7.svg","apAfQ":"merge-layers.19da79a6.svg","dpNT8":"remove-layer.4e9b2b7d.svg","5E29d":"rename-layer.13b70bac.svg","6rWqS":"cursor-picker.db2f5b39.png","5mHop":"cursor-zoom-ew.fbb85406.png","gy6aj":"cursor-fill.8027a243.png","9SVhx":"cursor-text.dcaa5de5.png","8BBCz":"cursor-rotate.5b164044.png","g2W7q":"klecks-logo.802fb0cc.png","7SFt9":"new-image.09cdcd80.svg","2Vvkk":"import.7a68c844.svg","1zJpX":"export.bc31616f.svg","9cKp0":"share.454898d1.svg","3iiTs":"help.208e9032.svg","gGmfI":"tool-paint.6cdb3344.svg","67aEJ":"tool-fill.3358320a.svg","a2j2Q":"tool-text.1cbd0325.svg","gZhDT":"tool-shape.3de78c3f.svg","48B5J":"caret-down.68d4cd16.svg","ksMx1":"tool-hand.e7fc81b9.svg","bReTA":"tool-zoom-in.d413f042.svg","i3X7V":"tool-zoom-out.299f4d1f.svg","j4HZO":"tool-undo.540bf765.svg","jItzQ":"inverted-border.3353c7f3.svg","ea7ga":"edit-rotate.fd0e572a.svg","gNPQL":"ui-collapse.2b5dfc6a.svg","9Mrdl":"align-left.4876a845.svg","jc4S8":"align-center.6f56d4bd.svg","cgtA2":"align-right.1521d61c.svg","erfrN":"typo-italic.39f02a8d.svg","kdJe6":"typo-bold.8156fef3.svg","gJYYq":"edit-brightness-contrast.8430cb26.svg","25BJB":"edit-crop.16c534dd.svg","fDGND":"edit-curves.bbdb97b2.svg","8f0bW":"edit-flip.00fd2c6b.svg","fAhTF":"edit-hue-saturation.c9c1c847.svg","lTNVM":"edit-invert.fa435c66.png","2mMxs":"edit-perspective.e23100db.svg","lkhcY":"edit-resize.56391e2b.svg","c9hFy":"edit-tilt-shift.dd20efff.png","297B8":"edit-to-alpha.f7a2065a.svg","jxtUn":"edit-transform.c8795430.svg","lfC0f":"edit-triangle-blur.9df2dbef.png","cDstS":"edit-unsharp-mask.c58e988c.png","efRnq":"brush-pen.49a7b91e.svg","lGY8s":"brush-blend.2b9837fa.svg","jDXzO":"brush-sketchy.9e5d0120.png","hkoNI":"brush-pixel.673f3e4c.svg","baIZM":"brush-eraser.a9e10dce.svg","91Av5":"brush-smudge.45852bcd.svg","aI6cE":"brush-chemy.a5a188f6.svg","28TVy":"loading.7ff8a2ac.gif","4tKUq":"dist.f610cf07.js","8EUal":"bitbof-logo.bc5e3ed5.svg","lQWO9":"ui-swap-lr.7f474f51.svg","78RX7":"licenses.e4375971.js","grSoY":"checkmark.5cb0764b.svg","2xc61":"constrain.62f04e45.svg","gXLuy":"tab-settings.1f52740e.svg","ll6eH":"tab-layers.c8a104e7.svg"}'));var o,s,l={},c=function(t){return t&&t.Math==Math&&t};l=c("object"==typeof globalThis&&globalThis)||c("object"==typeof window&&window)||c("object"==typeof self&&self)||c("object"==typeof e&&e)||function(){return this}()||Function("return this")();var h,u;h=!(u=function(t){try{return!!t()}catch(t){return!0}})((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]}));var d,p={};d=!u((function(){var t=function(){}.bind();return"function"!=typeof t||t.hasOwnProperty("prototype")}));var g,f=Function.prototype.call;p=d?f.bind(f):function(){return f.apply(f,arguments)};var m={}.propertyIsEnumerable,y=Object.getOwnPropertyDescriptor,x=y&&!m.call({1:2},1);g=x?function(t){var e=y(this,t);return!!e&&e.enumerable}:m;var b;b=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}};var v,w,C={},S={},E=Function.prototype,M=E.bind,I=E.call,k=d&&M.bind(I,I),T=(S=d?function(t){return t&&k(t)}:function(t){return t&&function(){return I.apply(t,arguments)}})({}.toString),R=S("".slice);w=function(t){return R(T(t),8,-1)};var L=l.Object,A=S("".split);C=u((function(){return!L("z").propertyIsEnumerable(0)}))?function(t){return"String"==w(t)?A(t,""):L(t)}:L;var P,O=l.TypeError;P=function(t){if(null==t)throw O("Can't call method on "+t);return t},v=function(t){return C(P(t))};var D,B,z,j;j=function(t){return"function"==typeof t},z=function(t){return"object"==typeof t?null!==t:j(t)};var H,_={},F=function(t){return j(t)?t:void 0};H=function(t,e){return arguments.length<2?F(l[t]):l[t]&&l[t][e]};var U={};U=S({}.isPrototypeOf);var N,Y,X,V={};V=H("navigator","userAgent")||"";var W,K,G=l.process,q=l.Deno,Z=G&&G.versions||q&&q.version,$=Z&&Z.v8;$&&(K=(W=$.split("."))[0]>0&&W[0]<4?1:+(W[0]+W[1])),!K&&V&&(!(W=V.match(/Edge\/(\d+)/))||W[1]>=74)&&(W=V.match(/Chrome\/(\d+)/))&&(K=+W[1]),X=K,Y=!!Object.getOwnPropertySymbols&&!u((function(){var t=Symbol();return!String(t)||!(Object(t)instanceof Symbol)||!Symbol.sham&&X&&X<41})),N=Y&&!Symbol.sham&&"symbol"==typeof Symbol.iterator;var J=l.Object;_=N?function(t){return"symbol"==typeof t}:function(t){var e=H("Symbol");return j(e)&&U(e.prototype,J(t))};var Q,tt,et,nt=l.String;et=function(t){try{return nt(t)}catch(t){return"Object"}};var it=l.TypeError;tt=function(t){if(j(t))return t;throw it(et(t)+" is not a function")},Q=function(t,e){var n=t[e];return null==n?void 0:tt(n)};var rt,at=l.TypeError;rt=function(t,e){var n,i;if("string"===e&&j(n=t.toString)&&!z(i=p(n,t)))return i;if(j(n=t.valueOf)&&!z(i=p(n,t)))return i;if("string"!==e&&j(n=t.toString)&&!z(i=p(n,t)))return i;throw at("Can't convert object to primitive value")};var ot,st;var lt,ct={},ht=Object.defineProperty;lt=function(t,e){try{ht(l,t,{value:e,configurable:!0,writable:!0})}catch(n){l[t]=e}return e};var ut=l["__core-js_shared__"]||lt("__core-js_shared__",{});ct=ut,(st=function(t,e){return ct[t]||(ct[t]=void 0!==e?e:{})})("versions",[]).push({version:"3.20.3",mode:"global",copyright:"© 2014-2022 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.20.3/LICENSE",source:"https://github.com/zloirock/core-js"});var dt,pt={},gt=l.Object;dt=function(t){return gt(P(t))};var ft=S({}.hasOwnProperty);pt=Object.hasOwn||function(t,e){return ft(dt(t),e)};var mt,yt=0,xt=Math.random(),bt=S(1..toString);mt=function(t){return"Symbol("+(void 0===t?"":t)+")_"+bt(++yt+xt,36)};var vt=st("wks"),wt=l.Symbol,Ct=wt&&wt.for,St=N?wt:wt&&wt.withoutSetter||mt;ot=function(t){if(!pt(vt,t)||!Y&&"string"!=typeof vt[t]){var e="Symbol."+t;Y&&pt(wt,t)?vt[t]=wt[t]:vt[t]=N&&Ct?Ct(e):St(e)}return vt[t]};var Et=l.TypeError,Mt=ot("toPrimitive");B=function(t,e){if(!z(t)||_(t))return t;var n,i=Q(t,Mt);if(i){if(void 0===e&&(e="default"),n=p(i,t,e),!z(n)||_(n))return n;throw Et("Can't convert object to primitive value")}return void 0===e&&(e="number"),rt(t,e)},D=function(t){var e=B(t,"string");return _(e)?e:e+""};var It,kt,Tt=l.document,Rt=z(Tt)&&z(Tt.createElement);kt=function(t){return Rt?Tt.createElement(t):{}},It=!h&&!u((function(){return 7!=Object.defineProperty(kt("div"),"a",{get:function(){return 7}}).a}));var Lt,At,Pt=Object.getOwnPropertyDescriptor,Ot=s=h?Pt:function(t,e){if(t=v(t),e=D(e),It)try{return Pt(t,e)}catch(t){}if(pt(t,e))return b(!p(g,t,e),t[e])},Dt={};At=h&&u((function(){return 42!=Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype}));var Bt,zt=l.String,jt=l.TypeError;Bt=function(t){if(z(t))return t;throw jt(zt(t)+" is not an object")};var Ht=l.TypeError,_t=Object.defineProperty,Ft=Object.getOwnPropertyDescriptor;Lt=h?At?function(t,e,n){if(Bt(t),e=D(e),Bt(n),"function"==typeof t&&"prototype"===e&&"value"in n&&"writable"in n&&!n.writable){var i=Ft(t,e);i&&i.writable&&(t[e]=n.value,n={configurable:"configurable"in n?n.configurable:i.configurable,enumerable:"enumerable"in n?n.enumerable:i.enumerable,writable:!1})}return _t(t,e,n)}:_t:function(t,e,n){if(Bt(t),e=D(e),Bt(n),It)try{return _t(t,e,n)}catch(t){}if("get"in n||"set"in n)throw Ht("Accessors not supported");return"value"in n&&(t[e]=n.value),t},Dt=h?function(t,e,n){return Lt(t,e,b(1,n))}:function(t,e,n){return t[e]=n,t};var Ut,Nt={},Yt=S(Function.toString);j(ct.inspectSource)||(ct.inspectSource=function(t){return Yt(t)}),Nt=ct.inspectSource;var Xt,Vt,Wt=l.WeakMap;Vt=j(Wt)&&/native code/.test(Nt(Wt));var Kt,Gt=st("keys");Kt=function(t){return Gt[t]||(Gt[t]=mt(t))};var qt={};qt={};var Zt,$t,Jt,Qt=l.TypeError,te=l.WeakMap;if(Vt||ct.state){var ee=ct.state||(ct.state=new te),ne=S(ee.get),ie=S(ee.has),re=S(ee.set);Zt=function(t,e){if(ie(ee,t))throw new Qt("Object already initialized");return e.facade=t,re(ee,t,e),e},$t=function(t){return ne(ee,t)||{}},Jt=function(t){return ie(ee,t)}}else{var ae=Kt("state");qt[ae]=!0,Zt=function(t,e){if(pt(t,ae))throw new Qt("Object already initialized");return e.facade=t,Dt(t,ae,e),e},$t=function(t){return pt(t,ae)?t[ae]:{}},Jt=function(t){return pt(t,ae)}}Xt={set:Zt,get:$t,has:Jt,enforce:function(t){return Jt(t)?$t(t):Zt(t,{})},getterFor:function(t){return function(e){var n;if(!z(e)||(n=$t(e)).type!==t)throw Qt("Incompatible receiver, "+t+" required");return n}}};var oe,se=Function.prototype,le=h&&Object.getOwnPropertyDescriptor,ce=pt(se,"name"),he=(oe={EXISTS:ce,PROPER:ce&&"something"===function(){}.name,CONFIGURABLE:ce&&(!h||h&&le(se,"name").configurable)}).CONFIGURABLE,ue=Xt.get,de=Xt.enforce,pe=String(String).split("String");(Ut=function(t,e,n,i){var r,a=!!i&&!!i.unsafe,o=!!i&&!!i.enumerable,s=!!i&&!!i.noTargetGet,c=i&&void 0!==i.name?i.name:e;j(n)&&("Symbol("===String(c).slice(0,7)&&(c="["+String(c).replace(/^Symbol\(([^)]*)\)/,"$1")+"]"),(!pt(n,"name")||he&&n.name!==c)&&Dt(n,"name",c),(r=de(n)).source||(r.source=pe.join("string"==typeof c?c:""))),t!==l?(a?!s&&t[e]&&(o=!0):delete t[e],o?t[e]=n:Dt(t,e,n)):o?t[e]=n:lt(e,n)})(Function.prototype,"toString",(function(){return j(this)&&ue(this).source||Nt(this)}));var ge,fe,me,ye,xe,be={},ve=Math.ceil,we=Math.floor;xe=function(t){var e=+t;return e!=e||0===e?0:(e>0?we:ve)(e)};var Ce=Math.max,Se=Math.min;ye=function(t,e){var n=xe(t);return n<0?Ce(n+e,0):Se(n,e)};var Ee,Me,Ie=Math.min;Me=function(t){return t>0?Ie(xe(t),9007199254740991):0},Ee=function(t){return Me(t.length)};var ke=function(t){return function(e,n,i){var r,a=v(e),o=Ee(a),s=ye(i,o);if(t&&n!=n){for(;o>s;)if((r=a[s++])!=r)return!0}else for(;o>s;s++)if((t||s in a)&&a[s]===n)return t||s||0;return!t&&-1}},Te={includes:ke(!0),indexOf:ke(!1)}.indexOf,Re=S([].push);me=function(t,e){var n,i=v(t),r=0,a=[];for(n in i)!pt(qt,n)&&pt(i,n)&&Re(a,n);for(;e.length>r;)pt(i,n=e[r++])&&(~Te(a,n)||Re(a,n));return a};var Le,Ae={},Pe=(Ae=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"]).concat("length","prototype");fe=Object.getOwnPropertyNames||function(t){return me(t,Pe)},Le=Object.getOwnPropertySymbols;var Oe=S([].concat);be=H("Reflect","ownKeys")||function(t){var e=fe(Bt(t));return Le?Oe(e,Le(t)):e},ge=function(t,e,n){for(var i=be(e),r=Lt,a=s,o=0;o<i.length;o++){var l=i[o];pt(t,l)||n&&pt(n,l)||r(t,l,a(e,l))}};var De={},Be=/#|\.prototype\./,ze=function(t,e){var n=He[je(t)];return n==Fe||n!=_e&&(j(e)?u(e):!!e)},je=ze.normalize=function(t){return String(t).replace(Be,".").toLowerCase()},He=ze.data={},_e=ze.NATIVE="N",Fe=ze.POLYFILL="P";De=ze,o=function(t,e){var n,i,r,a,o,s=t.target,c=t.global,h=t.stat;if(n=c?l:h?l[s]||lt(s,{}):(l[s]||{}).prototype)for(i in e){if(a=e[i],r=t.noTargetGet?(o=Ot(n,i))&&o.value:n[i],!De(c?i:s+(h?".":"#")+i,t.forced)&&void 0!==r){if(typeof a==typeof r)continue;ge(a,r)}(t.sham||r&&r.sham)&&Dt(a,"sham",!0),Ut(n,i,a,t)}};var Ue,Ne,Ye={},Xe={};Xe[ot("toStringTag")]="z",Ne="[object z]"===String(Xe);var Ve=ot("toStringTag"),We=l.Object,Ke="Arguments"==w(function(){return arguments}());Ye=Ne?w:function(t){var e,n,i;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(n=function(t,e){try{return t[e]}catch(t){}}(e=We(t),Ve))?n:Ke?w(e):"Object"==(i=w(e))&&j(e.callee)?"Arguments":i};var Ge=l.String;Ue=function(t){if("Symbol"===Ye(t))throw TypeError("Cannot convert a Symbol value to a string");return Ge(t)};var qe=Lt,Ze=l.Symbol,$e=Ze&&Ze.prototype;if(h&&j(Ze)&&(!("description"in $e)||void 0!==Ze().description)){var Je={},Qe=function(){var t=arguments.length<1||void 0===arguments[0]?void 0:Ue(arguments[0]),e=U($e,this)?new Ze(t):void 0===t?Ze():Ze(t);return""===t&&(Je[e]=!0),e};ge(Qe,Ze),Qe.prototype=$e,$e.constructor=Qe;var tn="Symbol(test)"==String(Ze("test")),en=S($e.toString),nn=S($e.valueOf),rn=/^Symbol\((.*)\)[^)]+$/,an=S("".replace),on=S("".slice);qe($e,"description",{configurable:!0,get:function(){var t=nn(this),e=en(t);if(pt(Je,t))return"";var n=tn?on(e,7,-1):an(e,rn,"$1");return""===n?void 0:n}}),o({global:!0,forced:!0},{Symbol:Qe})}var sn,ln,cn={};cn=l,ln=ot;var hn=Lt;(sn=function(t){var e=cn.Symbol||(cn.Symbol={});pt(e,t)||hn(e,t,{value:ln(t)})})("asyncIterator");var un={},dn={};dn=Array.isArray||function(t){return"Array"==w(t)};var pn,gn=S(S.bind);pn=function(t,e){return tt(t),void 0===e?t:d?gn(t,e):function(){return t.apply(e,arguments)}};var fn=l.TypeError,mn=function(t,e,n,i,r,a,o,s){for(var l,c,h=r,u=0,d=!!o&&pn(o,s);u<i;){if(u in n){if(l=d?d(n[u],u,e):n[u],a>0&&dn(l))c=Ee(l),h=mn(t,e,l,c,h,a-1)-1;else{if(h>=9007199254740991)throw fn("Exceed the acceptable array length");t[h]=l}h++}u++}return h};un=mn;var yn,xn,bn={},vn=function(){},wn=[],Cn=H("Reflect","construct"),Sn=/^\s*(?:class|function)\b/,En=S(Sn.exec),Mn=!Sn.exec(vn),In=function(t){if(!j(t))return!1;try{return Cn(vn,wn,t),!0}catch(t){return!1}},kn=function(t){if(!j(t))return!1;switch(Ye(t)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return Mn||!!En(Sn,Nt(t))}catch(t){return!0}};kn.sham=!0,bn=!Cn||u((function(){var t;return In(In.call)||!In(Object)||!In((function(){t=!0}))||t}))?kn:In;var Tn=ot("species"),Rn=l.Array;xn=function(t){var e;return dn(t)&&(e=t.constructor,(bn(e)&&(e===Rn||dn(e.prototype))||z(e)&&null===(e=e[Tn]))&&(e=void 0)),void 0===e?Rn:e},yn=function(t,e){return new(xn(t))(0===e?0:e)},o({target:"Array",proto:!0},{flat:function(){var t=arguments.length?arguments[0]:void 0,e=dt(this),n=Ee(e),i=yn(e,0);return i.length=un(i,e,e,n,0,void 0===t?1:xe(t)),i}}),o({target:"Array",proto:!0},{flatMap:function(t){var e,n=dt(this),i=Ee(n);return tt(t),(e=yn(n,0)).length=un(e,n,n,i,0,1,t,arguments.length>1?arguments[1]:void 0),e}});var Ln,An,Pn,On={},Dn={};Dn=Object.keys||function(t){return me(t,Ae)},Pn=h&&!At?Object.defineProperties:function(t,e){Bt(t);for(var n,i=v(e),r=Dn(e),a=r.length,o=0;a>o;)Lt(t,n=r[o++],i[n]);return t};var Bn={};Bn=H("document","documentElement");var zn,jn=Kt("IE_PROTO"),Hn=function(){},_n=function(t){return"<script>"+t+"<\/script>"},Fn=function(t){t.write(_n("")),t.close();var e=t.parentWindow.Object;return t=null,e},Un=function(){try{zn=new ActiveXObject("htmlfile")}catch(t){}var t,e;Un="undefined"!=typeof document?document.domain&&zn?Fn(zn):((e=kt("iframe")).style.display="none",Bn.appendChild(e),e.src=String("javascript:"),(t=e.contentWindow.document).open(),t.write(_n("document.F=Object")),t.close(),t.F):Fn(zn);for(var n=Ae.length;n--;)delete Un.prototype[Ae[n]];return Un()};qt[jn]=!0,On=Object.create||function(t,e){var n;return null!==t?(Hn.prototype=Bt(t),n=new Hn,Hn.prototype=null,n[jn]=t):n=Un(),void 0===e?n:Pn(n,e)};var Nn=ot("unscopables"),Yn=Array.prototype;null==Yn[Nn]&&Lt(Yn,Nn,{configurable:!0,value:On(null)}),An=function(t){Yn[Nn][t]=!0};var Xn={};Xn={};var Vn,Wn,Kn,Gn,qn=Lt,Zn={};Gn=!u((function(){function t(){}return t.prototype.constructor=null,Object.getPrototypeOf(new t)!==t.prototype}));var $n=Kt("IE_PROTO"),Jn=l.Object,Qn=Jn.prototype;Zn=Gn?Jn.getPrototypeOf:function(t){var e=dt(t);if(pt(e,$n))return e[$n];var n=e.constructor;return j(n)&&e instanceof n?n.prototype:e instanceof Jn?Qn:null};var ti,ei,ni,ii=ot("iterator"),ri=!1;[].keys&&("next"in(ni=[].keys())?(ei=Zn(Zn(ni)))!==Object.prototype&&(ti=ei):ri=!0),(null==ti||u((function(){var t={};return ti[ii].call(t)!==t})))&&(ti={}),j(ti[ii])||Ut(ti,ii,(function(){return this}));var ai,oi=(Kn={IteratorPrototype:ti,BUGGY_SAFARI_ITERATORS:ri}).IteratorPrototype,si=Lt,li=ot("toStringTag");ai=function(t,e,n){t&&!n&&(t=t.prototype),t&&!pt(t,li)&&si(t,li,{configurable:!0,value:e})};var ci=function(){return this};Wn=function(t,e,n,i){var r=e+" Iterator";return t.prototype=On(oi,{next:b(+!i,n)}),ai(t,r,!1),Xn[r]=ci,t};var hi,ui={},di=l.String,pi=l.TypeError;hi=function(t){if("object"==typeof t||j(t))return t;throw pi("Can't set "+di(t)+" as a prototype")},ui=Object.setPrototypeOf||("__proto__"in{}?function(){var t,e=!1,n={};try{(t=S(Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set))(n,[]),e=n instanceof Array}catch(t){}return function(n,i){return Bt(n),hi(i),e?t(n,i):n.__proto__=i,n}}():void 0);var gi=oe.PROPER,fi=oe.CONFIGURABLE,mi=Kn.IteratorPrototype,yi=Kn.BUGGY_SAFARI_ITERATORS,xi=ot("iterator"),bi=function(){return this};Vn=function(t,e,n,i,r,a,s){Wn(n,e,i);var l,c,h,u=function(t){if(t===r&&y)return y;if(!yi&&t in f)return f[t];switch(t){case"keys":case"values":case"entries":return function(){return new n(this,t)}}return function(){return new n(this)}},d=e+" Iterator",g=!1,f=t.prototype,m=f[xi]||f["@@iterator"]||r&&f[r],y=!yi&&m||u(r),x="Array"==e&&f.entries||m;if(x&&(l=Zn(x.call(new t)))!==Object.prototype&&l.next&&(Zn(l)!==mi&&(ui?ui(l,mi):j(l[xi])||Ut(l,xi,bi)),ai(l,d,!0)),gi&&"values"==r&&m&&"values"!==m.name&&(fi?Dt(f,"name","values"):(g=!0,y=function(){return p(m,this)})),r)if(c={values:u("values"),keys:a?y:u("keys"),entries:u("entries")},s)for(h in c)(yi||g||!(h in f))&&Ut(f,h,c[h]);else o({target:e,proto:!0,forced:yi||g},c);return f[xi]!==y&&Ut(f,xi,y,{name:r}),Xn[e]=y,c};var vi=Xt.set,wi=Xt.getterFor("Array Iterator");Ln=Vn(Array,"Array",(function(t,e){vi(this,{type:"Array Iterator",target:v(t),index:0,kind:e})}),(function(){var t=wi(this),e=t.target,n=t.kind,i=t.index++;return!e||i>=e.length?(t.target=void 0,{value:void 0,done:!0}):"keys"==n?{value:i,done:!1}:"values"==n?{value:e[i],done:!1}:{value:[i,e[i]],done:!1}}),"values");var Ci=Xn.Arguments=Xn.Array;if(An("keys"),An("values"),An("entries"),h&&"values"!==Ci.name)try{qn(Ci,"name",{value:"values"})}catch(t){}var Si,Ei,Mi=l.TypeError,Ii=function(t){return function(e,n,i,r){tt(n);var a=dt(e),o=C(a),s=Ee(a),l=t?s-1:0,c=t?-1:1;if(i<2)for(;;){if(l in o){r=o[l],l+=c;break}if(l+=c,t?l<0:s<=l)throw Mi("Reduce of empty array with no initial value")}for(;t?l>=0:s>l;l+=c)l in o&&(r=n(r,o[l],l,a));return r}},ki=(Si={left:Ii(!1),right:Ii(!0)}).left;Ei=function(t,e){var n=[][t];return!!n&&u((function(){n.call(null,e||function(){throw 1},1)}))};var Ti;Ti="process"==w(l.process);var Ri=Ei("reduce");o({target:"Array",proto:!0,forced:!Ri||!Ti&&X>79&&X<83},{reduce:function(t){var e=arguments.length;return ki(this,t,e,e>1?arguments[1]:void 0)}});var Li=Si.right,Ai=Ei("reduceRight");o({target:"Array",proto:!0,forced:!Ai||!Ti&&X>79&&X<83},{reduceRight:function(t){return Li(this,t,arguments.length,arguments.length>1?arguments[1]:void 0)}});var Pi,Oi,Di={};Oi=function(t,e,n){var i=D(e);i in t?Lt(t,i,b(0,n)):t[i]=n};var Bi=l.Array,zi=Math.max;Pi=function(t,e,n){for(var i=Ee(t),r=ye(e,i),a=ye(void 0===n?i:n,i),o=Bi(zi(a-r,0)),s=0;r<a;r++,s++)Oi(o,s,t[r]);return o.length=s,o};var ji=Math.floor,Hi=function(t,e){var n=t.length,i=ji(n/2);return n<8?_i(t,e):Fi(t,Hi(Pi(t,0,i),e),Hi(Pi(t,i),e),e)},_i=function(t,e){for(var n,i,r=t.length,a=1;a<r;){for(i=a,n=t[a];i&&e(t[i-1],n)>0;)t[i]=t[--i];i!==a++&&(t[i]=n)}return t},Fi=function(t,e,n,i){for(var r=e.length,a=n.length,o=0,s=0;o<r||s<a;)t[o+s]=o<r&&s<a?i(e[o],n[s])<=0?e[o++]:n[s++]:o<r?e[o++]:n[s++];return t};Di=Hi;var Ui,Ni=V.match(/firefox\/(\d+)/i);Ui=!!Ni&&+Ni[1];var Yi;Yi=/MSIE|Trident/.test(V);var Xi,Vi=V.match(/AppleWebKit\/(\d+)\./);Xi=!!Vi&&+Vi[1];var Wi=[],Ki=S(Wi.sort),Gi=S(Wi.push),qi=u((function(){Wi.sort(void 0)})),Zi=u((function(){Wi.sort(null)})),$i=Ei("sort"),Ji=!u((function(){if(X)return X<70;if(!(Ui&&Ui>3)){if(Yi)return!0;if(Xi)return Xi<603;var t,e,n,i,r="";for(t=65;t<76;t++){switch(e=String.fromCharCode(t),t){case 66:case 69:case 70:case 72:n=3;break;case 68:case 71:n=4;break;default:n=2}for(i=0;i<47;i++)Wi.push({k:e+i,v:n})}for(Wi.sort((function(t,e){return e.v-t.v})),i=0;i<Wi.length;i++)e=Wi[i].k.charAt(0),r.charAt(r.length-1)!==e&&(r+=e);return"DGBEFHACIJK"!==r}}));o({target:"Array",proto:!0,forced:qi||!Zi||!$i||!Ji},{sort:function(t){void 0!==t&&tt(t);var e=dt(this);if(Ji)return void 0===t?Ki(e):Ki(e,t);var n,i,r=[],a=Ee(e);for(i=0;i<a;i++)i in e&&Gi(r,e[i]);for(Di(r,function(t){return function(e,n){return void 0===n?-1:void 0===e?1:void 0!==t?+t(e,n)||0:Ue(e)>Ue(n)?1:-1}}(t)),n=r.length,i=0;i<n;)e[i]=r[i++];for(;i<a;)delete e[i++];return e}}),An("flat"),An("flatMap");var Qi=Math.hypot,tr=Math.abs,er=Math.sqrt,nr=!!Qi&&Qi(1/0,NaN)!==1/0;o({target:"Math",stat:!0,forced:nr},{hypot:function(t,e){for(var n,i,r=0,a=0,o=arguments.length,s=0;a<o;)s<(n=tr(arguments[a++]))?(r=r*(i=s/n)*i+1,s=n):r+=n>0?(i=n/s)*i:n;return s===1/0?1/0:s*er(r)}});var ir;ir=!u((function(){if(!(Xi&&Xi<535)){var t=Math.random();__defineSetter__.call(null,t,(function(){})),delete l[t]}})),h&&o({target:"Object",proto:!0,forced:ir},{__defineGetter__:function(t,e){Lt(dt(this),t,{get:tt(e),enumerable:!0,configurable:!0})}}),h&&o({target:"Object",proto:!0,forced:ir},{__defineSetter__:function(t,e){Lt(dt(this),t,{set:tt(e),enumerable:!0,configurable:!0})}});var rr,ar,or=ot("iterator"),sr=Array.prototype;ar=function(t){return void 0!==t&&(Xn.Array===t||sr[or]===t)};var lr,cr,hr=ot("iterator");cr=function(t){if(null!=t)return Q(t,hr)||Q(t,"@@iterator")||Xn[Ye(t)]};var ur=l.TypeError;lr=function(t,e){var n=arguments.length<2?cr(t):e;if(tt(n))return Bt(p(n,t));throw ur(et(t)+" is not iterable")};var dr;dr=function(t,e,n){var i,r;Bt(t);try{if(!(i=Q(t,"return"))){if("throw"===e)throw n;return n}i=p(i,t)}catch(t){r=!0,i=t}if("throw"===e)throw n;if(r)throw i;return Bt(i),n};var pr=l.TypeError,gr=function(t,e){this.stopped=t,this.result=e},fr=gr.prototype;rr=function(t,e,n){var i,r,a,o,s,l,c,h=n&&n.that,u=!(!n||!n.AS_ENTRIES),d=!(!n||!n.IS_ITERATOR),g=!(!n||!n.INTERRUPTED),f=pn(e,h),m=function(t){return i&&dr(i,"normal",t),new gr(!0,t)},y=function(t){return u?(Bt(t),g?f(t[0],t[1],m):f(t[0],t[1])):g?f(t,m):f(t)};if(d)i=t;else{if(!(r=cr(t)))throw pr(et(t)+" is not iterable");if(ar(r)){for(a=0,o=Ee(t);o>a;a++)if((s=y(t[a]))&&U(fr,s))return s;return new gr(!1)}i=lr(t,r)}for(l=i.next;!(c=p(l,i)).done;){try{s=y(c.value)}catch(t){dr(i,"throw",t)}if("object"==typeof s&&s&&U(fr,s))return s}return new gr(!1)},o({target:"Object",stat:!0},{fromEntries:function(t){var e={};return rr(t,(function(t,n){Oi(e,t,n)}),{AS_ENTRIES:!0}),e}});var mr=s;h&&o({target:"Object",proto:!0,forced:ir},{__lookupGetter__:function(t){var e,n=dt(this),i=D(t);do{if(e=mr(n,i))return e.get}while(n=Zn(n))}});var yr=s;h&&o({target:"Object",proto:!0,forced:ir},{__lookupSetter__:function(t){var e,n=dt(this),i=D(t);do{if(e=yr(n,i))return e.set}while(n=Zn(n))}});var xr={};xr=l.Promise;var br;br=function(t,e,n){for(var i in e)Ut(t,i,e[i],n);return t};var vr,wr=ot("species");vr=function(t){var e=H(t),n=Lt;h&&e&&!e[wr]&&n(e,wr,{configurable:!0,get:function(){return this}})};var Cr,Sr=l.TypeError;Cr=function(t,e){if(U(e,t))return t;throw Sr("Incorrect invocation")};var Er,Mr=ot("iterator"),Ir=!1;try{var kr=0,Tr={next:function(){return{done:!!kr++}},return:function(){Ir=!0}};Tr[Mr]=function(){return this},Array.from(Tr,(function(){throw 2}))}catch(t){}Er=function(t,e){if(!e&&!Ir)return!1;var n=!1;try{var i={};i[Mr]=function(){return{next:function(){return{done:n=!0}}}},t(i)}catch(t){}return n};var Rr,Lr,Ar=l.TypeError;Lr=function(t){if(bn(t))return t;throw Ar(et(t)+" is not a constructor")};var Pr=ot("species");Rr=function(t,e){var n,i=Bt(t).constructor;return void 0===i||null==(n=Bt(i)[Pr])?e:Lr(n)};var Or,Dr={},Br=Function.prototype,zr=Br.apply,jr=Br.call;Dr="object"==typeof Reflect&&Reflect.apply||(d?jr.bind(zr):function(){return jr.apply(zr,arguments)});var Hr={};Hr=S([].slice);var _r;_r=/(?:ipad|iphone|ipod).*applewebkit/i.test(V);var Fr,Ur,Nr,Yr,Xr=l.setImmediate,Vr=l.clearImmediate,Wr=l.process,Kr=l.Dispatch,Gr=l.Function,qr=l.MessageChannel,Zr=l.String,$r=0,Jr={};try{Fr=l.location}catch(t){}var Qr=function(t){if(pt(Jr,t)){var e=Jr[t];delete Jr[t],e()}},ta=function(t){return function(){Qr(t)}},ea=function(t){Qr(t.data)},na=function(t){l.postMessage(Zr(t),Fr.protocol+"//"+Fr.host)};Xr&&Vr||(Xr=function(t){var e=Hr(arguments,1);return Jr[++$r]=function(){Dr(j(t)?t:Gr(t),void 0,e)},Ur($r),$r},Vr=function(t){delete Jr[t]},Ti?Ur=function(t){Wr.nextTick(ta(t))}:Kr&&Kr.now?Ur=function(t){Kr.now(ta(t))}:qr&&!_r?(Yr=(Nr=new qr).port2,Nr.port1.onmessage=ea,Ur=pn(Yr.postMessage,Yr)):l.addEventListener&&j(l.postMessage)&&!l.importScripts&&Fr&&"file:"!==Fr.protocol&&!u(na)?(Ur=na,l.addEventListener("message",ea,!1)):Ur="onreadystatechange"in kt("script")?function(t){Bn.appendChild(kt("script")).onreadystatechange=function(){Bn.removeChild(this),Qr(t)}}:function(t){setTimeout(ta(t),0)});var ia,ra=(Or={set:Xr,clear:Vr}).set,aa={},oa=s,sa=Or.set;ia=/ipad|iphone|ipod/i.test(V)&&void 0!==l.Pebble;var la;la=/web0s(?!.*chrome)/i.test(V);var ca,ha,ua,da,pa,ga,fa,ma,ya=l.MutationObserver||l.WebKitMutationObserver,xa=l.document,ba=l.process,va=l.Promise,wa=oa(l,"queueMicrotask"),Ca=wa&&wa.value;Ca||(ca=function(){var t,e;for(Ti&&(t=ba.domain)&&t.exit();ha;){e=ha.fn,ha=ha.next;try{e()}catch(t){throw ha?da():ua=void 0,t}}ua=void 0,t&&t.enter()},_r||Ti||la||!ya||!xa?!ia&&va&&va.resolve?((fa=va.resolve(void 0)).constructor=va,ma=pn(fa.then,fa),da=function(){ma(ca)}):Ti?da=function(){ba.nextTick(ca)}:(sa=pn(sa,l),da=function(){sa(ca)}):(pa=!0,ga=xa.createTextNode(""),new ya(ca).observe(ga,{characterData:!0}),da=function(){ga.data=pa=!pa})),aa=Ca||function(t){var e={fn:t,next:void 0};ua&&(ua.next=e),ha||(ha=e,da()),ua=e};var Sa,Ea,Ma=function(t){var e,n;this.promise=new t((function(t,i){if(void 0!==e||void 0!==n)throw TypeError("Bad Promise constructor");e=t,n=i})),this.resolve=tt(e),this.reject=tt(n)};Ea=function(t){return new Ma(t)},Sa=function(t,e){if(Bt(t),z(e)&&e.constructor===t)return e;var n=Ea(t);return(0,n.resolve)(e),n.promise};var Ia;Ia=function(t,e){var n=l.console;n&&n.error&&(1==arguments.length?n.error(t):n.error(t,e))};var ka;ka=function(t){try{return{error:!1,value:t()}}catch(t){return{error:!0,value:t}}};var Ta={},Ra=function(){this.head=null,this.tail=null};Ra.prototype={add:function(t){var e={item:t,next:null};this.head?this.tail.next=e:this.head=e,this.tail=e},get:function(){var t=this.head;if(t)return this.head=t.next,this.tail===t&&(this.tail=null),t.item}},Ta=Ra;var La;La="object"==typeof window;var Aa,Pa,Oa,Da,Ba=ot("species"),za=Xt.getterFor("Promise"),ja=Xt.set,Ha=Xt.getterFor("Promise"),_a=xr&&xr.prototype,Fa=xr,Ua=_a,Na=l.TypeError,Ya=l.document,Xa=l.process,Va=Ea,Wa=Va,Ka=!!(Ya&&Ya.createEvent&&l.dispatchEvent),Ga=j(l.PromiseRejectionEvent),qa=!1,Za=De("Promise",(function(){var t=Nt(Fa),e=t!==String(Fa);if(!e&&66===X)return!0;if(X>=51&&/native code/.test(t))return!1;var n=new Fa((function(t){t(1)})),i=function(t){t((function(){}),(function(){}))};return(n.constructor={})[Ba]=i,!(qa=n.then((function(){}))instanceof i)||!e&&La&&!Ga})),$a=Za||!Er((function(t){Fa.all(t).catch((function(){}))})),Ja=function(t){var e;return!(!z(t)||!j(e=t.then))&&e},Qa=function(t,e){var n,i,r,a=e.value,o=1==e.state,s=o?t.ok:t.fail,l=t.resolve,c=t.reject,h=t.domain;try{s?(o||(2===e.rejection&&ro(e),e.rejection=1),!0===s?n=a:(h&&h.enter(),n=s(a),h&&(h.exit(),r=!0)),n===t.promise?c(Na("Promise-chain cycle")):(i=Ja(n))?p(i,n,l,c):l(n)):c(a)}catch(t){h&&!r&&h.exit(),c(t)}},to=function(t,e){t.notified||(t.notified=!0,aa((function(){for(var n,i=t.reactions;n=i.get();)Qa(n,t);t.notified=!1,e&&!t.rejection&&no(t)})))},eo=function(t,e,n){var i,r;Ka?((i=Ya.createEvent("Event")).promise=e,i.reason=n,i.initEvent(t,!1,!0),l.dispatchEvent(i)):i={promise:e,reason:n},!Ga&&(r=l["on"+t])?r(i):"unhandledrejection"===t&&Ia("Unhandled promise rejection",n)},no=function(t){p(ra,l,(function(){var e,n=t.facade,i=t.value;if(io(t)&&(e=ka((function(){Ti?Xa.emit("unhandledRejection",i,n):eo("unhandledrejection",n,i)})),t.rejection=Ti||io(t)?2:1,e.error))throw e.value}))},io=function(t){return 1!==t.rejection&&!t.parent},ro=function(t){p(ra,l,(function(){var e=t.facade;Ti?Xa.emit("rejectionHandled",e):eo("rejectionhandled",e,t.value)}))},ao=function(t,e,n){return function(i){t(e,i,n)}},oo=function(t,e,n){t.done||(t.done=!0,n&&(t=n),t.value=e,t.state=2,to(t,!0))},so=function(t,e,n){if(!t.done){t.done=!0,n&&(t=n);try{if(t.facade===e)throw Na("Promise can't be resolved itself");var i=Ja(e);i?aa((function(){var n={done:!1};try{p(i,e,ao(so,n,t),ao(oo,n,t))}catch(e){oo(n,e,t)}})):(t.value=e,t.state=1,to(t,!1))}catch(e){oo({done:!1},e,t)}}};if(Za&&(Ua=(Fa=function(t){Cr(this,Ua),tt(t),p(Aa,this);var e=za(this);try{t(ao(so,e),ao(oo,e))}catch(t){oo(e,t)}}).prototype,(Aa=function(t){ja(this,{type:"Promise",done:!1,notified:!1,parent:!1,reactions:new Ta,rejection:!1,state:0,value:void 0})}).prototype=br(Ua,{then:function(t,e){var n=Ha(this),i=Va(Rr(this,Fa));return n.parent=!0,i.ok=!j(t)||t,i.fail=j(e)&&e,i.domain=Ti?Xa.domain:void 0,0==n.state?n.reactions.add(i):aa((function(){Qa(i,n)})),i.promise},catch:function(t){return this.then(void 0,t)}}),Pa=function(){var t=new Aa,e=za(t);this.promise=t,this.resolve=ao(so,e),this.reject=ao(oo,e)},Ea=Va=function(t){return t===Fa||t===Oa?new Pa(t):Wa(t)},j(xr)&&_a!==Object.prototype)){Da=_a.then,qa||(Ut(_a,"then",(function(t,e){var n=this;return new Fa((function(t,e){p(Da,n,t,e)})).then(t,e)}),{unsafe:!0}),Ut(_a,"catch",Ua.catch,{unsafe:!0}));try{delete _a.constructor}catch(t){}ui&&ui(_a,Ua)}o({global:!0,wrap:!0,forced:Za},{Promise:Fa}),ai(Fa,"Promise",!1),vr("Promise"),Oa=H("Promise"),o({target:"Promise",stat:!0,forced:Za},{reject:function(t){var e=Va(this);return p(e.reject,void 0,t),e.promise}}),o({target:"Promise",stat:!0,forced:Za},{resolve:function(t){return Sa(this,t)}}),o({target:"Promise",stat:!0,forced:$a},{all:function(t){var e=this,n=Va(e),i=n.resolve,r=n.reject,a=ka((function(){var n=tt(e.resolve),a=[],o=0,s=1;rr(t,(function(t){var l=o++,c=!1;s++,p(n,e,t).then((function(t){c||(c=!0,a[l]=t,--s||i(a))}),r)})),--s||i(a)}));return a.error&&r(a.value),n.promise},race:function(t){var e=this,n=Va(e),i=n.reject,r=ka((function(){var r=tt(e.resolve);rr(t,(function(t){p(r,e,t).then(n.resolve,i)}))}));return r.error&&i(r.value),n.promise}});var lo=!!xr&&u((function(){xr.prototype.finally.call({then:function(){}},(function(){}))}));if(o({target:"Promise",proto:!0,real:!0,forced:lo},{finally:function(t){var e=Rr(this,H("Promise")),n=j(t);return this.then(n?function(n){return Sa(e,t()).then((function(){return n}))}:t,n?function(n){return Sa(e,t()).then((function(){throw n}))}:t)}}),j(xr)){var co=H("Promise").prototype.finally;xr.prototype.finally!==co&&Ut(xr.prototype,"finally",co,{unsafe:!0})}var ho,uo,po;po=function(){var t=Bt(this),e="";return t.global&&(e+="g"),t.ignoreCase&&(e+="i"),t.multiline&&(e+="m"),t.dotAll&&(e+="s"),t.unicode&&(e+="u"),t.sticky&&(e+="y"),e};var go,fo=l.RegExp,mo=u((function(){var t=fo("a","y");return t.lastIndex=2,null!=t.exec("abcd")})),yo=mo||u((function(){return!fo("a","y").sticky}));go={BROKEN_CARET:mo||u((function(){var t=fo("^r","gy");return t.lastIndex=2,null!=t.exec("str")})),MISSED_STICKY:yo,UNSUPPORTED_Y:mo};var xo,bo=Xt.get,vo=l.RegExp;xo=u((function(){var t=vo(".","s");return!(t.dotAll&&t.exec("\n")&&"s"===t.flags)}));var wo,Co=l.RegExp;wo=u((function(){var t=Co("(?<a>b)","g");return"b"!==t.exec("b").groups.a||"bc"!=="b".replace(t,"$<a>c")}));var So,Eo,Mo=st("native-string-replace",String.prototype.replace),Io=RegExp.prototype.exec,ko=Io,To=S("".charAt),Ro=S("".indexOf),Lo=S("".replace),Ao=S("".slice),Po=(Eo=/b*/g,p(Io,So=/a/,"a"),p(Io,Eo,"a"),0!==So.lastIndex||0!==Eo.lastIndex),Oo=go.BROKEN_CARET,Do=void 0!==/()??/.exec("")[1];(Po||Do||Oo||xo||wo)&&(ko=function(t){var e,n,i,r,a,o,s,l=this,c=bo(l),h=Ue(t),u=c.raw;if(u)return u.lastIndex=l.lastIndex,e=p(ko,u,h),l.lastIndex=u.lastIndex,e;var d=c.groups,g=Oo&&l.sticky,f=p(po,l),m=l.source,y=0,x=h;if(g&&(f=Lo(f,"y",""),-1===Ro(f,"g")&&(f+="g"),x=Ao(h,l.lastIndex),l.lastIndex>0&&(!l.multiline||l.multiline&&"\n"!==To(h,l.lastIndex-1))&&(m="(?: "+m+")",x=" "+x,y++),n=new RegExp("^(?:"+m+")",f)),Do&&(n=new RegExp("^"+m+"$(?!\\s)",f)),Po&&(i=l.lastIndex),r=p(Io,g?n:l,x),g?r?(r.input=Ao(r.input,y),r[0]=Ao(r[0],y),r.index=l.lastIndex,l.lastIndex+=r[0].length):l.lastIndex=0:Po&&r&&(l.lastIndex=l.global?r.index+r[0].length:i),Do&&r&&r.length>1&&p(Mo,r[0],n,(function(){for(a=1;a<arguments.length-2;a++)void 0===arguments[a]&&(r[a]=void 0)})),r&&d)for(r.groups=o=On(null),a=0;a<d.length;a++)o[(s=d[a])[0]]=r[s[1]];return r}),o({target:"RegExp",proto:!0,forced:/./.exec!==(uo=ko)},{exec:uo});var Bo=ot("species"),zo=RegExp.prototype;ho=function(t,e,n,i){var r=ot(t),a=!u((function(){var e={};return e[r]=function(){return 7},7!=""[t](e)})),o=a&&!u((function(){var e=!1,n=/a/;return"split"===t&&((n={}).constructor={},n.constructor[Bo]=function(){return n},n.flags="",n[r]=/./[r]),n.exec=function(){return e=!0,null},n[r](""),!e}));if(!a||!o||n){var s=S(/./[r]),l=e(r,""[t],(function(t,e,n,i,r){var o=S(t),l=e.exec;return l===uo||l===zo.exec?a&&!r?{done:!0,value:s(e,n,i)}:{done:!0,value:o(n,e,i)}:{done:!1}}));Ut(String.prototype,t,l[0]),Ut(zo,r,l[1])}i&&Dt(zo[r],"sham",!0)};var jo,Ho,_o=S("".charAt),Fo=S("".charCodeAt),Uo=S("".slice),No=function(t){return function(e,n){var i,r,a=Ue(P(e)),o=xe(n),s=a.length;return o<0||o>=s?t?"":void 0:(i=Fo(a,o))<55296||i>56319||o+1===s||(r=Fo(a,o+1))<56320||r>57343?t?_o(a,o):i:t?Uo(a,o,o+2):r-56320+(i-55296<<10)+65536}},Yo=(Ho={codeAt:No(!1),charAt:No(!0)}).charAt;jo=function(t,e,n){return e+(n?Yo(t,e).length:1)};var Xo,Vo=Math.floor,Wo=S("".charAt),Ko=S("".replace),Go=S("".slice),qo=/\$([$&'`]|\d{1,2}|<[^>]*>)/g,Zo=/\$([$&'`]|\d{1,2})/g;Xo=function(t,e,n,i,r,a){var o=n+t.length,s=i.length,l=Zo;return void 0!==r&&(r=dt(r),l=qo),Ko(a,l,(function(a,l){var c;switch(Wo(l,0)){case"$":return"$";case"&":return t;case"`":return Go(e,0,n);case"'":return Go(e,o);case"<":c=r[Go(l,1,-1)];break;default:var h=+l;if(0===h)return a;if(h>s){var u=Vo(h/10);return 0===u?a:u<=s?void 0===i[u-1]?Wo(l,1):i[u-1]+Wo(l,1):a}c=i[h-1]}return void 0===c?"":c}))};var $o,Jo=l.TypeError;$o=function(t,e){var n=t.exec;if(j(n)){var i=p(n,t,e);return null!==i&&Bt(i),i}if("RegExp"===w(t))return p(uo,t,e);throw Jo("RegExp#exec called on incompatible receiver")};var Qo=ot("replace"),ts=Math.max,es=Math.min,ns=S([].concat),is=S([].push),rs=S("".indexOf),as=S("".slice),os="$0"==="a".replace(/./,"$0"),ss=!!/./[Qo]&&""===/./[Qo]("a","$0");ho("replace",(function(t,e,n){var i=ss?"$":"$0";return[function(t,n){var i=P(this),r=null==t?void 0:Q(t,Qo);return r?p(r,t,i,n):p(e,Ue(i),t,n)},function(t,r){var a=Bt(this),o=Ue(t);if("string"==typeof r&&-1===rs(r,i)&&-1===rs(r,"$<")){var s=n(e,a,o,r);if(s.done)return s.value}var l=j(r);l||(r=Ue(r));var c=a.global;if(c){var h=a.unicode;a.lastIndex=0}for(var u=[];;){var d=$o(a,o);if(null===d)break;if(is(u,d),!c)break;""===Ue(d[0])&&(a.lastIndex=jo(o,Me(a.lastIndex),h))}for(var p,g="",f=0,m=0;m<u.length;m++){for(var y=Ue((d=u[m])[0]),x=ts(es(xe(d.index),o.length),0),b=[],v=1;v<d.length;v++)is(b,void 0===(p=d[v])?p:String(p));var w=d.groups;if(l){var C=ns([y],b,x,o);void 0!==w&&is(C,w);var S=Ue(Dr(r,void 0,C))}else S=Xo(y,o,x,b,w,r);x>=f&&(g+=as(o,f,x)+S,f=x+y.length)}return g+as(o,f)}]}),!!u((function(){var t=/./;return t.exec=function(){var t=[];return t.groups={a:"7"},t},"7"!=="".replace(t,"$<a>")}))||!os||ss);var ls;var cs,hs=S("".replace),us=RegExp("^[\t\n\v\f\r                　\u2028\u2029\ufeff][\t\n\v\f\r                　\u2028\u2029\ufeff]*"),ds=RegExp("[\t\n\v\f\r                　\u2028\u2029\ufeff][\t\n\v\f\r                　\u2028\u2029\ufeff]*$"),ps=function(t){return function(e){var n=Ue(P(e));return 1&t&&(n=hs(n,us,"")),2&t&&(n=hs(n,ds,"")),n}},gs=(ls={start:ps(1),end:ps(2),trim:ps(3)}).end,fs=oe.PROPER,ms=(cs=function(t){return u((function(){return!!"\t\n\v\f\r                　\u2028\u2029\ufeff"[t]()||"​᠎"!=="​᠎"[t]()||fs&&"\t\n\v\f\r                　\u2028\u2029\ufeff"[t].name!==t}))})("trimEnd"),ys=ms?function(){return gs(this)}:"".trimEnd;o({target:"String",proto:!0,name:"trimEnd",forced:ms},{trimEnd:ys,trimRight:ys});var xs=ls.start,bs=cs("trimStart"),vs=bs?function(){return xs(this)}:"".trimStart;o({target:"String",proto:!0,name:"trimStart",forced:bs},{trimStart:vs,trimLeft:vs});var ws,Cs,Ss,Es={};Ss="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView;var Ms,Is,ks,Ts=Lt,Rs=l.Int8Array,Ls=Rs&&Rs.prototype,As=l.Uint8ClampedArray,Ps=As&&As.prototype,Os=Rs&&Zn(Rs),Ds=Ls&&Zn(Ls),Bs=Object.prototype,zs=l.TypeError,js=ot("toStringTag"),Hs=mt("TYPED_ARRAY_TAG"),_s=mt("TYPED_ARRAY_CONSTRUCTOR"),Fs=Ss&&!!ui&&"Opera"!==Ye(l.opera),Us=!1,Ns={Int8Array:1,Uint8Array:1,Uint8ClampedArray:1,Int16Array:2,Uint16Array:2,Int32Array:4,Uint32Array:4,Float32Array:4,Float64Array:8},Ys={BigInt64Array:8,BigUint64Array:8},Xs=function(t){if(!z(t))return!1;var e=Ye(t);return pt(Ns,e)||pt(Ys,e)};for(Ms in Ns)(ks=(Is=l[Ms])&&Is.prototype)?Dt(ks,_s,Is):Fs=!1;for(Ms in Ys)(ks=(Is=l[Ms])&&Is.prototype)&&Dt(ks,_s,Is);if((!Fs||!j(Os)||Os===Function.prototype)&&(Os=function(){throw zs("Incorrect invocation")},Fs))for(Ms in Ns)l[Ms]&&ui(l[Ms],Os);if((!Fs||!Ds||Ds===Bs)&&(Ds=Os.prototype,Fs))for(Ms in Ns)l[Ms]&&ui(l[Ms].prototype,Ds);if(Fs&&Zn(Ps)!==Ds&&ui(Ps,Ds),h&&!pt(Ds,js))for(Ms in Us=!0,Ts(Ds,js,{get:function(){return z(this)?this[Hs]:void 0}}),Ns)l[Ms]&&Dt(l[Ms],Hs,Ms);var Vs=(Cs={NATIVE_ARRAY_BUFFER_VIEWS:Fs,TYPED_ARRAY_CONSTRUCTOR:_s,TYPED_ARRAY_TAG:Us&&Hs,aTypedArray:function(t){if(Xs(t))return t;throw zs("Target is not a typed array")},aTypedArrayConstructor:function(t){if(j(t)&&(!ui||U(Os,t)))return t;throw zs(et(t)+" is not a typed array constructor")},exportTypedArrayMethod:function(t,e,n,i){if(h){if(n)for(var r in Ns){var a=l[r];if(a&&pt(a.prototype,t))try{delete a.prototype[t]}catch(n){try{a.prototype[t]=e}catch(t){}}}Ds[t]&&!n||Ut(Ds,t,n?e:Fs&&Ls[t]||e,i)}},exportTypedArrayStaticMethod:function(t,e,n){var i,r;if(h){if(ui){if(n)for(i in Ns)if((r=l[i])&&pt(r,t))try{delete r[t]}catch(t){}if(Os[t]&&!n)return;try{return Ut(Os,t,n?e:Fs&&Os[t]||e)}catch(t){}}for(i in Ns)!(r=l[i])||r[t]&&!n||Ut(r,t,e)}},isView:function(t){if(!z(t))return!1;var e=Ye(t);return"DataView"===e||pt(Ns,e)||pt(Ys,e)},isTypedArray:Xs,TypedArray:Os,TypedArrayPrototype:Ds}).NATIVE_ARRAY_BUFFER_VIEWS,Ws=l.ArrayBuffer,Ks=l.Int8Array;ws=!Vs||!u((function(){Ks(1)}))||!u((function(){new Ks(-1)}))||!Er((function(t){new Ks,new Ks(null),new Ks(1.5),new Ks(t)}),!0)||u((function(){return 1!==new Ks(new Ws(2),1,void 0).length}));var Gs,qs,Zs=l.RangeError;qs=function(t){if(void 0===t)return 0;var e=xe(t),n=Me(e);if(e!==n)throw Zs("Wrong length or index");return n};var $s,Js=l.Array,Qs=Math.abs,tl=Math.pow,el=Math.floor,nl=Math.log,il=Math.LN2;$s={pack:function(t,e,n){var i,r,a,o=Js(n),s=8*n-e-1,l=(1<<s)-1,c=l>>1,h=23===e?tl(2,-24)-tl(2,-77):0,u=t<0||0===t&&1/t<0?1:0,d=0;for((t=Qs(t))!=t||t===1/0?(r=t!=t?1:0,i=l):(i=el(nl(t)/il),t*(a=tl(2,-i))<1&&(i--,a*=2),(t+=i+c>=1?h/a:h*tl(2,1-c))*a>=2&&(i++,a/=2),i+c>=l?(r=0,i=l):i+c>=1?(r=(t*a-1)*tl(2,e),i+=c):(r=t*tl(2,c-1)*tl(2,e),i=0));e>=8;)o[d++]=255&r,r/=256,e-=8;for(i=i<<e|r,s+=e;s>0;)o[d++]=255&i,i/=256,s-=8;return o[--d]|=128*u,o},unpack:function(t,e){var n,i=t.length,r=8*i-e-1,a=(1<<r)-1,o=a>>1,s=r-7,l=i-1,c=t[l--],h=127&c;for(c>>=7;s>0;)h=256*h+t[l--],s-=8;for(n=h&(1<<-s)-1,h>>=-s,s+=e;s>0;)n=256*n+t[l--],s-=8;if(0===h)h=1-o;else{if(h===a)return n?NaN:c?-1/0:1/0;n+=tl(2,e),h-=o}return(c?-1:1)*n*tl(2,h-e)}};var rl,al=fe,ol=Lt;rl=function(t){for(var e=dt(this),n=Ee(e),i=arguments.length,r=ye(i>1?arguments[1]:void 0,n),a=i>2?arguments[2]:void 0,o=void 0===a?n:ye(a,n);o>r;)e[r++]=t;return e};var sl=oe.PROPER,ll=oe.CONFIGURABLE,cl=Xt.get,hl=Xt.set,ul=l.ArrayBuffer,dl=ul,pl=dl&&dl.prototype,gl=l.DataView,fl=gl&&gl.prototype,ml=Object.prototype,yl=l.Array,xl=l.RangeError,bl=S(rl),vl=S([].reverse),wl=$s.pack,Cl=$s.unpack,Sl=function(t){return[255&t]},El=function(t){return[255&t,t>>8&255]},Ml=function(t){return[255&t,t>>8&255,t>>16&255,t>>24&255]},Il=function(t){return t[3]<<24|t[2]<<16|t[1]<<8|t[0]},kl=function(t){return wl(t,23,4)},Tl=function(t){return wl(t,52,8)},Rl=function(t,e){ol(t.prototype,e,{get:function(){return cl(this)[e]}})},Ll=function(t,e,n,i){var r=qs(n),a=cl(t);if(r+e>a.byteLength)throw xl("Wrong index");var o=cl(a.buffer).bytes,s=r+a.byteOffset,l=Pi(o,s,s+e);return i?l:vl(l)},Al=function(t,e,n,i,r,a){var o=qs(n),s=cl(t);if(o+e>s.byteLength)throw xl("Wrong index");for(var l=cl(s.buffer).bytes,c=o+s.byteOffset,h=i(+r),u=0;u<e;u++)l[c+u]=h[a?u:e-u-1]};if(Ss){var Pl=sl&&"ArrayBuffer"!==ul.name;if(u((function(){ul(1)}))&&u((function(){new ul(-1)}))&&!u((function(){return new ul,new ul(1.5),new ul(NaN),Pl&&!ll})))Pl&&ll&&Dt(ul,"name","ArrayBuffer");else{(dl=function(t){return Cr(this,pl),new ul(qs(t))}).prototype=pl;for(var Ol,Dl=al(ul),Bl=0;Dl.length>Bl;)(Ol=Dl[Bl++])in dl||Dt(dl,Ol,ul[Ol]);pl.constructor=dl}ui&&Zn(fl)!==ml&&ui(fl,ml);var zl=new gl(new dl(2)),jl=S(fl.setInt8);zl.setInt8(0,2147483648),zl.setInt8(1,2147483649),!zl.getInt8(0)&&zl.getInt8(1)||br(fl,{setInt8:function(t,e){jl(this,t,e<<24>>24)},setUint8:function(t,e){jl(this,t,e<<24>>24)}},{unsafe:!0})}else pl=(dl=function(t){Cr(this,pl);var e=qs(t);hl(this,{bytes:bl(yl(e),0),byteLength:e}),h||(this.byteLength=e)}).prototype,fl=(gl=function(t,e,n){Cr(this,fl),Cr(t,pl);var i=cl(t).byteLength,r=xe(e);if(r<0||r>i)throw xl("Wrong offset");if(r+(n=void 0===n?i-r:Me(n))>i)throw xl("Wrong length");hl(this,{buffer:t,byteLength:n,byteOffset:r}),h||(this.buffer=t,this.byteLength=n,this.byteOffset=r)}).prototype,h&&(Rl(dl,"byteLength"),Rl(gl,"buffer"),Rl(gl,"byteLength"),Rl(gl,"byteOffset")),br(fl,{getInt8:function(t){return Ll(this,1,t)[0]<<24>>24},getUint8:function(t){return Ll(this,1,t)[0]},getInt16:function(t){var e=Ll(this,2,t,arguments.length>1?arguments[1]:void 0);return(e[1]<<8|e[0])<<16>>16},getUint16:function(t){var e=Ll(this,2,t,arguments.length>1?arguments[1]:void 0);return e[1]<<8|e[0]},getInt32:function(t){return Il(Ll(this,4,t,arguments.length>1?arguments[1]:void 0))},getUint32:function(t){return Il(Ll(this,4,t,arguments.length>1?arguments[1]:void 0))>>>0},getFloat32:function(t){return Cl(Ll(this,4,t,arguments.length>1?arguments[1]:void 0),23)},getFloat64:function(t){return Cl(Ll(this,8,t,arguments.length>1?arguments[1]:void 0),52)},setInt8:function(t,e){Al(this,1,t,Sl,e)},setUint8:function(t,e){Al(this,1,t,Sl,e)},setInt16:function(t,e){Al(this,2,t,El,e,arguments.length>2?arguments[2]:void 0)},setUint16:function(t,e){Al(this,2,t,El,e,arguments.length>2?arguments[2]:void 0)},setInt32:function(t,e){Al(this,4,t,Ml,e,arguments.length>2?arguments[2]:void 0)},setUint32:function(t,e){Al(this,4,t,Ml,e,arguments.length>2?arguments[2]:void 0)},setFloat32:function(t,e){Al(this,4,t,kl,e,arguments.length>2?arguments[2]:void 0)},setFloat64:function(t,e){Al(this,8,t,Tl,e,arguments.length>2?arguments[2]:void 0)}});ai(dl,"ArrayBuffer"),ai(gl,"DataView"),Gs={ArrayBuffer:dl,DataView:gl};var Hl={},_l=Math.floor;Hl=Number.isInteger||function(t){return!z(t)&&isFinite(t)&&_l(t)===t};var Fl,Ul,Nl=l.RangeError;Ul=function(t){var e=xe(t);if(e<0)throw Nl("The argument can't be less than 0");return e};var Yl=l.RangeError;Fl=function(t,e){var n=Ul(t);if(n%e)throw Yl("Wrong offset");return n};var Xl,Vl=fe,Wl=Cs.aTypedArrayConstructor;Xl=function(t){var e,n,i,r,a,o,s=Lr(this),l=dt(t),c=arguments.length,h=c>1?arguments[1]:void 0,u=void 0!==h,d=cr(l);if(d&&!ar(d))for(o=(a=lr(l,d)).next,l=[];!(r=p(o,a)).done;)l.push(r.value);for(u&&c>2&&(h=pn(h,arguments[2])),n=Ee(l),i=new(Wl(s))(n),e=0;n>e;e++)i[e]=u?h(l[e],e):l[e];return i};var Kl,Gl,ql=S([].push),Zl=function(t){var e=1==t,n=2==t,i=3==t,r=4==t,a=6==t,o=7==t,s=5==t||a;return function(l,c,h,u){for(var d,p,g=dt(l),f=C(g),m=pn(c,h),y=Ee(f),x=0,b=u||yn,v=e?b(l,y):n||o?b(l,0):void 0;y>x;x++)if((s||x in f)&&(p=m(d=f[x],x,g),t))if(e)v[x]=p;else if(p)switch(t){case 3:return!0;case 5:return d;case 6:return x;case 2:ql(v,d)}else switch(t){case 4:return!1;case 7:ql(v,d)}return a?-1:i||r?r:v}},$l=(Kl={forEach:Zl(0),map:Zl(1),filter:Zl(2),some:Zl(3),every:Zl(4),find:Zl(5),findIndex:Zl(6),filterReject:Zl(7)}).forEach;Gl=function(t,e,n){var i,r;return ui&&j(i=e.constructor)&&i!==n&&z(r=i.prototype)&&r!==n.prototype&&ui(t,r),t};var Jl=Xt.get,Ql=Xt.set,tc=Lt,ec=s,nc=Math.round,ic=l.RangeError,rc=Gs.ArrayBuffer,ac=rc.prototype,oc=Gs.DataView,sc=Cs.NATIVE_ARRAY_BUFFER_VIEWS,lc=Cs.TYPED_ARRAY_CONSTRUCTOR,cc=Cs.TYPED_ARRAY_TAG,hc=Cs.TypedArray,uc=Cs.TypedArrayPrototype,dc=Cs.aTypedArrayConstructor,pc=Cs.isTypedArray,gc=function(t,e){dc(t);for(var n=0,i=e.length,r=new t(i);i>n;)r[n]=e[n++];return r},fc=function(t,e){tc(t,e,{get:function(){return Jl(this)[e]}})},mc=function(t){var e;return U(ac,t)||"ArrayBuffer"==(e=Ye(t))||"SharedArrayBuffer"==e},yc=function(t,e){return pc(t)&&!_(e)&&e in t&&Hl(+e)&&e>=0},xc=function(t,e){return e=D(e),yc(t,e)?b(2,t[e]):ec(t,e)},bc=function(t,e,n){return e=D(e),!(yc(t,e)&&z(n)&&pt(n,"value"))||pt(n,"get")||pt(n,"set")||n.configurable||pt(n,"writable")&&!n.writable||pt(n,"enumerable")&&!n.enumerable?tc(t,e,n):(t[e]=n.value,t)};h?(sc||(s=xc,Lt=bc,fc(uc,"buffer"),fc(uc,"byteOffset"),fc(uc,"byteLength"),fc(uc,"length")),o({target:"Object",stat:!0,forced:!sc},{getOwnPropertyDescriptor:xc,defineProperty:bc}),Es=function(t,e,n){var i=t.match(/\d+$/)[0]/8,r=t+(n?"Clamped":"")+"Array",a="get"+t,s="set"+t,c=l[r],h=c,u=h&&h.prototype,d={},g=function(t,e){tc(t,e,{get:function(){return function(t,e){var n=Jl(t);return n.view[a](e*i+n.byteOffset,!0)}(this,e)},set:function(t){return function(t,e,r){var a=Jl(t);n&&(r=(r=nc(r))<0?0:r>255?255:255&r),a.view[s](e*i+a.byteOffset,r,!0)}(this,e,t)},enumerable:!0})};sc?ws&&(h=e((function(t,e,n,r){return Cr(t,u),Gl(z(e)?mc(e)?void 0!==r?new c(e,Fl(n,i),r):void 0!==n?new c(e,Fl(n,i)):new c(e):pc(e)?gc(h,e):p(Xl,h,e):new c(qs(e)),t,h)})),ui&&ui(h,hc),$l(Vl(c),(function(t){t in h||Dt(h,t,c[t])})),h.prototype=u):(h=e((function(t,e,n,r){Cr(t,u);var a,o,s,l=0,c=0;if(z(e)){if(!mc(e))return pc(e)?gc(h,e):p(Xl,h,e);a=e,c=Fl(n,i);var d=e.byteLength;if(void 0===r){if(d%i)throw ic("Wrong length");if((o=d-c)<0)throw ic("Wrong length")}else if((o=Me(r)*i)+c>d)throw ic("Wrong length");s=o/i}else s=qs(e),a=new rc(o=s*i);for(Ql(t,{buffer:a,byteOffset:c,byteLength:o,length:s,view:new oc(a)});l<s;)g(t,l++)})),ui&&ui(h,hc),u=h.prototype=On(uc)),u.constructor!==h&&Dt(u,"constructor",h),Dt(u,lc,h),cc&&Dt(u,cc,r),d[r]=h,o({global:!0,forced:h!=c,sham:!sc},d),"BYTES_PER_ELEMENT"in h||Dt(h,"BYTES_PER_ELEMENT",i),"BYTES_PER_ELEMENT"in u||Dt(u,"BYTES_PER_ELEMENT",i),vr(r)}):Es=function(){},Es("Float32",(function(t){return function(e,n,i){return t(this,e,n,i)}})),Es("Float64",(function(t){return function(e,n,i){return t(this,e,n,i)}})),Es("Int8",(function(t){return function(e,n,i){return t(this,e,n,i)}})),Es("Int16",(function(t){return function(e,n,i){return t(this,e,n,i)}})),Es("Int32",(function(t){return function(e,n,i){return t(this,e,n,i)}})),Es("Uint8",(function(t){return function(e,n,i){return t(this,e,n,i)}})),Es("Uint8",(function(t){return function(e,n,i){return t(this,e,n,i)}}),!0),Es("Uint16",(function(t){return function(e,n,i){return t(this,e,n,i)}})),Es("Uint32",(function(t){return function(e,n,i){return t(this,e,n,i)}})),(0,Cs.exportTypedArrayStaticMethod)("from",Xl,ws);var vc=Cs.aTypedArrayConstructor;(0,Cs.exportTypedArrayStaticMethod)("of",(function(){for(var t=0,e=arguments.length,n=new(vc(this))(e);e>t;)n[t]=arguments[t++];return n}),ws);var wc,Cc=S("".replace),Sc=String(Error("zxcasd").stack),Ec=/\n\s*at [^:]*:[^\n]*/,Mc=Ec.test(Sc);wc=function(t,e){if(Mc&&"string"==typeof t)for(;e--;)t=Cc(t,Ec,"");return t};var Ic;Ic=function(t,e){z(e)&&"cause"in e&&Dt(t,"cause",e.cause)};var kc;kc=function(t,e){return void 0===t?arguments.length<2?"":e:Ue(t)};var Tc;Tc=!u((function(){var t=Error("a");return!("stack"in t)||(Object.defineProperty(t,"stack",b(1,7)),7!==t.stack)}));var Rc=ot("toStringTag"),Lc=l.Error,Ac=[].push,Pc=function(t,e){var n,i=arguments.length>2?arguments[2]:void 0,r=U(Oc,this);ui?n=ui(new Lc,r?Zn(this):Oc):(n=r?this:On(Oc),Dt(n,Rc,"Error")),void 0!==e&&Dt(n,"message",kc(e)),Tc&&Dt(n,"stack",wc(n.stack,1)),Ic(n,i);var a=[];return rr(t,Ac,{that:a}),Dt(n,"errors",a),n};ui?ui(Pc,Lc):ge(Pc,Lc,{name:!0});var Oc=Pc.prototype=On(Lc.prototype,{constructor:b(1,Pc),message:b(1,""),name:b(1,"AggregateError")});o({global:!0},{AggregateError:Pc}),h&&!("lastIndex"in[])&&(Lt(Array.prototype,"lastIndex",{configurable:!0,get:function(){var t=dt(this),e=Ee(t);return 0==e?0:e-1}}),An("lastIndex")),h&&!("lastItem"in[])&&(Lt(Array.prototype,"lastItem",{configurable:!0,get:function(){var t=dt(this),e=Ee(t);return 0==e?void 0:t[e-1]},set:function(t){var e=dt(this),n=Ee(e);return e[0==n?0:n-1]=t}}),An("lastItem"));var Dc,Bc,zc,jc,Hc=Lt,_c=fe,Fc="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];jc=function(t){return Fc&&"Window"==w(t)?function(t){try{return _c(t)}catch(t){return Pi(Fc)}}(t):_c(v(t))};var Uc,Nc={};Uc=u((function(){if("function"==typeof ArrayBuffer){var t=new ArrayBuffer(8);Object.isExtensible(t)&&Object.defineProperty(t,"a",{value:8})}}));var Yc=Object.isExtensible,Xc=u((function(){Yc(1)}));Nc=Xc||Uc?function(t){return!!z(t)&&((!Uc||"ArrayBuffer"!=w(t))&&(!Yc||Yc(t)))}:Yc;var Vc;Vc=!u((function(){return Object.isExtensible(Object.preventExtensions({}))}));var Wc=!1,Kc=mt("meta"),Gc=0,qc=function(t){Hc(t,Kc,{value:{objectID:"O"+Gc++,weakData:{}}})},Zc=zc={enable:function(){Zc.enable=function(){},Wc=!0;var t=fe,e=S([].splice),n={};n[Kc]=1,t(n).length&&(fe=function(n){for(var i=t(n),r=0,a=i.length;r<a;r++)if(i[r]===Kc){e(i,r,1);break}return i},o({target:"Object",stat:!0,forced:!0},{getOwnPropertyNames:jc}))},fastKey:function(t,e){if(!z(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!pt(t,Kc)){if(!Nc(t))return"F";if(!e)return"E";qc(t)}return t[Kc].objectID},getWeakData:function(t,e){if(!pt(t,Kc)){if(!Nc(t))return!0;if(!e)return!1;qc(t)}return t[Kc].weakData},onFreeze:function(t){return Vc&&Wc&&Nc(t)&&!pt(t,Kc)&&qc(t),t}};qt[Kc]=!0,Bc=function(t,e,n){var i=-1!==t.indexOf("Map"),r=-1!==t.indexOf("Weak"),a=i?"set":"add",s=l[t],c=s&&s.prototype,h=s,d={},p=function(t){var e=S(c[t]);Ut(c,t,"add"==t?function(t){return e(this,0===t?0:t),this}:"delete"==t?function(t){return!(r&&!z(t))&&e(this,0===t?0:t)}:"get"==t?function(t){return r&&!z(t)?void 0:e(this,0===t?0:t)}:"has"==t?function(t){return!(r&&!z(t))&&e(this,0===t?0:t)}:function(t,n){return e(this,0===t?0:t,n),this})};if(De(t,!j(s)||!(r||c.forEach&&!u((function(){(new s).entries().next()})))))h=n.getConstructor(e,t,i,a),zc.enable();else if(De(t,!0)){var g=new h,f=g[a](r?{}:-0,1)!=g,m=u((function(){g.has(1)})),y=Er((function(t){new s(t)})),x=!r&&u((function(){for(var t=new s,e=5;e--;)t[a](e,e);return!t.has(-0)}));y||((h=e((function(t,e){Cr(t,c);var n=Gl(new s,t,h);return null!=e&&rr(e,n[a],{that:n,AS_ENTRIES:i}),n}))).prototype=c,c.constructor=h),(m||x)&&(p("delete"),p("has"),i&&p("get")),(x||f)&&p(a),r&&c.clear&&delete c.clear}return d[t]=h,o({global:!0,forced:h!=s},d),ai(h,t),r||n.setStrong(h,t,i),h};var $c=Lt,Jc=zc.fastKey,Qc=Xt.set,th=Xt.getterFor;Bc("Map",(function(t){return function(){return t(this,arguments.length?arguments[0]:void 0)}}),{getConstructor:function(t,e,n,i){var r=t((function(t,r){Cr(t,a),Qc(t,{type:e,index:On(null),first:void 0,last:void 0,size:0}),h||(t.size=0),null!=r&&rr(r,t[i],{that:t,AS_ENTRIES:n})})),a=r.prototype,o=th(e),s=function(t,e,n){var i,r,a=o(t),s=l(t,e);return s?s.value=n:(a.last=s={index:r=Jc(e,!0),key:e,value:n,previous:i=a.last,next:void 0,removed:!1},a.first||(a.first=s),i&&(i.next=s),h?a.size++:t.size++,"F"!==r&&(a.index[r]=s)),t},l=function(t,e){var n,i=o(t),r=Jc(e);if("F"!==r)return i.index[r];for(n=i.first;n;n=n.next)if(n.key==e)return n};return br(a,{clear:function(){for(var t=o(this),e=t.index,n=t.first;n;)n.removed=!0,n.previous&&(n.previous=n.previous.next=void 0),delete e[n.index],n=n.next;t.first=t.last=void 0,h?t.size=0:this.size=0},delete:function(t){var e=this,n=o(e),i=l(e,t);if(i){var r=i.next,a=i.previous;delete n.index[i.index],i.removed=!0,a&&(a.next=r),r&&(r.previous=a),n.first==i&&(n.first=r),n.last==i&&(n.last=a),h?n.size--:e.size--}return!!i},forEach:function(t){for(var e,n=o(this),i=pn(t,arguments.length>1?arguments[1]:void 0);e=e?e.next:n.first;)for(i(e.value,e.key,this);e&&e.removed;)e=e.previous},has:function(t){return!!l(this,t)}}),br(a,n?{get:function(t){var e=l(this,t);return e&&e.value},set:function(t,e){return s(this,0===t?0:t,e)}}:{add:function(t){return s(this,t=0===t?0:t,t)}}),h&&$c(a,"size",{get:function(){return o(this).size}}),r},setStrong:function(t,e,n){var i=e+" Iterator",r=th(e),a=th(i);Vn(t,e,(function(t,e){Qc(this,{type:i,target:t,state:r(t),kind:e,last:void 0})}),(function(){for(var t=a(this),e=t.kind,n=t.last;n&&n.removed;)n=n.previous;return t.target&&(t.last=n=n?n.next:t.state.first)?"keys"==e?{value:n.key,done:!1}:"values"==e?{value:n.value,done:!1}:{value:[n.key,n.value],done:!1}:(t.target=void 0,{value:void 0,done:!0})}),n?"entries":"values",!n,!0),vr(e)}});var eh,nh=zc.getWeakData,ih=Xt.set,rh=Xt.getterFor,ah=Kl.find,oh=Kl.findIndex,sh=S([].splice),lh=0,ch=function(t){return t.frozen||(t.frozen=new hh)},hh=function(){this.entries=[]},uh=function(t,e){return ah(t.entries,(function(t){return t[0]===e}))};hh.prototype={get:function(t){var e=uh(this,t);if(e)return e[1]},has:function(t){return!!uh(this,t)},set:function(t,e){var n=uh(this,t);n?n[1]=e:this.entries.push([t,e])},delete:function(t){var e=oh(this.entries,(function(e){return e[0]===t}));return~e&&sh(this.entries,e,1),!!~e}},eh={getConstructor:function(t,e,n,i){var r=t((function(t,r){Cr(t,a),ih(t,{type:e,id:lh++,frozen:void 0}),null!=r&&rr(r,t[i],{that:t,AS_ENTRIES:n})})),a=r.prototype,o=rh(e),s=function(t,e,n){var i=o(t),r=nh(Bt(e),!0);return!0===r?ch(i).set(e,n):r[i.id]=n,t};return br(a,{delete:function(t){var e=o(this);if(!z(t))return!1;var n=nh(t);return!0===n?ch(e).delete(t):n&&pt(n,e.id)&&delete n[e.id]},has:function(t){var e=o(this);if(!z(t))return!1;var n=nh(t);return!0===n?ch(e).has(t):n&&pt(n,e.id)}}),br(a,n?{get:function(t){var e=o(this);if(z(t)){var n=nh(t);return!0===n?ch(e).get(t):n?n[e.id]:void 0}},set:function(t,e){return s(this,t,e)}}:{add:function(t){return s(this,t,!0)}}),r}};var dh,ph=Xt.enforce,gh=!l.ActiveXObject&&"ActiveXObject"in l,fh=function(t){return function(){return t(this,arguments.length?arguments[0]:void 0)}},mh=Bc("WeakMap",fh,eh);if(Vt&&gh){dh=eh.getConstructor(fh,"WeakMap",!0),zc.enable();var yh=mh.prototype,xh=S(yh.delete),bh=S(yh.has),vh=S(yh.get),wh=S(yh.set);br(yh,{delete:function(t){if(z(t)&&!Nc(t)){var e=ph(this);return e.frozen||(e.frozen=new dh),xh(this,t)||e.frozen.delete(t)}return xh(this,t)},has:function(t){if(z(t)&&!Nc(t)){var e=ph(this);return e.frozen||(e.frozen=new dh),bh(this,t)||e.frozen.has(t)}return bh(this,t)},get:function(t){if(z(t)&&!Nc(t)){var e=ph(this);return e.frozen||(e.frozen=new dh),bh(this,t)?vh(this,t):e.frozen.get(t)}return vh(this,t)},set:function(t,e){if(z(t)&&!Nc(t)){var n=ph(this);n.frozen||(n.frozen=new dh),bh(this,t)?wh(this,t,e):n.frozen.set(t,e)}else wh(this,t,e);return this}})}var Ch=l.Object,Sh=l.TypeError,Eh=H("Map"),Mh=H("WeakMap"),Ih=function(){this.object=null,this.symbol=null,this.primitives=null,this.objectsByIndex=On(null)};Ih.prototype.get=function(t,e){return this[t]||(this[t]=e())},Ih.prototype.next=function(t,e,n){var i=n?this.objectsByIndex[t]||(this.objectsByIndex[t]=new Mh):this.primitives||(this.primitives=new Eh),r=i.get(e);return r||i.set(e,r=new Ih),r};var kh=new Ih;Dc=function(){var t,e,n=kh,i=arguments.length;for(t=0;t<i;t++)z(e=arguments[t])&&(n=n.next(t,e,!0));if(this===Ch&&n===kh)throw Sh("Composite keys must contain a non-primitive component");for(t=0;t<i;t++)z(e=arguments[t])||(n=n.next(t,e,!1));return n};var Th=l.Object,Rh=function(){var t=H("Object","freeze");return t?t(On(null)):On(null)};o({global:!0},{compositeKey:function(){return Dr(Dc,Th,arguments).get("object",Rh)}}),o({global:!0},{compositeSymbol:function(){return 1==arguments.length&&"string"==typeof arguments[0]?H("Symbol").for(arguments[0]):Dr(Dc,null,arguments).get("symbol",H("Symbol"))}}),o({global:!0},{globalThis:l});var Lh;o({target:"Map",proto:!0,real:!0,forced:false},{deleteAll:Lh=function(){for(var t,e=Bt(this),n=tt(e.delete),i=!0,r=0,a=arguments.length;r<a;r++)t=p(n,e,arguments[r]),i=i&&t;return!!i}});var Ah;Ah=function(t){return p(Map.prototype.entries,t)},o({target:"Map",proto:!0,real:!0,forced:false},{every:function(t){var e=Bt(this),n=Ah(e),i=pn(t,arguments.length>1?arguments[1]:void 0);return!rr(n,(function(t,n,r){if(!i(n,t,e))return r()}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}}),o({target:"Map",proto:!0,real:!0,forced:false},{filter:function(t){var e=Bt(this),n=Ah(e),i=pn(t,arguments.length>1?arguments[1]:void 0),r=new(Rr(e,H("Map"))),a=tt(r.set);return rr(n,(function(t,n){i(n,t,e)&&p(a,r,t,n)}),{AS_ENTRIES:!0,IS_ITERATOR:!0}),r}}),o({target:"Map",proto:!0,real:!0,forced:false},{find:function(t){var e=Bt(this),n=Ah(e),i=pn(t,arguments.length>1?arguments[1]:void 0);return rr(n,(function(t,n,r){if(i(n,t,e))return r(n)}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).result}}),o({target:"Map",proto:!0,real:!0,forced:false},{findKey:function(t){var e=Bt(this),n=Ah(e),i=pn(t,arguments.length>1?arguments[1]:void 0);return rr(n,(function(t,n,r){if(i(n,t,e))return r(t)}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).result}});var Ph,Oh=[].push;o({target:"Map",stat:!0},{from:Ph=function(t){var e,n,i,r,a=arguments.length,o=a>1?arguments[1]:void 0;return Lr(this),(e=void 0!==o)&&tt(o),null==t?new this:(n=[],e?(i=0,r=pn(o,a>2?arguments[2]:void 0),rr(t,(function(t){p(Oh,n,r(t,i++))}))):rr(t,Oh,{that:n}),new this(n))}});var Dh=S([].push);o({target:"Map",stat:!0},{groupBy:function(t,e){tt(e);var n=lr(t),i=new this,r=tt(i.has),a=tt(i.get),o=tt(i.set);return rr(n,(function(t){var n=e(t);p(r,i,n)?Dh(p(a,i,n),t):p(o,i,n,[t])}),{IS_ITERATOR:!0}),i}});var Bh;Bh=function(t,e){return t===e||t!=t&&e!=e},o({target:"Map",proto:!0,real:!0,forced:false},{includes:function(t){return rr(Ah(Bt(this)),(function(e,n,i){if(Bh(n,t))return i()}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}}),o({target:"Map",stat:!0},{keyBy:function(t,e){var n=new this;tt(e);var i=tt(n.set);return rr(t,(function(t){p(i,n,e(t),t)})),n}}),o({target:"Map",proto:!0,real:!0,forced:false},{keyOf:function(t){return rr(Ah(Bt(this)),(function(e,n,i){if(n===t)return i(e)}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).result}}),o({target:"Map",proto:!0,real:!0,forced:false},{mapKeys:function(t){var e=Bt(this),n=Ah(e),i=pn(t,arguments.length>1?arguments[1]:void 0),r=new(Rr(e,H("Map"))),a=tt(r.set);return rr(n,(function(t,n){p(a,r,i(n,t,e),n)}),{AS_ENTRIES:!0,IS_ITERATOR:!0}),r}}),o({target:"Map",proto:!0,real:!0,forced:false},{mapValues:function(t){var e=Bt(this),n=Ah(e),i=pn(t,arguments.length>1?arguments[1]:void 0),r=new(Rr(e,H("Map"))),a=tt(r.set);return rr(n,(function(t,n){p(a,r,t,i(n,t,e))}),{AS_ENTRIES:!0,IS_ITERATOR:!0}),r}}),o({target:"Map",proto:!0,real:!0,forced:false},{merge:function(t){for(var e=Bt(this),n=tt(e.set),i=arguments.length,r=0;r<i;)rr(arguments[r++],n,{that:e,AS_ENTRIES:!0});return e}});var zh;o({target:"Map",stat:!0},{of:zh=function(){return new this(Hr(arguments))}});var jh=l.TypeError;o({target:"Map",proto:!0,real:!0,forced:false},{reduce:function(t){var e=Bt(this),n=Ah(e),i=arguments.length<2,r=i?void 0:arguments[1];if(tt(t),rr(n,(function(n,a){i?(i=!1,r=a):r=t(r,a,n,e)}),{AS_ENTRIES:!0,IS_ITERATOR:!0}),i)throw jh("Reduce of empty map with no initial value");return r}}),o({target:"Map",proto:!0,real:!0,forced:false},{some:function(t){var e=Bt(this),n=Ah(e),i=pn(t,arguments.length>1?arguments[1]:void 0);return rr(n,(function(t,n,r){if(i(n,t,e))return r()}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}});var Hh=l.TypeError;o({target:"Map",proto:!0,real:!0,forced:false},{update:function(t,e){var n=Bt(this),i=tt(n.get),r=tt(n.has),a=tt(n.set),o=arguments.length;tt(e);var s=p(r,n,t);if(!s&&o<3)throw Hh("Updating absent value");var l=s?p(i,n,t):tt(o>2?arguments[2]:void 0)(t,n);return p(a,n,t,e(l,t,n)),n}});var _h=Math.min,Fh=Math.max;o({target:"Math",stat:!0},{clamp:function(t,e,n){return _h(n,Fh(e,t))}}),o({target:"Math",stat:!0},{DEG_PER_RAD:Math.PI/180});var Uh=180/Math.PI;o({target:"Math",stat:!0},{degrees:function(t){return t*Uh}});var Nh={};Nh=Math.scale||function(t,e,n,i,r){var a=+t,o=+e,s=+n,l=+i,c=+r;return a!=a||o!=o||s!=s||l!=l||c!=c?NaN:a===1/0||a===-1/0?a:(a-o)*(c-l)/(s-o)+l};var Yh={},Xh={};Xh=Math.sign||function(t){return 0==(t=+t)||t!=t?t:t<0?-1:1};var Vh=Math.abs,Wh=Math.pow,Kh=Wh(2,-52),Gh=Wh(2,-23),qh=Wh(2,127)*(2-Gh),Zh=Wh(2,-126);Yh=Math.fround||function(t){var e,n,i=Vh(t),r=Xh(t);return i<Zh?r*(i/Zh/Gh+1/Kh-1/Kh)*Zh*Gh:(n=(e=(1+Gh/Kh)*i)-(e-i))>qh||n!=n?r*(1/0):r*n},o({target:"Math",stat:!0},{fscale:function(t,e,n,i,r){return Yh(Nh(t,e,n,i,r))}}),o({target:"Math",stat:!0},{iaddh:function(t,e,n,i){var r=t>>>0,a=n>>>0;return(e>>>0)+(i>>>0)+((r&a|(r|a)&~(r+a>>>0))>>>31)|0}}),o({target:"Math",stat:!0},{imulh:function(t,e){var n=65535,i=+t,r=+e,a=i&n,o=r&n,s=i>>16,l=r>>16,c=(s*o>>>0)+(a*o>>>16);return s*l+(c>>16)+((a*l>>>0)+(c&n)>>16)}}),o({target:"Math",stat:!0},{isubh:function(t,e,n,i){var r=t>>>0,a=n>>>0;return(e>>>0)-(i>>>0)-((~r&a|~(r^a)&r-a>>>0)>>>31)|0}}),o({target:"Math",stat:!0},{RAD_PER_DEG:180/Math.PI});var $h=Math.PI/180;o({target:"Math",stat:!0},{radians:function(t){return t*$h}}),o({target:"Math",stat:!0},{scale:Nh});var Jh={},Qh=l.isFinite;Jh=Number.isFinite||function(t){return"number"==typeof t&&Qh(t)};var tu=Xt.set,eu=Xt.getterFor("Seeded Random Generator"),nu=l.TypeError,iu=Wn((function(t){tu(this,{type:"Seeded Random Generator",seed:t%2147483647})}),"Seeded Random",(function(){var t=eu(this);return{value:(1073741823&(t.seed=(1103515245*t.seed+12345)%2147483647))/1073741823,done:!1}}));o({target:"Math",stat:!0,forced:!0},{seededPRNG:function(t){var e=Bt(t).seed;if(!Jh(e))throw nu('Math.seededPRNG() argument should have a "seed" field with a finite value.');return new iu(e)}}),o({target:"Math",stat:!0},{signbit:function(t){return(t=+t)==t&&0==t?1/t==-1/0:t<0}}),o({target:"Math",stat:!0},{umulh:function(t,e){var n=65535,i=+t,r=+e,a=i&n,o=r&n,s=i>>>16,l=r>>>16,c=(s*o>>>0)+(a*o>>>16);return s*l+(c>>>16)+((a*l>>>0)+(c&n)>>>16)}});var ru={},au=ls.trim,ou=l.parseInt,su=l.Symbol,lu=su&&su.iterator,cu=/^[+-]?0x/i,hu=S(cu.exec),uu=8!==ou("\t\n\v\f\r                　\u2028\u2029\ufeff08")||22!==ou("\t\n\v\f\r                　\u2028\u2029\ufeff0x16")||lu&&!u((function(){ou(Object(lu))}));ru=uu?function(t,e){var n=au(Ue(t));return ou(n,e>>>0||(hu(cu,n)?16:10))}:ou;var du=l.RangeError,pu=l.SyntaxError,gu=l.TypeError,fu=/^[\da-z]+$/,mu=S("".charAt),yu=S(fu.exec),xu=S(1..toString),bu=S("".slice);o({target:"Number",stat:!0},{fromString:function(t,e){var n,i,r=1;if("string"!=typeof t)throw gu("Invalid number representation");if(!t.length)throw pu("Invalid number representation");if("-"==mu(t,0)&&(r=-1,!(t=bu(t,1)).length))throw pu("Invalid number representation");if((n=void 0===e?10:xe(e))<2||n>36)throw du("Invalid radix");if(!yu(fu,t)||xu(i=ru(t,n),n)!==t)throw pu("Invalid number representation");return r*i}});var vu=Lt,wu=ot("observable"),Cu=Xt.getterFor,Su=Xt.set,Eu=Cu("Observable"),Mu=Cu("Subscription"),Iu=Cu("SubscriptionObserver"),ku=l.Array,Tu=function(t){this.observer=Bt(t),this.cleanup=void 0,this.subscriptionObserver=void 0};Tu.prototype={type:"Subscription",clean:function(){var t=this.cleanup;if(t){this.cleanup=void 0;try{t()}catch(t){Ia(t)}}},close:function(){if(!h){var t=this.facade,e=this.subscriptionObserver;t.closed=!0,e&&(e.closed=!0)}this.observer=void 0},isClosed:function(){return void 0===this.observer}};var Ru=function(t,e){var n,i=Su(this,new Tu(t));h||(this.closed=!1);try{(n=Q(t,"start"))&&p(n,t,this)}catch(t){Ia(t)}if(!i.isClosed()){var r=i.subscriptionObserver=new Lu(i);try{var a=e(r),o=a;null!=a&&(i.cleanup=j(a.unsubscribe)?function(){o.unsubscribe()}:tt(a))}catch(t){return void r.error(t)}i.isClosed()&&i.clean()}};Ru.prototype=br({},{unsubscribe:function(){var t=Mu(this);t.isClosed()||(t.close(),t.clean())}}),h&&vu(Ru.prototype,"closed",{configurable:!0,get:function(){return Mu(this).isClosed()}});var Lu=function(t){Su(this,{type:"SubscriptionObserver",subscriptionState:t}),h||(this.closed=!1)};Lu.prototype=br({},{next:function(t){var e=Iu(this).subscriptionState;if(!e.isClosed()){var n=e.observer;try{var i=Q(n,"next");i&&p(i,n,t)}catch(t){Ia(t)}}},error:function(t){var e=Iu(this).subscriptionState;if(!e.isClosed()){var n=e.observer;e.close();try{var i=Q(n,"error");i?p(i,n,t):Ia(t)}catch(t){Ia(t)}e.clean()}},complete:function(){var t=Iu(this).subscriptionState;if(!t.isClosed()){var e=t.observer;t.close();try{var n=Q(e,"complete");n&&p(n,e)}catch(t){Ia(t)}t.clean()}}}),h&&vu(Lu.prototype,"closed",{configurable:!0,get:function(){return Iu(this).subscriptionState.isClosed()}});var Au=function(t){Cr(this,Pu),Su(this,{type:"Observable",subscriber:tt(t)})},Pu=Au.prototype;br(Pu,{subscribe:function(t){var e=arguments.length;return new Ru(j(t)?{next:t,error:e>1?arguments[1]:void 0,complete:e>2?arguments[2]:void 0}:z(t)?t:{},Eu(this).subscriber)}}),br(Au,{from:function(t){var e=bn(this)?this:Au,n=Q(Bt(t),wu);if(n){var i=Bt(p(n,t));return i.constructor===e?i:new e((function(t){return i.subscribe(t)}))}var r=lr(t);return new e((function(t){rr(r,(function(e,n){if(t.next(e),t.closed)return n()}),{IS_ITERATOR:!0,INTERRUPTED:!0}),t.complete()}))},of:function(){for(var t=bn(this)?this:Au,e=arguments.length,n=ku(e),i=0;i<e;)n[i]=arguments[i++];return new t((function(t){for(var i=0;i<e;i++)if(t.next(n[i]),t.closed)return;t.complete()}))}}),Ut(Pu,wu,(function(){return this})),o({global:!0},{Observable:Au}),vr("Observable"),o({target:"Promise",stat:!0},{allSettled:function(t){var e=this,n=Ea(e),i=n.resolve,r=n.reject,a=ka((function(){var n=tt(e.resolve),r=[],a=0,o=1;rr(t,(function(t){var s=a++,l=!1;o++,p(n,e,t).then((function(t){l||(l=!0,r[s]={status:"fulfilled",value:t},--o||i(r))}),(function(t){l||(l=!0,r[s]={status:"rejected",reason:t},--o||i(r))}))})),--o||i(r)}));return a.error&&r(a.value),n.promise}});o({target:"Promise",stat:!0},{any:function(t){var e=this,n=H("AggregateError"),i=Ea(e),r=i.resolve,a=i.reject,o=ka((function(){var i=tt(e.resolve),o=[],s=0,l=1,c=!1;rr(t,(function(t){var h=s++,u=!1;l++,p(i,e,t).then((function(t){u||c||(c=!0,r(t))}),(function(t){u||c||(u=!0,o[h]=t,--l||a(new n(o,"No one promise resolved")))}))})),--l||a(new n(o,"No one promise resolved"))}));return o.error&&a(o.value),i.promise}}),o({target:"Promise",stat:!0},{try:function(t){var e=Ea(this),n=ka(t);return(n.error?e.reject:e.resolve)(n.value),e.promise}});var Ou,Du=H("Map"),Bu=H("WeakMap"),zu=S([].push),ju=st("metadata"),Hu=ju.store||(ju.store=new Bu),_u=function(t,e,n){var i=Hu.get(t);if(!i){if(!n)return;Hu.set(t,i=new Du)}var r=i.get(e);if(!r){if(!n)return;i.set(e,r=new Du)}return r},Fu=(Ou={store:Hu,getMap:_u,has:function(t,e,n){var i=_u(e,n,!1);return void 0!==i&&i.has(t)},get:function(t,e,n){var i=_u(e,n,!1);return void 0===i?void 0:i.get(t)},set:function(t,e,n,i){_u(n,i,!0).set(t,e)},keys:function(t,e){var n=_u(t,e,!1),i=[];return n&&n.forEach((function(t,e){zu(i,e)})),i},toKey:function(t){return void 0===t||"symbol"==typeof t?t:String(t)}}).toKey,Uu=Ou.set;o({target:"Reflect",stat:!0},{defineMetadata:function(t,e,n){var i=arguments.length<4?void 0:Fu(arguments[3]);Uu(t,e,Bt(n),i)}});var Nu=Ou.toKey,Yu=Ou.getMap,Xu=Ou.store;o({target:"Reflect",stat:!0},{deleteMetadata:function(t,e){var n=arguments.length<3?void 0:Nu(arguments[2]),i=Yu(Bt(e),n,!1);if(void 0===i||!i.delete(t))return!1;if(i.size)return!0;var r=Xu.get(e);return r.delete(n),!!r.size||Xu.delete(e)}});var Vu=Ou.has,Wu=Ou.get,Ku=Ou.toKey,Gu=function(t,e,n){if(Vu(t,e,n))return Wu(t,e,n);var i=Zn(e);return null!==i?Gu(t,i,n):void 0};o({target:"Reflect",stat:!0},{getMetadata:function(t,e){var n=arguments.length<3?void 0:Ku(arguments[2]);return Gu(t,Bt(e),n)}});var qu=H("Map"),Zu=qu.prototype,$u=S(Zu.forEach),Ju=S(Zu.has),Qu=S(Zu.set),td=S([].push),ed=S((function(t){var e,n,i,r=dt(this),a=Ee(r),o=yn(r,0),s=new qu,l=null!=t?tt(t):function(t){return t};for(e=0;e<a;e++)i=l(n=r[e]),Ju(s,i)||Qu(s,i,n);return $u(s,(function(t){td(o,t)})),o})),nd=S([].concat),id=Ou.keys,rd=Ou.toKey,ad=function(t,e){var n=id(t,e),i=Zn(t);if(null===i)return n;var r=ad(i,e);return r.length?n.length?ed(nd(n,r)):r:n};o({target:"Reflect",stat:!0},{getMetadataKeys:function(t){var e=arguments.length<2?void 0:rd(arguments[1]);return ad(Bt(t),e)}});var od=Ou.get,sd=Ou.toKey;o({target:"Reflect",stat:!0},{getOwnMetadata:function(t,e){var n=arguments.length<3?void 0:sd(arguments[2]);return od(t,Bt(e),n)}});var ld=Ou.keys,cd=Ou.toKey;o({target:"Reflect",stat:!0},{getOwnMetadataKeys:function(t){var e=arguments.length<2?void 0:cd(arguments[1]);return ld(Bt(t),e)}});var hd=Ou.has,ud=Ou.toKey,dd=function(t,e,n){if(hd(t,e,n))return!0;var i=Zn(e);return null!==i&&dd(t,i,n)};o({target:"Reflect",stat:!0},{hasMetadata:function(t,e){var n=arguments.length<3?void 0:ud(arguments[2]);return dd(t,Bt(e),n)}});var pd=Ou.has,gd=Ou.toKey;o({target:"Reflect",stat:!0},{hasOwnMetadata:function(t,e){var n=arguments.length<3?void 0:gd(arguments[2]);return pd(t,Bt(e),n)}});var fd=Ou.toKey,md=Ou.set;o({target:"Reflect",stat:!0},{metadata:function(t,e){return function(n,i){md(t,e,Bt(n),fd(i))}}});var yd;o({target:"Set",proto:!0,real:!0,forced:false},{addAll:yd=function(){for(var t=Bt(this),e=tt(t.add),n=0,i=arguments.length;n<i;n++)p(e,t,arguments[n]);return t}}),o({target:"Set",proto:!0,real:!0,forced:false},{deleteAll:Lh}),o({target:"Set",proto:!0,real:!0,forced:false},{difference:function(t){var e=Bt(this),n=new(Rr(e,H("Set")))(e),i=tt(n.delete);return rr(t,(function(t){p(i,n,t)})),n}});var xd;xd=function(t){return p(Set.prototype.values,t)},o({target:"Set",proto:!0,real:!0,forced:false},{every:function(t){var e=Bt(this),n=xd(e),i=pn(t,arguments.length>1?arguments[1]:void 0);return!rr(n,(function(t,n){if(!i(t,t,e))return n()}),{IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}}),o({target:"Set",proto:!0,real:!0,forced:false},{filter:function(t){var e=Bt(this),n=xd(e),i=pn(t,arguments.length>1?arguments[1]:void 0),r=new(Rr(e,H("Set"))),a=tt(r.add);return rr(n,(function(t){i(t,t,e)&&p(a,r,t)}),{IS_ITERATOR:!0}),r}}),o({target:"Set",proto:!0,real:!0,forced:false},{find:function(t){var e=Bt(this),n=xd(e),i=pn(t,arguments.length>1?arguments[1]:void 0);return rr(n,(function(t,n){if(i(t,t,e))return n(t)}),{IS_ITERATOR:!0,INTERRUPTED:!0}).result}}),o({target:"Set",stat:!0},{from:Ph}),o({target:"Set",proto:!0,real:!0,forced:false},{intersection:function(t){var e=Bt(this),n=new(Rr(e,H("Set"))),i=tt(e.has),r=tt(n.add);return rr(t,(function(t){p(i,e,t)&&p(r,n,t)})),n}}),o({target:"Set",proto:!0,real:!0,forced:false},{isDisjointFrom:function(t){var e=Bt(this),n=tt(e.has);return!rr(t,(function(t,i){if(!0===p(n,e,t))return i()}),{INTERRUPTED:!0}).stopped}}),o({target:"Set",proto:!0,real:!0,forced:false},{isSubsetOf:function(t){var e=lr(this),n=Bt(t),i=n.has;return j(i)||(n=new(H("Set"))(t),i=tt(n.has)),!rr(e,(function(t,e){if(!1===p(i,n,t))return e()}),{IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}}),o({target:"Set",proto:!0,real:!0,forced:false},{isSupersetOf:function(t){var e=Bt(this),n=tt(e.has);return!rr(t,(function(t,i){if(!1===p(n,e,t))return i()}),{INTERRUPTED:!0}).stopped}});var bd=S([].join),vd=[].push;o({target:"Set",proto:!0,real:!0,forced:false},{join:function(t){var e=Bt(this),n=xd(e),i=void 0===t?",":Ue(t),r=[];return rr(n,vd,{that:r,IS_ITERATOR:!0}),bd(r,i)}}),o({target:"Set",proto:!0,real:!0,forced:false},{map:function(t){var e=Bt(this),n=xd(e),i=pn(t,arguments.length>1?arguments[1]:void 0),r=new(Rr(e,H("Set"))),a=tt(r.add);return rr(n,(function(t){p(a,r,i(t,t,e))}),{IS_ITERATOR:!0}),r}}),o({target:"Set",stat:!0},{of:zh});var wd=l.TypeError;o({target:"Set",proto:!0,real:!0,forced:false},{reduce:function(t){var e=Bt(this),n=xd(e),i=arguments.length<2,r=i?void 0:arguments[1];if(tt(t),rr(n,(function(n){i?(i=!1,r=n):r=t(r,n,n,e)}),{IS_ITERATOR:!0}),i)throw wd("Reduce of empty set with no initial value");return r}}),o({target:"Set",proto:!0,real:!0,forced:false},{some:function(t){var e=Bt(this),n=xd(e),i=pn(t,arguments.length>1?arguments[1]:void 0);return rr(n,(function(t,n){if(i(t,t,e))return n()}),{IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}}),o({target:"Set",proto:!0,real:!0,forced:false},{symmetricDifference:function(t){var e=Bt(this),n=new(Rr(e,H("Set")))(e),i=tt(n.delete),r=tt(n.add);return rr(t,(function(t){p(i,n,t)||p(r,n,t)})),n}}),o({target:"Set",proto:!0,real:!0,forced:false},{union:function(t){var e=Bt(this),n=new(Rr(e,H("Set")))(e);return rr(t,tt(n.add),{that:n}),n}});var Cd=Ho.charAt,Sd=u((function(){return"𠮷"!=="𠮷".at(-2)}));o({target:"String",proto:!0,forced:Sd},{at:function(t){var e=Ue(P(this)),n=e.length,i=xe(t),r=i>=0?i:n+i;return r<0||r>=n?void 0:Cd(e,r)}});var Ed=Ho.codeAt,Md=Ho.charAt,Id=Xt.set,kd=Xt.getterFor("String Iterator"),Td=Wn((function(t){Id(this,{type:"String Iterator",string:t,index:0})}),"String",(function(){var t,e=kd(this),n=e.string,i=e.index;return i>=n.length?{value:void 0,done:!0}:(t=Md(n,i),e.index+=t.length,{value:{codePoint:Ed(t,0),position:i},done:!1})}));o({target:"String",proto:!0},{codePoints:function(){return new Td(Ue(P(this)))}});var Rd,Ld=ot("match");Rd=function(t){var e;return z(t)&&(void 0!==(e=t[Ld])?!!e:"RegExp"==w(t))};var Ad=ot("matchAll"),Pd=Xt.set,Od=Xt.getterFor("RegExp String Iterator"),Dd=RegExp.prototype,Bd=l.TypeError,zd=S(po),jd=S("".indexOf),Hd=S("".matchAll),_d=!!Hd&&!u((function(){Hd("a",/./)})),Fd=Wn((function(t,e,n,i){Pd(this,{type:"RegExp String Iterator",regexp:t,string:e,global:n,unicode:i,done:!1})}),"RegExp String",(function(){var t=Od(this);if(t.done)return{value:void 0,done:!0};var e=t.regexp,n=t.string,i=$o(e,n);return null===i?{value:void 0,done:t.done=!0}:t.global?(""===Ue(i[0])&&(e.lastIndex=jo(n,Me(e.lastIndex),t.unicode)),{value:i,done:!1}):(t.done=!0,{value:i,done:!1})})),Ud=function(t){var e,n,i,r,a,o,s=Bt(this),l=Ue(t);return e=Rr(s,RegExp),void 0===(n=s.flags)&&U(Dd,s)&&!("flags"in Dd)&&(n=zd(s)),i=void 0===n?"":Ue(n),r=new e(e===RegExp?s.source:s,i),a=!!~jd(i,"g"),o=!!~jd(i,"u"),r.lastIndex=Me(s.lastIndex),new Fd(r,l,a,o)};o({target:"String",proto:!0,forced:_d},{matchAll:function(t){var e,n,i,r=P(this);if(null!=t){if(Rd(t)&&(e=Ue(P("flags"in Dd?t.flags:zd(t))),!~jd(e,"g")))throw Bd("`.matchAll` does not allow non-global regexes");if(_d)return Hd(r,t);if(i=Q(t,Ad))return p(i,t,r)}else if(_d)return Hd(r,t);return n=Ue(r),new RegExp(t,"g")[Ad](n)}}),Ad in Dd||Ut(Dd,Ad,Ud);var Nd=ot("replace"),Yd=RegExp.prototype,Xd=l.TypeError,Vd=S(po),Wd=S("".indexOf),Kd=(S("".replace),S("".slice)),Gd=Math.max,qd=function(t,e,n){return n>t.length?-1:""===e?n:Wd(t,e,n)};o({target:"String",proto:!0},{replaceAll:function(t,e){var n,i,r,a,o,s,l,c,h=P(this),u=0,d=0,g="";if(null!=t){if(Rd(t)&&(n=Ue(P("flags"in Yd?t.flags:Vd(t))),!~Wd(n,"g")))throw Xd("`.replaceAll` does not allow non-global regexes");if(i=Q(t,Nd))return p(i,t,h,e)}for(r=Ue(h),a=Ue(t),(o=j(e))||(e=Ue(e)),s=a.length,l=Gd(1,s),u=qd(r,a,0);-1!==u;)c=o?Ue(e(a,u,r)):Xo(a,r,u,[],void 0,e),g+=Kd(r,d,u)+c,d=u+s,u=qd(r,a,u+l);return d<r.length&&(g+=Kd(r,d)),g}}),sn("dispose"),sn("observable"),sn("patternMatch"),o({target:"WeakMap",proto:!0,real:!0,forced:false},{deleteAll:Lh}),o({target:"WeakMap",stat:!0},{from:Ph}),o({target:"WeakMap",stat:!0},{of:zh}),o({target:"WeakSet",proto:!0,real:!0,forced:false},{addAll:yd}),o({target:"WeakSet",proto:!0,real:!0,forced:false},{deleteAll:Lh}),o({target:"WeakSet",stat:!0},{from:Ph}),o({target:"WeakSet",stat:!0},{of:zh});var Zd;Zd={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0};var $d,Jd=kt("span").classList,Qd=Jd&&Jd.constructor&&Jd.constructor.prototype;$d=Qd===Object.prototype?void 0:Qd;var tp=ot("iterator"),ep=ot("toStringTag"),np=Ln.values,ip=function(t,e){if(t){if(t[tp]!==np)try{Dt(t,tp,np)}catch(e){t[tp]=np}if(t[ep]||Dt(t,ep,e),Zd[e])for(var n in Ln)if(t[n]!==Ln[n])try{Dt(t,n,Ln[n])}catch(e){t[n]=Ln[n]}}};for(var rp in Zd)ip(l[rp]&&l[rp].prototype,rp);ip($d,"DOMTokenList");var ap=!l.setImmediate||!l.clearImmediate;o({global:!0,bind:!0,enumerable:!0,forced:ap},{setImmediate:Or.set,clearImmediate:Or.clear});var op=l.process;o({global:!0,enumerable:!0,noTargetGet:!0},{queueMicrotask:function(t){var e=Ti&&op.domain;aa(e?e.bind(t):t)}});var sp=Ho.charAt,lp=Xt.set,cp=Xt.getterFor("String Iterator");Vn(String,"String",(function(t){lp(this,{type:"String Iterator",string:Ue(t),index:0})}),(function(){var t,e=cp(this),n=e.string,i=e.index;return i>=n.length?{value:void 0,done:!0}:(t=sp(n,i),e.index+=t.length,{value:t,done:!1})}));var hp,up=ot("iterator");hp=!u((function(){var t=new URL("b?a=1&b=2&c=3","http://a"),e=t.searchParams,n="";return t.pathname="c%20d",e.forEach((function(t,i){e.delete("b"),n+=i+t})),!e.sort||"http://a/c%20d?a=1&c=3"!==t.href||"3"!==e.get("c")||"a=1"!==String(new URLSearchParams("?a=1"))||!e[up]||"a"!==new URL("https://a@b").username||"b"!==new URLSearchParams(new URLSearchParams("a=b")).get("a")||"xn--e1aybc"!==new URL("http://тест").host||"#%D0%B1"!==new URL("http://a#б").hash||"a1c3"!==n||"x"!==new URL("http://x",void 0).host}));var dp=Pn,pp={},gp=Object.assign,fp=Object.defineProperty,mp=S([].concat);pp=!gp||u((function(){if(h&&1!==gp({b:1},gp(fp({},"a",{enumerable:!0,get:function(){fp(this,"b",{value:3,enumerable:!1})}}),{b:2})).b)return!0;var t={},e={},n=Symbol(),i="abcdefghijklmnopqrst";return t[n]=7,i.split("").forEach((function(t){e[t]=t})),7!=gp({},t)[n]||Dn(gp({},e)).join("")!=i}))?function(t,e){for(var n=dt(t),i=arguments.length,r=1,a=Le,o=g;i>r;)for(var s,l=C(arguments[r++]),c=a?mp(Dn(l),a(l)):Dn(l),u=c.length,d=0;u>d;)s=c[d++],h&&!p(o,l,s)||(n[s]=l[s]);return n}:gp;var yp,xp;xp=function(t,e,n,i){try{return i?e(Bt(n)[0],n[1]):e(n)}catch(e){dr(t,"throw",e)}};var bp=l.Array;yp=function(t){var e=dt(t),n=bn(this),i=arguments.length,r=i>1?arguments[1]:void 0,a=void 0!==r;a&&(r=pn(r,i>2?arguments[2]:void 0));var o,s,l,c,h,u,d=cr(e),g=0;if(!d||this==bp&&ar(d))for(o=Ee(e),s=n?new this(o):bp(o);o>g;g++)u=a?r(e[g],g):e[g],Oi(s,g,u);else for(h=(c=lr(e,d)).next,s=n?new this:[];!(l=p(h,c)).done;g++)u=a?xp(c,r,[l.value,g],!0):l.value,Oi(s,g,u);return s.length=g,s};var vp,wp=Ho.codeAt,Cp=/[^\0-\u007E]/,Sp=/[.\u3002\uFF0E\uFF61]/g,Ep=l.RangeError,Mp=S(Sp.exec),Ip=Math.floor,kp=String.fromCharCode,Tp=S("".charCodeAt),Rp=S([].join),Lp=S([].push),Ap=S("".replace),Pp=S("".split),Op=S("".toLowerCase),Dp=function(t){return t+22+75*(t<26)},Bp=function(t,e,n){var i=0;for(t=n?Ip(t/700):t>>1,t+=Ip(t/e);t>455;)t=Ip(t/35),i+=36;return Ip(i+36*t/(t+38))},zp=function(t){var e=[];t=function(t){for(var e=[],n=0,i=t.length;n<i;){var r=Tp(t,n++);if(r>=55296&&r<=56319&&n<i){var a=Tp(t,n++);56320==(64512&a)?Lp(e,((1023&r)<<10)+(1023&a)+65536):(Lp(e,r),n--)}else Lp(e,r)}return e}(t);var n,i,r=t.length,a=128,o=0,s=72;for(n=0;n<t.length;n++)(i=t[n])<128&&Lp(e,kp(i));var l=e.length,c=l;for(l&&Lp(e,"-");c<r;){var h=2147483647;for(n=0;n<t.length;n++)(i=t[n])>=a&&i<h&&(h=i);var u=c+1;if(h-a>Ip((2147483647-o)/u))throw Ep("Overflow: input needs wider integers to process");for(o+=(h-a)*u,a=h,n=0;n<t.length;n++){if((i=t[n])<a&&++o>2147483647)throw Ep("Overflow: input needs wider integers to process");if(i==a){for(var d=o,p=36;;){var g=p<=s?1:p>=s+26?26:p-s;if(d<g)break;var f=d-g,m=36-g;Lp(e,kp(Dp(g+f%m))),d=Ip(f/m),p+=36}Lp(e,kp(Dp(d))),s=Bp(o,u,c==l),o=0,c++}}o++,a++}return Rp(e,"")};vp=function(t){var e,n,i=[],r=Pp(Ap(Op(t),Sp,"."),".");for(e=0;e<r.length;e++)n=r[e],Lp(i,Mp(Cp,n)?"xn--"+zp(n):n);return Rp(i,".")};var jp,Hp,_p=l.TypeError;Hp=function(t,e){if(t<e)throw _p("Not enough arguments");return t};var Fp=ot("iterator"),Up=Xt.set,Np=Xt.getterFor("URLSearchParams"),Yp=Xt.getterFor("URLSearchParamsIterator"),Xp=H("fetch"),Vp=H("Request"),Wp=H("Headers"),Kp=Vp&&Vp.prototype,Gp=Wp&&Wp.prototype,qp=l.RegExp,Zp=l.TypeError,$p=l.decodeURIComponent,Jp=l.encodeURIComponent,Qp=S("".charAt),tg=S([].join),eg=S([].push),ng=S("".replace),ig=S([].shift),rg=S([].splice),ag=S("".split),og=S("".slice),sg=/\+/g,lg=Array(4),cg=function(t){return lg[t-1]||(lg[t-1]=qp("((?:%[\\da-f]{2}){"+t+"})","gi"))},hg=function(t){try{return $p(t)}catch(e){return t}},ug=function(t){var e=ng(t,sg," "),n=4;try{return $p(e)}catch(t){for(;n;)e=ng(e,cg(n--),hg);return e}},dg=/[!'()~]|%20/g,pg={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},gg=function(t){return pg[t]},fg=function(t){return ng(Jp(t),dg,gg)},mg=Wn((function(t,e){Up(this,{type:"URLSearchParamsIterator",iterator:lr(Np(t).entries),kind:e})}),"Iterator",(function(){var t=Yp(this),e=t.kind,n=t.iterator.next(),i=n.value;return n.done||(n.value="keys"===e?i.key:"values"===e?i.value:[i.key,i.value]),n}),!0),yg=function(t){this.entries=[],this.url=null,void 0!==t&&(z(t)?this.parseObject(t):this.parseQuery("string"==typeof t?"?"===Qp(t,0)?og(t,1):t:Ue(t)))};yg.prototype={type:"URLSearchParams",bindURL:function(t){this.url=t,this.update()},parseObject:function(t){var e,n,i,r,a,o,s,l=cr(t);if(l)for(n=(e=lr(t,l)).next;!(i=p(n,e)).done;){if(a=(r=lr(Bt(i.value))).next,(o=p(a,r)).done||(s=p(a,r)).done||!p(a,r).done)throw Zp("Expected sequence with length 2");eg(this.entries,{key:Ue(o.value),value:Ue(s.value)})}else for(var c in t)pt(t,c)&&eg(this.entries,{key:c,value:Ue(t[c])})},parseQuery:function(t){if(t)for(var e,n,i=ag(t,"&"),r=0;r<i.length;)(e=i[r++]).length&&(n=ag(e,"="),eg(this.entries,{key:ug(ig(n)),value:ug(tg(n,"="))}))},serialize:function(){for(var t,e=this.entries,n=[],i=0;i<e.length;)t=e[i++],eg(n,fg(t.key)+"="+fg(t.value));return tg(n,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var xg=function(){Cr(this,bg);var t=arguments.length>0?arguments[0]:void 0;Up(this,new yg(t))},bg=xg.prototype;if(br(bg,{append:function(t,e){Hp(arguments.length,2);var n=Np(this);eg(n.entries,{key:Ue(t),value:Ue(e)}),n.updateURL()},delete:function(t){Hp(arguments.length,1);for(var e=Np(this),n=e.entries,i=Ue(t),r=0;r<n.length;)n[r].key===i?rg(n,r,1):r++;e.updateURL()},get:function(t){Hp(arguments.length,1);for(var e=Np(this).entries,n=Ue(t),i=0;i<e.length;i++)if(e[i].key===n)return e[i].value;return null},getAll:function(t){Hp(arguments.length,1);for(var e=Np(this).entries,n=Ue(t),i=[],r=0;r<e.length;r++)e[r].key===n&&eg(i,e[r].value);return i},has:function(t){Hp(arguments.length,1);for(var e=Np(this).entries,n=Ue(t),i=0;i<e.length;)if(e[i++].key===n)return!0;return!1},set:function(t,e){Hp(arguments.length,1);for(var n,i=Np(this),r=i.entries,a=!1,o=Ue(t),s=Ue(e),l=0;l<r.length;l++)(n=r[l]).key===o&&(a?rg(r,l--,1):(a=!0,n.value=s));a||eg(r,{key:o,value:s}),i.updateURL()},sort:function(){var t=Np(this);Di(t.entries,(function(t,e){return t.key>e.key?1:-1})),t.updateURL()},forEach:function(t){for(var e,n=Np(this).entries,i=pn(t,arguments.length>1?arguments[1]:void 0),r=0;r<n.length;)i((e=n[r++]).value,e.key,this)},keys:function(){return new mg(this,"keys")},values:function(){return new mg(this,"values")},entries:function(){return new mg(this,"entries")}},{enumerable:!0}),Ut(bg,Fp,bg.entries,{name:"entries"}),Ut(bg,"toString",(function(){return Np(this).serialize()}),{enumerable:!0}),ai(xg,"URLSearchParams"),o({global:!0,forced:!hp},{URLSearchParams:xg}),!hp&&j(Wp)){var vg=S(Gp.has),wg=S(Gp.set),Cg=function(t){if(z(t)){var e,n=t.body;if("URLSearchParams"===Ye(n))return e=t.headers?new Wp(t.headers):new Wp,vg(e,"content-type")||wg(e,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),On(t,{body:b(0,Ue(n)),headers:b(0,e)})}return t};if(j(Xp)&&o({global:!0,enumerable:!0,forced:!0},{fetch:function(t){return Xp(t,arguments.length>1?Cg(arguments[1]):{})}}),j(Vp)){var Sg=function(t){return Cr(this,Kp),new Vp(t,arguments.length>1?Cg(arguments[1]):{})};Kp.constructor=Sg,Sg.prototype=Kp,o({global:!0,forced:!0},{Request:Sg})}}jp={URLSearchParams:xg,getState:Np};var Eg=Xt.set,Mg=Xt.getterFor("URL"),Ig=jp.URLSearchParams,kg=jp.getState,Tg=l.URL,Rg=l.TypeError,Lg=l.parseInt,Ag=Math.floor,Pg=Math.pow,Og=S("".charAt),Dg=S(/./.exec),Bg=S([].join),zg=S(1..toString),jg=S([].pop),Hg=S([].push),_g=S("".replace),Fg=S([].shift),Ug=S("".split),Ng=S("".slice),Yg=S("".toLowerCase),Xg=S([].unshift),Vg=/[a-z]/i,Wg=/[\d+-.a-z]/i,Kg=/\d/,Gg=/^0x/i,qg=/^[0-7]+$/,Zg=/^\d+$/,$g=/^[\da-f]+$/i,Jg=/[\0\t\n\r #%/:<>?@[\\\]^|]/,Qg=/[\0\t\n\r #/:<>?@[\\\]^|]/,tf=/^[\u0000-\u0020]+|[\u0000-\u0020]+$/g,ef=/[\t\n\r]/g,nf=function(t){var e,n,i,r;if("number"==typeof t){for(e=[],n=0;n<4;n++)Xg(e,t%256),t=Ag(t/256);return Bg(e,".")}if("object"==typeof t){for(e="",i=function(t){for(var e=null,n=1,i=null,r=0,a=0;a<8;a++)0!==t[a]?(r>n&&(e=i,n=r),i=null,r=0):(null===i&&(i=a),++r);return r>n&&(e=i,n=r),e}(t),n=0;n<8;n++)r&&0===t[n]||(r&&(r=!1),i===n?(e+=n?":":"::",r=!0):(e+=zg(t[n],16),n<7&&(e+=":")));return"["+e+"]"}return t},rf={},af=pp({},rf,{" ":1,'"':1,"<":1,">":1,"`":1}),of=pp({},af,{"#":1,"?":1,"{":1,"}":1}),sf=pp({},of,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),lf=function(t,e){var n=wp(t,0);return n>32&&n<127&&!pt(e,t)?t:encodeURIComponent(t)},cf={ftp:21,file:null,http:80,https:443,ws:80,wss:443},hf=function(t,e){var n;return 2==t.length&&Dg(Vg,Og(t,0))&&(":"==(n=Og(t,1))||!e&&"|"==n)},uf=function(t){var e;return t.length>1&&hf(Ng(t,0,2))&&(2==t.length||"/"===(e=Og(t,2))||"\\"===e||"?"===e||"#"===e)},df=function(t){return"."===t||"%2e"===Yg(t)},pf={},gf={},ff={},mf={},yf={},xf={},bf={},vf={},wf={},Cf={},Sf={},Ef={},Mf={},If={},kf={},Tf={},Rf={},Lf={},Af={},Pf={},Of={},Df=function(t,e,n){var i,r,a,o=Ue(t);if(e){if(r=this.parse(o))throw Rg(r);this.searchParams=null}else{if(void 0!==n&&(i=new Df(n,!0)),r=this.parse(o,null,i))throw Rg(r);(a=kg(new Ig)).bindURL(this),this.searchParams=a}};Df.prototype={type:"URL",parse:function(t,e,n){var i,r,a,o,s,l=this,c=e||pf,h=0,u="",d=!1,p=!1,g=!1;for(t=Ue(t),e||(l.scheme="",l.username="",l.password="",l.host=null,l.port=null,l.path=[],l.query=null,l.fragment=null,l.cannotBeABaseURL=!1,t=_g(t,tf,"")),t=_g(t,ef,""),i=yp(t);h<=i.length;){switch(r=i[h],c){case pf:if(!r||!Dg(Vg,r)){if(e)return"Invalid scheme";c=ff;continue}u+=Yg(r),c=gf;break;case gf:if(r&&(Dg(Wg,r)||"+"==r||"-"==r||"."==r))u+=Yg(r);else{if(":"!=r){if(e)return"Invalid scheme";u="",c=ff,h=0;continue}if(e&&(l.isSpecial()!=pt(cf,u)||"file"==u&&(l.includesCredentials()||null!==l.port)||"file"==l.scheme&&!l.host))return;if(l.scheme=u,e)return void(l.isSpecial()&&cf[l.scheme]==l.port&&(l.port=null));u="","file"==l.scheme?c=If:l.isSpecial()&&n&&n.scheme==l.scheme?c=mf:l.isSpecial()?c=vf:"/"==i[h+1]?(c=yf,h++):(l.cannotBeABaseURL=!0,Hg(l.path,""),c=Af)}break;case ff:if(!n||n.cannotBeABaseURL&&"#"!=r)return"Invalid scheme";if(n.cannotBeABaseURL&&"#"==r){l.scheme=n.scheme,l.path=Pi(n.path),l.query=n.query,l.fragment="",l.cannotBeABaseURL=!0,c=Of;break}c="file"==n.scheme?If:xf;continue;case mf:if("/"!=r||"/"!=i[h+1]){c=xf;continue}c=wf,h++;break;case yf:if("/"==r){c=Cf;break}c=Lf;continue;case xf:if(l.scheme=n.scheme,null==r)l.username=n.username,l.password=n.password,l.host=n.host,l.port=n.port,l.path=Pi(n.path),l.query=n.query;else if("/"==r||"\\"==r&&l.isSpecial())c=bf;else if("?"==r)l.username=n.username,l.password=n.password,l.host=n.host,l.port=n.port,l.path=Pi(n.path),l.query="",c=Pf;else{if("#"!=r){l.username=n.username,l.password=n.password,l.host=n.host,l.port=n.port,l.path=Pi(n.path),l.path.length--,c=Lf;continue}l.username=n.username,l.password=n.password,l.host=n.host,l.port=n.port,l.path=Pi(n.path),l.query=n.query,l.fragment="",c=Of}break;case bf:if(!l.isSpecial()||"/"!=r&&"\\"!=r){if("/"!=r){l.username=n.username,l.password=n.password,l.host=n.host,l.port=n.port,c=Lf;continue}c=Cf}else c=wf;break;case vf:if(c=wf,"/"!=r||"/"!=Og(u,h+1))continue;h++;break;case wf:if("/"!=r&&"\\"!=r){c=Cf;continue}break;case Cf:if("@"==r){d&&(u="%40"+u),d=!0,a=yp(u);for(var f=0;f<a.length;f++){var m=a[f];if(":"!=m||g){var y=lf(m,sf);g?l.password+=y:l.username+=y}else g=!0}u=""}else if(null==r||"/"==r||"?"==r||"#"==r||"\\"==r&&l.isSpecial()){if(d&&""==u)return"Invalid authority";h-=yp(u).length+1,u="",c=Sf}else u+=r;break;case Sf:case Ef:if(e&&"file"==l.scheme){c=Tf;continue}if(":"!=r||p){if(null==r||"/"==r||"?"==r||"#"==r||"\\"==r&&l.isSpecial()){if(l.isSpecial()&&""==u)return"Invalid host";if(e&&""==u&&(l.includesCredentials()||null!==l.port))return;if(o=l.parseHost(u))return o;if(u="",c=Rf,e)return;continue}"["==r?p=!0:"]"==r&&(p=!1),u+=r}else{if(""==u)return"Invalid host";if(o=l.parseHost(u))return o;if(u="",c=Mf,e==Ef)return}break;case Mf:if(!Dg(Kg,r)){if(null==r||"/"==r||"?"==r||"#"==r||"\\"==r&&l.isSpecial()||e){if(""!=u){var x=Lg(u,10);if(x>65535)return"Invalid port";l.port=l.isSpecial()&&x===cf[l.scheme]?null:x,u=""}if(e)return;c=Rf;continue}return"Invalid port"}u+=r;break;case If:if(l.scheme="file","/"==r||"\\"==r)c=kf;else{if(!n||"file"!=n.scheme){c=Lf;continue}if(null==r)l.host=n.host,l.path=Pi(n.path),l.query=n.query;else if("?"==r)l.host=n.host,l.path=Pi(n.path),l.query="",c=Pf;else{if("#"!=r){uf(Bg(Pi(i,h),""))||(l.host=n.host,l.path=Pi(n.path),l.shortenPath()),c=Lf;continue}l.host=n.host,l.path=Pi(n.path),l.query=n.query,l.fragment="",c=Of}}break;case kf:if("/"==r||"\\"==r){c=Tf;break}n&&"file"==n.scheme&&!uf(Bg(Pi(i,h),""))&&(hf(n.path[0],!0)?Hg(l.path,n.path[0]):l.host=n.host),c=Lf;continue;case Tf:if(null==r||"/"==r||"\\"==r||"?"==r||"#"==r){if(!e&&hf(u))c=Lf;else if(""==u){if(l.host="",e)return;c=Rf}else{if(o=l.parseHost(u))return o;if("localhost"==l.host&&(l.host=""),e)return;u="",c=Rf}continue}u+=r;break;case Rf:if(l.isSpecial()){if(c=Lf,"/"!=r&&"\\"!=r)continue}else if(e||"?"!=r)if(e||"#"!=r){if(null!=r&&(c=Lf,"/"!=r))continue}else l.fragment="",c=Of;else l.query="",c=Pf;break;case Lf:if(null==r||"/"==r||"\\"==r&&l.isSpecial()||!e&&("?"==r||"#"==r)){if(".."===(s=Yg(s=u))||"%2e."===s||".%2e"===s||"%2e%2e"===s?(l.shortenPath(),"/"==r||"\\"==r&&l.isSpecial()||Hg(l.path,"")):df(u)?"/"==r||"\\"==r&&l.isSpecial()||Hg(l.path,""):("file"==l.scheme&&!l.path.length&&hf(u)&&(l.host&&(l.host=""),u=Og(u,0)+":"),Hg(l.path,u)),u="","file"==l.scheme&&(null==r||"?"==r||"#"==r))for(;l.path.length>1&&""===l.path[0];)Fg(l.path);"?"==r?(l.query="",c=Pf):"#"==r&&(l.fragment="",c=Of)}else u+=lf(r,of);break;case Af:"?"==r?(l.query="",c=Pf):"#"==r?(l.fragment="",c=Of):null!=r&&(l.path[0]+=lf(r,rf));break;case Pf:e||"#"!=r?null!=r&&("'"==r&&l.isSpecial()?l.query+="%27":l.query+="#"==r?"%23":lf(r,rf)):(l.fragment="",c=Of);break;case Of:null!=r&&(l.fragment+=lf(r,af))}h++}},parseHost:function(t){var e,n,i;if("["==Og(t,0)){if("]"!=Og(t,t.length-1))return"Invalid host";if(e=function(t){var e,n,i,r,a,o,s,l=[0,0,0,0,0,0,0,0],c=0,h=null,u=0,d=function(){return Og(t,u)};if(":"==d()){if(":"!=Og(t,1))return;u+=2,h=++c}for(;d();){if(8==c)return;if(":"!=d()){for(e=n=0;n<4&&Dg($g,d());)e=16*e+Lg(d(),16),u++,n++;if("."==d()){if(0==n)return;if(u-=n,c>6)return;for(i=0;d();){if(r=null,i>0){if(!("."==d()&&i<4))return;u++}if(!Dg(Kg,d()))return;for(;Dg(Kg,d());){if(a=Lg(d(),10),null===r)r=a;else{if(0==r)return;r=10*r+a}if(r>255)return;u++}l[c]=256*l[c]+r,2!=++i&&4!=i||c++}if(4!=i)return;break}if(":"==d()){if(u++,!d())return}else if(d())return;l[c++]=e}else{if(null!==h)return;u++,h=++c}}if(null!==h)for(o=c-h,c=7;0!=c&&o>0;)s=l[c],l[c--]=l[h+o-1],l[h+--o]=s;else if(8!=c)return;return l}(Ng(t,1,-1)),!e)return"Invalid host";this.host=e}else if(this.isSpecial()){if(t=vp(t),Dg(Jg,t))return"Invalid host";if(e=function(t){var e,n,i,r,a,o,s,l=Ug(t,".");if(l.length&&""==l[l.length-1]&&l.length--,(e=l.length)>4)return t;for(n=[],i=0;i<e;i++){if(""==(r=l[i]))return t;if(a=10,r.length>1&&"0"==Og(r,0)&&(a=Dg(Gg,r)?16:8,r=Ng(r,8==a?1:2)),""===r)o=0;else{if(!Dg(10==a?Zg:8==a?qg:$g,r))return t;o=Lg(r,a)}Hg(n,o)}for(i=0;i<e;i++)if(o=n[i],i==e-1){if(o>=Pg(256,5-e))return null}else if(o>255)return null;for(s=jg(n),i=0;i<n.length;i++)s+=n[i]*Pg(256,3-i);return s}(t),null===e)return"Invalid host";this.host=e}else{if(Dg(Qg,t))return"Invalid host";for(e="",n=yp(t),i=0;i<n.length;i++)e+=lf(n[i],rf);this.host=e}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||"file"==this.scheme},includesCredentials:function(){return""!=this.username||""!=this.password},isSpecial:function(){return pt(cf,this.scheme)},shortenPath:function(){var t=this.path,e=t.length;!e||"file"==this.scheme&&1==e&&hf(t[0],!0)||t.length--},serialize:function(){var t=this,e=t.scheme,n=t.username,i=t.password,r=t.host,a=t.port,o=t.path,s=t.query,l=t.fragment,c=e+":";return null!==r?(c+="//",t.includesCredentials()&&(c+=n+(i?":"+i:"")+"@"),c+=nf(r),null!==a&&(c+=":"+a)):"file"==e&&(c+="//"),c+=t.cannotBeABaseURL?o[0]:o.length?"/"+Bg(o,"/"):"",null!==s&&(c+="?"+s),null!==l&&(c+="#"+l),c},setHref:function(t){var e=this.parse(t);if(e)throw Rg(e);this.searchParams.update()},getOrigin:function(){var t=this.scheme,e=this.port;if("blob"==t)try{return new Bf(t.path[0]).origin}catch(t){return"null"}return"file"!=t&&this.isSpecial()?t+"://"+nf(this.host)+(null!==e?":"+e:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(t){this.parse(Ue(t)+":",pf)},getUsername:function(){return this.username},setUsername:function(t){var e=yp(Ue(t));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var n=0;n<e.length;n++)this.username+=lf(e[n],sf)}},getPassword:function(){return this.password},setPassword:function(t){var e=yp(Ue(t));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var n=0;n<e.length;n++)this.password+=lf(e[n],sf)}},getHost:function(){var t=this.host,e=this.port;return null===t?"":null===e?nf(t):nf(t)+":"+e},setHost:function(t){this.cannotBeABaseURL||this.parse(t,Sf)},getHostname:function(){var t=this.host;return null===t?"":nf(t)},setHostname:function(t){this.cannotBeABaseURL||this.parse(t,Ef)},getPort:function(){var t=this.port;return null===t?"":Ue(t)},setPort:function(t){this.cannotHaveUsernamePasswordPort()||(""==(t=Ue(t))?this.port=null:this.parse(t,Mf))},getPathname:function(){var t=this.path;return this.cannotBeABaseURL?t[0]:t.length?"/"+Bg(t,"/"):""},setPathname:function(t){this.cannotBeABaseURL||(this.path=[],this.parse(t,Rf))},getSearch:function(){var t=this.query;return t?"?"+t:""},setSearch:function(t){""==(t=Ue(t))?this.query=null:("?"==Og(t,0)&&(t=Ng(t,1)),this.query="",this.parse(t,Pf)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var t=this.fragment;return t?"#"+t:""},setHash:function(t){""!=(t=Ue(t))?("#"==Og(t,0)&&(t=Ng(t,1)),this.fragment="",this.parse(t,Of)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var Bf=function(t){var e=Cr(this,zf),n=arguments.length>1?arguments[1]:void 0,i=Eg(e,new Df(t,!1,n));h||(e.href=i.serialize(),e.origin=i.getOrigin(),e.protocol=i.getProtocol(),e.username=i.getUsername(),e.password=i.getPassword(),e.host=i.getHost(),e.hostname=i.getHostname(),e.port=i.getPort(),e.pathname=i.getPathname(),e.search=i.getSearch(),e.searchParams=i.getSearchParams(),e.hash=i.getHash())},zf=Bf.prototype,jf=function(t,e){return{get:function(){return Mg(this)[t]()},set:e&&function(t){return Mg(this)[e](t)},configurable:!0,enumerable:!0}};if(h&&dp(zf,{href:jf("serialize","setHref"),origin:jf("getOrigin"),protocol:jf("getProtocol","setProtocol"),username:jf("getUsername","setUsername"),password:jf("getPassword","setPassword"),host:jf("getHost","setHost"),hostname:jf("getHostname","setHostname"),port:jf("getPort","setPort"),pathname:jf("getPathname","setPathname"),search:jf("getSearch","setSearch"),searchParams:jf("getSearchParams"),hash:jf("getHash","setHash")}),Ut(zf,"toJSON",(function(){return Mg(this).serialize()}),{enumerable:!0}),Ut(zf,"toString",(function(){return Mg(this).serialize()}),{enumerable:!0}),Tg){var Hf=Tg.createObjectURL,_f=Tg.revokeObjectURL;Hf&&Ut(Bf,"createObjectURL",pn(Hf,Tg)),_f&&Ut(Bf,"revokeObjectURL",pn(_f,Tg))}if(ai(Bf,"URL"),o({global:!0,forced:!hp,sham:!h},{URL:Bf}),o({target:"URL",proto:!0,enumerable:!0},{toJSON:function(){return p(URL.prototype.toString,this)}}),function(){function t(){var t=Array.prototype.slice.call(arguments),e=document.createDocumentFragment();t.forEach((function(t){var n=t instanceof Node;e.appendChild(n?t:document.createTextNode(String(t)))})),this.appendChild(e)}[Element.prototype,Document.prototype,DocumentFragment.prototype].forEach((function(e){e.hasOwnProperty("append")||Object.defineProperty(e,"append",{configurable:!0,enumerable:!0,writable:!0,value:t})}))}(),"scrollTo"in Element.prototype||Object.defineProperty(Element.prototype,"scrollTo",{value:function(t,e){this.scrollLeft=t,this.scrollTop=e}}),"scrollBy"in Element.prototype||Object.defineProperty(Element.prototype,"scrollBy",{value:function(t,e){this.scrollLeft+=t,this.scrollTop+=e}}),!("localStorage"in window))try{window.localStorage={getItem:()=>null,setItem:()=>{},removeItem:()=>{}}}catch(t){}function Ff(t,e){const n=document.createElement("canvas");return t&&e&&(n.width=t,n.height=e),n}const Uf=navigator.userAgent.toLowerCase().indexOf("firefox")>-1,Nf=function(){let t=null;return document.body?function(){const e=new Event("");t=e.timeStamp<36e5}():window.addEventListener("DOMContentLoaded",(function(e){t=e.timeStamp<36e5})),function(){if(null===t)throw"eventUsesHighResTimeStamp not initialized";return t}}(),Yf=(()=>{if(!("MouseEvent"in window))return!1;let t;try{t=new MouseEvent("mousemove")}catch(t){return!1}return"movementX"in t&&!Uf})(),Xf=!!window.PointerEvent,Vf=function(){const t=function(){const t=Ff();try{return t.getContext("experimental-webgl",{premultipliedAlpha:!1}),!0}catch(t){return!1}}();return function(){return t}}(),Wf=function(){const t={chrome:!1,gl:!1};return window.chrome&&window.chrome.app&&(t.chrome=!0),t.gl=Vf(),function(){return JSON.parse(JSON.stringify(t))}}(),Kf=function(){let t=null;function e(){const e=document.createElement("div");e.style.position="absolute",e.style.top="0",e.style.left="max(0px, 25px)",document.body.appendChild(e),setTimeout((function(){t=25===e.offsetLeft,document.body.removeChild(e)}),25)}return document.body?e():window.addEventListener("DOMContentLoaded",(function(){e()})),function(){if(null===t)throw new Error("isCssMinMaxSupported not initialized");return t}}(),Gf={},qf=function(t,e,n,i){Xf||(e=e.replace("pointer","mouse")),e in Gf||(Gf[e]=[]),Gf[e].push(n),t.addEventListener(e,n,i)},Zf=function(t,e,n,i){if(Xf||(e=e.replace("pointer","mouse")),e in Gf)for(let t=0;t<Gf[e].length;t++)Gf[e][t]===n&&(Gf[e].splice(t,1),t--);t.removeEventListener(e,n,i)};function $f(t,e){const n=Object.keys(e);let i;const r=t.style;for(let t=0;t<n.length;t++)i=n[t],r[i]=e[i],r.alignContent="true","userSelect"===i&&(r.webkitUserSelect=e[i])}function Jf(t,e){return e?Jf(e,t%e):t}function Qf(t,e){const n=Jf(t,e);return[t/n,e/n]}const tm=(()=>{const t={space:[" ","Spacebar"],alt:["Alt","AltGraph"],shift:"Shift",ctrl:"Control",cmd:["Meta","MetaLeft","MetaRight"],enter:"Enter",esc:"Escape",backspace:"Backspace",delete:"Delete",sqbr_open:"[",sqbr_close:"]",a:["a","A"],b:["b","B"],c:["c","C"],e:["e","E"],f:["f","F"],g:["g","G"],r:["r","R"],s:["s","S"],t:["t","T"],u:["u","U"],x:["x","X"],y:["y","Y"],z:["z","Z"],plus:"+",minus:"-",left:"ArrowLeft",right:"ArrowRight",up:"ArrowUp",down:"ArrowDown",home:"Home",end:"End"},e=Object.keys(t),n={},i={};let r=[],a={};const o=[];for(let r=0;r<e.length;r++){n[e[r]]=!1;const a=t[e[r]];if("string"==typeof a)i[t[e[r]]]=e[r];else for(let t=0;t<a.length;t++)i[a[t]]=e[r]}function s(t,e,n,i){o.forEach((r=>{r[0]&&r[0](t,e,n,i)}))}function l(t,e,n){o.forEach((i=>{i[1]&&i[1](t,e,n)}))}function c(t){const e=t.key,o="code"in t?t.code:t.keyCode;if(console.log(o),e in i){const l=i[e];if(n[l])return void s(l,t,r.join("+"),!0);n[l]=!0,a[o]=l,r.push(l),s(l,t,r.join("+"))}}function h(t){t.key;const e="code"in t?t.code:t.keyCode,i=r.join("+");if(["Meta","MetaLeft","MetaRight","OSLeft","OSRight"].includes(e))u(null);else if(e in a&&null!==a[e]){const o=a[e];n[o]=!1,a[e]=null;for(let t=0;t<r.length;t++)r[t]==o&&(r.splice(t,1),t--);l(o,t,i)}}function u(t){const i=r.join("+");r=[],a={};const s=[];for(let t=0;t<e.length;t++)n[e[t]]&&(n[e[t]]=!1,s.push(e[t]));for(let t=0;t<s.length;t++)l(s[t],{preventDefault:function(){},stopPropagation:function(){}},i);o.forEach((t=>{t[2]&&t[2]()}))}return{add:t=>{if(o.includes(t))return;const e=0===o.length;o.push(t),e&&(qf(document,"keydown",c),qf(document,"keyup",h),qf(window,"blur",u))},remove:t=>{if(!o.includes(t))return;const e=1===o.length;for(let e=0;e<o.length;e++)if(o[e]===t){o.splice(e,1);break}e&&(Zf(document,"keydown",c),Zf(document,"keyup",h),Zf(window,"blur",u))},getIsDown:()=>n,getCombo:()=>r}})();function em(t,e,n){return t*(1-n)+e*n}function nm(t,e,n,i){return Math.sqrt(Math.pow(t-n,2)+Math.pow(e-i,2))}function im(t,e){return Math.atan2(e.y-t.y,e.x-t.x)}function rm(t,e){return 180*im(t,e)/Math.PI}function am(t,e,n){return t<=e?e:t>=n?n:t}function om(t,e,n){const i=n*(Math.PI/180),r=Math.cos(i),a=Math.sin(i);return{x:t*r-e*a,y:t*a+e*r}}const sm=function(t){const e=[100];let n,i=0,r=null,a=null,o=null;function s(e){t({deltaY:Math.round(e/r),pageX:o.pageX,pageY:o.pageY,clientX:o.clientX,clientY:o.clientY})}function l(){null!==a&&(s(a),a=null),null===r||e.includes(r)||e.push(r),i=0,r=null}this.process=function(t){o={pageX:t.pageX,pageY:t.pageY,clientX:t.clientX,clientY:t.clientY},clearTimeout(n),n=setTimeout(l,200);let c=t.deltaY;"deltaMode"in t&&1===t.deltaMode&&(c*=100/3);const h=Math.abs(c);if(i>0&&null===r)a=null;else{if(0===i){if(i++,h<50)return;return r=h,void(e.includes(r)?s(c):a=c)}if(0!==h){if(h===r||h/r%1<1e-4);else if(r/h%1<1e-4)r=h;else if(h!==r)return r=null,void(a=null);null!==a&&(s(a),a=null),s(c)}}}},lm=function(){const t=[];let e=0,n=null,i=!1,r=1;return function(a){const o=a.target,s=a.onPointer,l=a.onWheel,c=a.onEnterLeave,h="maxPointers"in a?a.maxPointers:1,u={1:"left",2:"right",4:"middle"},d=new sm((function(t){if(!p&&l){const e=o.getBoundingClientRect();t.relX=t.clientX-e.left+o.scrollLeft,t.relY=t.clientY-e.top+o.scrollTop,l(t)}}));let p=!1;const g=Nf()?0:-performance.timing.navigationStart;let f="",m=!1;const y=[],x=[];function b(t){for(let e=0;e<y.length;e++)if(t===y[e].pointerId)return y[e];return null}function v(t){let e=null;for(let n=0;n<x.length;n++)x[n]===t&&(e=y[n],y.splice(n,1),x.splice(n,1),n--);return e}function w(t,a){return 0===t||1===t?t:(e<60?(n=0===e?t:em(t,n,.95),e++):i||(i=!0,n<.13&&(r=2.3)),Math.pow(t,1/r))}function C(e){if(e.corrected)return e.corrected;const n={pointerId:e.pointerId,pointerType:e.pointerType,pageX:e.pageX,pageY:e.pageY,clientX:e.clientX,clientY:e.clientY,movementX:e.movementX,movementY:e.movementY,timeStamp:e.timeStamp+g,pressure:w(e.pressure,e.type),buttons:e.buttons,button:e.button,coalescedArr:[],eventPreventDefault:function(){e.preventDefault()},eventStopPropagation:function(){e.stopPropagation()}};e.corrected=n;let i=null;"pointerId"in e?"pressure"in e&&0!==e.buttons&&(["mouse"].includes(e.pointerType)||"touch"===e.pointerType&&0===e.pressure)&&(n.pressure=1,i=1):(n.pointerId=0,n.pointerType="mouse",n.pressure=0!==e.buttons?1:0,i=n.pressure),Uf&&"mouse"!=e.pointerType&&"pointermove"===e.type&&0===e.buttons&&(n.buttons=1);let r=[];"getCoalescedEvents"in e&&(r=e.getCoalescedEvents());let a=function(e){for(let n=t.length-1;n>=0;n--)if(e.pointerId===t[n].pointerId)return t[n];return null}(n);null===a&&(a=function(e){const n={pointerId:e.pointerId,lastPageX:null,lastPageY:null};return t.push(n),t.length>15&&t.shift(),n}(n));const o=a.lastPageX,s=a.lastPageY;for(let t=0;t<r.length;t++){const e=r[t];n.coalescedArr.push({pageX:e.pageX,pageY:e.pageY,clientX:e.clientX,clientY:e.clientY,movementX:null===a.lastPageX?0:e.pageX-a.lastPageX,movementY:null===a.lastPageY?0:e.pageY-a.lastPageY,timeStamp:0===e.timeStamp?n.timeStamp:e.timeStamp+g,pressure:null===i?w(e.pressure):i}),a.lastPageX=e.pageX,a.lastPageY=e.pageY}return a.lastPageX=n.pageX,a.lastPageY=n.pageY,n.movementX=null===o?0:a.lastPageX-o,n.movementY=null===s?0:a.lastPageY-s,n}function S(t,e,n){const i=o.getBoundingClientRect(),r={type:t,pointerId:e.pointerId,pointerType:e.pointerType,pageX:e.pageX,pageY:e.pageY,clientX:e.clientX,clientY:e.clientY,relX:e.clientX-i.left+o.scrollLeft,relY:e.clientY-i.top+o.scrollTop,dX:e.movementX,dY:e.movementY,time:e.timeStamp,eventPreventDefault:e.eventPreventDefault,eventStopPropagation:e.eventStopPropagation};if("pointermove"===t&&(r.coalescedArr=[],e.coalescedArr.length>1)){let t;for(let n=0;n<e.coalescedArr.length;n++)t=e.coalescedArr[n],r.coalescedArr.push({pageX:t.pageX,pageY:t.pageY,clientX:t.clientX,clientY:t.clientY,relX:t.clientX-i.left+o.scrollLeft,relY:t.clientY-i.top+o.scrollTop,dX:t.movementX,dY:t.movementY,time:t.timeStamp})}if(n){const t=Object.keys(n);for(let e=0;e<t.length;e++)r[t[e]]=n[t[e]]}return r}function E(t,e,n,i){const r=o.getBoundingClientRect(),a={type:t,pointerId:e.identifier,pointerType:"touch",pageX:e.pageX,pageY:e.pageY,clientX:e.clientX,clientY:e.clientY,relX:e.pageX-r.left+o.scrollLeft,relY:e.pageY-r.top+o.scrollTop,time:n.timeStamp+g,eventPreventDefault:function(){n.preventDefault()},eventStopPropagation:function(){n.stopPropagation()}};"pointermove"===t&&(a.coalescedArr=[]);const s=Object.keys(i);for(let t=0;t<s.length;t++)a[s[t]]=i[s[t]];return a}function M(){Zf(document,"pointermove",D),Zf(document,"pointerup",B),Zf(document,"pointerleave",z)}let I,k,T,R=0;function L(){R++,c&&c(!0)}function A(){R--,c&&c(!1)}function P(t){t=C(t);const e=f;if(f=t.pointerType,x.includes(t.pointerId)||x.length===h||"touch"===t.pointerType)return void(m=!1);if(!m&&"mouse"===t.pointerType&&"pen"===e)return void(m=!0);m=!1;const n=S("pointermove",t);s(n)}function O(t){if(t=C(t),x.includes(t.pointerId)||x.length===h||![1,2,4].includes(t.buttons))return;0===y.length&&(qf(document,"pointermove",D),qf(document,"pointerup",B),qf(document,"pointerleave",z));const e={pointerId:t.pointerId,pointerType:t.pointerType,downPageX:t.pageX,downPageY:t.pageY,buttons:t.buttons,lastPageX:t.pageX,lastPageY:t.pageY,lastTimeStamp:t.timeStamp};y.push(e),j(e),x.push(t.pointerId);const n=S("pointerdown",t,{downPageX:t.pageX,downPageY:t.pageY,button:u[t.buttons],pressure:t.pressure});s(n)}function D(t){if(t=C(t),!x.includes(t.pointerId))return;const e=b(t.pointerId);if(H(e),t.buttons!==e.buttons){1===y.length&&M(),v(t.pointerId);const n=S("pointerup",t,{downPageX:e.downPageX,downPageY:e.downPageY});return void s(n)}if(j(e),"pen"===t.pointerType&&t.pageX===e.lastPageX&&t.pageY===e.lastPageY&&t.timeStamp===e.lastTimeStamp)return;const n=S("pointermove",t,{downPageX:e.downPageX,downPageY:e.downPageY,button:u[t.buttons],pressure:t.pressure});e.lastPageX=t.pageX,e.lastPageY=t.pageY,e.lastTimeStamp=t.timeStamp,s(n)}function B(t){if(t=C(t),!x.includes(t.pointerId))return;1===y.length&&M();const e=v(t.pointerId);H(e);const n=S("pointerup",t,{downPageX:e.downPageX,downPageY:e.downPageY});s(n)}function z(t){if(t=C(t),!x.includes(t.pointerId))return;1===y.length&&M();const e=v(t.pointerId);H(e);const n=S("pointerup",t,{downPageX:e.downPageX,downPageY:e.downPageY});s(n)}function j(t){"touch"===t.pointerType&&(t.touchTimeout=setTimeout((function(){!function(t){B({pointerId:t.pointerId,pointerType:t.pointerType,type:"pointerup",timeStamp:performance.now(),pageX:0,pageY:0,clientX:0,clientY:0,preventDefault:function(){},stopPropagation:function(){}})}(t)}),2500))}function H(t){t.touchTimeout&&(clearTimeout(t.touchTimeout),t.touchTimeout=null)}c&&(qf(o,"pointerenter",L),qf(o,"pointerleave",A)),s&&(qf(o,"pointermove",P),qf(o,"pointerdown",O)),l&&qf(o,"wheel",d.process),Xf?a.fixScribble&&(k=function(t){t.preventDefault()},qf(o,"touchmove",k)):(I=function(t){t.preventDefault();const e=t.changedTouches;for(let n=0;n<e.length&&y.length<h;n++){const i=e[n];0===y.length&&(qf(document,"touchmove",k),qf(document,"touchend",T),qf(document,"touchcancel",T)),y.push({pointerId:i.identifier,downPageX:i.pageX,downPageY:i.pageY,buttons:1,lastPageX:i.pageX,lastPageY:i.pageY}),x.push(i.identifier);const r=E("pointerdown",i,t,{dX:0,dY:0,downPageX:i.downPageX,downPageY:i.downPageY,button:"left",pressure:1});s(r)}},k=function(t){t.preventDefault();const e=t.changedTouches;for(let n=0;n<e.length;n++){const i=e[n];if(!x.includes(i.identifier))continue;const r=b(i.identifier),a=E("pointermove",i,t,{dX:i.pageX-r.lastPageX,dY:i.pageY-r.lastPageY,downPageX:r.downPageX,downPageY:r.downPageY,button:"left",isCoalesced:!1,pressure:1});r.lastPageX=i.pageX,r.lastPageY=i.pageY,s(a)}},T=function(t){"touchcancel"!==t.type&&t.preventDefault();const e=t.changedTouches;for(let n=0;n<e.length;n++){const i=e[n];if(!x.includes(i.identifier))continue;1===y.length&&(Zf(document,"touchmove",k),Zf(document,"touchend",T),Zf(document,"touchcancel",T));const r=v(i.identifier),a=E("pointerup",i,t,{dX:i.pageX-r.lastPageX,dY:i.pageY-r.lastPageY,downPageX:r.downPageX,downPageY:r.downPageY});s(a)}},s&&qf(o,"touchstart",I)),this.isOver=function(){return R>0},this.destroy=function(){p||(p=!0,Zf(o,"pointerenter",L),Zf(o,"pointerleave",A),Zf(o,"pointermove",P),Zf(o,"pointerdown",O),Zf(o,"wheel",d.process),y.length>0&&M(),Xf?Zf(o,"touchmove",k):(Zf(o,"touchstart",I),y.length>0&&(Zf(document,"touchmove",k),Zf(document,"touchend",T),Zf(document,"touchcancel",T))))}}}();var cm={};t(cm,"EventChain",(function(){return hm})),t(cm,"DoubleTapper",(function(){return um})),t(cm,"NFingerTapper",(function(){return dm})),t(cm,"PinchZoomer",(function(){return pm})),t(cm,"CoalescedExploder",(function(){return gm})),t(cm,"OnePointerLimiter",(function(){return fm})),t(cm,"LinetoolProcessor",(function(){return mm})),t(cm,"LineSanitizer",(function(){return ym})),t(cm,"LineSmoothing",(function(){return xm}));const hm=function(t){const e=t.chainArr;let n=()=>{};function i(t,i){for(;t<e.length;t++)if(null===(i=e[t].chainIn(i)))return null;return n(i),null}for(let t=0;t<e.length;t++)!function(t){e[t].setChainOut((function(e){i(t+1,e)}))}(t);this.chainIn=function(t){return i(0,t)},this.setChainOut=function(t){n=t}},um=function(t){let e=function(){};let n=["touch","mouse","pen"],i=["left"],r=[];const a=[];let o=0,s=0,l=[];function c(){if(0!==r.length){clearTimeout(u.fail),clearTimeout(u.maxUntilSecondDown),clearTimeout(u.success),u.fail=null,u.maxUntilSecondDown=null,u.success=null;for(let t=0;t<l.length;t++)e(l[t]);l=[],r=[]}}function h(){u.fail=null,u.success=null,l=[];const e=r[r.length-1];r=[],t.onDoubleTap({pageX:e.pageX,pageY:e.pageY})}const u={fail:null,maxUntilSecondDown:null,success:null};function d(t,e,n){const i=n-s;return!(i<=0)&&(u[t]=setTimeout(e,i),!0)}this.chainIn=function(t){return function(t){if("pointerdown"===t.type)a.push(t.pointerId);else if("pointerup"===t.type)for(let e=0;e<a.length;e++)if(a[e]===t.pointerId){a.splice(e,1);break}if(!n.includes(t.pointerType))return void c();s=performance.now();const e=r.length>0?r[r.length-1]:null;if("pointerup"===t.type&&(o=t.time),"pointerdown"===t.type){if(a.length>1)return void c();if(null!==u.success)return void c();if(0===r.length&&s-o<400)return void c();if(!i.includes(t.button))return void c();if(e&&e.isDown||r.length>2)return void c();if(e&&nm(e.position[0],e.position[1],t.pageX,t.pageY)>19&&(c(),s-e.time<400))return;if(r.push({isDown:!0,time:s,position:[t.pageX,t.pageY],pointerId:t.pointerId}),r.length>1)clearTimeout(u.maxUntilSecondDown);else if(!d("maxUntilSecondDown",c,t.time+300))return void c();if(clearTimeout(u.fail),!d("fail",c,t.time+300))return void c()}if(e&&"pointermove"===t.type&&e.pointerId===t.pointerId&&nm(e.position[0],e.position[1],t.pageX,t.pageY)>10)return void c();if(e&&"pointerup"===t.type){if(e.pointerId!==t.pointerId)return void c();if(s>=e.time+300)return void c();if(clearTimeout(u.fail),r.length<3)return d("fail",c,t.time+500)?void(r=[e,{isUp:!0,time:s,position:[t.pageX,t.pageY]}]):void c();s<r[1].time+500?(r.push({pageX:t.pageX,pageY:t.pageY}),d("success",h,t.time+250)||c()):c()}}(t),0===r.length?(c(),t):(l.push(t),null)},this.setChainOut=function(t){e=t},this.setAllowedPointerTypeArr=function(t){n=t},this.setAllowedButtonArr=function(t){i=t}},dm=function(t){const e=t.fingers;let n=function(){};let i,r=[],a=[],o=0;const s=[];function l(){if(0!==a.length){clearTimeout(h.firstLastDownTimeout),clearTimeout(h.tapTimeout);for(let t=0;t<a.length;t++)n(a[t]);a=[],r=[]}}let c;const h={firstLastDownTimeout:null,tapTimeout:null};function u(t,e){const n=e-c;return!(n<=0)&&(h[t]=setTimeout(l,n),!0)}function d(n){const d=o;if(o=n.time,"pointerdown"===n.type)s.push(n.pointerId);else if("pointerup"===n.type)for(let t=0;t<s.length;t++)if(s[t]===n.pointerId){s.splice(t,1);break}if("touch"===n.pointerType){if(c=performance.now(),"pointerdown"===n.type)return r.length+1!==s.length||r.length===e||r.length>0&&n.time-250>r[0].downTime||0===r.length&&n.time-50<d?void l():0!==r.length||(i=n.time,u("firstLastDownTimeout",n.time+250)&&u("tapTimeout",n.time+500))?void r.push({pointerId:n.pointerId,downTime:n.time,downPageX:n.pageX,downPageY:n.pageY}):void l();if("pointermove"===n.type){if(0===r.length)return;let t=null;for(let e=0;e<r.length;e++)if(r[e].pointerId===n.pointerId){t=r[e];break}if(null===t)return void l();if(n.time-500>i)return void l();if(nm(n.pageX,n.pageY,t.downPageX,t.downPageY)>12)return void l()}if("pointerup"===n.type){if(0===r.length)return;if(r.length!==e)return void l();let o=null,s=0;for(;s<r.length;s++)if(r[s].pointerId===n.pointerId){o=r[s];break}if(null===o)return;if(n.time-500>i)return void l();if(nm(n.pageX,n.pageY,o.downPageX,o.downPageY)>12)return void l();o.isUp=!0;let c=!0;for(let t=0;t<r.length;t++)if(!r[t].isUp){c=!1;break}if(c)return clearTimeout(h.firstLastDownTimeout),clearTimeout(h.tapTimeout),a=[],r=[],t.onTap(),!0}}else r.length>0&&l()}this.chainIn=function(t){return!0===d(t)?null:0===r.length?t:(a.push(t),null)},this.setChainOut=function(t){n=t}},pm=function(t){let e=function(){};const n=[];let i,r=null,a=[];function o(){r=null,a=[]}function s(t){if(r){if(clearTimeout(l.secondFingerTimeout),!t)for(let t=0;t<a.length;t++)e(a[t]);o()}}const l={secondFingerTimeout:null};function c(t){if("pointerdown"===t.type)n.push(t.pointerId);else if("pointerup"===t.type)for(let e=0;e<n.length;e++)if(n[e]===t.pointerId){n.splice(e,1);break}if(r||!("touch"!==t.pointerType||"pointermove"===t.type&&n.length>0||n.length>1||"pointerup"===t.type)){if(i=performance.now(),"pointerdown"===t.type)return r?"touch"===t.pointerType?(r.touchPointerArr.push({pointerId:t.pointerId,relX:t.relX,relY:t.relY}),void(r.isInProgress?d(r,{type:"down",index:r.touchPointerArr.length-1}):(clearTimeout(l.secondFingerTimeout),r.isInProgress=!0,u(r)))):void(r.isInProgress?r.otherPointerIdArr.push(t.pointerId):s()):(r={touchPointerArr:[{pointerId:t.pointerId,relX:t.relX,relY:t.relY,downRelX:t.relX,downRelY:t.relY}],otherPointerIdArr:[],isInProgress:!1},function(t,e,n){const r=n-i;return!(r<=0||(l[t]=setTimeout(e,r),0))}("secondFingerTimeout",(function(){s()}),t.time+250)?void 0:void s());if("pointermove"!==t.type||"touch"!==t.pointerType){if("pointerup"===t.type){if("touch"===t.pointerType){let e=0;for(;e<r.touchPointerArr.length;e++)if(r.touchPointerArr[e].pointerId===t.pointerId){r.touchPointerArr.splice(e,1);break}r.touchPointerArr.length>0&&d(r,{type:"up",index:e})}else for(let e=0;e<r.otherPointerIdArr.length;e++)if(r.otherPointerIdArr[e]===t.pointerId){r.otherPointerIdArr.splice(e,1);break}if(0===r.touchPointerArr.length&&0===r.otherPointerIdArr.length)return void(r.isInProgress?(o(),p()):s())}}else{let e=null,n=0;for(;n<r.touchPointerArr.length;n++)if(t.pointerId===r.touchPointerArr[n].pointerId){e=r.touchPointerArr[n];break}if(e.relX=t.relX,e.relY=t.relY,r.isInProgress)n<2&&d(r,{type:"move",index:n});else{if(nm(e.downRelX,e.downRelY,e.relX,e.relY)>10)return void s()}}}}let h=[];function u(e){for(let t=0;t<e.touchPointerArr.length;t++){const n=e.touchPointerArr[t];h.push({pointerId:n.pointerId,relX:n.relX,relY:n.relY,downRelX:n.relX,downRelY:n.relY})}const n={type:"move",angleRad:0,scale:1};1===h.length?(n.relX=h[0].downRelX,n.relY=h[0].downRelY):(n.relX=.5*(h[0].downRelX+h[1].downRelX),n.relY=.5*(h[0].downRelY+h[1].downRelY)),n.downRelX=n.relX,n.downRelY=n.relY,t.onPinch(n)}function d(e,n){if(!(n.index>1))if("move"===n.type){let i;if(h[n.index].relX=e.touchPointerArr[n.index].relX,h[n.index].relY=e.touchPointerArr[n.index].relY,1===h.length)i={type:"move",downRelX:h[0].downRelX,downRelY:h[0].downRelY,relX:h[0].relX,relY:h[0].relY,angleRad:0,scale:1};else{const t=nm(h[0].downRelX,h[0].downRelY,h[1].downRelX,h[1].downRelY),e=nm(h[0].relX,h[0].relY,h[1].relX,h[1].relY),n=im({x:h[0].downRelX,y:h[0].downRelY},{x:h[1].downRelX,y:h[1].downRelY}),r=im({x:h[0].relX,y:h[0].relY},{x:h[1].relX,y:h[1].relY});i={type:"move",downRelX:.5*(h[0].downRelX+h[1].downRelX),downRelY:.5*(h[0].downRelY+h[1].downRelY),relX:.5*(h[0].relX+h[1].relX),relY:.5*(h[0].relY+h[1].relY),angleRad:r-n,scale:e/t}}t.onPinch(i)}else"down"!==n.type&&"up"!==n.type||(p(),u(e))}function p(){h=[],t.onPinch({type:"end"})}this.chainIn=function(t){return c(t),r?(r.isInProgress||a.push(t),null):t},this.setChainOut=function(t){e=t}},gm=function(){let t=function(){};this.chainIn=function(e){if("pointermove"!==e.type)return e;if(!(e.coalescedArr.length>0))return e;{let n,i=JSON.parse(JSON.stringify(e));i.coalescedArr=[];for(let r=0;r<e.coalescedArr.length;r++)r>0&&(i=JSON.parse(JSON.stringify(e))),n=e.coalescedArr[r],i.pageX=n.pageX,i.pageY=n.pageY,i.relX=n.relX,i.relY=n.relY,i.dX=n.dX,i.dY=n.dY,i.time=n.time,r<e.coalescedArr.length-1&&(i.isCoalesced=!0),t(i)}return null},this.setChainOut=function(e){t=e}},fm=function(t){let e=function(){},n=null;const i=[];this.chainIn=function(t){if(i.includes(t.pointerId)){if("pointerup"===t.type)for(let e=0;e<i.length;e++)if(i[e]===t.pointerId){i.splice(e,1);break}return null}return null===n?("pointerdown"===t.type&&(n=t.pointerId),t):t.pointerId!==n?("pointerdown"===t.type&&i.push(t.pointerId),null):("pointerup"===t.type&&(n=null),t)},this.setChainOut=function(t){t}},mm=function(t){let e=null,n=[],i=null;this.process=function(r){if("down"===r.type&&(e=r,i=null,r.shiftIsPressed))return t.onDraw({type:"line",x0:null,y0:null,pressure0:null,x1:r.x,y1:r.y,pressure1:r.pressure}),void n.push(r);if("move"===r.type)if(r.shiftIsPressed){if(null===i){const a=Math.abs(r.x-e.x),o=Math.abs(r.y-e.y);if(a>5||o>5){i=a>o?0:1;for(let r=0;r<n.length;r++){const a=n[r];0===i?a.y=e.y:a.x=e.x,t.onDraw(JSON.parse(JSON.stringify(a)))}n=[]}}if(null===i)return void n.push(r);0===i?r.y=e.y:r.x=e.x}else if(n.length>0){for(let e=0;e<n.length;e++)t.onDraw(JSON.parse(JSON.stringify(n[e])));n=[]}"up"===r.type&&(n=[]),t.onDraw(JSON.parse(JSON.stringify(r)))}},ym=function(){let t=function(){},e=!1;this.chainIn=function(n){return"down"===n.type&&(e?t({type:"up",scale:n.scale,shiftIsPressed:n.shiftIsPressed,isCoalesced:!1}):e=!0),e||"move"!==n.type&&"up"!==n.type?("up"===n.type&&e&&(e=!1),n):null},this.setChainOut=function(e){t=e},this.getIsDrawing=function(){return e}},xm=function(t){let e,n,i,r=function(){},a=am(t.smoothing,0,1);this.chainIn=function(t){if(t=JSON.parse(JSON.stringify(t)),clearTimeout(i),clearInterval(n),"down"===t.type&&(e={x:t.x,y:t.y,pressure:t.pressure}),"move"===t.type){const o=t.x,s=t.y,l=t.pressure;t.x=em(t.x,e.x,a),t.y=em(t.y,e.y,a),t.pressure=em(t.pressure,e.pressure,a),e={x:t.x,y:t.y,pressure:t.pressure},a>0&&(i=setTimeout((function(){n=setInterval((function(){(t=JSON.parse(JSON.stringify(t))).x=em(o,e.x,a),t.y=em(s,e.y,a),t.pressure=em(l,e.pressure,a),e={x:t.x,y:t.y,pressure:t.pressure},r(t)}),35)}),80))}return t},this.setChainOut=function(t){r=t},this.setSmoothing=function(t){a=am(t,0,1)}};const bm=function(t){const e=Ff();let n;if(t<1){if(e.width=1,e.height=1,n=e.getContext("2d"),!n)throw new Error("2d context not supported or canvas already initialized");n.fillStyle="rgb(128, 128, 128)",n.fillRect(0,0,1,1)}else if(t>200)e.width=401,e.height=401;else{if(e.width=2*t,e.height=2*t,n=e.getContext("2d"),!n)throw new Error("2d context not supported or canvas already initialized");n.fillStyle="rgb(255, 255, 255)",n.fillRect(0,0,2*t,2*t),n.fillStyle="rgb(200, 200, 200)",n.fillRect(0,0,t,t),n.fillRect(t,t,2*t,2*t)}return e},vm=function(){const t={8:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAMElEQVQ4T2M8ceLEfwY8wNzcHJ80A+OoAcMiDP7//483HZw8eRJ/Ohg1gIFx6IcBAIhJUqnarXQ1AAAAAElFTkSuQmCC",4:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAJ0lEQVQoU2M8ceLEfwYkYG5ujsxlYKSDgv///6O44eTJk6huoL0CAGsOKVVu8UYvAAAAAElFTkSuQmCC"};return function(e,n){function i(e){if(e=parseInt(""+e),t[""+e])return t[""+e];const n=bm(e).toDataURL("image/png");return t[""+e]=n,n}if(!n)return i(e);setTimeout((function(){n(i(e))}),1)}}();const wm=function(){function t(t,e){return[e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15]]}return{getIdentity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},multiplyMatrixAndPoint:t,multiplyMatrices:function(e,n){const i=[n[0],n[1],n[2],n[3]],r=[n[4],n[5],n[6],n[7]],a=[n[8],n[9],n[10],n[11]],o=[n[12],n[13],n[14],n[15]],s=t(e,i),l=t(e,r),c=t(e,a),h=t(e,o);return[s[0],s[1],s[2],s[3],l[0],l[1],l[2],l[3],c[0],c[1],c[2],c[3],h[0],h[1],h[2],h[3]]},createTranslationMatrix:function(t,e){return[1,0,0,0,0,1,0,0,0,0,1,0,t,e,0,1]},createRotationMatrix:function(t){return[Math.cos(-t),-Math.sin(-t),0,0,Math.sin(-t),Math.cos(-t),0,0,0,0,1,0,0,0,0,1]},createScaleMatrix:function(t){return[t,0,0,0,0,t,0,0,0,0,1,0,0,0,0,1]}}}(),Cm={add:function(t,e){return{x:t.x+e.x,y:t.y+e.y}},sub:function(t,e){return{x:t.x-e.x,y:t.y-e.y}},nor:function(t){const e=Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2));return{x:t.x/e,y:t.y/e}},len:function(t){return Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2))},dist:function(t,e){return Cm.len(Cm.sub(t,e))},mul:function(t,e){return{x:t.x*e,y:t.y*e}},angle:function(t,e){return Math.atan2(e.y-t.y,e.x-t.x)},dot:function(t,e){const n=[t.x,t.y],i=[e.x,e.y];return n.map(((t,e)=>n[e]*i[e])).reduce(((t,e)=>t+e))}},Sm=function(t){const e=[],n=this;for(let n=0;n<t.points.length;n++)!function(n){let i;n<t.points.length-1&&(i=nm(t.points[n].x,t.points[n].y,t.points[n+1].x,t.points[n+1].y)),e[n]={x:t.points[n].x,y:t.points[n].y,length:i}}(n);this.getAtDist=function(t){let i=Math.min(n.getLength(),t),r=0;for(;i>e[r].length&&r<e.length-2;r++)i-=e[r].length;const a=Math.min(1,Math.max(0,i/e[r].length));return{x:e[r].x*(1-a)+e[r+1].x*a,y:e[r].y*(1-a)+e[r+1].y*a}},this.getLength=function(){let t=0;for(let n=0;n<e.length-1;n++)t+=e[n].length;return t}},Em=function(t){const e=t.length;let n;this.xa=[],this.ya=[],this.u=[],this.y2=[];const i=t[0][0],r=t[t.length-1][0];for(t.sort((function(t,e){return t[0]-e[0]})),n=0;n<e;n++)this.xa.push(t[n][0]),this.ya.push(t[n][1]);for(this.u[0]=0,this.y2[0]=0,n=1;n<e-1;++n){const t=this.xa[n+1]-this.xa[n-1],e=(this.xa[n]-this.xa[n-1])/t,i=e*this.y2[n-1]+2;this.y2[n]=(e-1)/i;const r=(this.ya[n+1]-this.ya[n])/(this.xa[n+1]-this.xa[n])-(this.ya[n]-this.ya[n-1])/(this.xa[n]-this.xa[n-1]);this.u[n]=(6*r/t-e*this.u[n-1])/i}for(this.y2[e-1]=0,n=e-2;n>=0;--n)this.y2[n]=this.y2[n]*this.y2[n+1]+this.u[n];this.getFirstX=function(){return i},this.getLastX=function(){return r}};Em.prototype.interpolate=function(t){let e=0,n=this.ya.length-1;for(;n-e>1;){const i=n+e>>1;this.xa[i]>t?n=i:e=i}const i=this.xa[n]-this.xa[e],r=(this.xa[n]-t)/i,a=(t-this.xa[e])/i;return r*this.ya[e]+a*this.ya[n]+((r*r*r-r)*this.y2[e]+(a*a*a-a)*this.y2[n])*(i*i)/6},Em.prototype.findX=function(t,e){let n=null,i=null;for(let r=0;r<=e;r++){const a=r/e,o=this.interpolate(a);if(null===n){n=a,i=Math.abs(o-t);continue}const s=Math.abs(o-t);if(!(s<i))break;n=a,i=s}return n};class Mm{constructor(t,e,n){this.h=Math.max(0,Math.min(360,t)),this.s=Math.max(.001,Math.min(100,e)),this.v=Math.max(0,Math.min(100,n))}}class Im{constructor(t,e,n){this.r=Math.max(0,Math.min(255,t)),this.g=Math.max(0,Math.min(255,e)),this.b=Math.max(0,Math.min(255,n))}}class km{constructor(t,e,n,i){this.c=Math.max(0,Math.min(100,t)),this.m=Math.max(0,Math.min(100,e)),this.y=Math.max(0,Math.min(100,n)),this.k=Math.max(0,Math.min(100,i))}}const Tm={_RGBtoHSV:function(t){const e=new Mm(0,0,0),n=t.r/255,i=t.g/255,r=t.b/255,a=Math.min(n,i,r),o=Math.max(n,i,r),s=o-a;if(e.v=o,0==s)e.h=0,e.s=0;else{e.s=s/o;const t=((o-n)/6+s/2)/s,a=((o-i)/6+s/2)/s,l=((o-r)/6+s/2)/s;n==o?e.h=l-a:i==o?e.h=1/3+t-l:r==o&&(e.h=2/3+a-t),e.h<0&&(e.h+=1),e.h>1&&(e.h-=1)}return e.h=Math.round(360*e.h),e.s=Math.round(100*e.s),e.v=Math.round(100*e.v),e},_HSVtoRGB:function(t){const e=new Im(0,0,0);let n,i,r,a,o,s,l,c;const h=t.h/360%1,u=t.s/100,d=t.v/100;return 0==u?(e.r=255*d,e.g=255*d,e.b=255*d):(n=6*h,i=Math.floor(n),r=d*(1-u),a=d*(1-u*(n-i)),o=d*(1-u*(1-(n-i))),0==i?(s=d,l=o,c=r):1==i?(s=a,l=d,c=r):2==i?(s=r,l=d,c=o):3==i?(s=r,l=a,c=d):4==i?(s=o,l=r,c=d):(s=d,l=r,c=a),e.r=255*s,e.g=255*l,e.b=255*c,e.r=Math.round(e.r),e.g=Math.round(e.g),e.b=Math.round(e.b)),e},_CMYKtoRGB:function(t){const e=new Im(0,0,0),n=t.c/100,i=t.m/100,r=t.y/100,a=t.k/100;return e.r=1-Math.min(1,n*(1-a)+a),e.g=1-Math.min(1,i*(1-a)+a),e.b=1-Math.min(1,r*(1-a)+a),e.r=Math.round(255*e.r),e.g=Math.round(255*e.g),e.b=Math.round(255*e.b),e},_RGBtoCMYK:function(t){const e=new km(0,0,0,0),n=t.r/255,i=t.g/255,r=t.b/255;return e.k=Math.min(1-n,1-i,1-r),e.c=(1-n-e.k)/(1-e.k),e.m=(1-i-e.k)/(1-e.k),e.y=(1-r-e.k)/(1-e.k),e.c=Math.round(100*e.c),e.m=Math.round(100*e.m),e.y=Math.round(100*e.y),e.k=Math.round(100*e.k),e},toRGB:function(t){return t instanceof Im?t:t instanceof Mm?this._HSVtoRGB(t):t instanceof km?this._CMYKtoRGB(t):void 0},toHSV:function(t){return t instanceof Mm?t:t instanceof Im?this._RGBtoHSV(t):t instanceof km?this._RGBtoHSV(this._CMYKtoRGB(t)):void 0},toCMYK:function(t){return t instanceof km?t:t instanceof Im?this._RGBtoCMYK(t):t instanceof Mm?this._RGBtoCMYK(this._HSVtoRGB(t)):void 0},toHexString:function(t){if(t instanceof Im){let e=parseInt(""+t.r).toString(16),n=parseInt(""+t.g).toString(16),i=parseInt(""+t.b).toString(16);return 1==e.length&&(e="0"+e),1==n.length&&(n="0"+n),1==i.length&&(i="0"+i),e+n+i}},toRgbStr:function(t){return"rgb("+Math.round(t.r)+", "+Math.round(t.g)+", "+Math.round(t.b)+")"},toRgbaStr:function(t){return"rgba("+Math.round(t.r)+", "+Math.round(t.g)+", "+Math.round(t.b)+", "+t.a+")"},hexToRGB:function(t){t=(t=t.trim()).replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(function(t,e,n,i){return e+e+n+n+i+i}));const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?new Im(parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)):null}};const Rm=function(){function t(t){t.preventDefault();let e=!1;if(t.relatedTarget)try{t.relatedTarget.focus(),e=!0}catch(t){console.error("failed to focus")}e||t.currentTarget.blur()}return function(e){e.setAttribute("tabindex","-1"),qf(e,"focus",t)}}(),Lm=[];class Am{static subscribe(t){Am.listeners.includes(t)||Am.listeners.push(t)}static unsubscribe(t){for(let e=0;e<Am.listeners.length;e++)if(t===Am.listeners[e])return void Am.listeners.splice(e,1)}static emit(t){Am.listeners.forEach((e=>{e(t)}))}constructor(){}}Am.listeners=[];class Pm{static getItem(t){let e=null;try{e=localStorage.getItem(t)}catch(t){this.error=t}return e}static setItem(t,e){try{localStorage.setItem(t,e)}catch(t){this.error=t}}static removeItem(t){try{localStorage.removeItem(t)}catch(t){this.error=t}}static getError(){return this.error}}const Om={eventUsesHighResTimeStamp:Nf,mouseEventHasMovement:Yf,hasPointerEvents:Xf,hasWebGl:Vf,getVisitor:Wf,isCssMinMaxSupported:Kf,canShareFiles:function(){return"share"in navigator&&"canShare"in navigator},insertAfter:function(t,e){t.parentNode&&t.parentNode.insertBefore(e,t.nextSibling)},loadImage:function(t,e){let n=0;!function i(){1e3!==n?t.complete?(n++,e()):setTimeout(i,1):alert("couldn't load")}()},css:$f,setAttributes:function(t,e){const n=Object.keys(e);let i;for(let r=0;r<n.length;r++)i=n[r],t.setAttribute(i,e[i])},addClassName:function(t,e){const n=t.getAttribute("class"),i=null===n?[]:n.split(" ");i.includes(e)||(i.push(e),t.setAttribute("class",i.join(" ")))},removeClassName:function(t,e){const n=t.getAttribute("class"),i=null===n?[]:n.split(" ");if(i.includes(e)){for(let t=0;t<i.length;t++)i[t]===e&&(i.splice(t,1),t--);t.setAttribute("class",i.join(" "))}},append:function(t,e){const n=document.createDocumentFragment();e.forEach((t=>t?n.append(t):null)),t.append(n)},fitInto:function(t,e,n,i,r){let a=t*n,o=e*n;return a>n&&(o*=n/a,a=n),o>i&&(a*=i/o,o=i),r&&(a=Math.max(r,a),o=Math.max(r,o)),{width:a,height:o}},centerWithin:function(t,e,n,i){return{x:t/2-n/2,y:e/2-i/2}},getDate:function(){const t=new Date;return t.getFullYear()+"_"+(t.getMonth()+1).toString().padStart(2,"0")+"_"+t.getDate().toString().padStart(2,"0")+"_"+(60*t.getHours()+t.getMinutes()).toString(36).padStart(3,"0")+"_"},gcd:Jf,reduce:Qf,decToFraction:function(t){const e=t.toString().length-2,n=Math.pow(10,e);return Qf(t*n,n)},imageBlobToUrl:function(t){if(!t)throw new Error("blobObj is undefined or null");if(window.Blob&&t instanceof Blob)return URL.createObjectURL(t);if("Object"===t.constructor.name){const e=t;return"data:"+e.type+";"+e.encoding+","+e.data}throw new Error("unknown blob format")},dateDayDifference:function(t,e){return t=new Date(t),e=new Date(e),t.setHours(0,0,0,0),e.setHours(0,0,0,0),(e.getTime()-t.getTime())/864e5},copyObj:function(t){return JSON.parse(JSON.stringify(t))},shareCanvas:function(t){const e="image/png",n=()=>alert("sharing not supported");t.canvas.toBlob((function(i){if(null===i)return n(),void t.callback();try{const r=[new File([i],t.fileName,{type:e})];navigator.share({title:t.title,files:r}).then((t=>{})).catch((t=>{n()}))}catch(t){n()}t.callback()}),e)},handleClick:function(t){const e=t.target;return!!e&&(!(!["A","LABEL","INPUT"].includes(e.tagName)&&!e.allowClick)||(t.preventDefault(),!1))},createSvg:function t(e){const n=document.createElementNS("http://www.w3.org/2000/svg",e.elementType),i=Object.keys(e);let r;for(let a=0;a<i.length;a++)if(r=i[a],"childrenArr"===r)for(let i=0;i<e.childrenArr.length;i++)n.appendChild(t(e.childrenArr[i]));else"elementType"!==r&&n.setAttribute(r,e[r]);return n},BbLog:Am,LocalStorage:Pm,mix:em,dist:nm,distSquared:function(t,e,n,i){return Math.pow(t-n,2)+Math.pow(e-i,2)},lenSquared:function(t,e){return t*t+e*e},pointsToAngleRad:im,pointsToAngleDeg:rm,clamp:am,rotate:om,rotateAround:function(t,e,n){const i=om(e.x-t.x,e.y-t.y,n);return i.x+=t.x,i.y+=t.y,i},Matrix:wm,Vec2:Cm,intDxy:function(t,e,n){t.x+=e,t.y+=n;const i=Math.round(t.x),r=Math.round(t.y);return t.x-=i,t.y-=r,{dX:i,dY:r}},roundEven:function(t){if(t%1==0)return t%2==0?t:t+1;const e=Math.ceil(t),n=Math.floor(t);return e%2==0?e:n},roundUneven:function(t){if(t%1==0)return t%2==0?t+1:t;const e=Math.ceil(t),n=Math.floor(t);return e%2==1?e:n},updateBounds:function(t,e){return e?(t?(t.x1=Math.min(t.x1,e.x1),t.y1=Math.min(t.y1,e.y1),t.x2=Math.max(t.x2,e.x2),t.y2=Math.max(t.y2,e.y2)):t={x1:e.x1,y1:e.y1,x2:e.x2,y2:e.y2},t):t},boundsInArea:function(t,e,n){let i=Math.max(0,t.x1),r=Math.max(0,t.y1),a=Math.min(e-1,t.x2),o=Math.min(n-1,t.y2);return i>a||r>o?null:{x1:i,y1:r,x2:a,y2:o}},projectPointOnLine:function(t,e,n){let i,r;if(t.x===e.x)return i=t.x,r=n.y,{x:i,y:r};const a=(e.y-t.y)/(e.x-t.x),o=t.y-a*t.x;return i=(a*n.y+n.x-a*o)/(a*a+1),r=(a*a*n.y+a*n.x+o)/(a*a+1),{x:i,y:r}},PointLine:Sm,BezierLine:function(){const t=this,e=[];let n,i,r,a=0,o=null;this.add=function(t,s,l,c,h){if(n&&t===n.x&&s===n.y)return;if(n={x:t,y:s},e[e.length]={x:t,y:s,spacing:l},1===e.length)return void(o=l);if(2===e.length)return e[0].dir=Cm.nor(Cm.sub(e[1],e[0])),a=l,void(o=l);{const t=e[e.length-1],n=e[e.length-2],i=e[e.length-3];n.dir=Cm.nor(Cm.sub(t,i)),(isNaN(n.dir.x)||isNaN(n.dir.y))&&(n.dir=JSON.parse(JSON.stringify(i.dir)))}const u=e[e.length-3],d=e[e.length-2],p=u,g=Cm.add(u,Cm.mul(u.dir,Cm.dist(u,d)/4)),f=Cm.sub(d,Cm.mul(d.dir,Cm.dist(u,d)/4)),m=d;let y;if(c){let t;t=function(t,e,n,i,r){const a=[];let o,s;for(let l=0;l<=r;l++)o=l/r,s={},s.x=Math.pow(1-o,3)*t.x+3*Math.pow(1-o,2)*o*e.x+3*(1-o)*Math.pow(o,2)*n.x+Math.pow(o,3)*i.x,s.y=Math.pow(1-o,3)*t.y+3*Math.pow(1-o,2)*o*e.y+3*(1-o)*Math.pow(o,2)*n.y+Math.pow(o,3)*i.y,a[a.length]=s;return a}(p,g,f,m,20),y=new Sm({points:t})}else y=new Sm({points:[p,m]});const x=y.getLength();let b=em(o,l,am(a/x,0,1)),v=a;for(;v<=x;v+=b){b=em(o,l,am(v/x,0,1));const t=y.getAtDist(v),e=i?rm(i,t):void 0;c&&c({x:t.x,y:t.y,t:v/x,angle:e,dAngle:i?e-r:0}),i=t,r=e}c?a=v-x:(a=0,h({p1:p,p2:g,p3:f,p4:m})),o=l},this.addFinal=function(n,i,r){if(e.length<2)return;const a=e[e.length-2],o=e[e.length-1],s=Cm.add(o,Cm.sub(o,a));t.add(s.x,s.y,n,i,r)}},SplineInterpolator:Em,quadraticSplineInput:function(t,e,n){function i(t,e){return Math.round(t*Math.pow(10,e))/Math.pow(10,e)}const r=[];for(let a=0;a<=1;a+=n)r.push([i(a,4),i(t+Math.pow(a,2)*(e-t),4)]);return r},canvas:Ff,copyCanvas:function(t){const e=Ff(t.width,t.height),n=e.getContext("2d");if(!n)throw new Error("2d context not supported or canvas already initialized");return n.drawImage(t,0,0),e},testShouldPixelate:function(t,e,n){if(![1,-1].includes(e)||![1,-1].includes(n)||t.width%1!=0||t.height%1!=0||Math.abs(t.angleDeg)%90!=0)return!1;const i=Math.abs(t.angleDeg-90)%180==0,r=i?t.height:t.width,a=i?t.width:t.height;return(Math.abs(r)%2==0&&t.x%1==0||Math.abs(r)%2==1&&t.x%1==.5)&&(Math.abs(a)%2==0&&t.y%1==0||Math.abs(a)%2==1&&t.y%1==.5)},drawTransformedImageWithBounds:function(t,e,n,i,r){i||(i={x:0,y:0,width:e.width,height:e.height}),t.save(),r?t.imageSmoothingEnabled=!1:(t.imageSmoothingEnabled=!0,t.imageSmoothingQuality="high"),t.translate(n.x,n.y),t.rotate(n.angleDeg/180*Math.PI),t.scale(n.width>0?1:-1,n.height>0?1:-1),t.drawImage(e,i.x,i.y,i.width,i.height,-Math.abs(n.width)/2,-Math.abs(n.height)/2,Math.abs(n.width),Math.abs(n.height)),t.restore()},drawTransformedImageOnCanvas:function(t,e,n){(n=JSON.parse(JSON.stringify(n))).center||(n.center={x:e.width/2,y:e.height/2}),n.scale||(n.scale={x:1,y:1}),n.angleDegree||(n.angleDegree=0),n.translate||(n.translate={x:0,y:0});const i=t.getContext("2d");if(!i)throw new Error("2d context not supported or canvas already initialized");i.save(),Math.abs(n.scale.x-1)>1e-6||Math.abs(n.scale.y-1)>1e-6||Math.abs(n.angleDegree%90)>1e-6?(i.imageSmoothingEnabled=!0,i.imageSmoothingQuality="high"):i.imageSmoothingEnabled=!1,i.translate(n.translate.x,n.translate.y),i.translate(n.center.x,n.center.y),i.rotate(n.angleDegree/180*Math.PI),i.scale(n.scale.x,n.scale.y),i.translate(-n.center.x,-n.center.y),i.drawImage(e,0,0,e.width,e.height),i.restore()},createCheckerCanvas:bm,createCheckerDataUrl:vm,resizeCanvas:function t(e,n,i,r,a){if(n&&i&&(n!==e.width||i!==e.height))if(n=Math.max(n,1),i=Math.max(i,1),n<=e.width&&i<=e.height){r=r||Ff(),a=a||Ff();const t=function(t,e,n,i){const r={oldWidthEx:Math.round(Math.log2(t)),oldHeightEx:Math.round(Math.log2(e)),newWidthEx:Math.ceil(Math.log2(n)),newHeightEx:Math.ceil(Math.log2(i))};return r.oldWidthEx=Math.max(r.oldWidthEx,r.newWidthEx),r.oldHeightEx=Math.max(r.oldHeightEx,r.newHeightEx),r}(e.width,e.height,n,i);let o,s;a.width=t.oldWidthEx>t.newWidthEx?Math.pow(2,t.oldWidthEx):n,a.height=t.oldHeightEx>t.newHeightEx?Math.pow(2,t.oldHeightEx):i,r.getContext("2d").save(),a.getContext("2d").save();let l=r,c=a;o=t.oldWidthEx,s=t.oldHeightEx;let h=c.getContext("2d");h.imageSmoothingEnabled=!0,h.imageSmoothingQuality="high",h.globalCompositeOperation="copy",h.drawImage(e,0,0,c.width,c.height);let u=c.width,d=c.height;for(;o>t.newWidthEx||s>t.newHeightEx;o--,s--){h=l.getContext("2d"),h.imageSmoothingEnabled=!0,h.imageSmoothingQuality="high",h.globalCompositeOperation="copy";const e=o>t.newWidthEx?u/2:u,n=s>t.newHeightEx?d/2:d;l.width=e,l.height=n,h.drawImage(c,0,0,u,d,0,0,e,n),u=e,d=n;const i=l;l=c,c=i}e.width=n,e.height=i;const p=e.getContext("2d");p.save(),p.imageSmoothingEnabled=!0,p.imageSmoothingQuality="high",p.drawImage(c,0,0,u,d,0,0,n,i),p.restore(),r.getContext("2d").restore(),a.getContext("2d").restore()}else if(n>=e.width&&i>=e.height){(r=r||Ff()).width=n,r.height=i;const t=r.getContext("2d");t.save(),t.imageSmoothingEnabled=!0,t.imageSmoothingQuality="high",t.drawImage(e,0,0,n,i),t.restore(),e.width=n,e.height=i,e.getContext("2d").drawImage(r,0,0)}else t(e,n,e.height,r,a),t(e,n,i,r,a)},convertToAlphaChannelCanvas:function(t){const e=t.getContext("2d").getImageData(0,0,t.width,t.height);for(let t=0;t<e.data.length;t+=4)0!==e.data[t+3]&&(e.data[t+3]=(e.data[t]+e.data[t+1]+e.data[t+2])/3*(e.data[t+3]/255));t.getContext("2d").putImageData(e,0,0)},HSV:Mm,RGB:Im,CMYK:km,ColorConverter:Tm,testIsWhiteBestContrast:function(t){return.299*t.r+.587*t.g+.114*t.b<125},appendTextDiv:function(t,e){const n=document.createElement("div");return n.innerHTML=e,t.appendChild(n),n},clearSelection:function(){if(window.getSelection){const t=window.getSelection();t&&(t.empty?t.empty():t.removeAllRanges&&t.removeAllRanges())}else"selection"in document&&document.selection.empty()},makeUnfocusable:Rm,el:function(t){const e=document.createElement(t.tagName?t.tagName:"div");t.css&&$f(e,t.css),t.content&&("string"==typeof t.content?e.innerHTML=t.content:Array.isArray(t.content)?Om.append(e,t.content):e.appendChild(t.content)),t.textContent&&(e.textContent=t.textContent),t.className&&(e.className=t.className),t.id&&(e.id=t.id),t.parent&&t.parent.appendChild(e),"title"in t&&void 0!==t.title&&(e.title=t.title);const n=[];if("onClick"in t&&(qf(e,"click",t.onClick),n.push(["click",t.onClick])),"onChange"in t&&(qf(e,"change",t.onChange),n.push(["change",t.onChange])),n.length>0&&Lm.push({el:e,listeners:n}),"custom"in t){const n=Object.keys(t.custom);for(let i=0;i<n.length;i++)e.setAttribute(n[i],t.custom[n[i]])}return e},destroyEl:function(t){for(let e=0;e<Lm.length;e++){const n=Lm[e];if(n.el===t)return n.listeners.forEach((e=>{t.removeEventListener(e[0],e[1])})),void Lm.splice(e,1)}},isInputFocused:function(t=!1){let e=document.activeElement&&["INPUT","TEXTAREA"].includes(document.activeElement.tagName);return t?e:e&&!document.activeElement.getAttribute("data-ignore-focus")},addEventListener:qf,removeEventListener:Zf,setEventListener:function(t,e,n){Xf||(e=e.replace("pointer","mouse")),t[e]=n},KeyListener:class{isPressed(t){if(!(t in tm.getIsDown()))throw'key "'+t+'" not found';return tm.getIsDown()[t]}getComboStr(){return tm.getCombo().join("+")}comboOnlyContains(t){for(let e=0;e<tm.getCombo().length;e++)if(!t.includes(tm.getCombo()[e]))return!1;return!0}destroy(){tm.remove(this.ref)}constructor(t){this.onDown=t.onDown,this.onUp=t.onUp,this.onBlur=t.onBlur,this.ref=[this.onDown,this.onUp,this.onBlur],tm.add(this.ref)}},PointerListener:lm,sameKeys:function(t,e){return t.split("+").sort().join("+")===e.split("+").sort().join("+")},EventChain:cm};let Dm=!1;class Bm{pause(t){}addListener(t){}push(t){}undo(){return[]}redo(){return[]}getAll(){return[]}canRedo(){return!1}canUndo(){return!1}getState(){return 0}getActionNumber(){return 0}}const zm=new class{broadcast(t){setTimeout((()=>{for(let e=0;e<this.listeners.length;e++)this.listeners[e](t);this.state++}),1)}pause(t){!1===t?this.pauseStack=Math.max(0,this.pauseStack-1):this.pauseStack++}addListener(t){this.listeners.push(t)}push(t){if(this.pauseStack>0)return;for(;this.actionNumber<this.dataArr.length-1;)this.dataArr.pop();const e=this.dataArr[this.dataArr.length-1];if("layerOpacity"===t.action&&e&&"layerOpacity"===e.action&&e.params[0]===t.params[0])return this.dataArr[this.dataArr.length-1]=t,void this.state++;if("focusLayer"===t.action&&e&&"focusLayer"===e.action)return this.dataArr[this.dataArr.length-1]=t,void this.state++;this.dataArr[this.dataArr.length]=t,this.actionNumber=this.dataArr.length-1;const n=this.maxState;this.maxState=Math.max(this.maxState,this.actionNumber-this.max),n<this.maxState?this.broadcast({bufferUpdate:this.dataArr[this.maxState]}):this.broadcast(null),this.maxState>=0&&(this.dataArr[this.maxState]=null)}undo(){let t;if(this.canUndo()){t=[];for(let e=this.maxState+1;e<this.actionNumber;e++)t.push(this.dataArr[e]);this.actionNumber--,this.broadcast(null)}return t}redo(){const t=[];return this.canRedo()&&(this.actionNumber++,t.push(this.dataArr[this.actionNumber]),this.broadcast(null)),t}getAll(){return[].concat(this.dataArr)}canRedo(){return this.actionNumber<this.dataArr.length-1}canUndo(){return this.actionNumber>this.maxState}getState(){return this.state}getActionNumber(){return this.actionNumber+1}constructor(){if(this.max=20,Dm)throw new Error("klHistory already instantiated");Dm=!0,this.state=0,this.dataArr=[],this.listeners=[],this.pauseStack=0,this.maxState=-1,this.actionNumber=-1}};const jm=new class{emit(){this.listeners.forEach((t=>{t(this.count)}))}increase(t){void 0!==t?this.count+=t:this.count++,this.emit()}decrease(t){void 0!==t?this.count-=t:this.count--,this.emit()}get(){return this.count}subscribe(t){this.listeners.push(t)}constructor(){this.listeners=[],this.count=0}};var Hm;Hm=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("iDK6N");var _m;_m=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("8gElo");const Fm=n(JSON.parse('{"switch-ui-left-right":"Switch left/right UI","toggle-show-tools":"Show/Hide Tools","scroll":"Scroll","donate":"Donate","home":"Home","modal-new-tab":"Open in new tab","tab-layers":"Layers","tab-edit":"Edit","tab-file":"File","tool-brush":"Brush","tool-paint-bucket":"Paint Bucket","tool-shape":"Shape","tool-text":"Text","tool-hand":"Hand Tool","tool-zoom":"Zoom","tool-undo-redo":"Undo / Redo","undo":"Undo","redo":"Redo","brush-pen":"Pen","brush-blend":"Blend","brush-sketchy":"Sketchy","brush-pixel":"Pixel","brush-chemy":"Chemy","brush-smudge":"Smudge","brush-size":"Size","brush-blending":"Blending","brush-toggle-pressure":"Toggle Pressure Sensitivity","brush-lock-alpha":"Lock Alpha","brush-lock-alpha-title":"Locks layer\'s alpha channel","brush-pen-circle":"Circle","brush-pen-chalk":"Chalk","brush-pen-calligraphy":"Calligraphy","brush-pen-square":"Square","brush-sketchy-scale":"Scale","brush-pixel-dither":"Dither","brush-chemy-fill":"Fill","brush-chemy-stroke":"Stroke","brush-chemy-mirror-x":"Horizontal Symmetry","brush-chemy-mirror-y":"Vertical Symmetry","brush-chemy-gradient":"Gradient","brush-eraser-transparent-bg":"Transparent Background","stabilizer":"Stabilizer","stabilizer-title":"Stroke Stabilizer","eyedropper":"Eyedropper","secondary-color":"Secondary Color","manual-color-input":"Manual Color Input","mci-hex":"Hex","mci-copy":"Copy","modal-ok":"Ok","modal-cancel":"Cancel","modal-close":"Close","layers-active-layer":"Active Layer","layers-layer":"Layer","layers-copy":"copy","layers-blending":"Blending","layers-new":"New Layer","layers-remove":"Remove Layer","layers-duplicate":"Duplicate Layer","layers-merge":"Merge with layer below","layers-rename":"Rename","layers-blend-normal":"normal","layers-blend-darken":"darken","layers-blend-multiply":"multiply","layers-blend-color-burn":"color burn","layers-blend-lighten":"lighten","layers-blend-screen":"screen","layers-blend-color-dodge":"color dodge","layers-blend-overlay":"overlay","layers-blend-soft-light":"soft light","layers-blend-hard-light":"hard light","layers-blend-difference":"difference","layers-blend-exclusion":"exclusion","layers-blend-hue":"hue","layers-blend-saturation":"saturation","layers-blend-color":"color","layers-blend-luminosity":"luminosity","layers-rename-title":"Rename Layer","layers-rename-name":"Name","layers-rename-clear":"Clear Name","layers-rename-sketch":"Sketch","layers-rename-colors":"Colors","layers-rename-lines":"Lines","layers-rename-foreground":"Foreground","layers-merge-modal-title":"Merge/Mix Layers","layers-merge-description":"Merges the selected layer with the one underneath. Select the mix mode:","file-no-autosave":"No autosave, no cloud storage","file-new":"New","file-import":"Import","file-save":"Save","file-save-png":"Save PNG","file-save-psd":"Save PSD","file-save-layers":"Save Layers","file-copy":"Copy","file-copy-title":"Copy To Clipboard","file-share":"Share","file-storage":"Browser Storage","file-storage-thumb-title":"Restores when reopening page","file-storage-about":"About Browser Storage","file-storage-cant-access":"Can\'t access","file-storage-empty":"Empty","file-storage-store":"Store","file-storage-clear":"Clear","file-storage-storing":"Storing","file-storage-overwrite":"Overwrite","file-storage-min-ago":"{x}min ago","file-storage-hours-ago":"{x}h ago","file-storage-days-ago":"{x}d ago","file-storage-month-ago":"> 1month ago","file-storage-restored":"Restored from Browser Storage","file-storage-stored":"Stored to Browser Storage","file-storage-failed":"Failed to store to Browser Storage","file-storage-failed-1":"Failed to store. Possible causes:","file-storage-failed-2":"Out of disk space","file-storage-failed-3":"Storage disabled in incognito tab","file-storage-failed-4":"Browser doesn\'t support storage","file-storage-failed-clear":"Failed to clear.","file-upload":"Upload","cleared-layer":"Cleared layer","filled":"Filled","new-title":"New Image","new-current":"Current","new-fit":"Fit","new-oversize":"Oversize","new-square":"Square","new-landscape":"Landscape","new-portrait":"Portrait","new-screen":"Screen","new-video":"Video","new-din-paper":"DIN Paper","new-px":"px","new-ratio":"Ratio","upload-title":"Upload to Imgur","upload-link-notice":"Anyone with the link to your uploaded image will be able to view it.","upload-name":"Title","upload-title-untitled":"Untitled","upload-caption":"Caption","upload-tos":"Terms of Service","upload-tos-2":"for imgur.com","upload-submit":"Upload","upload-uploading":"Uploading...","upload-success":"Upload Successful","upload-failed":"Upload failed.","upload-delete":"To delete your image from Imgur visit:","cropcopy-title-copy":"Copy To Clipboard","cropcopy-title-crop":"Crop","cropcopy-btn-copy":"To Clipboard","cropcopy-copied":"Copied.","cropcopy-btn-crop":"Apply Crop","crop-drag-to-crop":"Drag to crop","filter-crop-extend":"Crop/Extend","filter-flip":"Flip","filter-perspective":"Perspective","filter-resize":"Resize","filter-rotate":"Rotate","filter-transform":"Transform","filter-bright-contrast":"Bright/Contrast","filter-curves":"Curves","filter-hue-sat":"Hue/Saturation","filter-invert":"Invert","filter-tilt-shift":"Tilt Shift","filter-to-alpha":"To Alpha","filter-triangle-blur":"Triangle Blur","filter-unsharp-mask":"Unsharp Mask","filter-crop-title":"Crop / Extend","filter-crop-description":"Crop or extend the image.","filter-crop-left":"Left","filter-crop-right":"Right","filter-crop-top":"Top","filter-crop-bottom":"Bottom","filter-crop-rule-thirds":"Rule of Thirds","filter-crop-fill":"Fill","filter-flip-title":"Flip","filter-flip-description":"Flips layer or whole image.","filter-flip-horizontal":"Horizontal","filter-flip-vertical":"Vertical","filter-flip-image":"Flip Image","filter-flip-layer":"Flip Layer","filter-perspective-title":"Perspective","filter-perspective-description":"Transforms the selected layer.","filter-perspective-before":"Before","filter-perspective-after":"After","filter-resize-title":"Resize","filter-resize-description":"Resizes the image.","filter-rotate-title":"Rotate","filter-rotate-description":"Rotates the image.","filter-transform-empty":"Layer is empty.","filter-transform-title":"Transform","filter-transform-description":"Transforms selected layer. Hold Shift for additional behavior.","filter-transform-rotation":"Rotation","filter-transform-flip":"Flip","filter-transform-center":"Center","filter-transform-constrain":"Constrain","filter-transform-snap":"Snap","filter-transform-snap-title":"Snap Rotation And Position","filter-bright-contrast-title":"Brightness / Contrast","filter-bright-contrast-description":"Change brightness and contrast for the selected layer.","filter-bright-contrast-brightness":"Brightness","filter-bright-contrast-contrast":"Contrast","filter-curves-title":"Curves","filter-curves-description":"Apply curves on the selected layer.","filter-curves-all":"All","filter-hue-sat-title":"Hue / Saturation","filter-hue-sat-description":"Change hue and saturation for the selected layer.","filter-hue-sat-hue":"Hue","filter-hue-sat-saturation":"Saturation","filter-applied":"applied","filter-tilt-shift-title":"Tilt Shift","filter-tilt-shift-description":"Applies tilt shift on the selected layer.","filter-tilt-shift-blur":"Blur Radius","filter-tilt-shift-gradient":"Gradient Radius","filter-to-alpha-title":"To Alpha","filter-to-alpha-description":"Generates alpha channel for selected layer from:","filter-to-alpha-inverted-lum":"Inverted Luminance","filter-to-alpha-lum":"Luminance","filter-to-alpha-replace":"Replace RGB","filter-triangle-blur-title":"Triangle Blur","filter-triangle-blur-description":"Applies triangle blur on the selected layer.","filter-unsharp-mask-title":"Unsharp Mask","filter-unsharp-mask-description":"Sharpens the selected layer by scaling pixels away from the average of their neighbors.","filter-unsharp-mask-strength":"Strength","import-opening":"Opening file...","import-title":"Import Image","import-too-large":"Image too large, will be downscaled.","import-btn-as-layer":"As Layer","import-btn-as-image":"As Image","import-as-layer-title":"Import Image as New Layer","import-as-layer-description":"Adjust the position of the imported image.","import-as-layer-limit-reached":"Layer limit reached. Image will be placed on existing layer.","import-as-layer-fit":"Fit","import-flatten":"Flatten image","import-unsupported-file":"Unsupported file type. See Help for supported types.","import-broken-file":"Couldn\'t load image. File might be corrupted.","import-psd-unsupported":"Unsupported features. PSD had to be flattened.","import-psd-limited-support":"PSD support is limited. Flattened will more likely look correct.","import-psd-too-large":"Image exceeds maximum dimensions of {x} x {x} pixels. Unable to import.","import-psd-size":"Image size","hand-reset":"Reset","hand-fit":"Fit","bucket-tolerance":"Tolerance","bucket-sample":"Sample","bucket-sample-title":"Which layers to sample color from","bucket-sample-all":"All","bucket-sample-active":"Active","bucket-sample-above":"Above","bucket-grow":"Grow","bucket-grow-title":"Grow filled area (in pixels)","bucket-contiguous":"Contiguous","bucket-contiguous-title":"Only fill connected areas","shape-stroke":"Stroke","shape-fill":"Fill","shape-rect":"Rectangle","shape-ellipse":"Ellipse","shape-line":"Line","shape-line-width":"Line Width","shape-outwards":"Outwards","shape-fixed":"Fixed 1:1","shape-snap":"Snap","shape-snap-title":"45° Angle Snapping","text-instruction":"Click canvas to place text","text-title":"Add Text","text-placeholder":"Your text (multiline Shift+Enter)","text-color":"Color","text-size":"Size","text-left":"Left","text-center":"Center","text-right":"Right","text-italic":"Italic","text-bold":"Bold","save-reminder-title":"Reminder to save","save-reminder-text":"Unsaved work may get lost.","submit":"Submit","submit-title":"Submit Drawing","submit-prompt":"Submit drawing?","submit-submitting":"Submitting","embed-init-loading":"Loading app","embed-init-waiting":"Waiting for image","unsaved":"Unsaved","help":"Help","tab-settings":"Settings","settings-language":"Language","settings-preferred-language":"Preferred Language","settings-language-reload":"Will update after reloading.","licenses":"Licenses","source-code":"Source Code","auto":"auto","zoom-in":"Zoom In","zoom-out":"Zoom Out","radius":"Radius","constrain-proportions":"Constrain Proportions","width":"Width","height":"Height","opacity":"Opacity","red":"Red","green":"Green","blue":"Blue","eraser":"Eraser","center":"Center","background":"Background","scaling-algorithm":"Scaling Algorithm","algorithm-smooth":"Smooth","algorithm-pixelated":"Pixelated","preview":"Preview"}')),Um=[{code:"en",name:"English"},{code:"de",name:"Deutsch"},{code:"ja",name:"日本語"},{code:"zh-CN",name:"简体中文"}],Nm=async t=>{if("en"===t)return Fm;if("de"===t)return await a("gpPe5");if("ja"===t)return await a("bOQHI");if("zh-CN"===t)return await a("7F5d9");throw new Error("unknown language code")};let Ym="en";{const t=[];(navigator.languages?navigator.languages:[navigator.language]).forEach((e=>{const n=e.split("-");t.push(e),2===n.length&&t.push(n[0])}));try{localStorage.getItem("klecks-language")&&t.unshift(localStorage.getItem("klecks-language"))}catch(t){}for(let e=0;e<t.length;e++){const n=t[e];if(Um.find((t=>t.code.toLowerCase()===n.toLowerCase()))){Ym=n;break}}}const Xm=new class{async setLanguage(t){this.data="en"===t?{...Fm}:{...Fm,...await Nm(t)},this.code=t,document.documentElement.setAttribute("lang",t),this.listeners.forEach((t=>{t()}))}get(t){if(!(t in this.data))throw new Error("translation code doesn't exist: "+t);return this.data[t]}getLanguage(){return Um.find((t=>t.code===this.code))}getCode(){return this.code}subscribe(t){this.listeners.includes(t)||this.listeners.push(t)}unsubscribe(t){for(let e=0;e<this.listeners.length;e++)if(t===this.listeners[e])return void this.listeners.splice(e,1)}constructor(){this.listeners=[],this.data={...Fm},this.code="en"}},Vm=(t,e)=>{if(e){let n=Xm.get(t);return Object.keys(e).forEach((t=>{n=n.replace(`{${t}}`,e[t])})),n}return Xm.get(t)};function Wm(t){jm.increase();let e=!1;const i=Om.el({parent:document.body,css:{position:"absolute",left:"0",top:"0",right:"0",bottom:"0",overflow:"hidden"}}),r=Om.el({parent:i,className:"kl-popup"}),a=Om.el({parent:r,css:{width:"100%",minHeight:"100%",position:"relative",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center"}}),o=Om.el({parent:a,onClick:()=>{t.ignoreBackground||m("Cancel")},css:{position:"absolute",left:"0",top:"0",zIndex:"0",width:"100%",height:"100%"}}),s=Om.el({tagName:"button",className:"popup-x",content:`<img alt="${Vm("modal-close")}" height="20" src="${n(_m)}">`,title:Vm("modal-close"),onClick:()=>{m("Cancel")},css:{width:"40px",height:"40px",lineHeight:"40px",position:"absolute",right:"0",top:"0",background:"none",boxShadow:"none"}}),l=["kl-popup-box"];l.push("kl-popup-box--sm");const c=Om.el({content:[s,Om.el({content:t.message,css:{marginBottom:t.div?"10px":null,marginRight:"15px"}}),t.div],className:l.join(" "),css:t.style?t.style:null});a.append(Om.el({css:{flex:"0.5"}}),c,Om.el({css:{flex:"1"}})),"error"===t.type&&Om.addClassName(c,"poperror"),"ok"===t.type&&Om.addClassName(c,"popok"),"warning"===t.type&&Om.addClassName(c,"popwarning"),"upload"===t.type&&Om.addClassName(c,"popupload");const h=new Om.KeyListener({onDown:function(t,n,i){e||(g&&"enter"===i&&!Om.isInputFocused()&&(n.stopPropagation(),setTimeout((function(){g.click()}),10)),"esc"===i&&(n.stopPropagation(),m("Cancel")))}}),u=t=>{h.isPressed("ctrl")&&t.preventDefault()};Om.addEventListener(r,"wheel",u),r.onclick=Om.handleClick;let d=null;d=t.autoFocus?t.autoFocus:!1===t.autoFocus?null:"Ok";const p=t.buttons&&t.buttons.length>0?Om.el({parent:c,css:{display:"flex",flexWrap:"wrap",justifyContent:"flex-end",marginTop:"12px",marginLeft:"-8px"}}):null;let g;const f=[];function m(n){e||(e=!0,Om.clearSelection(),document.body.removeChild(i),jm.decrease(),Om.destroyEl(s),Om.destroyEl(o),h.destroy(),Om.removeEventListener(r,"wheel",u),r.onclick=null,f.forEach((t=>{Om.destroyEl(t)})),f.splice(0,f.length),t.callback&&t.callback(n))}t.buttons&&t.buttons.forEach((e=>{const i=["kl-popup__btn"];let a;("Ok"===e||t.primaries&&t.primaries.includes(e))&&i.push("kl-button-primary");let o=e;"Ok"===e&&(o=Vm("modal-ok"),a=n(Hm)),"Cancel"===e&&(o=Vm("modal-cancel"),a=n(_m));let s=null;a&&(s=Om.el({tagName:"img",custom:{src:a,height:"17"}}));const l=Om.el({parent:p,tagName:"button",className:i.join(" "),content:[s,o],onClick:()=>{m(e)}});f.push(l),d===e&&(setTimeout((()=>{l.focus(),r.scrollTo(0,0)}),10),setTimeout((()=>{r.scrollTo(0,0)}),20)),e===t.clickOnEnter&&(g=l)})),t.closefunc&&t.closefunc((function(){m("Cancel")}))}window.onscroll=t=>{t.preventDefault()};const Km=function(t){jm.increase();const e=document.body,i=Om.el({parent:e,className:"g-root",css:{position:"fixed",left:"0",top:"0",bottom:"0",right:"0",background:"rgba(0, 0, 0, 0.45)",overflow:"auto",animationName:"consoleIn",animationDuration:"0.3s",animationTimingFunction:"ease-out"}});function r(){jm.decrease(),i.onclick=null,e.removeChild(i),clearInterval(undefined),window.removeEventListener("resize",s),u.destroy(),Om.destroyEl(c),Om.destroyEl(a),t.onClose&&t.onClose()}i.onclick=Om.handleClick;const a=Om.el({parent:i,css:{position:"absolute",left:"0",top:"0",bottom:"0",right:"0"},onClick:r}),o=Om.el({parent:i,css:{position:"absolute",width:Om.isCssMinMaxSupported()?"min(calc(100% - 40px), "+(t.width?t.width:400)+"px)":(t.width?t.width:400)+"px",height:"calc(100% - 40px)",background:"#eee",borderRadius:"10px",overflow:"hidden",boxShadow:"rgba(0, 0, 0, 0.25) 0px 5px 60px"}});function s(){const t=o.offsetWidth,e=o.offsetHeight;Om.css(o,{left:Math.max(0,(window.innerWidth-t)/2)+"px",top:Math.max(20,(window.innerHeight-e)/2-.2*e)+"px"})}s(),window.addEventListener("resize",s);const l=Om.el({parent:o,css:{height:"40px",display:"flex",justifyContent:"space-between",alignItems:"center",paddingLeft:"20px"}});t.title&&l.appendChild(t.title);const c=Om.el({parent:l,tagName:"button",className:"popup-x",content:`<img alt="${Vm("modal-close")}" height="20" src="${n(_m)}">`,title:Vm("modal-close"),onClick:r,css:{width:"40px",height:"40px",lineHeight:"40px",background:"none",boxShadow:"none"},custom:{tabindex:"0"}}),h=Om.el({parent:o,css:{height:"calc(100% - 40px)"}});t.content&&h.appendChild(t.content);const u=new Om.KeyListener({onDown:function(t,e){"esc"===t&&(e.stopPropagation(),r())}});this.close=function(){r()}};class Gm{getValue(){return this.check.checked}getElement(){return this.element}destroy(){this.check.onchange=null}constructor(t){this.element=Om.el({className:"kl-checkbox"});const e=Om.el({parent:this.element,tagName:"label",className:"kl-checkbox__inner"});this.check=Om.el({parent:e,tagName:"input",css:{marginLeft:"0",display:"inline-block"},custom:{type:"checkbox"}}),this.check.checked=t.init,t.doHighlight&&this.check.checked&&Om.addClassName(this.element,"kl-checkbox--highlight"),t.allowTab||(this.check.tabIndex=-1),t.title&&(e.title=t.title);const n=document.createElement("div");n.style.display="inline-block",n.innerHTML=t.label,n.allowClick=!0,e.appendChild(n),this.check.onchange=()=>{t.doHighlight&&(this.check.checked?Om.addClassName(this.element,"kl-checkbox--highlight"):Om.removeClassName(this.element,"kl-checkbox--highlight")),t.callback(this.check.checked),setTimeout((()=>{this.check.blur()}),0)},t.css&&Om.css(this.element,t.css)}}const qm=function(t){const e=document.createElement("input");if(t.type)try{e.type=t.type}catch(t){}else e.type="text";return void 0!==t.min&&(e.min=""+t.min),void 0!==t.max&&(e.max=""+t.max),e.value=""+t.init,t.callback&&(e.onchange=function(){t.callback(e.value)}),t.css&&Om.css(e,t.css),e};class Zm{setValue(t){this.selectEl.value=t}getValue(){return this.selectEl.value}setDeltaValue(t){let e=0;for(let t=0;t<this.optionArr.length;t++)if(""+this.optionArr[t][0]===this.selectEl.value){e=t;break}e=Math.max(0,Math.min(this.optionArr.length-1,e+t)),this.selectEl.value=this.optionArr[e][0],this.onChange(this.selectEl.value)}getElement(){return this.selectEl}constructor(t){this.destroy=()=>{this.selectEl.removeEventListener("change",this.changeListener)},this.selectEl=Om.el({tagName:"select",title:t.title,css:{cursor:"pointer",fontSize:"15px",padding:"3px",background:"#fff",colorScheme:"only light"}}),t.css&&Om.css(this.selectEl,t.css);const e=t.isFocusable;e||(this.selectEl.tabIndex=-1),this.optionArr=t.optionArr;for(let t=0;t<this.optionArr.length;t++){if(null===this.optionArr[t])continue;const e=document.createElement("option");e.value=this.optionArr[t][0],e.textContent=this.optionArr[t][1],this.selectEl.append(e)}this.onChange=t.onChange,this.changeListener=t=>{e||this.selectEl.blur(),this.onChange(this.selectEl.value)},this.selectEl.addEventListener("change",this.changeListener),this.selectEl.value="initValue"in t?t.initValue:null}}const $m=function(t){let e=!!t.initValue;const n=Om.el({className:"image-toggle",title:t.title,css:{backgroundImage:"url('"+t.image+"')"},onClick:function(n){n.preventDefault(),t.isRadio&&e||(e=!e,i(),t.onChange(e))}});function i(){e?Om.addClassName(n,"image-toggle-active"):Om.removeClassName(n,"image-toggle-active")}i(),this.setValue=function(t){e=!!t,i()},this.getElement=function(){return n},this.getValue=function(){return e}},Jm=function(t){const e=Om.el({className:"image-radio-wrapper",css:{display:"flex"}});let n;const i=[];function r(r,a){a.id===t.initId&&(n=r);const o=new $m({image:a.image,title:a.title,initValue:a.id===t.initId,isRadio:!0,onChange:function(){!function(e,r){n=e;for(let t=0;t<i.length;t++)i[t].setValue(t===n);t.onChange(r)}(r,a.id)}});return e.appendChild(o.getElement()),o}for(let e=0;e<t.optionArr.length;e++)i.push(r(e,t.optionArr[e]));this.getElement=function(){return e},this.getValue=function(){return t.optionArr[n].id}};var Qm;Qm=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("kav7s");const ty=function(t,e){const i=Om.el({css:{cssFloat:"right",borderRadius:"3px",width:"18px",height:"18px",backgroundImage:'url("'+n(Qm)+'")',backgroundSize:"contain",backgroundRepeat:"no-repeat",cursor:"pointer",boxSizing:"border-box",colorScheme:"only light"}});function r(){t?Om.css(i,{backgroundColor:"#fff",opacity:"0.9",border:"1px solid var(--active-highlight-color)"}):Om.css(i,{backgroundColor:"transparent",opacity:"0.5",border:"1px solid #666"})}return Om.hasPointerEvents||(i.style.display="none"),i.title=Vm("brush-toggle-pressure"),i.onclick=function(){t=!t,r(),e(t)},r(),e(t),i},ey=function(t,e){let n=Math.min(10,1+Math.pow(Math.floor(t/50),2));return e&&(n*=2),1/n},ny=function(t){const e=this;let n,i=!1!==t.isEnabled,r=!!t.curve;if(!t.label||!t.onChange)throw"PcSlider missing params";if(!(0==t.min||0==t.max||0==t.initValue||t.min&&t.max&&t.initValue))throw"PcSlider broken params";if(t.min>=t.max)throw"PcSlider broken params";const a=t.width,o=t.height,s=t.resolution?t.resolution:a;let l=t.min,c=t.max;const h=t.onChange,u=!!t.isChangeOnFinal,d=t.formatFunc,p=t.eventResMs;if(r){const e="quadratic"===t.curve?Om.quadraticSplineInput(l,c,.1):t.curve;n=new Om.SplineInterpolator(e)}function g(t){return r?n.findX(t,Math.floor(1.5*s)):(t-l)/(c-l)}const f=Om.el({className:"sliderWrapper",css:{overflow:"hidden",position:"relative",width:a+"px",height:o+"px",userSelect:"none"}}),m=t.label,y=document.createElement("div"),x=document.createElement("div"),b=document.createElement("div");let v=g(t.initValue);f.appendChild(x),f.appendChild(y),x.appendChild(b),x.className="sliderInner",f.oncontextmenu=function(){return!1},y.innerHTML=m,x.style.position="absolute",x.style.left="0",x.style.top="0",x.style.width=v*a+"px",x.style.height=o+"px";const w=o-14;function C(){i?Om.css(f,{opacity:null,pointerEvents:null}):Om.css(f,{opacity:"0.5",pointerEvents:"none"})}function S(){let t=l+v*(c-l);return r&&(t=n.interpolate(v)),t}function E(){let t=function(t){let e=l+t*(c-l);return r&&(e=n.interpolate(t)),e}(v);t=d?d(t):parseInt(t),t=t.toLocaleString(Xm.getCode()),y.innerHTML=m+'&nbsp;&nbsp;<span style="font-weight:bold">'+t+"</span>",x.style.width=v*a+"px"}Om.css(y,{position:"absolute",left:"7px",top:o/2-w/2+1+"px",lineHeight:w+"px",fontSize:w+"px",pointerEvents:"none"}),C();let M,I,k=0;function T(t){if(t||!u)if(p&&!t){const t=performance.now();t-k>=p&&(k=t,h(S()))}else h(S())}function R(t){if(t.eventPreventDefault(),i){if("pointerdown"===t.type&&(f.className="sliderWrapper sliderWrapperActive","left"===t.button&&(v=t.relX/a,v=Math.max(0,Math.min(1,v)),E(),T(!1)),M=v),"pointermove"===t.type&&["left","right"].includes(t.button)){let e=t.dX;const n=Math.abs(t.pageY-t.downPageY);e*=ey(n,"right"===t.button),e/=a,M+=e,v=Math.max(0,Math.min(1,M)),E(),T(!1)}"pointerup"===t.type&&(f.className="sliderWrapper",T(!0))}}const L=setTimeout((()=>{I=new Om.PointerListener({target:f,maxPointers:1,fixScribble:!0,onPointer:R,onWheel:function(t){r?(v+=-t.deltaY*(n.getLastX()-n.getFirstX())/40,v=Math.max(n.getFirstX(),Math.min(n.getLastX(),v))):(v+=-t.deltaY/40,v=Math.max(0,Math.min(1,v))),E(),h(S())}}),E()}),1);this.increaseValue=function(t){v=Math.min(1,v+Math.abs(t)),E(),h(S())},this.decreaseValue=function(t){v=Math.max(0,v-Math.abs(t)),E(),h(S())},this.setValue=function(t){v=g(t),E()},this.getValue=function(){return S()},this.update=function(t){if(l=t.min,c=t.max,r=!!t.curve,r){const e="quadratic"===t.curve?Om.quadraticSplineInput(l,c,.1):t.curve;n=new Om.SplineInterpolator(e)}else n=null;e.setIsEnabled(!t.isDisabled)},this.setIsEnabled=function(t){i=!!t,C()},this.destroy=function(){clearTimeout(L),I&&I.destroy()},this.getElement=function(){return f}};var iy;iy=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("43nfB");const ry=function(t){let e=new Om.RGB(t.color.r,t.color.g,t.color.b);const i=Om.el({}),r=Om.el({css:{width:"20px",height:"20px",marginBottom:"10px",boxShadow:"inset 0 0 0 1px #fff, 0 0 0 1px #000",background:"#"+Om.ColorConverter.toHexString(e),colorScheme:"only light"}});i.appendChild(r);const a=Om.el({css:{display:"flex",alignItems:"center",marginBottom:"15px"}}),o=Om.el({content:Vm("mci-hex"),css:{width:"60px"}}),s=qm({init:"#"+Om.ColorConverter.toHexString(e),css:{width:"80px"},callback:function(){let t=Om.ColorConverter.hexToRGB(s.value);null===t?(t=e,s.value="#"+Om.ColorConverter.toHexString(e)):e=t,r.style.background="#"+Om.ColorConverter.toHexString(t);for(let t=0;t<h.length;t++)h[t].update()}}),l=Om.el({tagName:"button",content:'<img src="'+n(iy)+'" height="20"/>',title:Vm("mci-copy"),css:{marginLeft:"10px"},onClick:function(){s.select(),document.execCommand("copy")}});function c(t,n){const a={},o=Om.el({css:{display:"flex",alignItems:"center",marginTop:"5px"}}),l=Om.el({content:t,css:{width:"60px"}}),c=qm({init:e[n],min:0,max:255,type:"number",css:{width:"80px"},callback:function(){""===c.value||parseFloat(c.value)<0||parseFloat(c.value)>255?a.update():(c.value=""+Math.round(parseFloat(c.value)),e[n]=c.value,r.style.background="#"+Om.ColorConverter.toHexString(e),s.value="#"+Om.ColorConverter.toHexString(e))}});return o.appendChild(l),o.appendChild(c),i.appendChild(o),a.update=function(){c.value=e[n]},a}a.appendChild(o),a.appendChild(s),a.appendChild(l),i.appendChild(a),setTimeout((function(){s.focus(),s.select()}),0);const h=[];h.push(c(Vm("red"),"r")),h.push(c(Vm("green"),"g")),h.push(c(Vm("blue"),"b")),Wm({target:document.body,message:`<b>${Vm("manual-color-input")}</b>`,div:i,autoFocus:!1,clickOnEnter:"Ok",buttons:["Ok","Cancel"],callback:function(e){let n=null;"Ok"===e&&(n=Om.ColorConverter.hexToRGB(s.value)),t.onClose(n)}})};var ay;ay=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("9Vqzx");const oy=function(t){const e=document.createElement("div");e.oncontextmenu=function(t){t.preventDefault()};let n=Om.ColorConverter.toHSV(new Om.RGB(t.color.r,t.color.g,t.color.b));Om.css(e,{width:t.width+"px",position:"relative",overflow:"hidden",userSelect:"none"});const i=Om.canvas(10,10);function r(){const t=i.getContext("2d");for(let e=0;e<i.height;e+=1){const r=t.createLinearGradient(0,0,i.width,0),a=Om.ColorConverter.toRGB(new Om.HSV(n.h,1,100-e/i.height*100)),o=Om.ColorConverter.toRGB(new Om.HSV(n.h,100,100-e/i.height*100));r.addColorStop(0,"#"+Om.ColorConverter.toHexString(a)),r.addColorStop(1,"#"+Om.ColorConverter.toHexString(o)),t.fillStyle="#ff0000",t.fillStyle=r,t.fillRect(0,e,i.width,1)}}i.style.width=t.width+"px",i.style.height=t.heightSV+"px",i.style.cursor="crosshair",r();const a=Om.canvas(t.width,t.heightH);a.style.cursor="ew-resize",function(){const e=a.getContext("2d"),n=e.createLinearGradient(0,0,t.width,0);for(let t=0;t<1;t+=.01){const e=Om.ColorConverter.toRGB(new Om.HSV(360*t,100,100));n.addColorStop(t,"rgba("+parseInt(""+e.r)+", "+parseInt(""+e.g)+", "+parseInt(""+e.b)+", 1)")}e.fillStyle=n,e.fillRect(0,0,t.width,t.heightH)}(),Om.css(i,{width:t.width+"px",height:t.heightSV+"px",overflow:"hidden",position:"relative"}),i.style.cssFloat="left",a.style.cssFloat="left",e.appendChild(i),e.appendChild(a);const o=document.createElement("div");Om.css(o,{width:"8px",height:"8px",borderRadius:"8px",position:"absolute",pointerEvents:"none",boxShadow:"0 0 0 1px #000, inset 0 0 0 1px #fff"}),e.appendChild(o);const s=document.createElement("div");function l(){const e=n.s/100*t.width-4,i=(1-n.v/100)*t.heightSV-4;Om.css(o,{left:e+"px",top:i+"px"})}function c(){s.style.left=n.h/359.999*t.width-1+"px"}Om.css(s,{width:"0",height:t.heightH+"px",borderLeft:"1px solid #fff",borderRight:"1px solid #000",position:"absolute",top:t.heightSV+"px",pointerEvents:"none"}),e.appendChild(s),l(),c();const h={h:0,s:0,v:0};let u=null;const d=new Om.PointerListener({target:i,maxPointers:1,fixScribble:!0,onPointer:function(e){if("pointerdown"===e.type&&(u=e.pointerId,"left"===e.button?(h.s=e.relX/t.width*100,h.v=100-e.relY/t.heightSV*100,n=new Om.HSV(n.h,h.s,h.v),l(),t.callback(Om.ColorConverter.toRGB(n))):(h.s=n.s,h.v=n.v)),"pointermove"===e.type&&["left","right"].includes(e.button)&&u===e.pointerId){let i=1;"right"===e.button&&(i=.5),h.s+=e.dX/t.width*100*i,h.v-=e.dY/t.heightSV*100*i,n=new Om.HSV(n.h,h.s,h.v),l(),t.callback(Om.ColorConverter.toRGB(n))}"pointerup"===e.type&&(u=null)}});let p=null;const g=new Om.PointerListener({target:a,maxPointers:1,fixScribble:!0,onPointer:function(e){if("pointerdown"===e.type&&(p=e.pointerId,"left"===e.button?(h.h=e.relX/t.width*359.99,n=new Om.HSV(h.h,n.s,n.v),r(),c(),t.callback(Om.ColorConverter.toRGB(n))):h.h=n.h),"pointermove"===e.type&&["left","right"].includes(e.button)&&p===e.pointerId){const i=Math.abs(e.pageY-e.downPageY),a=ey(i,"right"===e.button);h.h+=e.dX/t.width*359.99*a,"right"===e.button&&(h.h=h.h%359.99,h.h<0&&(h.h+=359.99)),h.h=Math.min(359.99,h.h),n=new Om.HSV(h.h,n.s,n.v),r(),c(),t.callback(Om.ColorConverter.toRGB(n))}"pointerup"===e.type&&(p=null)}}),f=document.createElement("div");f.style.clear="both",e.appendChild(f),this.setColor=function(t){n=Om.ColorConverter.toHSV(new Om.RGB(t.r,t.g,t.b)),r(),l(),c()},this.getColor=function(){return Om.ColorConverter.toRGB(n)},this.getElement=function(){return e},this.destroy=function(){d.destroy(),g.destroy()},this.end=function(){u=null,p=null}},sy=function(t){const e=document.createElement("div");e.style.position="relative";const n=Om.el({}),i=Om.el({css:{colorScheme:"only light"}});let r;e.appendChild(n),e.appendChild(i);let a=!1;Om.css(n,{marginTop:parseInt(""+(t.pointSize/2-1))+"px",height:"2px",background:"#aaa",width:t.width+"px"});Om.el({parent:i,css:{margin:"-7px 0 0 -7px",width:"calc(100% + 14px)",height:"calc(100% + 7px)"}});function o(){i.style.left=r+"px",i.style.boxShadow=a?"0 0 6px rgba(0,0,0,1)":"0 0 3px rgba(0,0,0,0.8)"}function s(){return r/(t.width-t.pointSize)}let l;{let e,n;r=Om.clamp(t.init*(t.width-t.pointSize),0,t.width-t.pointSize),Om.css(i,{position:"absolute",top:"0px",backgroundColor:"#eaeaea",boxShadow:"0 0 3px rgba(0,0,0,0.8)",width:t.pointSize+"px",height:t.pointSize+"px",borderRadius:t.pointSize+"px",cursor:"ew-resize",transition:"box-shadow 0.2s ease-in-out"}),o(),l=new Om.PointerListener({target:i,fixScribble:!0,onPointer:function(i){"pointerdown"===i.type&&"left"===i.button?(e=!0,a=!0,n=r,o(),i.eventStopPropagation()):"pointermove"===i.type&&"left"===i.button&&(i.eventStopPropagation(),n+=i.dX,r=parseInt(""+Om.clamp(n,0,t.width-t.pointSize)),o(),t.callback(s(),e,!1),e=!1),"pointerup"===i.type&&(i.eventStopPropagation(),a=!1,o(),t.callback(s(),!1,!0))}})}this.getEl=function(){return e},this.setActive=function(t){i.style.backgroundColor=t?"#fff":"#eaeaea"},this.destroy=function(){l.destroy()}},ly=function(t){const e=Om.el({content:t.label?t.label:"",css:{display:"flex",alignItems:"center",colorScheme:"only light"}});let n=0;const i=[],r=[],a=Om.createCheckerDataUrl(5);for(let e=0;e<t.colorArr.length;e++){const r=t.colorArr[e];let a=!1;for(let t=0;t<i.length;t++){const e=i[t];if(null!==e&&null!==r&&(e.r===r.r&&e.g===r.g&&e.b===r.b&&e.a===r.a)){a=!0;break}}a||(i.push(r),"initialIndex"in t&&t.initialIndex===e&&(n=i.length-1))}for(let s=0;s<i.length;s++)!function(s){const l=Om.el({content:i[s]?"":"X",css:{width:"22px",height:"22px",backgroundColor:i[s]?Om.ColorConverter.toRgbaStr(i[s]):"transparent",marginLeft:"7px",boxShadow:"0 0 0 1px #aaa",cursor:"pointer",userSelect:"none",textAlign:"center",lineHeight:"23px",color:"#aaa"}});i[s]&&0===i[s].a&&(l.style.backgroundImage="url("+a+")"),l.onclick=function(e){e.preventDefault(),n=s,o(),t.onChange(i[s])},l.setIsSelected=function(t){t?Om.css(l,{boxShadow:"0 0 0 2px var(--active-highlight-color), 0 0 5px 0 var(--active-highlight-color)",pointerEvents:"none"}):Om.css(l,{boxShadow:"0 0 0 1px #aaa",pointerEvents:""})},e.appendChild(l),r.push(l)}(s);function o(){for(let t=0;t<r.length;t++)r[t].setIsSelected(t===n)}o(),this.getElement=function(){return e},this.destroy=()=>{r.forEach((t=>{t.onclick=null})),r.splice(0,r.length)}},cy=function(t){const e=Om.el({}),n=Om.el({parent:e,className:"kl-option-wrapper",css:{display:"flex"}}),i=[];let r="initialId"in t?t.initialId:t.optionArr[0].id;function a(e){const a={id:e.id,el:null},s=["kl-option"];t.isSmall&&s.push("kl-option--small"),"string"!=typeof e.label&&(s.push("kl-option--custom-el"),Om.css(e.label,{display:"block",pointerEvents:"none"})),a.el=Om.el({parent:n,content:e.label,className:s.join(" "),onClick:function(){r!==a.id&&(r=a.id,o(),t.onChange(r))}}),e.title&&(a.el.title=e.title),i.push(a)}function o(){for(let t=0;t<i.length;t++)i[t].id===r?Om.addClassName(i[t].el,"kl-option-selected"):Om.removeClassName(i[t].el,"kl-option-selected")}for(let e=0;e<t.optionArr.length;e++)a(t.optionArr[e]);function s(){for(let t=0;t<i.length;t++)if(i[t].id===r)return t}o(),t.changeOnInit&&setTimeout((function(){t.onChange(r)}),0),this.getElement=function(){return e},this.getValue=function(){return r},this.next=function(){r=i[(s()+1)%i.length].id,o(),t.onChange(r)},this.previous=function(){r=i[(i.length+s()-1)%i.length].id,o(),t.onChange(r)},this.destroy=()=>{i.forEach((t=>{Om.destroyEl(t.el)})),i.splice(0,i.length)}};var hy;hy=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("vALcr");function uy(t){const e=document.createElement("div");let n;function i(){n={x:0,y:0,width:t.canvas.width,height:t.canvas.height}}function r(){o.width=Math.round(n.width),o.height=Math.round(n.height),o.getContext("2d").drawImage(t.canvas,Math.round(-n.x),Math.round(-n.y)),l&&(l.src=o.toDataURL("image/png")),t.onChange&&t.onChange(o.width,o.height)}function a(){Om.css(y,{left:f+n.x*d+"px",top:m+n.y*p+"px",width:n.width*d+"px",height:n.height*p+"px"}),t.onChange&&t.onChange(Math.round(n.width),Math.round(n.height))}Om.css(e,{position:"relative",height:t.height+"px",width:t.width+"px",overflow:"hidden",colorScheme:"only light"}),e.style.position="relative",i();const o=Om.canvas();let s=o,l=null;t.isNotCopy||(l=new Image,s=l),Om.css(s,{height:t.height+"px",width:t.width+"px"}),e.appendChild(s),r();const c=Om.el({css:{width:t.width+"px",height:t.height+"px",position:"absolute",left:"0",top:"0",pointerEvents:"none"}});e.appendChild(c),Om.createCheckerDataUrl(4,(function(t){c.style.backgroundImage="url("+t+")"}));const h=Om.fitInto(t.canvas.width,t.canvas.height,t.width-40,t.height-40,1),u=Om.canvas(Math.round(h.width),Math.round(h.height));u.style.imageRendering="pixelated";const d=u.width/t.canvas.width,p=u.height/t.canvas.height,g=u.getContext("2d");g.imageSmoothingEnabled=!1,g.drawImage(t.canvas,0,0,u.width,u.height),c.appendChild(u);const f=parseInt(""+(t.width-u.width)/2),m=parseInt(""+(t.height-u.height)/2);Om.css(u,{position:"absolute",left:f+"px",top:m+"px"});const y=Om.el({css:{position:"absolute",boxShadow:"0 0 0 1px #fff, 0 0 0 2px #000, 0 0 40px 1px #000"}});function x(e){return{x:Om.clamp((e.x-f)/d,0,t.canvas.width),y:Om.clamp((e.y-m)/p,0,t.canvas.height)}}function b(t,e){let n={x:Math.min(t.x,e.x),y:Math.min(t.y,e.y)},i={x:Math.max(t.x,e.x),y:Math.max(t.y,e.y)},r=x(n),a=x(i);return r.x=Math.floor(r.x),r.y=Math.floor(r.y),a.x=Math.ceil(a.x),a.y=Math.ceil(a.y),{x:r.x,y:r.y,width:a.x-r.x,height:a.y-r.y}}function v(){return 0===n.x&&0===n.y&&n.width===t.canvas.width&&n.height===t.canvas.height}let w;c.appendChild(y),a();let C,S=null,E=!1,M=!1;const I=new Om.PointerListener({target:s,fixScribble:!0,onPointer:function(e){"pointerdown"===e.type&&"left"===e.button?(e.eventPreventDefault(),E=!0,w={x:e.relX,y:e.relY},!v()&&function(t){let e=Math.round(f+n.x*d),i=Math.round(m+n.y*p),r=Math.round(n.width*d),a=Math.round(n.height*p);return e<=t.x&&t.x<=e+r&&i<=t.y&&t.y<=i+a}(w)?S={x:n.x,y:n.y,width:n.width,height:n.height}:n=b(w,w)):"pointermove"===e.type&&"left"===e.button?(e.eventPreventDefault(),M=!0,S?(n.x=S.x+Math.round((e.relX-w.x)/d),n.y=S.y+Math.round((e.relY-w.y)/p),n.x=Om.clamp(n.x,0,t.canvas.width-n.width),n.y=Om.clamp(n.y,0,t.canvas.height-n.height)):n=b(w,{x:e.relX,y:e.relY}),a()):"pointerup"===e.type&&w&&(e.eventPreventDefault(),E=!1,S=null,w=null,0!==n.width&&0!==n.height&&M||(i(),a()),M=!1,C=setTimeout(r,1))}}),k=new Om.KeyListener({onDown:function(e,i,o){if(E)return;let s=!1,l=Math.max(1,1/d),c=k.isPressed("shift");"left"===e&&(c?n.width=Om.clamp(n.width-l,1,t.canvas.width-n.x):n.x=Om.clamp(n.x-l,0,t.canvas.width-n.width),s=!0),"right"===e&&(c?n.width=Om.clamp(n.width+l,1,t.canvas.width-n.x):n.x=Om.clamp(n.x+l,0,t.canvas.width-n.width),s=!0),"up"===e&&(c?n.height=Om.clamp(n.height-l,1,t.canvas.height-n.y):n.y=Om.clamp(n.y-l,0,t.canvas.height-n.height),s=!0),"down"===e&&(c?n.height=Om.clamp(n.height+l,1,t.canvas.height-n.y):n.y=Om.clamp(n.y+l,0,t.canvas.height-n.height),s=!0),s&&(i.preventDefault(),a(),clearTimeout(C),C=setTimeout(r,100))}});this.getEl=function(){return e},this.reset=function(){i(),r(),a()},this.destroy=function(){s.style.removeProperty("width"),s.style.removeProperty("height"),k.destroy(),I.destroy()},this.isReset=function(){return v()},this.getRect=function(){return JSON.parse(JSON.stringify(n))},this.getCroppedImage=function(){return o}}var dy;dy=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("gShQZ");var py;py=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("ldqtT");var gy;gy=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("apAfQ");var fy;fy=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("dpNT8");var my;function yy(t,e,n,i,r,a){for(let o=n;o<=r;o++)for(let n=i;n<=a;n++)255!==t[n*e+o]&&(t[n*e+o]=254)}let xy,by;function vy(t,e,n,i,r){return xy=n%t+i,by=Math.floor(n/t)+r,xy<0||by<0||xy>=t||by>=e?null:by*t+xy}function wy(t,e,n,i,r,a,o){return null!==o&&255!==e[o]&&((t[4*o]===r[0]&&t[4*o+1]===r[1]&&t[4*o+2]===r[2]&&t[4*o+3]===r[3]||a>0&&Math.abs(t[4*o]-r[0])<=a&&Math.abs(t[4*o+1]-r[1])<=a&&Math.abs(t[4*o+2]-r[2])<=a&&Math.abs(t[4*o+3]-r[3])<=a)&&(e[o]=255,!0))}function Cy(t,e,n,i,r,a,o,s){i=Math.round(i),r=Math.round(r);let l=new Uint8Array(new ArrayBuffer(e*n));return function(t,e,n,i,r,a,o,s,l){let c,h,u,d,p,g,f,m,y,x,b,v,w=[t[4*(a*n+r)],t[4*(a*n+r)+1],t[4*(a*n+r)+2],t[4*(a*n+r)+3]];if(l){let s,l,c=[];for(c.push(a*n+r),e[a*n+r]=255;c.length;)s=c.pop(),l=vy(n,i,s,-1,0),wy(t,e,0,0,w,o,l)&&c.push(l),l=vy(n,i,s,1,0),wy(t,e,0,0,w,o,l)&&c.push(l),l=vy(n,i,s,0,-1),wy(t,e,0,0,w,o,l)&&c.push(l),l=vy(n,i,s,0,1),wy(t,e,0,0,w,o,l)&&c.push(l)}else for(let r=0;r<n*i;r++)wy(t,e,0,0,w,o,r);if(0!==s){for(let t=0;t<n;t++)for(let r=0;r<i;r++)255===e[r*n+t]&&(c=t,h=t,u=r,d=r,p=255!==e[r*n+t-1],g=255!==e[(r-1)*n+t-1],f=255!==e[(r-1)*n+t],m=255!==e[(r-1)*n+t+1],y=255!==e[r*n+t+1],x=255!==e[(r+1)*n+t+1],b=255!==e[(r+1)*n+t],v=255!==e[(r+1)*n+t-1],p&&(c=t-s),p&&g&&f&&(c=t-s,u=r-s),f&&(u=Math.min(u,r-s)),f&&m&&y&&(u=Math.min(u,r-s),h=t+s),y&&(h=Math.max(h,t+1*s)),y&&x&&b&&(h=Math.max(h,t+1*s),d=Math.max(d,r+1*s)),b&&(d=Math.max(d,r+1*s)),b&&v&&p&&(c=Math.min(c,t-1*s),d=Math.max(d,r+1*s)),(p||g||f||m||y||x||b||v)&&yy(e,n,Math.max(0,c),Math.max(0,u),Math.min(n-1,h),Math.min(i-1,d)));for(let t=0;t<n*i;t++)254===e[t]&&(e[t]=255)}}(t,l,e,n,i,r,a,o,s),{data:l}}function Sy(t,e){if(!["rect","ellipse","line"].includes(e.type))throw new Error("unknown shape");{const n=Math.round(e.lineWidth),i=180*e.angleRad/Math.PI;t.save(),e.opacity&&(t.globalAlpha=e.opacity),e.isEraser&&(t.globalCompositeOperation="destination-out"),t.rotate(-e.angleRad),e.fillRgb?t.fillStyle=Om.ColorConverter.toRgbStr(e.fillRgb):e.strokeRgb&&(t.strokeStyle=Om.ColorConverter.toRgbStr(e.strokeRgb),t.lineWidth=n);let r=e.x1,a=e.y1,o=e.x2,s=e.y2;if(e.isAngleSnap){let t=Om.rotate(r,a,e.angleRad/Math.PI*180),n=Om.rotate(o,s,e.angleRad/Math.PI*180),l=Om.pointsToAngleDeg(t,n)+90,c=45*Math.round(l/45),h=Om.rotateAround({x:r,y:a},{x:o,y:s},c-l);o=h.x,s=h.y,(i+c)%90==0&&(Math.round((i-c)/90)%2==0?o=r:s=a)}let l,c,h=r,u=a,d=o-r,p=s-a;if("line"!==e.type&&e.isFixedRatio){let t=Om.rotate(e.x1,e.y1,e.angleRad/Math.PI*180),n=Om.rotate(e.x2,e.y2,e.angleRad/Math.PI*180),i=t.x,l=t.y,c=n.x-t.x,g=n.y-t.y;Math.abs(c)<Math.abs(g)?g=Math.abs(c)*(g<0?-1:1):c=Math.abs(g)*(c<0?-1:1),n.x=i+c,n.y=l+g,t=Om.rotate(t.x,t.y,-e.angleRad/Math.PI*180),n=Om.rotate(n.x,n.y,-e.angleRad/Math.PI*180),r=t.x,a=t.y,o=n.x,s=n.y,h=r,u=a,d=o-r,p=s-a}if(e.isOutwards&&(h-=d,u-=p,d*=2,p*=2,r=h,a=u,o=h+d,s=u+p),"line"===e.type){const i=Math.round(r),h=Math.round(a),u=Math.round(o),d=Math.round(s),p=Math.floor(r),g=Math.floor(a),f=Math.floor(o),m=Math.floor(s);n%2==0?h===d?(l={x:p,y:h},c={x:f,y:d},p<f?c.x+=1:l.x+=1):i===u?(l={x:i,y:g},c={x:u,y:m},g<m?c.y+=1:l.y+=1):(l={x:r,y:a},c={x:o,y:s}):(l={x:p,y:g},c={x:f,y:m},g===m?(p<f?c.x+=1:l.x+=1,l.y+=.5,c.y+=.5):p===f?(g<m?c.y+=1:l.y+=1,l.x+=.5,c.x+=.5):(l.x=r,l.y=a,c.x=o,c.y=s)),l=Om.rotate(l.x,l.y,e.angleRad/Math.PI*180),c=Om.rotate(c.x,c.y,e.angleRad/Math.PI*180),t.beginPath(),t.moveTo(l.x,l.y),t.lineTo(c.x,c.y),t.stroke()}else if("rect"===e.type){const h=Math.floor(r),u=Math.floor(a),d=Math.floor(o),p=Math.floor(s);i%90==0?e.fillRgb?(r%1==0&&(r+=1),a%1==0&&(a+=1),o%1==0&&(o+=1),s%1==0&&(s+=1),l={x:r<o?h:d,y:a<s?u:p},c={x:Math.ceil((r<o?o:r)-l.x),y:Math.ceil((a<s?s:a)-l.y)},c.x=l.x+c.x,c.y=l.y+c.y):n%2==0?(l={x:h,y:u},c={x:d,y:p}):(l={x:h+.5,y:u+.5},c={x:d+.5,y:p+.5}):(l={x:r,y:a},c={x:o,y:s}),l=Om.rotate(l.x,l.y,e.angleRad/Math.PI*180),c=Om.rotate(c.x,c.y,e.angleRad/Math.PI*180),c.x=c.x-l.x,c.y=c.y-l.y,e.fillRgb?t.fillRect(l.x,l.y,c.x,c.y):t.strokeRect(l.x,l.y,c.x,c.y)}else l=Om.rotate(r,a,e.angleRad/Math.PI*180),c=Om.rotate(o,s,e.angleRad/Math.PI*180),h=l.x,u=l.y,d=c.x-l.x,p=c.y-l.y,t.beginPath(),t.ellipse(h+d/2,u+p/2,Math.abs(d/2),Math.abs(p/2),0,0,2*Math.PI),e.fillRgb?t.fill():t.stroke();t.restore()}}function Ey(t,e){let n=""===e.textStr?" ":e.textStr,i=Om.el({css:{position:"fixed",left:"0",top:"0",width:"100000px",fontSize:e.size+"px",lineHeight:e.lineHeight?e.lineHeight+"px":"default"}}),r=Om.el({parent:i,css:{display:"inline-block",textAlign:e.align?e.align:"left",fontFamily:e.font?e.font:"sans-serif",fontSize:e.size+"px",fontWeight:e.isBold?"bold":"normal",fontStyle:e.isItalic?"italic":"normal",lineHeight:e.lineHeight?e.lineHeight+"px":"default",opacity:"0",pointerEvents:"none"}}),a="";for(let t=0;t<n.length;t++)"\n"!==n[t]?a+=n[t].replace("\t","    "):(r.appendChild(Om.el({tagName:"span",textContent:a,css:{whiteSpace:"pre"}})),a="",r.appendChild(Om.el({tagName:"br"})));r.appendChild(Om.el({tagName:"span",textContent:a,css:{whiteSpace:"pre"}})),document.body.appendChild(i);let o={x0:99999999,y0:99999999,x1:0,y1:0};for(let t=0;t<r.children.length;t++){let e=r.children[t];o.x0=Math.min(o.x0,e.offsetLeft),o.y0=Math.min(o.y0,e.offsetTop),o.x1=Math.max(o.x1,e.offsetLeft+e.offsetWidth),o.y1=Math.max(o.y1,e.offsetTop+e.offsetHeight)}let s=t.getContext("2d");s.save();let l=[];e.isItalic&&l.push("italic"),e.isBold&&l.push("bold"),l.push(e.size+"px "+(e.font?e.font:"sans-serif")),s.font=l.join(" "),s.fillStyle=e.color?e.color:"#000";let c=e.x,h=e.y;"right"===e.align&&(c+=-o.x1+o.x0),"center"===e.align&&(c+=(-o.x1+o.x0)/2),s.translate(e.x,e.y),s.rotate(e.angleRad?-e.angleRad:0),s.translate(-e.x,-e.y),s.translate(c,h);for(let t=0;t<r.children.length;t++){let e=r.children[t];s.fillText(e.innerText,e.offsetLeft,e.offsetTop)}return e.isDebug?(s.lineWidth=1,s.strokeRect(0,.85*-e.size,o.x1,o.y1),s.restore(),s.fillRect(e.x-1,e.y-1,2,2)):s.restore(),document.body.removeChild(i),{x:c-e.x,y:h-e.y-.85*e.size,width:o.x1-o.x0,height:o.y1-o.y0}}function My(t,e){let n=Om.canvas(Math.max(1,Math.round(t.width*e)),Math.max(1,Math.round(t.height*e))),i=n.getContext("2d");i.save(),e>1&&(i.imageSmoothingEnabled=!1);for(let e=0;e<t.layers.length;e++)0!==t.layers[e].opacity&&(i.globalAlpha=t.layers[e].opacity,i.globalCompositeOperation=t.layers[e].mixModeStr?t.layers[e].mixModeStr:"source-over",i.drawImage(t.layers[e].image,0,0,n.width,n.height));return i.restore(),n}my=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("5E29d");const Iy=["source-over","darken","multiply","color-burn","lighten","screen","color-dodge","overlay","soft-light","hard-light","difference","exclusion","hue","saturation","color","luminosity"];function ky(t){if(!t)return Vm("layers-blend-normal");const e={"source-over":"layers-blend-normal",darken:"layers-blend-darken",multiply:"layers-blend-multiply","color-burn":"layers-blend-color-burn",lighten:"layers-blend-lighten",screen:"layers-blend-screen","color-dodge":"layers-blend-color-dodge",overlay:"layers-blend-overlay","soft-light":"layers-blend-soft-light","hard-light":"layers-blend-hard-light",difference:"layers-blend-difference",exclusion:"layers-blend-exclusion",hue:"layers-blend-hue",saturation:"layers-blend-saturation",color:"layers-blend-color",luminosity:"layers-blend-luminosity"};if(!(t in e))throw new Error("unknown blend mode");return Vm(e[t])}class Ty{getElement(){return this.rootElement}setSize(t,e){this.rootElement.setAttribute("width",""+t),this.rootElement.setAttribute("height",""+e),this.compass.setAttribute("transform","translate("+t/2+", "+e/2+")")}updateCursor(t){"x"in t&&(this.brushCircleOuter.setAttribute("cx",""+t.x),this.brushCircleInner.setAttribute("cx",""+t.x)),"y"in t&&(this.brushCircleOuter.setAttribute("cy",""+t.y),this.brushCircleInner.setAttribute("cy",""+t.y)),"radius"in t&&(this.brushCircleOuter.setAttribute("r",""+Math.max(0,t.radius)),this.brushCircleInner.setAttribute("r",""+Math.max(0,t.radius-1))),"isVisible"in t&&(this.brushCircleOuter.style.opacity=t.isVisible?"1":"0",this.brushCircleInner.style.opacity=t.isVisible?"1":"0")}updateColorPreview(t){if("x"in t&&(this.pickerPreviewCol.setAttribute("cx",""+t.x),this.pickerPreviewBorder.setAttribute("cx",""+t.x)),"y"in t&&(this.pickerPreviewCol.setAttribute("cy",""+t.y),this.pickerPreviewBorder.setAttribute("cy",""+t.y)),"color"in t){this.pickerPreviewCol.setAttribute("stroke",Om.ColorConverter.toRgbStr(t.color));let e=Om.testIsWhiteBestContrast(t.color)?"rgba(255,255,255,0.5)":"rgba(0,0,0,0.5)";this.pickerPreviewBorder.setAttribute("stroke",e)}"isVisible"in t&&(this.pickerPreviewCol.style.opacity=t.isVisible?"1":"0",this.pickerPreviewBorder.style.opacity=t.isVisible?"1":"0")}updateCompass(t){"angleDeg"in t&&(this.compassInner.setAttribute("transform","rotate("+t.angleDeg+")"),this.compassLineCircle.style.opacity=t.angleDeg%90==0?"1":"0"),"isVisible"in t&&(this.compass.style.opacity=t.isVisible?"1":"0")}constructor(t){this.rootElement=Om.createSvg({elementType:"svg",width:""+t.width,height:""+t.height}),Om.css(this.rootElement,{position:"absolute",left:"0",top:"0",pointerEvents:"none",userSelect:"none"}),this.brushCircleOuter=Om.createSvg({elementType:"circle",r:"10",stroke:"rgba(0,0,0,0.7)","stroke-width":"1",fill:"none"}),this.brushCircleInner=Om.createSvg({elementType:"circle",r:"9",stroke:"rgba(255,255,255,0.7)","stroke-width":"1",fill:"none"}),this.rootElement.append(this.brushCircleOuter,this.brushCircleInner),this.pickerPreviewBorder=Om.createSvg({elementType:"circle",r:"47",stroke:"black","stroke-width":"22",fill:"none"}),this.pickerPreviewBorder.style.opacity="0",this.pickerPreviewCol=Om.createSvg({elementType:"circle",r:"47",stroke:"black","stroke-width":"20",fill:"none"}),this.pickerPreviewCol.style.opacity="0",this.rootElement.append(this.pickerPreviewBorder,this.pickerPreviewCol),this.compassSize=30,this.compass=Om.createSvg({elementType:"g",transform:"translate("+t.width/2+", "+t.height/2+")"}),Om.css(this.compass,{transition:"opacity 0.25s ease-in-out",opacity:"0"}),this.compassInner=Om.createSvg({elementType:"g",transform:"rotate(45)"}),this.compassBaseCircle=Om.createSvg({elementType:"circle",fill:"rgba(0,0,0,0.9)",stroke:"none",cx:"0",cy:"0",r:""+this.compassSize}),this.compassLineCircle=Om.createSvg({elementType:"circle",fill:"none",stroke:"rgba(255,255,255,0.75)","stroke-width":"1",cx:"0",cy:"0",r:""+.9*this.compassSize}),this.compassUpperTriangle=Om.createSvg({elementType:"path",fill:"#f00",stroke:"none",d:"M -"+.25*this.compassSize+",0 "+.25*this.compassSize+",0 0,-"+.9*this.compassSize+" z"}),this.compassLowerTriangle=Om.createSvg({elementType:"path",fill:"#fff",stroke:"none",d:"M -"+.25*this.compassSize+",0 "+.25*this.compassSize+",0 0,"+.9*this.compassSize+" z"}),this.compassInner.append(this.compassBaseCircle,this.compassLineCircle,this.compassUpperTriangle,this.compassLowerTriangle),this.compass.append(this.compassInner),this.rootElement.append(this.compass)}}var Ry;Ry=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("6rWqS");var Ly;Ly=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("5mHop");var Ay;Ay=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("gy6aj");var Py;Py=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("9SVhx");let Oy;var Dy;(Dy=Oy||(Oy={}))[Dy.Draw=0]="Draw",Dy[Dy.Hand=1]="Hand",Dy[Dy.HandGrabbing=2]="HandGrabbing",Dy[Dy.Pick=3]="Pick",Dy[Dy.Zoom=4]="Zoom",Dy[Dy.Rotate=5]="Rotate",Dy[Dy.Rotating=6]="Rotating",Dy[Dy.Fill=7]="Fill",Dy[Dy.Text=8]="Text",Dy[Dy.Shape=9]="Shape";function By(t){const e=t.width/t.layers[0].image.width,n=e>1?t.layers[0].image.width:t.width,i=e>1?t.layers[0].image.height:t.height;let r=Om.canvas(n,i);r.style.backgroundImage="url("+Om.createCheckerDataUrl(8)+")";let a=r.getContext("2d");function o(){a.save(),a.clearRect(0,0,r.width,r.height);for(let e=0;e<t.layers.length;e++)a.globalAlpha=t.layers[e].opacity,a.globalCompositeOperation=t.layers[e].mixModeStr,r.width>t.layers[e].image.width&&(a.imageSmoothingEnabled=!1),a.drawImage(t.layers[e].image,0,0,r.width,r.height);a.restore()}Om.css(r,{width:"100%",height:"100%",imageRendering:e>1?"pixelated":null}),setTimeout(o,0),this.getElement=function(){return r},this.render=function(){o()}}var zy;function jy(t){if(Math.abs(t.angleDeg)%90!=0)return;t.width=Math.round(t.width),t.height=Math.round(t.height);const e=Math.abs(t.angleDeg-90)%180==0;t.x=(e?t.height:t.width)%2==0?Math.round(t.x):Math.round(t.x-.5)+.5,t.y=(e?t.width:t.height)%2==0?Math.round(t.y):Math.round(t.y-.5)+.5}function Hy(t){return{x:t.x,y:t.y,width:t.width,height:t.height,angleDeg:t.angleDeg}}function _y(t,e,n){let i,r;i=t-n.x,r=e-n.y;const a=Om.rotateAround({x:0,y:0},{x:i,y:r},-n.angleDeg);return i=a.x,r=a.y,{x:i,y:r}}function Fy(t,e,n){const i=Om.rotateAround({x:0,y:0},{x:t,y:e},n.angleDeg);return{x:i.x+n.x,y:i.y+n.y}}zy=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("8BBCz");class Uy{updateScaled(){this.scaled.x=this.transform.x*this.scale,this.scaled.y=this.transform.y*this.scale,this.scaled.width=this.transform.width*this.scale,this.scaled.height=this.transform.height*this.scale,this.scaled.corners=this.corners.map((t=>({x:t.x*this.scale,y:t.y*this.scale})))}snapCorner(t,e){if(!this.snappingEnabled)return{x:t,y:e};let n;const i={x:null,y:null,dist:{x:null,y:null}};for(let e=0;e<this.snapX.length;e++)n=Math.abs(t-this.snapX[e]),n<this.minSnapDist/this.scale&&(null===i.x||n<i.dist.x)&&(i.x=this.snapX[e],i.dist.x=n);for(let t=0;t<this.snapY.length;t++)n=Math.abs(e-this.snapY[t]),n<this.minSnapDist/this.scale&&(null===i.y||n<i.dist.y)&&(i.y=this.snapY[t],i.dist.y=n);return null===i.x&&null===i.y?{x:t,y:e}:{x:null===i.x?t:i.x,y:null===i.y?e:i.y}}constrainCorner(t,e,n){if(!this.isConstrained)return{x:e,y:n};const i=this.transform.width*this.transform.height<0?-1:1;return Om.projectPointOnLine({x:this.transform.x,y:this.transform.y},Fy(this.ratio,i*([0,2].includes(t)?1:-1),this.transform),{x:e,y:n})}updateCornerPositions(){this.corners[0].x=-this.transform.width/2,this.corners[0].y=-this.transform.height/2,this.corners[1].x=this.transform.width/2,this.corners[1].y=-this.transform.height/2,this.corners[2].x=this.transform.width/2,this.corners[2].y=this.transform.height/2,this.corners[3].x=-this.transform.width/2,this.corners[3].y=this.transform.height/2}restoreRatio(t,e){if(!this.isConstrained)return;const n=Math.abs(this.transform.angleDeg)%90==0,i=Math.abs(this.transform.angleDeg-90)%180==0;if(e&&!t){const t=Math.abs(this.corners[3].y-this.corners[0].y);let e=this.ratio*t;n&&(e=0==(i?this.transform.y%1:this.transform.x%1)?Om.roundEven(e):Om.roundUneven(e)),this.corners[1].x-this.corners[0].x<0&&(e*=-1),this.corners[0].x=-e/2,this.corners[3].x=-e/2,this.corners[1].x=e/2,this.corners[2].x=e/2}if(!e&&t){let t=Math.abs(this.corners[0].x-this.corners[1].x)/this.ratio;n&&(t=0==(i?this.transform.x%1:this.transform.y%1)?Om.roundEven(t):Om.roundUneven(t)),this.corners[3].y-this.corners[0].y<0&&(t*=-1),this.corners[0].y=-t/2,this.corners[1].y=-t/2,this.corners[2].y=t/2,this.corners[3].y=t/2}}updateTransformViaCorners(){const t=Om.rotateAround({x:0,y:0},{x:(this.corners[0].x+this.corners[1].x)/2,y:(this.corners[0].y+this.corners[3].y)/2},this.transform.angleDeg);this.transform.x=t.x+this.transform.x,this.transform.y=t.y+this.transform.y,this.transform.width=this.corners[1].x-this.corners[0].x,this.transform.height=this.corners[3].y-this.corners[0].y,this.updateCornerPositions(),this.updateDOM()}updateDOM(t){this.updateScaled(),Om.css(this.transEl,{left:this.scaled.x+"px",top:this.scaled.y+"px",transformOrigin:"0 0",transform:"rotate("+this.transform.angleDeg+"deg)"}),Om.css(this.boundsEl,{width:Math.abs(this.scaled.width)+"px",height:Math.abs(this.scaled.height)+"px",left:Math.min(this.scaled.corners[0].x,this.scaled.corners[1].x)+"px",top:Math.min(this.scaled.corners[0].y,this.scaled.corners[3].y)+"px"}),this.corners[0].updateDOM(),this.corners[1].updateDOM(),this.corners[2].updateDOM(),this.corners[3].updateDOM(),this.edges[0].updateDOM(),this.edges[1].updateDOM(),this.edges[2].updateDOM(),this.edges[3].updateDOM(),this.angleGrip.x=0,this.angleGrip.y=-Math.abs(this.transform.height*this.scale)/2-20,this.angleGrip.updateDOM(),t||this.callback&&this.callback(Hy(this.transform))}getTransform(){return Hy(this.transform)}setConstrained(t){this.isConstrained=!!t,t&&0!==this.transform.width&&0!==this.transform.height&&(this.ratio=Math.abs(this.transform.width/this.transform.height))}setSnapping(t){this.snappingEnabled=!!t}setPos(t){this.transform.x=t.x,this.transform.y=t.y,this.updateDOM(!0)}move(t,e){this.transform.x+=t,this.transform.y+=e,this.updateDOM(!1)}setSize(t,e){this.transform.width=t,this.transform.height=e,Math.abs(this.transform.angleDeg)%90==0&&jy(this.transform),this.updateCornerPositions(),this.updateDOM(!1)}setAngleDeg(t){this.transform.angleDeg=t,Math.abs(this.transform.angleDeg)%90==0&&(jy(this.transform),this.updateCornerPositions()),this.updateDOM(!0)}getElement(){return this.rootEl}getRatio(){return this.ratio}destroy(){this.keyListener.destroy(),this.boundsPointerListener.destroy(),this.corners[0].pointerListener.destroy(),this.corners[1].pointerListener.destroy(),this.corners[2].pointerListener.destroy(),this.corners[3].pointerListener.destroy(),this.edges[0].pointerListener.destroy(),this.edges[1].pointerListener.destroy(),this.edges[2].pointerListener.destroy(),this.edges[3].pointerListener.destroy(),this.anglePointerListener.destroy()}constructor(t){this.scaled={x:0,y:0,width:0,height:0,corners:[{x:0,y:0}]},this.minSnapDist=7,this.cornerCursors=["nw","n","ne","e","se","s","sw","w"],this.gripSize=14,this.edgeSize=10,this.corners=[],this.edges=[],this.transform={x:t.x,y:t.y,width:t.width,height:t.height,angleDeg:t.angleDeg},this.isConstrained=!!t.isConstrained,this.snapX=t.snapX,this.snapY=t.snapY,this.callback=t.callback,this.scale=t.scale,this.snappingEnabled=!0,this.ratio=this.transform.width/this.transform.height,this.rootEl=Om.el({className:"kl-free-transform",css:{userSelect:"none"}}),this.transEl=Om.el({parent:this.rootEl,css:{position:"absolute"}}),this.boundsEl=Om.el({css:{position:"absolute",cursor:"move",boxShadow:"rgba(255, 255, 255, 0.5) 0 0 0 1px inset, rgba(0, 0, 0, 0.5) 0 0 0 1px"}});const e={x:0,y:0};this.keyListener=new Om.KeyListener({});let i,r={x:0,y:0};this.boundsPointerListener=new Om.PointerListener({target:this.boundsEl,fixScribble:!0,onPointer:t=>{if(t.eventPreventDefault(),"pointerdown"===t.type&&(r={x:this.transform.x,y:this.transform.y}),"pointermove"===t.type&&"left"===t.button){let e;this.transform.x=r.x+(t.pageX-t.downPageX)/this.scale,this.transform.y=r.y+(t.pageY-t.downPageY)/this.scale;let n={};if(this.snappingEnabled){let t,i;for(t=0;t<this.snapX.length;t++)e=Math.abs(this.transform.x-this.snapX[t]),e<this.minSnapDist/this.scale&&(!n.x||e<n.distX)&&(n.x=this.snapX[t],n.distX=e);for(t=0;t<this.snapY.length;t++)e=Math.abs(this.transform.y-this.snapY[t]),e<this.minSnapDist/this.scale&&(!n.y||e<n.distY)&&(n.y=this.snapY[t],n.distY=e);for(t=0;t<4;t++){let r;for(i=Fy(this.corners[t].x,this.corners[t].y,this.transform),r=0;r<this.snapX.length;r++)e=Math.abs(i.x-this.snapX[r]),e<this.minSnapDist/this.scale&&(!n.x||e<n.distX)&&(n.x=this.snapX[r]-(i.x-this.transform.x),n.distX=e);for(r=0;r<this.snapY.length;r++)e=Math.abs(i.y-this.snapY[r]),e<this.minSnapDist/this.scale&&(!n.y||e<n.distY)&&(n.y=this.snapY[r]-(i.y-this.transform.y),n.distY=e)}}if("shift"===this.keyListener.getComboStr()){let t=Om.projectPointOnLine({x:0,y:r.y},{x:10,y:r.y},{x:this.transform.x,y:this.transform.y}),e=Om.dist(t.x,t.y,this.transform.x,this.transform.y);n={},n.x=t.x,n.y=t.y,n.distX=e,n.distY=e,t=Om.projectPointOnLine({x:r.x,y:0},{x:r.x,y:10},{x:this.transform.x,y:this.transform.y}),e=Om.dist(t.x,t.y,this.transform.x,this.transform.y),e<n.distX&&(n.x=t.x,n.y=t.y,n.distX=e,n.distY=e),t=Om.projectPointOnLine({x:r.x,y:r.y},{x:r.x+1,y:r.y+1},{x:this.transform.x,y:this.transform.y}),e=Om.dist(t.x,t.y,this.transform.x,this.transform.y),e<n.distX&&(n.x=t.x,n.y=t.y,n.distX=e,n.distY=e),t=Om.projectPointOnLine({x:r.x,y:r.y},{x:r.x+1,y:r.y-1},{x:this.transform.x,y:this.transform.y}),e=Om.dist(t.x,t.y,this.transform.x,this.transform.y),e<n.distX&&(n.x=t.x,n.y=t.y,n.distX=e,n.distY=e)}null!=n.x&&(this.transform.x=n.x),null!=n.y&&(this.transform.y=n.y),Math.abs(this.transform.angleDeg)%90==0&&(jy(this.transform),this.updateCornerPositions()),this.updateDOM()}}});for(let t=0;t<4;t++)(t=>{const e=this.corners[t]={i:t,el:Om.el({css:{width:this.gripSize+"px",height:this.gripSize+"px",background:"#fff",borderRadius:this.gripSize+"px",position:"absolute",boxShadow:"inset 0 0 0 2px #000"}}),x:0,y:0,virtualPos:{x:0,y:0},updateDOM:null,pointerListener:null};e.updateDOM=()=>{const n=[[-1,-1],[1,-1],[1,1],[-1,1]].map((t=>(t[0]*=this.transform.width>0?1:-1,t[1]*=this.transform.height>0?1:-1,t))),i=Math.abs(this.scaled.width)<20||Math.abs(this.scaled.height)<20?10:0;Om.css(e.el,{left:this.scaled.corners[e.i].x-this.gripSize/2+n[t][0]*i+"px",top:this.scaled.corners[e.i].y-this.gripSize/2+n[t][1]*i+"px"});let r=Om.pointsToAngleDeg({x:this.transform.x,y:this.transform.y},Fy(e.x,e.y,this.transform))+135;for(;r<0;)r+=360;let a=Math.round(r/45)%this.cornerCursors.length;Om.css(e.el,{cursor:this.cornerCursors[a]+"-resize"})},e.pointerListener=new Om.PointerListener({target:this.corners[t].el,fixScribble:!0,onPointer:e=>{if(e.eventPreventDefault(),"pointerdown"===e.type&&"left"===e.button)this.corners[t].virtualPos=Fy(this.corners[t].x,this.corners[t].y,this.transform);else if("pointermove"===e.type&&"left"===e.button){this.corners[t].virtualPos.x+=e.dX/this.scale,this.corners[t].virtualPos.y+=e.dY/this.scale;let n={x:this.corners[t].virtualPos.x,y:this.corners[t].virtualPos.y};n=this.constrainCorner(t,n.x,n.y),this.isConstrained||(n=this.snapCorner(n.x,n.y)),Math.abs(this.transform.angleDeg)%90==0&&(n.x=Math.round(n.x),n.y=Math.round(n.y));const i=_y(n.x,n.y,this.transform),r=i.x-this.corners[t].x,a=i.y-this.corners[t].y;this.corners[t].x=i.x,this.corners[t].y=i.y;let o=[];0===t?o=[3,1,2]:1===t?o=[2,0,3]:2===t?o=[1,3,0]:3===t&&(o=[0,2,1]),this.corners[o[0]].x=this.corners[t].x,this.corners[o[1]].y=this.corners[t].y,this.keyListener.isPressed("shift")&&(this.corners[o[2]].x-=r,this.corners[o[2]].y-=a,this.corners[o[1]].x=this.corners[o[2]].x,this.corners[o[0]].y=this.corners[o[2]].y),this.updateTransformViaCorners()}}})})(t);this.updateCornerPositions(),this.updateScaled();for(let t=0;t<4;t++)(t=>{this.edges[t]={el:Om.el({css:{width:this.edgeSize+"px",height:this.edgeSize+"px",position:"absolute"}}),updateDOM:null,pointerListener:null};const n=this.edges[t];n.updateDOM=()=>{0===t?Om.css(n.el,{left:Math.min(this.scaled.corners[0].x,this.scaled.corners[1].x)+"px",top:Math.min(this.scaled.corners[0].y,this.scaled.corners[3].y)-this.edgeSize+"px",width:Math.abs(this.scaled.width)+"px",height:this.edgeSize+"px"}):1===t?Om.css(n.el,{left:Math.max(this.scaled.corners[0].x,this.scaled.corners[1].x)+"px",top:Math.min(this.scaled.corners[1].y,this.scaled.corners[2].y)+"px",width:this.edgeSize+"px",height:Math.abs(this.scaled.height)+"px"}):2===t?Om.css(n.el,{left:Math.min(this.scaled.corners[3].x,this.scaled.corners[2].x)+"px",top:Math.max(this.scaled.corners[0].y,this.scaled.corners[3].y)+"px",width:Math.abs(this.scaled.width)+"px",height:this.edgeSize+"px"}):3===t&&Om.css(n.el,{left:Math.min(this.scaled.corners[0].x,this.scaled.corners[1].x)-this.edgeSize+"px",top:Math.min(this.scaled.corners[0].y,this.scaled.corners[3].y)+"px",width:this.edgeSize+"px",height:Math.abs(this.scaled.height)+"px"});let e=Math.round(this.transform.angleDeg/45);for(;e<0;)e+=8;e=(2*t+1+e)%this.cornerCursors.length,n.el.style.cursor=this.cornerCursors[e]+"-resize"};const r=[0,2].includes(t);n.pointerListener=new Om.PointerListener({target:this.edges[t].el,fixScribble:!0,onPointer:n=>{if(n.eventPreventDefault(),"pointerdown"===n.type&&"left"===n.button&&(i=r?this.corners[0].y>=this.corners[3].y:this.corners[0].x>=this.corners[1].x,e.x=0,e.y=0),"pointermove"===n.type&&"left"===n.button){const a=Om.rotateAround({x:0,y:0},{x:n.dX/this.scale,y:n.dY/this.scale},-this.transform.angleDeg);let o={dX:a.x,dY:a.y};Math.abs(this.transform.angleDeg)%90==0&&(o=Om.intDxy(e,a.x,a.y));let s=[];0===t?s=[2,3,0,1]:1===t?s=[0,3,1,2]:2===t?s=[0,1,2,3]:3===t&&(s=[1,2,0,3]);let l=r?"y":"x",c=r?o.dY:o.dX;i?(this.corners[s[0]][l]+=c,this.corners[s[1]][l]+=c):(this.corners[s[2]][l]+=c,this.corners[s[3]][l]+=c),this.keyListener.isPressed("shift")&&(i?(this.corners[s[2]][l]-=c,this.corners[s[3]][l]-=c):(this.corners[s[0]][l]-=c,this.corners[s[1]][l]-=c)),r?this.restoreRatio(!1,!0):this.restoreRatio(!0,!1),this.updateTransformViaCorners()}}})})(t);this.angleGrip={el:Om.el({css:{cursor:"url("+n(zy)+") 10 10, move",width:this.gripSize+"px",height:this.gripSize+"px",background:"#0ff",borderRadius:this.gripSize+"px",position:"absolute",boxShadow:"inset 0 0 0 2px #000"}}),x:0,y:0,snap:!1,updateDOM:()=>{Om.css(this.angleGrip.el,{left:this.angleGrip.x-this.gripSize/2+"px",top:this.angleGrip.y-this.gripSize/2+"px"})}},Om.el({parent:this.angleGrip.el,css:{width:"2px",height:"13px",left:this.gripSize/2-1+"px",top:this.gripSize+"px",background:"#0ff",position:"absolute"}}),this.anglePointerListener=new Om.PointerListener({target:this.angleGrip.el,fixScribble:!0,onPointer:t=>{if(t.eventPreventDefault(),"pointermove"===t.type&&"left"===t.button){const e=this.rootEl.getBoundingClientRect(),n={x:e.left-this.rootEl.scrollLeft,y:e.top-this.rootEl.scrollTop},i={x:(t.clientX-n.x)/this.scale,y:(t.clientY-n.y)/this.scale},r=Om.pointsToAngleDeg({x:this.transform.x,y:this.transform.y},i)+90;this.transform.angleDeg=r;const a=45*Math.round(r/360*8);("shift"===this.keyListener.getComboStr()||this.snappingEnabled&&Math.abs(a-r)<8)&&(this.transform.angleDeg=a),this.updateDOM()}"pointerup"===t.type&&Math.abs(this.transform.angleDeg)%90==0&&(jy(this.transform),this.updateCornerPositions(),this.updateDOM())}}),jy(this.transform),this.updateDOM(!0),Om.append(this.transEl,[this.boundsEl,this.edges[0].el,this.edges[1].el,this.edges[2].el,this.edges[3].el,this.corners[0].el,this.corners[1].el,this.corners[2].el,this.corners[3].el,this.angleGrip.el])}}function Ny(t){let e=Om.fitInto(t.imageWidth,t.imageHeight,t.elementWidth-20,t.elementHeight-60,1),n=e.width/t.imageWidth,i=Om.el({css:{width:t.elementWidth+"px",height:t.elementHeight+"px",backgroundColor:"#9e9e9e",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",userSelect:"none",position:"relative",display:"flex",alignItems:"center",justifyContent:"center",colorScheme:"only light"}});i.oncontextmenu=function(){return!1};let r=Om.el({css:{position:"relative",boxShadow:"0 0 5px rgba(0,0,0,0.5)",width:e.width+"px",height:e.height+"px"}});i.appendChild(r);let a=t.layers.map((t=>({image:t.image,mixModeStr:t.mixModeStr,opacity:t.opacity})));a[a.length-1].image=Om.canvas(n>1?t.imageWidth:e.width,n>1?t.imageHeight:e.height);let o,s,l=new By({width:e.width,height:e.height,layers:a});function c(){if(!o)return;let e=o.getTransform();n<1&&(e.x*=n,e.y*=n,e.width*=n,e.height*=n);let i=a[t.transformIndex].image,r=i.getContext("2d");r.save(),r.clearRect(0,0,i.width,i.height),Om.drawTransformedImageWithBounds(r,t.layers[t.transformIndex].image,e,null,Om.testShouldPixelate(e,e.width/s.width,e.height/s.height)),r.restore(),l.render()}r.appendChild(l.getElement());{let i={width:t.layers[t.transformIndex].image.width*n,height:t.layers[t.transformIndex].image.height*n};(i.width>e.width||i.height>e.height)&&(i=Om.fitInto(t.layers[t.transformIndex].image.width,t.layers[t.transformIndex].image.height,e.width,e.height,1)),s={x:t.imageWidth/2,y:t.imageHeight/2,width:t.layers[t.transformIndex].image.width,height:t.layers[t.transformIndex].image.height},o=new Uy({x:s.x,y:s.y,width:s.width,height:s.height,angleDeg:0,isConstrained:!0,snapX:[0,t.imageWidth],snapY:[0,t.imageHeight],scale:n,callback:t=>{c()}})}Om.css(o.getElement(),{position:"absolute",left:"0",top:"0"}),r.appendChild(o.getElement()),setTimeout(c,0),this.move=function(t,e){o.move(t,e)},this.reset=function(){let e=t.layers[t.transformIndex].image.width,n=t.layers[t.transformIndex].image.height;o.setSize(e,n),o.setPos({x:e/2,y:n/2}),o.setAngleDeg(0),c()},this.setTransformFit=function(){let e=Om.fitInto(t.layers[t.transformIndex].image.width,t.layers[t.transformIndex].image.height,t.imageWidth,t.imageHeight,1);o.setSize(e.width,e.height),o.setPos({x:e.width/2,y:e.height/2}),o.setAngleDeg(0),c()},this.setTransformCenter=function(){o.setPos({x:t.imageWidth/2,y:t.imageHeight/2}),o.setAngleDeg(0),c()},this.getTransformation=function(){return!!o&&o.getTransform()},this.getIsPixelated=()=>{const t=o.getTransform();return Om.testShouldPixelate(t,t.width/s.width,t.height/s.height)},this.getElement=function(){return i},this.destroy=function(){o.destroy()}}function Yy(t){let e=t.x,n=t.y,i=t.width,r=t.height,a=t.scale,o=t.callback,s=t.maxW,l=t.maxH,c=document.createElement("div"),h=["nw","n","ne","e","se","s","sw","w"],u=new Om.KeyListener({});Om.css(c,{position:"absolute",left:e*a+"px",top:n*a+"px"});let d=document.createElement("div");Om.css(d,{position:"absolute",border:"1px dashed #fff",cursor:"move"}),d.update=function(){Om.css(d,{left:x[0].x*a-1+"px",top:x[0].y*a-1+"px",width:(x[2].x-x[0].x)*a+"px",height:(x[2].y-x[0].y)*a+"px"})};let p={x:0,y:0},g=new Om.PointerListener({target:d,onPointer:function(t){if(t.eventPreventDefault(),"pointermove"===t.type&&"left"===t.button){const{dX:e,dY:n}=Om.intDxy(p,t.dX/a,t.dY/a);x[0].x+=e,x[0].y+=n,x[1].x+=e,x[1].y+=n,x[2].x+=e,x[2].y+=n,x[3].x+=e,x[3].y+=n,z()}"pointerup"===t.type&&S()}}),f=document.createElement("div");Om.css(f,{position:"absolute",borderTop:"1px solid #0ff",borderBottom:"1px solid #0ff"}),f.update=function(){Om.css(f,{left:x[0].x*a+"px",top:(x[0].y+(x[2].y-x[0].y)/3)*a+"px",width:(x[2].x-x[0].x)*a+"px",height:(x[2].y-x[0].y)/3*a+"px"})};let m=document.createElement("div");Om.css(m,{position:"absolute",borderLeft:"1px solid #0ff",borderRight:"1px solid #0ff"}),m.update=function(){Om.css(m,{left:(x[0].x+(x[2].x-x[0].x)/3)*a+"px",top:x[0].y*a+"px",width:(x[2].x-x[0].x)/3*a+"px",height:(x[2].y-x[0].y)*a+"px"})};const y=10;let x=[{x:0,y:0},{x:i,y:0},{x:i,y:r},{x:0,y:r}];function b(t){x[0].y+=t,x[0].y=Math.max(x[3].y-l,Math.min(x[3].y-1,x[0].y)),x[1].y=x[0].y}function v(t){x[1].x+=t,x[1].x=Math.min(x[0].x+s,Math.max(x[0].x+1,x[1].x)),x[2].x=x[1].x}function w(t){x[2].y+=t,x[2].y=Math.min(x[1].y+l,Math.max(x[1].y+1,x[2].y)),x[3].y=x[2].y}function C(t){x[0].x+=t,x[0].x=Math.max(x[1].x-s,Math.min(x[1].x-1,x[0].x)),x[3].x=x[0].x}function S(){p.x=0,p.y=0,o(B())}let E=[];for(let t=0;t<4;t++)!function(t){E[t]=document.createElement("div");let e=E[t];e.style.width="40px",e.style.height="40px",e.style.position="absolute",e.update=function(){0===t?(e.style.left=x[0].x*a+y+"px",e.style.top=x[0].y*a-80+y+"px",e.style.width=(x[1].x-x[0].x)*a-20+"px",e.style.height="80px"):1===t?(e.style.left=x[1].x*a-y+"px",e.style.top=x[1].y*a+y+"px",e.style.width="80px",e.style.height=(x[2].y-x[1].y)*a-20+"px"):2===t?(e.style.left=x[3].x*a+y+"px",e.style.top=x[3].y*a-y+"px",e.style.width=(x[2].x-x[3].x)*a-20+"px",e.style.height="80px"):3===t&&(e.style.left=x[0].x*a-80+y+"px",e.style.top=x[0].y*a+y+"px",e.style.width="80px",e.style.height=(x[3].y-x[0].y)*a-20+"px");let n=2*t+1;e.style.cursor=h[n]+"-resize"}}(t);let M=[];for(let t=0;t<4;t++)!function(t){M[t]=document.createElement("div");let e=M[t];e.style.position="absolute",e.style.background="#000",e.style.opacity="0.5",e.update=function(){0===t?(e.style.left=x[0].x*a+"px",e.style.top=x[0].y*a-8e3+"px",e.style.width=(x[1].x-x[0].x)*a+"px",e.style.height="8000px"):1===t?(e.style.left=x[1].x*a+"px",e.style.top=x[1].y*a-8e3+"px",e.style.width="8000px",e.style.height="16000px"):2===t?(e.style.left=x[3].x*a+"px",e.style.top=x[3].y*a+"px",e.style.width=(x[2].x-x[3].x)*a+"px",e.style.height="8000px"):3===t&&(e.style.left=x[0].x*a-8e3+"px",e.style.top=x[0].y*a-8e3+"px",e.style.width="8000px",e.style.height="16000px")}}(t);let I=new Om.PointerListener({target:E[0],fixScribble:!0,onPointer:function(t){if(t.eventPreventDefault(),"pointermove"===t.type&&"left"===t.button){const{dX:e,dY:n}=Om.intDxy(p,t.dX/a,t.dY/a);b(n),u.isPressed("shift")&&w(-n),z()}"pointerup"===t.type&&S()}}),k=new Om.PointerListener({target:E[1],fixScribble:!0,onPointer:function(t){if(t.eventPreventDefault(),"pointermove"===t.type&&"left"===t.button){const{dX:e,dY:n}=Om.intDxy(p,t.dX/a,t.dY/a);v(e),u.isPressed("shift")&&C(-e),z()}"pointerup"===t.type&&S()}}),T=new Om.PointerListener({target:E[2],fixScribble:!0,onPointer:function(t){if(t.eventPreventDefault(),"pointermove"===t.type&&"left"===t.button){const{dX:e,dY:n}=Om.intDxy(p,t.dX/a,t.dY/a);w(n),u.isPressed("shift")&&b(-n),z()}"pointerup"===t.type&&S()}}),R=new Om.PointerListener({target:E[3],fixScribble:!0,onPointer:function(t){if(t.eventPreventDefault(),"pointermove"===t.type&&"left"===t.button){const{dX:e,dY:n}=Om.intDxy(p,t.dX/a,t.dY/a);C(e),u.isPressed("shift")&&v(-e),z()}"pointerup"===t.type&&S()}}),L=[];!function(){for(let t=0;t<4;t++)!function(t){L[t]=document.createElement("div");let e=L[t];Om.css(e,{width:"80px",height:"80px",position:"absolute"}),e.style.cursor=["nwse-resize","nesw-resize"][t%2],e.update=function(){0===t?Om.css(e,{left:x[0].x*a-80+y+"px",top:x[0].y*a-80+y+"px"}):1===t?Om.css(e,{left:x[1].x*a-y+"px",top:x[1].y*a-80+y+"px"}):2===t?Om.css(e,{left:x[1].x*a-y+"px",top:x[2].y*a-y+"px"}):3===t&&Om.css(e,{left:x[0].x*a-80+y+"px",top:x[2].y*a-y+"px"})}}(t)}();let A=new Om.PointerListener({target:L[0],fixScribble:!0,onPointer:function(t){if(t.eventPreventDefault(),"pointermove"===t.type&&"left"===t.button){const{dX:e,dY:n}=Om.intDxy(p,t.dX/a,t.dY/a);C(e),b(n),u.isPressed("shift")&&(v(-e),w(-n)),z()}"pointerup"===t.type&&S()}}),P=new Om.PointerListener({target:L[1],fixScribble:!0,onPointer:function(t){if(t.eventPreventDefault(),"pointermove"===t.type&&"left"===t.button){const{dX:e,dY:n}=Om.intDxy(p,t.dX/a,t.dY/a);v(e),b(n),u.isPressed("shift")&&(C(-e),w(-n)),z()}"pointerup"===t.type&&S()}}),O=new Om.PointerListener({target:L[2],fixScribble:!0,onPointer:function(t){if(t.eventPreventDefault(),"pointermove"===t.type&&"left"===t.button){const{dX:e,dY:n}=Om.intDxy(p,t.dX/a,t.dY/a);v(e),w(n),u.isPressed("shift")&&(C(-e),b(-n)),z()}"pointerup"===t.type&&S()}}),D=new Om.PointerListener({target:L[3],fixScribble:!0,onPointer:function(t){if(t.eventPreventDefault(),"pointermove"===t.type&&"left"===t.button){const{dX:e,dY:n}=Om.intDxy(p,t.dX/a,t.dY/a);C(e),w(n),u.isPressed("shift")&&(v(-e),b(-n)),z()}"pointerup"===t.type&&S()}});function B(){return x[1].x-=x[0].x,x[1].y-=x[0].y,x[2].x-=x[0].x,x[2].y-=x[0].y,x[3].x-=x[0].x,x[3].y-=x[0].y,e+=x[0].x,n+=x[0].y,x[0].x=0,x[0].y=0,{x:e,y:n,width:x[1].x,height:x[2].y}}function z(){E[0].update(),E[1].update(),E[2].update(),E[3].update(),L[0].update(),L[1].update(),L[2].update(),L[3].update(),M[0].update(),M[1].update(),M[2].update(),M[3].update(),d.update(),f.update(),m.update()}c.append(M[1],M[0],M[2],M[3],f,m,d,E[1],E[0],E[2],E[3],L[0],L[1],L[2],L[3]),z(),this.getTransform=B,this.setTransform=function(t){e=t.x,n=t.y,i=t.width,r=t.height,Om.css(c,{left:e*a+"px",top:n*a+"px"}),x[0].x=0,x[0].y=0,x[1].x=i,x[1].y=0,x[2].x=i,x[2].y=r,x[3].x=0,x[3].y=r,z(),S()},this.setScale=function(t){a=t,Om.css(c,{left:e*a+"px",top:n*a+"px"}),z()},this.showThirds=function(t){t?(f.style.display="block",m.style.display="block"):(f.style.display="none",m.style.display="none")},this.getElement=function(){return c},this.destroy=function(){u.destroy(),g.destroy(),A.destroy(),P.destroy(),O.destroy(),D.destroy(),I.destroy(),k.destroy(),T.destroy(),R.destroy()}}var Xy;Xy=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("g2W7q");var Vy;Vy=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("7SFt9");var Wy;Wy=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("2Vvkk");var Ky;Ky=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("1zJpX");var Gy;Gy=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("9cKp0");var qy;qy=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("3iiTs");var Zy;Zy=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("gGmfI");var $y;$y=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("67aEJ");var Jy;Jy=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("a2j2Q");var Qy;Qy=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("gZhDT");var tx;function ex(t){let e=["draw","fill","text","shape"],i=[n(Zy),n($y),n(Jy),n(Qy)],r=[`${Vm("tool-brush")} [B]`,`${Vm("tool-paint-bucket")} [G]`,`${Vm("tool-text")} [T]`,`${Vm("tool-shape")} [U]`],a=0,o=!0,s=!1;setTimeout((function(){for(let t=1;t<i.length;t++){(new Image).src=i[t]}}),100);let l,c,h,u,d="6px 0",p=Om.el({css:{position:"relative",flexGrow:"1"}}),g=!1;Om.hasPointerEvents&&(u=new Om.PointerListener({target:p,maxPointers:1,onPointer:function(n){if("pointerdown"===n.type){if(s)return;l=setTimeout((function(){S()}),400),g=!0,c=n.pageX,h=n.pageY}else if("pointermove"===n.type)g&&!s&&Om.dist(c,h,n.pageX,n.pageY)>5&&(clearTimeout(l),S());else if("pointerup"===n.type){if(clearTimeout(l),s&&g){let i=document.elementFromPoint(n.pageX,n.pageY);for(let n=0;n<v.length;n++)if(i===v[n].wrapper){E(),o=!0,a=n,M(),t.onChange(e[a]);break}}g=!1}}}));let f=Om.el({parent:p,className:"toolspace-row-button nohighlight toolspace-row-button-activated",title:r[a],onClick:function(n){if(o&&!s)return n.preventDefault(),n.stopPropagation(),void S();o=!0,t.onChange(e[a]),s&&E()},css:{padding:"10px 0",pointerEvents:"auto",height:"100%",boxSizing:"border-box"}}),m=Om.el({parent:f,css:{backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"contain",width:"calc(100% - 7px)",height:"100%",pointerEvents:"none",opacity:"0.75"}}),y=Om.el({parent:f,css:{position:"absolute",right:"1px",bottom:"1px",width:"18px",height:"18px",cursor:"pointer",backgroundImage:"url('"+n(tx)+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"60%"},title:"More Tools",onClick:function(t){t.preventDefault(),t.stopPropagation(),S()}}),x=Om.el({css:{position:"absolute",left:"0",top:"0",right:"0",bottom:"0"}}),b=(new Om.PointerListener({target:x,pointers:1,onPointer:function(t){"pointerdown"===t.type&&(t.eventPreventDefault(),E())}}),Om.el({className:"tool-dropdown-wrapper",css:{position:"absolute",width:"100%",height:100*(e.length-1)+"%",top:"100%",left:"0",zIndex:"1",boxSizing:"border-box",cursor:"pointer",transition:"height 0.1s ease-in-out, opacity 0.1s ease-in-out",borderBottomLeftRadius:"5px",borderBottomRightRadius:"5px",overflow:"hidden"}})),v=[];function w(t){let n={},i=Om.el({parent:b,className:"tool-dropdown-button",title:t.title,css:{padding:"10px 0",height:100/(e.length-1)+"%",boxSizing:"border-box"},onClick:function(e){e.preventDefault(),e.stopPropagation(),t.onClick(t.index,t.id)}});n.wrapper=i;Om.el({parent:i,css:{backgroundImage:"url('"+t.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"contain",height:"100%",pointerEvents:"none",opacity:"0.75"}});return n.show=function(t){i.style.display=t?"block":"none"},n.setIsSmall=function(t){i.style.padding=t?d:"10px 0"},n}function C(n,i){E(),o=!0,a=n,M(),t.onChange(e[a])}for(let t=0;t<e.length;t++)v.push(w({index:t,id:e[t],image:i[t],title:r[t],onClick:C}));function S(){jm.increase(.5),s=!0;for(let t=0;t<e.length;t++)v[t].show(a!==t);y.style.display="none",p.style.zIndex="1",document.body.appendChild(x),p.appendChild(b)}function E(){jm.decrease(.5),s=!1,y.style.removeProperty("display"),p.style.removeProperty("z-index"),document.body.removeChild(x),p.removeChild(b)}function M(){f.title=r[a],m.style.backgroundImage="url('"+i[a]+"')"}M(),this.setIsSmall=function(t){f.style.padding=t?d:"10px 0";for(let n=0;n<e.length;n++)v[n].setIsSmall(t);t?(y.style.width="14px",y.style.height="14px"):(y.style.width="18px",y.style.height="18px")},this.setActive=function(t){if(e.includes(t)){o=!0;for(let n=0;n<e.length;n++)if(e[n]===t){a=n;break}Om.addClassName(f,"toolspace-row-button-activated"),M()}else o=!1,Om.removeClassName(f,"toolspace-row-button-activated")},this.getActive=function(){return e[a]},this.getElement=function(){return p}}tx=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("48B5J");var nx;nx=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("ksMx1");var ix;ix=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("bReTA");var rx;rx=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("i3X7V");var ax;ax=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("j4HZO");var ox;ox=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("jItzQ");var sx;sx=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("ea7ga");var lx;lx=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("gNPQL");var cx;cx=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("9Mrdl");var hx;hx=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("jc4S8");var ux;ux=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("cgtA2");var dx;dx=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("erfrN");var px;px=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("kdJe6");var gx={};let fx,mx;function yx(){if(fx)return;fx={"source-over":"normal",darken:"darken",multiply:"multiply","color-burn":"color burn",lighten:"lighten",screen:"screen","color-dodge":"color dodge",overlay:"overlay","soft-light":"soft light","hard-light":"hard light",difference:"difference",exclusion:"exclusion",hue:"hue",saturation:"saturation",color:"color",luminosity:"luminosity"},mx={};let t=Object.keys(fx);for(let e=0;e<t.length;e++)mx[fx[t[e]]]=t[e]}function xx(t){return yx(),mx[t]}function bx(t){return yx(),fx[t]}function vx(t){let e={type:"psd",canvas:t.canvas,width:t.width,height:t.height};function n(t){e.warningArr||(e.warningArr=[]),e.warningArr.includes(t)||e.warningArr.push(t)}function i(t){let e=xx(t);return e||(n("blend-mode"),e="source-over"),e}if(8!==t.bitsPerChannel&&n("bits-per-channel"),!t.children)return e.error=!0,e;let r=0;if(r+=function t(e){let i=0;if(e.blendMode){let t=xx(e.blendMode);if(t&&"source-over"!==t)return 1}for(let r=0;r<e.children.length;r++){let a=e.children[r];a.clipping||a.adjustment||(a.children?(n("group"),i+=t(a)):i++)}return i}(t),r>16)return e.error=!0,e;function a(t,e){const n=t.getContext("2d");let i=n.getImageData(0,0,t.width,t.height);if(0===e)for(let t=0;t<i.data.length;t+=4)i.data[t+3]=i.data[t];else for(let t=0;t<i.data.length;t+=4)i.data[t+3]=255-i.data[t];n.putImageData(i,0,0)}return e.layers=[],e.layers=function t(r){let o,s,l=[],c=r.hidden?0:r.opacity,h=i(r.blendMode);"source-over"!==h&&(o=Ff(e.width,e.height),s=o.getContext("2d")),r.mask&&(n("mask"),a(r.mask.canvas,r.mask.defaultColor));for(let h=0;h<r.children.length;h++){let u=r.children[h];if(u.clipping)continue;if(u.adjustment){n("adjustment");continue}let d=(u.children||u.canvas)&&r.children[h+1]&&r.children[h+1].clipping;if(d&&n("clipping"),u.children){let n=t(u);for(let t=0;t<n.length;t++){let a=n[t],u=a.image.getContext("2d");if(d){let t=Ff(e.width,e.height),n=t.getContext("2d");n.drawImage(a.image,0,0);for(let t=h+1;t<r.children.length&&r.children[t].clipping;t++){let e=r.children[t];0===e.opacity||e.hidden||(n.globalCompositeOperation=i(e.blendMode),n.globalAlpha=e.opacity,n.drawImage(e.canvas,e.left,e.top))}u.globalCompositeOperation="source-atop",u.drawImage(t,0,0)}r.mask&&(u.globalCompositeOperation=0===r.mask.defaultColor?"destination-in":"destination-out",u.drawImage(r.mask.canvas,r.mask.left,r.mask.top)),o?(s.globalCompositeOperation=a.mixModeStr,s.globalAlpha=a.opacity,s.drawImage(a.image,0,0)):(a.opacity=a.opacity*c,l.push(a))}continue}let p=Ff(e.width,e.height),g=p.getContext("2d");if(u.canvas&&g.drawImage(u.canvas,u.left,u.top),u.effects&&n("layer-effect"),u.mask&&(n("mask"),a(u.mask.canvas,u.mask.defaultColor),g.globalCompositeOperation=0===u.mask.defaultColor?"destination-in":"destination-out",g.drawImage(u.mask.canvas,u.mask.left,u.mask.top)),d){let t=Ff(u.right-u.left,u.bottom-u.top),e=t.getContext("2d");e.drawImage(u.canvas,0,0);for(let t=h+1;t<r.children.length&&r.children[t].clipping;t++){let n=r.children[t];0===n.opacity||n.hidden||(e.globalCompositeOperation=i(n.blendMode),e.globalAlpha=n.opacity,e.drawImage(n.canvas,n.left-u.left,n.top-u.top))}g.globalCompositeOperation="source-atop",g.drawImage(t,u.left,u.top)}r.mask&&(g.globalCompositeOperation=0===r.mask.defaultColor?"destination-in":"destination-out",g.drawImage(r.mask.canvas,r.mask.left,r.mask.top)),o?c>0&&(s.globalCompositeOperation=i(u.blendMode),s.globalAlpha=u.hidden?0:u.opacity,s.drawImage(p,0,0)):l.push({name:u.name,opacity:(u.hidden?0:u.opacity)*c,mixModeStr:i(u.blendMode),image:p})}return o&&(l=[{name:r.name,opacity:c,mixModeStr:h,image:o}]),l}({name:"root",opacity:1,blendMode:"normal",children:t.children}),e}function wx(t){const e={width:t.width,height:t.height,layers:[]};return t.layers?e.layers=e.layers.concat(t.layers.map((t=>({name:t.name,opacity:t.opacity,mixModeStr:t.mixModeStr,image:t.image})))):e.layers.push({name:Vm("background"),opacity:1,mixModeStr:"source-over",image:t.canvas}),e}t(gx,"blendPsdToKl",(function(){return xx})),t(gx,"blendKlToPsd",(function(){return bx})),t(gx,"readPsd",(function(){return vx})),t(gx,"klPsdToKlProject",(function(){return wx}));var Cx={};t(Cx,"setDbName",(function(){return Mx})),t(Cx,"getKlProjectObj",(function(){return kx})),t(Cx,"storeKlProjectObj",(function(){return Tx})),t(Cx,"clear",(function(){return Rx}));const Sx=!!window.indexedDB;let Ex="Klecks";function Mx(t){Ex=""+t}function Ix(t,e,n){let i,r=!1;function a(t){r||(r=!0,n(t))}if(Sx){try{i=window.indexedDB.open(Ex,1)}catch(t){return void a(t.message)}i.onupgradeneeded=function(t){try{i.result.createObjectStore("ProjectStore",{keyPath:"id"}).createIndex("id","id",{unique:!0})}catch(t){a(t.message)}},i.onerror=function(t){a("indexedDB.open failed, "+i.error)},i.onsuccess=function(n){let o,s,l;try{if(o=i.result,!o.objectStoreNames.contains("ProjectStore"))return window.indexedDB.deleteDatabase(Ex),void a("object store ProjectStore missing. destroying db");s=o.transaction("ProjectStore","readwrite"),l=s.objectStore("ProjectStore"),l.index("id")}catch(t){return void a(t.message)}o.onerror=function(t){a("database error, "+o.error)};try{t(l)}catch(t){return void a(t.message)}s.oncomplete=function(){r||(r=!0,e()),o.close()},s.onerror=function(){a("transaction error, "+s.error)}}}else setTimeout((function(){a("no indexed db available")}),0)}function kx(t,e){if(Sx){let n;Ix((function(t){n=t.get(1)}),(function(){t(n.result)}),(function(t){e("execIndexedDBTransaction error, "+t)}))}else t(null)}function Tx(t,e,n){Ix((function(e){e.put(t)}),(function(){e()}),(function(t){n(t)}))}function Rx(t,e){Ix((function(t){t.delete(1)}),(function(){t()}),(function(t){e(t)}))}var Lx;Lx=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("gJYYq");var Ax;Ax=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("25BJB");var Px;Px=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("fDGND");var Ox;Ox=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("8f0bW");var Dx;Dx=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("fAhTF");var Bx;Bx=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("lTNVM");var zx;zx=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("2mMxs");var jx;jx=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("lkhcY");var Hx;Hx=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("c9hFy");var _x;_x=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("297B8");var Fx;Fx=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("jxtUn");var Ux;Ux=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("lfC0f");var Nx;Nx=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("cDstS");const Yx={isLoaded:!1},Xx={glBrightnessContrast:{lang:{name:"filter-bright-contrast-title",button:"filter-bright-contrast"},name:"",buttonLabel:"",webgl:!0,updateContext:!0,icon:n(Lx),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},cropExtend:{lang:{name:"filter-crop-title",button:"filter-crop-extend"},name:"",buttonLabel:"",icon:n(Ax),webgl:!1,neededWithWebGL:!0,updateContext:!0,updatePos:!0,getDialog:null,apply:null,inEmbed:!1},glCurves:{lang:{name:"filter-curves-title",button:"filter-curves"},name:"",buttonLabel:"",icon:n(Px),webgl:!0,updateContext:!0,updatePos:!1,getDialog:null,apply:null,inEmbed:!0},flip:{lang:{name:"filter-flip-title",button:"filter-flip"},name:"",buttonLabel:"",icon:n(Ox),webgl:!1,neededWithWebGL:!0,updateContext:!0,updatePos:!1,getDialog:null,apply:null,inEmbed:!0},glHueSaturation:{lang:{name:"filter-hue-sat-title",button:"filter-hue-sat"},name:"",buttonLabel:"",icon:n(Dx),webgl:!0,updateContext:!0,updatePos:!1,getDialog:null,apply:null,inEmbed:!0},invert:{lang:{name:"filter-invert",button:"filter-invert"},name:"",icon:n(Bx),webgl:!0,updateContext:!0,updatePos:!1,isInstant:!0,getDialog:null,apply:null,inEmbed:!0},glPerspective:{lang:{name:"filter-perspective-title",button:"filter-perspective"},name:"",buttonLabel:"",icon:n(zx),webgl:!0,updateContext:!0,updatePos:!1,getDialog:null,apply:null,inEmbed:!0},resize:{lang:{name:"filter-resize-title",button:"filter-resize"},name:"",buttonLabel:"",icon:n(jx),webgl:!1,neededWithWebGL:!0,updateContext:!0,updatePos:!0,getDialog:null,apply:null,inEmbed:!1},rotate:{lang:{name:"filter-rotate-title",button:"filter-rotate"},name:"",buttonLabel:"",icon:n(sx),webgl:!1,neededWithWebGL:!0,updateContext:!0,updatePos:!0,getDialog:null,apply:null,inEmbed:!1},glTiltShift:{lang:{name:"filter-tilt-shift-title",button:"filter-tilt-shift"},name:"",buttonLabel:"",icon:n(Hx),webgl:!0,updateContext:!0,updatePos:!1,getDialog:null,apply:null,inEmbed:!0},toAlpha:{lang:{name:"filter-to-alpha-title",button:"filter-to-alpha"},name:"",buttonLabel:"",icon:n(_x),webgl:!0,updateContext:!1,updatePos:!1,getDialog:null,apply:null,inEmbed:!0},transform:{lang:{name:"filter-transform-title",button:"filter-transform"},name:"",buttonLabel:"",icon:n(Fx),webgl:!1,neededWithWebGL:!0,updateContext:!0,updatePos:!1,ieFails:!0,getDialog:null,apply:null,inEmbed:!0},glBlur:{lang:{name:"filter-triangle-blur-title",button:"filter-triangle-blur"},name:"",buttonLabel:"",icon:n(Ux),webgl:!0,updateContext:!0,updatePos:!1,getDialog:null,apply:null,inEmbed:!0},glUnsharpMask:{lang:{name:"filter-unsharp-mask-title",button:"filter-unsharp-mask"},name:"",buttonLabel:"",icon:n(Nx),webgl:!0,updateContext:!0,updatePos:!1,getDialog:null,apply:null,inEmbed:!0}};function Vx(){Object.keys(Xx).forEach((t=>{Xx[t].name=Vm(Xx[t].lang.name),Xx[t].buttonLabel=Vm(Xx[t].lang.button)}))}Vx(),Xm.subscribe((()=>{Vx()}));const Wx={};function Kx(t,e,n){this.x=t,this.y=e,this.z=n}Kx.prototype.dot2=function(t,e){return this.x*t+this.y*e};let Gx=[new Kx(1,1,0),new Kx(-1,1,0),new Kx(1,-1,0),new Kx(-1,-1,0),new Kx(1,0,1),new Kx(-1,0,1),new Kx(1,0,-1),new Kx(-1,0,-1),new Kx(0,1,1),new Kx(0,-1,1),new Kx(0,1,-1),new Kx(0,-1,-1)],qx=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],Zx=new Array(512),$x=new Array(512);Wx.seed=function(t){t>0&&t<1&&(t*=65536),(t=Math.floor(t))<256&&(t|=t<<8);for(let e=0;e<256;e++){let n;n=1&e?qx[e]^255&t:qx[e]^t>>8&255,Zx[e]=Zx[e+256]=n,$x[e]=$x[e+256]=Gx[n%12]}},Wx.seed(0);let Jx=.5*(Math.sqrt(3)-1),Qx=(3-Math.sqrt(3))/6;Wx.simplex2=function(t,e){let n,i,r,a,o,s=(t+e)*Jx,l=Math.floor(t+s),c=Math.floor(e+s),h=(l+c)*Qx,u=t-l+h,d=e-c+h;u>d?(a=1,o=0):(a=0,o=1);let p=u-a+Qx,g=d-o+Qx,f=u-1+2*Qx,m=d-1+2*Qx;l&=255,c&=255;let y=$x[l+Zx[c]],x=$x[l+a+Zx[c+o]],b=$x[l+1+Zx[c+1]],v=.5-u*u-d*d;v<0?n=0:(v*=v,n=v*v*y.dot2(u,d));let w=.5-p*p-g*g;w<0?i=0:(w*=w,i=w*w*x.dot2(p,g));let C=.5-f*f-m*m;return C<0?r=0:(C*=C,r=C*C*b.dot2(f,m)),70*(n+i+r)};const tb=Wx;function eb(t){const e=t/500,n=t,i=Om.canvas(t,n),r=i.getContext("2d"),a=r.createImageData(t,n);for(let i=0;i<t;i++)for(let r=0;r<n;r++){let o=4*(r*t+i);const s=e+.04*tb.simplex2(i/50/e,r/50/e);let l=100+(tb.simplex2(i/50/s,r/50/s)+1)/2*100;l-=(tb.simplex2(i/10/e,r/10/e)+1)/2*100;const c=Om.dist(t/2,n/2,i,r);l*=Om.clamp(1-((c-t/2.5)/(t/14)+tb.simplex2(i/22/s,r/22/s)),0,1);l*=2*Om.clamp(1-c/t,0,1),a.data[o]=0,a.data[o+1]=0,a.data[o+2]=0,a.data[o+3]=Om.clamp(l,0,255)}return r.putImageData(a,0,0),i}function nb(t,e,n){let i=Om.Vec2.sub(n,e),r=Om.Vec2.sub(t,e),a=Om.clamp(Om.Vec2.dot(r,i)/Om.Vec2.dot(i,i),0,1);return Om.Vec2.len(Om.Vec2.sub(r,Om.Vec2.mul(i,a)))}function ib(t){const e=.25;let n=2/3,i=1/3;n*=e,i*=e;const r={x:e*t,y:t-t*e},a={x:t-t*e,y:e*t},o=t,s=Om.canvas(t,o);let l=s.getContext("2d");const c=l.createImageData(t,o);for(let e=0;e<t;e++)for(let n=0;n<o;n++){const i=4*(n*t+e);let o=nb({x:e,y:n},r,a);o=Om.clamp(255-(o-.16666666666666666*t)/(.08333333333333333*t)*255,0,255),c.data[i]=0,c.data[i+1]=0,c.data[i+2]=0,c.data[i+3]=o}return l.putImageData(c,0,0),s}const rb=[];rb[1]=eb(128),rb[2]=ib(128);function ab(t,e,n){return t<=e?e:t>=n?n:t}const ob=Om.canvas(32,32),sb=ob.getContext("2d");function lb(t,e){const n=(e=Om.copyObj(e)).brush.size,i=e.brush.center.x,r=e.brush.center.y;let a=e.aP.y*t.width+e.aP.x;const o=4*(e.bP.y*t.width+e.bP.x-a);let s=0;const l=n>30?1024:512,c=[];for(let t=0;t<l;t++)c[t]=(Math.random()-.5)/1.001+.5;const h=Math.max(3,Math.min(8,e.brush.size-8)),u=(a,o,u,d)=>{const p=Om.dist(i,r,u,d),g=1-e.brush.opacity*(1-(y=1,(f=(p-(n-h))/h)<=(m=0)?m:f>=y?y:f));var f,m,y;if(1!==g){if(t.data[a+3])if(t.data[o+3]){let e;e=t.data[a+3]<t.data[o+3]?1-t.data[a+3]/t.data[o+3]*(1-g):t.data[o+3]/t.data[a+3]*g,t.data[o]=Math.floor(Om.mix(t.data[a],t.data[o+0],e)+c[s]),t.data[o+1]=Math.floor(Om.mix(t.data[a+1],t.data[o+1],e)+c[s]),t.data[o+2]=Math.floor(Om.mix(t.data[a+2],t.data[o+2],e)+c[s]),s=(s+1)%l}else t.data[o]=t.data[a+0],t.data[o+1]=t.data[a+1],t.data[o+2]=t.data[a+2];else;e.brush.alphaLock||(t.data[o+3]=Math.floor(Om.mix(t.data[a+3],t.data[o+3],g)+.5))}},d=4*e.bP.x,p=d+4*(e.size.w-1);if(e.aP.y<e.bP.y)for(let n=e.size.h-1,i=e.bP.y+e.size.h-1;n>=0;n--,i--){const r=(n+e.bP.y)*t.width*4;for(let t=p+r,n=p+r-o,a=e.bP.x+e.size.w-1;t>=d+r;t-=4,n-=4,a--)u(n,t,a,i)}else if(e.aP.y>e.bP.y)for(let n=0,i=e.bP.y;n<e.size.h;n++,i++){const r=(n+e.bP.y)*t.width*4;for(let t=p+r,n=p+r-o,a=e.bP.x+e.size.w-1;t>=d+r;t-=4,n-=4,a--)u(n,t,a,i)}else if(e.aP.x<e.bP.x)for(let n=e.size.h-1,i=e.bP.y+e.size.h-1;n>=0;n--,i--){const r=(n+e.bP.y)*t.width*4;for(let t=p+r,n=p+r-o,a=e.bP.x+e.size.w-1;t>=d+r;t-=4,n-=4,a--)u(n,t,a,i)}else for(let n=0,i=e.bP.y;n<e.size.h;n++,i++){const r=(n+e.bP.y)*t.width*4;for(let t=d+r,n=d+r-o,a=e.bP.x;t<p+r;t+=4,n+=4,a++)u(n,t,a,i)}}const cb={PenBrush:function(){let t,e,n,i,r,a=new Fb.DecoyKlHistory,o=2,s=.8489,l=1,c=!0,h=!1,u=!1,d=0,p={x:0,y:0,pressure:0},g={x:0,y:0,pressure:0},f=!1,m=[1,.9,1,1],y=document.createElement("canvas");y.width=128,y.height=128;let x=document.createElement("canvas");x.width=64,x.height=64;let b=document.createElement("canvas");b.width=32,b.height=32;let v=null,w=2*Math.PI;function C(){if(0===d||3===d)return;let t,e=[[y,128],[x,64],[b,32]];for(let i=0;i<e.length;i++)t=e[i][0].getContext("2d"),t.save(),t.clearRect(0,0,e[i][1],e[i][1]),t.fillStyle="rgba("+n.r+", "+n.g+", "+n.b+", "+m[d]+")",t.fillRect(0,0,e[i][1],e[i][1]),t.globalCompositeOperation="destination-in",t.imageSmoothingQuality="high",t.drawImage(rb[d],0,0,e[i][1],e[i][1]),t.restore()}function S(e,n,r,a,o,s){if(!(r<=0))if(u&&(t.globalCompositeOperation="source-atop"),s&&s[3]===a||(t.globalAlpha=a),s||0!==d&&3!==d||(t.fillStyle=i),0===d)t.beginPath(),t.arc(e,n,r,0,w),t.closePath(),t.fill();else if(3===d)void 0!==o&&(t.save(),t.translate(e,n),t.rotate(o/180*Math.PI),t.fillRect(-r,-r,2*r,2*r),t.restore());else{t.save(),t.translate(e,n);let i=y;r<=32&&r>16?i=x:r<=16&&(i=b),t.scale(r,r),1===d&&t.rotate(53123*(e+n)%w),t.drawImage(i,-1,-1,2,2),t.restore()}}function E(e,n,i,r){null===v&&(v=new Om.BezierLine,v.add(p.x,p.y,0,(function(){})));let a=[];function u(t){let e=Om.mix(g.pressure,r,t.t),n=l*(h?e*e:1),i=Math.max(.1,o*(c?e:1));a.push([t.x,t.y,i,n,t.angle])}let d,f=i*s;null===e?v.addFinal(f,u):v.add(e,n,f,u),t.save();for(let t=0;t<a.length;t++){let e=a[t];S(e[0],e[1],e[2],e[3],e[4],d),d=e}t.restore()}this.startLine=function(i,a,m){e={tool:["brush","PenBrush"],actions:[]},e.actions.push({action:"opacityPressure",params:[h]}),e.actions.push({action:"sizePressure",params:[c]}),e.actions.push({action:"setSize",params:[o]}),e.actions.push({action:"setSpacing",params:[s]}),e.actions.push({action:"setOpacity",params:[l]}),e.actions.push({action:"setColor",params:[n]}),e.actions.push({action:"setAlpha",params:[d]}),e.actions.push({action:"setLockAlpha",params:[u]}),m=Om.clamp(m,0,1);let y=h?l*m*m:l,x=c?Math.max(.1,m*o):Math.max(.1,o);f=!0,t.save(),S(i,a,x,y),t.restore(),r=x*s,p.x=i,p.y=a,p.pressure=m,g.pressure=m,e.actions.push({action:"startLine",params:[i,a,m]})},this.goLine=function(n,i,r){if(!f)return;e.actions.push({action:"goLine",params:[n,i,r]});let a=Om.clamp(r,0,1),s=c?Math.max(.1,p.pressure*o):Math.max(.1,o);t.save(),E(n,i,s,p.pressure),t.restore(),p.x=n,p.y=i,g.pressure=p.pressure,p.pressure=a},this.endLine=function(n,i){let r=c?Math.max(.1,p.pressure*o):Math.max(.1,o);t.save(),E(null,null,r,p.pressure),t.restore(),f=!1,v=null,e&&(e.actions.push({action:"endLine",params:[n,i]}),a.push(e),e=void 0)},this.drawLineSegment=function(t,e,i,g){if(p.x=i,p.y=g,p.pressure=1,f||void 0===t)return;let m,y=Om.pointsToAngleDeg({x:t,y:e},{x:i,y:g}),x=Math.sqrt(Math.pow(i-t,2)+Math.pow(g-e,2)),b=(i-t)/x,v=(g-e)/x,w=o*s;for(r=o*s,m=r;m<=x;m+=w)S(t+b*m,e+v*m,o,l,y);let C={tool:["brush","PenBrush"],actions:[]};C.actions.push({action:"opacityPressure",params:[h]}),C.actions.push({action:"sizePressure",params:[c]}),C.actions.push({action:"setSize",params:[o]}),C.actions.push({action:"setSpacing",params:[s]}),C.actions.push({action:"setOpacity",params:[l]}),C.actions.push({action:"setColor",params:[n]}),C.actions.push({action:"setAlpha",params:[d]}),C.actions.push({action:"setLockAlpha",params:[u]}),C.actions.push({action:"drawLineSegment",params:[t,e,i,g]}),a.push(C)},this.isDrawing=function(){return f},this.setAlpha=function(t){d!==t&&(d=t,C())},this.setColor=function(t){n!==t&&(n={r:t.r,g:t.g,b:t.b},i="rgb("+n.r+","+n.g+","+n.b+")",C())},this.setContext=function(e){t=e},this.setHistory=function(t){a=t},this.setSize=function(t){o=t},this.setOpacity=function(t){l=t},this.setSpacing=function(t){s=t},this.sizePressure=function(t){c=t},this.opacityPressure=function(t){h=t},this.setLockAlpha=function(t){u=t},this.getSpacing=function(){return s},this.getSize=function(){return o},this.getOpacity=function(){return l},this.getLockAlpha=function(t){return u}},BlendBrush:class{updateRedrawBounds(t){this.redrawBounds=Om.updateBounds(this.redrawBounds,t)}getCellsWidth(){return Math.ceil(this.context.canvas.width/256)}drawChangedCells(){const t=this.cells.map((t=>null));this.getTouchedCells(this.redrawBounds).forEach(((e,n)=>{e&&(t[n]=this.cells[n])})),this.drawCells(t),this.redrawBounds=null}getTouchedCells(t){const e=this.cells.map((t=>!1)),n=this.getCellsWidth();for(let i=(t={x1:Math.floor(t.x1/256),y1:Math.floor(t.y1/256),x2:Math.floor(t.x2/256),y2:Math.floor(t.y2/256)}).x1;i<=t.x2;i++)for(let r=t.y1;r<=t.y2;r++)e[r*n+i]=!0;return e}sliceBounds(t){const e=this.getCellsWidth(),n=[];return this.getTouchedCells(t).forEach(((i,r)=>{if(!i)return;const a=r%e*256,o=256*Math.floor(r/e),s=this.cells[r].width,l=this.cells[r].height,c={x1:Math.max(0,t.x1-a),y1:Math.max(0,t.y1-o),x2:Math.min(s-1,t.x2-a),y2:Math.min(l-1,t.y2-o)};c.x1>c.x2||c.y1>c.y2||n.push({index:r,bounds:c})})),n}copyFromCanvas(t){if(!t)return;const e=this.getTouchedCells(t),n=this.getCellsWidth();e.forEach(((t,e)=>{if(!t||this.cells[e])return;const i=e%n,r=Math.floor(e/n),a=(Math.min(256*i+256,this.context.canvas.width)-1)%256+1,o=(Math.min(256*r+256,this.context.canvas.height)-1)%256+1,s=Om.canvas(a,o).getContext("2d");s.drawImage(this.context.canvas,256*-i,256*-r),this.cells[e]=s.getImageData(0,0,a,o)}))}getAverage(t,e,n){n=Math.max(.5,.75*n);const i=Math.max(0,Math.floor(t-n)),r=Math.max(0,Math.floor(e-n)),a=Math.min(this.context.canvas.width-1,Math.ceil(t+n)),o=Math.min(this.context.canvas.height-1,Math.ceil(e+n));if(i>a||r>o)return{r:0,g:0,b:0,a:0};let s,l=0,c=0,h=0,u=0;return this.sliceBounds({x1:i,y1:r,x2:a,y2:o}).forEach((t=>{const e=this.cells[t.index].width,n=this.cells[t.index].data,i=t.bounds;for(let t=i.y1;t<=i.y2;t+=4)for(let r=i.x1,a=t*e*4+4*i.x1;r<=i.x2;r+=4,a+=16)s=n[a+3],l+=n[a]*s,c+=n[a+1]*s,h+=n[a+2]*s,u+=s})),0!==u&&(l/=u,c/=u,h/=u,u=Math.min(1,u)),{r:l,g:c,b:h,a:u}}prepDot(t,e,n){n=Math.max(.5,n);let i=Math.max(0,Math.floor(t-n)),r=Math.max(0,Math.floor(e-n)),a=Math.min(this.context.canvas.width-1,Math.ceil(t+n)),o=Math.min(this.context.canvas.height-1,Math.ceil(e+n));return i>a||r>o?null:{x1:i,y1:r,x2:a,y2:o}}drawDot(t){let e=0;const n=t.size>30?1024:512,i=[];for(let t=0;t<n;t++)i[t]=(Math.random()-.5)/1.001+.5;const r=[8,4,4,4,2,2,2,2,2,2][Math.floor(2*t.size)],a=r?r*r:0,o=[];if(r){let t=0;for(let e=0;e<r;e++)for(let n=0;n<r;n++,t+=2)o[t]=(e+1)/r,o[t+1]=(n+1)/r}const s=.8*Math.pow(t.opacity,2),l=1-s,c=s/l,h=t.size*t.size,u=h*l/t.opacity,d=(1+c)*t.opacity,p=this.sliceBounds({x1:t.x1,y1:t.y1,x2:t.x2,y2:t.y2}),g=this.getCellsWidth();p.forEach((r=>{const s=r.index%g*256,l=256*Math.floor(r.index/g),c=this.cells[r.index].width,p=this.cells[r.index].data;for(let g=r.bounds.y1,f=g+l-t.y;g<=r.bounds.y2;g++,f++)for(let l=r.bounds.x1,m=g*c*4+4*r.bounds.x1,y=l+s-t.x;l<=r.bounds.x2;l++,m+=4,y++){let r=0;if(a){for(let e=0;e<o.length;e+=2){const n=Om.lenSquared(y+o[e],f+o[e+1]);n>=h||(r+=ab(d-n/u,0,t.opacity))}if(!r)continue;r/=a}else{const e=Math.pow(y,2)+Math.pow(f,2);if(e>=h)continue;r=ab(d-e/u,0,t.opacity)}const s=1-r,l=p[m+3]/255;if(this.settingLockLayerAlpha){const n=t.r*r+p[m]*s,a=t.g*r+p[m+1]*s,o=t.b*r+p[m+2]*s;l&&(p[m]=Math.floor(n+i[e]),p[m+1]=Math.floor(a+i[e]),p[m+2]=Math.floor(o+i[e]))}else{const n=t.r*r+p[m]*l*s,a=t.g*r+p[m+1]*l*s,o=t.b*r+p[m+2]*l*s;let c=1-s*(1-l);p[m+3]=Math.floor(Math.min(255,255*c)+.5),c&&(p[m]=Math.floor(n/c+i[e]),p[m+1]=Math.floor(a/c+i[e]),p[m+2]=Math.floor(o/c+i[e]))}e=(e+1)%n}}))}calcSpacing(t){return Om.mix(2*t/2,2*t/9,Om.clamp((t-2.7)/9.3,0,1))}continueLine(t,e,n,i){let r,a;this.drawBuffer=[];let o,s=this.settingSizePressure?Math.max(1,n*this.size):Math.max(1,this.size),l=this.calcSpacing(s),c=t,h=e;if(null===t&&(c=this.lastInput.x,h=this.lastInput.y),0===this.blending)this.mixr=this.color.r,this.mixg=this.color.g,this.mixb=this.color.b;else{let t;if(i)t={r:this.localColOld.r,g:this.localColOld.g,b:this.localColOld.b,a:0};else{const e=[c,h,this.settingSizePressure?Math.max(.5,n*this.size):Math.max(.5,this.size)],i=this.prepDot(e[0],e[1],e[2]);this.copyFromCanvas(i),t=this.getAverage(e[0],e[1],e[2])}o={r:0,g:0,b:0,a:0},t.a>0&&0===this.blendCol.a?(this.blendCol.r=t.r,this.blendCol.g=t.g,this.blendCol.b=t.b,this.blendCol.a=t.a,o.r=this.blendCol.r,o.g=this.blendCol.g,o.b=this.blendCol.b,o.a=this.blendCol.a):(0===t.a&&(t.r=this.color.r,t.g=this.color.g,t.b=this.color.b,t.a=1-this.blending),this.blendCol.r=Om.mix(this.blendCol.r,Om.mix(this.blendCol.r,t.r,this.blendMix),t.a),this.blendCol.g=Om.mix(this.blendCol.g,Om.mix(this.blendCol.g,t.g,this.blendMix),t.a),this.blendCol.b=Om.mix(this.blendCol.b,Om.mix(this.blendCol.b,t.b,this.blendMix),t.a),this.blendCol.a=Math.min(1,this.blendCol.a+t.a),o.r=this.blendCol.r,o.g=this.blendCol.g,o.b=this.blendCol.b,o.a=this.blendCol.a)}const u=t=>{if(this.blending>=1&&this.blendCol.a<=0)return;let e=t.t;r=this.lastInput2.pressure*(1-e)+n*e,a=this.settingOpacityPressure?this.opacity*r*r:this.opacity,s=this.settingSizePressure?Math.max(.1,r*this.size):Math.max(.1,this.size),0!=this.blending&&(this.mixr=Om.mix(this.localColOld.r,o.r,e),this.mixg=Om.mix(this.localColOld.g,o.g,e),this.mixb=Om.mix(this.localColOld.b,o.b,e)),1===this.blending&&0===this.localColOld.a&&(this.mixr=o.r,this.mixg=o.g,this.mixb=o.b);const i=this.prepDot(t.x,t.y,s);i&&(this.updateRedrawBounds(i),this.drawBuffer.push({x:t.x,y:t.y,size:s,opacity:a,x1:i.x1,y1:i.y1,x2:i.x2,y2:i.y2,r:Om.mix(this.color.r,this.mixr,this.blending),g:Om.mix(this.color.g,this.mixg,this.blending),b:Om.mix(this.color.b,this.mixb,this.blending)}))};null===t?this.bezierLine.addFinal(l,u):this.bezierLine.add(t,e,l,u),this.copyFromCanvas(this.redrawBounds),this.drawBuffer.forEach((t=>{this.drawDot(t)})),this.drawBuffer=[],this.localColOld=o}setHistory(t){this.history=t}getSize(){return this.size}setSize(t){this.size=t}getOpacity(){return this.opacity}setOpacity(t){this.opacity=t}getBlending(){return this.blending}setBlending(t){this.blending=t}setColor(t){this.color=Om.copyObj(t)}setContext(t){this.context=t}setSizePressure(t){this.settingSizePressure=!!t}setOpacityPressure(t){this.settingOpacityPressure=!!t}getLockAlpha(){return this.settingLockLayerAlpha}setLockAlpha(t){this.settingLockLayerAlpha=!!t}getIsDrawing(){return this.isDrawing}setIsTesting(t){this.isTesting=!!t}startLine(t,e,n){this.historyEntry={tool:["brush","BlendBrush"],actions:[]};const i=Math.ceil(this.context.canvas.width/256)*Math.ceil(this.context.canvas.height/256);this.cells="0".repeat(i).split("").map((t=>null)),this.isDrawing=!0,n=Math.max(0,Math.min(1,n));let r=this.settingOpacityPressure?this.opacity*n*n:this.opacity,a=this.settingSizePressure?Math.max(.1,n*this.size):Math.max(.1,this.size);if(0===this.blending)this.mixr=this.color.r,this.mixg=this.color.g,this.mixb=this.color.b;else{this.copyFromCanvas(this.prepDot(t,e,a));let i=this.getAverage(t,e,this.settingSizePressure?Math.max(.1,n*this.size):Math.max(.1,this.size));0===i.a?this.blendCol={r:this.color.r,g:this.color.g,b:this.color.b,a:1-this.blending}:this.blendCol={r:i.r,g:i.g,b:i.b,a:i.a},this.mixr=this.blendCol.r,this.mixg=this.blendCol.g,this.mixb=this.blendCol.b}if(this.localColOld={r:this.mixr,g:this.mixg,b:this.mixb,a:this.blendCol.a},this.redrawBounds=null,this.drawBuffer=[],this.blending<1||this.blendCol.a>0){const n=this.prepDot(t,e,a);n&&(this.updateRedrawBounds(n),this.drawBuffer.push({x:t,y:e,size:a,opacity:r,x1:n.x1,y1:n.y1,x2:n.x2,y2:n.y2,r:Om.mix(this.color.r,this.mixr,this.blending),g:Om.mix(this.color.g,this.mixg,this.blending),b:Om.mix(this.color.b,this.mixb,this.blending)}))}this.copyFromCanvas(this.redrawBounds),this.drawBuffer.forEach((t=>{this.drawDot(t)})),this.drawBuffer=[],this.bezierLine=new Om.BezierLine,this.bezierLine.add(t,e,0,(function(){})),this.lastInput.x=t,this.lastInput.y=e,this.lastInput.pressure=n,this.lastInput2=Om.copyObj(this.lastInput),this.redrawBounds&&!this.isTesting&&this.drawChangedCells()}goLine(t,e,n,i){this.isDrawing&&(this.continueLine(t,e,this.lastInput.pressure,i),this.lastInput2=Om.copyObj(this.lastInput),this.lastInput.x=t,this.lastInput.y=e,this.lastInput.pressure=n,this.redrawBounds&&!this.isTesting&&this.drawChangedCells())}endLine(){this.bezierLine&&this.continueLine(null,null,this.lastInput.pressure,!1),this.isDrawing=!1,this.bezierLine=null,this.redrawBounds&&this.drawChangedCells(),this.historyEntry&&this.history&&this.cells.find((t=>!!t))&&(this.historyEntry.actions.push({action:"drawCells",params:[this.cells]}),this.history.push(this.historyEntry),this.historyEntry=null),this.cells=null}drawCells(t){const e=this.getCellsWidth();t.forEach(((t,n)=>{if(!t)return;const i=n%e*256,r=256*Math.floor(n/e);this.context.putImageData(t,i,r)}))}drawLineSegment(t,e,n,i){if(this.lastInput.x=n,this.lastInput.y=i,this.isDrawing||void 0===t)return;const r=Math.ceil(this.context.canvas.width/256)*Math.ceil(this.context.canvas.height/256);this.cells="0".repeat(r).split("").map((t=>null)),this.redrawBounds=null,this.drawBuffer=[],this.copyFromCanvas(this.prepDot(t,e,Math.max(.1,this.size)));let a=this.getAverage(t,e,Math.max(.1,this.size));0===a.a?this.blendCol={r:this.color.r,g:this.color.g,b:this.color.b,a:1-this.blending}:this.blendCol={r:a.r,g:a.g,b:a.b,a:a.a},this.mixr=this.color.r*(1-this.blendCol.a)+(this.blending*this.blendCol.r+this.color.r*(1-this.blending))*this.blendCol.a,this.mixg=this.color.g*(1-this.blendCol.a)+(this.blending*this.blendCol.g+this.color.g*(1-this.blending))*this.blendCol.a,this.mixb=this.color.b*(1-this.blendCol.a)+(this.blending*this.blendCol.b+this.color.b*(1-this.blending))*this.blendCol.a;const o=this.settingOpacityPressure?1*this.opacity*1:this.opacity,s=this.settingSizePressure?Math.max(.1,1*this.size):Math.max(.1,this.size),l=Math.sqrt(Math.pow(n-t,2)+Math.pow(i-e,2)),c=(n-t)/l,h=(i-e)/l,u=this.calcSpacing(s);for(let n=0;n<=l;n+=u){const i=this.prepDot(t+c*n,e+h*n,s);i&&(this.copyFromCanvas(i),this.drawBuffer.push({x:t+c*n,y:e+h*n,size:s,opacity:o,x1:i.x1,y1:i.y1,x2:i.x2,y2:i.y2,r:Om.mix(this.color.r,this.mixr,this.blending),g:Om.mix(this.color.g,this.mixg,this.blending),b:Om.mix(this.color.b,this.mixb,this.blending)}))}this.drawBuffer.forEach((t=>{this.drawDot(t)})),this.drawBuffer=[],this.history&&this.cells.find((t=>!!t))&&(this.drawCells(this.cells),this.historyEntry={tool:["brush","BlendBrush"],actions:[{action:"drawCells",params:[this.cells]}]},this.history.push(this.historyEntry),this.historyEntry=null),this.cells=null}constructor(){this.isTesting=!1,this.size=29,this.opacity=.6,this.blending=.65,this.settingLockLayerAlpha=!1,this.settingSizePressure=!0,this.settingOpacityPressure=!1,this.blendCol={r:0,g:0,b:0,a:1},this.blendMix=.45,this.isDrawing=!1,this.lastInput={x:0,y:0,pressure:0},this.lastInput2={x:0,y:0,pressure:0}}},SketchyBrush:function(){let t,e,n,i,r,a=1,o=.2,s=.5,l=1,c=!1,h={x:0,y:0,pressure:0},u=new Fb.DecoyKlHistory,d=0;this.setHistory=function(t){u=t},this.setSeed=function(t){d=parseInt(t)},this.getSeed=function(){return parseInt(""+d)};let p=[],g=0,f=[function(t,e){return t},function(t,e){let n=new Om.RGB(t.r,t.g,t.b);return n.r*=e.r/255,n.g*=e.g/255,n.b*=e.b/255,n},function(t,e){let n=new Om.RGB(t.r,t.g,t.b);return n.r*=e.r/255,n.g*=e.g/255,n.b*=e.b/255,n}];this.getSize=function(){return a/2},this.setColor=function(t){e=t},this.getOpacity=function(){return o},this.setOpacity=function(t){o=t},this.getBlending=function(){return s},this.setBlending=function(t){s=t},this.setSize=function(t){a=2*t},this.getScale=function(){return l},this.setScale=function(t){l=t},this.setContext=function(e){t=e},this.startLine=function(t,u,d,p){if(p&&h.x){h.x,h.y;c=!0,this.endLine()}else c=!0,n=t,i=u,h.x=t,h.y=u,r={tool:["brush","SketchyBrush"],actions:[]},r.actions.push({action:"setScale",params:[l]}),r.actions.push({action:"setSize",params:[a/2]}),r.actions.push({action:"setOpacity",params:[o]}),r.actions.push({action:"setColor",params:[e]}),r.actions.push({action:"setBlending",params:[s]}),r.actions.push({action:"startLine",params:[t,u,d]})},this.goLine=function(u,m,y,x){if(!c||u===h.x&&m===h.y)return;let b,v,w,C,S=parseInt(u),E=parseInt(m);p.push([S,E]);let M=e.r,I=e.g,k=e.b;if(null!==x)M=x.r,I=x.g,k=x.b;else if(0!==s&&S+5>=0&&E+5>=0&&S-5<t.canvas.width-1&&E-5<t.canvas.height-1){M=0,I=0,k=0;let n=Math.min(t.canvas.width-1,Math.max(0,S-5)),i=Math.min(t.canvas.height-1,Math.max(0,E-5)),r=Math.min(t.canvas.width-1,Math.max(0,S+5)),a=Math.min(t.canvas.height-1,Math.max(0,E+5));if(r-=n,a-=i,r>0&&a>0){let e=t.getImageData(n,i,r,a),o=0;for(let t=0;t<e.data.length;t+=4)M+=e.data[t+0],I+=e.data[t+1],k+=e.data[t+2],o++;M/=o,I/=o,k/=o}let o=f[0](new Om.RGB(M,I,k),e);M=parseInt(""+Om.mix(e.r,o.r,s)),I=parseInt(""+Om.mix(e.g,o.g,s)),k=parseInt(""+Om.mix(e.b,o.b,s))}for(t.save(),t.strokeStyle="rgba("+M+", "+I+", "+k+", "+o+")",t.lineWidth=a,t.beginPath(),t.moveTo(n,i),t.lineTo(S,E),b=0;b<p.length;b++)v=p[b][0]-p[g][0],w=p[b][1]-p[g][1],C=v*v+w*w,C<4e3*l*l&&(d++,.5*Math.sin(6324634.2345*Math.cos(5342.3423*d))+.5>C/2e3/l/l)&&(t.moveTo(p[g][0]+.3*v,p[g][1]+.3*w),t.lineTo(p[b][0]-.3*v,p[b][1]-.3*w));t.stroke(),t.restore(),g++,n=S,i=E,h.x=S,h.y=E,r.actions.push({action:"goLine",params:[u,m,y,{r:M,g:I,b:k}]})},this.endLine=function(){c=!1,g=0,p=[],r&&(r.actions.push({action:"endLine",params:[]}),u.push(r),r=void 0)},this.drawLineSegment=function(n,i,r,d){if(h.x=r,h.y=d,c||void 0===n)return;t.save(),t.lineWidth=a;let p=e.r,g=e.g,m=e.b;if(n+5>=0&&i+5>=0&&n-5<t.canvas.width-1&&i-5<t.canvas.height-1){p=0,g=0,m=0;let e=Math.min(t.canvas.width-1,Math.max(0,n-5)),r=Math.min(t.canvas.height-1,Math.max(0,i-5)),a=Math.min(t.canvas.width-1,Math.max(0,n+5)),o=Math.min(t.canvas.height-1,Math.max(0,i+5));if(a-=e,o-=r,a>0&&o>0){let n=Math.min(ob.width,a),i=Math.min(ob.height,o);sb.save(),sb.globalCompositeOperation="copy",sb.drawImage(t.canvas,e,r,a,o,0,0,n,i),sb.restore();let s=sb.getImageData(e,r,a,o),l=0;for(let t=0;t<s.data.length;t+=4)p+=s.data[t+0],g+=s.data[t+1],m+=s.data[t+2],l++;p/=l,g/=l,m/=l}}let y=f[0](new Om.RGB(p,g,m),e);p=parseInt(""+(s*y.r+e.r*(1-s))),g=parseInt(""+(s*y.g+e.g*(1-s))),m=parseInt(""+(s*y.b+e.b*(1-s))),t.strokeStyle="rgba("+p+", "+g+", "+m+", "+o+")",t.beginPath(),t.moveTo(n,i),t.lineTo(r,d),t.stroke(),t.strokeStyle="rgba("+p+", "+g+", "+m+", "+o+")",t.restore();let x={tool:["brush","SketchyBrush"],actions:[]};x.actions.push({action:"setScale",params:[l]}),x.actions.push({action:"setSize",params:[a/2]}),x.actions.push({action:"setOpacity",params:[o]}),x.actions.push({action:"setColor",params:[e]}),x.actions.push({action:"setBlending",params:[s]}),x.actions.push({action:"drawLineSegment",params:[n,i,r,d]}),u.push(x)},this.isDrawing=function(){return c}},PixelBrush:function(){let t,e,n,i,r,a,o=new Fb.DecoyKlHistory,s=.5,l=.9,c=1,h=!0,u=!1,d=!1,p=!1,g=!0,f={x:0,y:0,pressure:0},m={x:0,y:0,pressure:0},y=!1,x=null,b=(Math.PI,Om.canvas(4,4)),v=b.getContext("2d"),w=[[3,2],[1,0],[3,0],[1,2],[2,1],[0,3],[0,1],[2,3],[2,0],[0,2],[0,0],[2,2],[1,1],[3,3],[3,1],[1,3]];function C(){v.clearRect(0,0,4,4),v.fillStyle=p?"#fff":i;for(let t=0;t<Math.max(1,Math.round(c*w.length));t++)v.fillRect(w[t][0],w[t][1],1,1);a=t.createPattern(b,"repeat")}function S(e,n,r,o,s){t.save(),p?(t.fillStyle=g?a:"#fff",t.globalCompositeOperation=d?"source-atop":"destination-out"):(t.fillStyle=g?a:i,d&&(t.globalCompositeOperation="source-atop")),t.globalAlpha=g?1:c,e=Math.floor(e),n=Math.floor(n),r=Math.floor(r),o=Math.floor(o);let l=Math.abs(r-e),h=e<r?1:-1,u=-Math.abs(o-n),f=n<o?1:-1,m=l+u;for(;s?s=!1:t.fillRect(e,n,1,1),e!==r||n!==o;){let t=2*m;t>=u&&(m+=u,e+=h),t<=l&&(m+=l,n+=f)}t.restore()}function E(t,e,n,i){let r=function(t,e,n,i,r){let a=Om.Vec2.nor({x:i.x-t.x,y:i.y-t.y}),o=Om.Vec2.nor({x:e.x-t.x,y:e.y-t.y}),s=Om.Vec2.nor({x:i.x-n.x,y:i.y-n.y});return Math.abs(Om.Vec2.angle(a,o)%Math.PI),Math.PI,Math.abs(Om.Vec2.angle(a,s)%Math.PI),Math.PI,Math.max(Om.Vec2.dist(a,o),Om.Vec2.dist(a,s))>r}(t,e,n,i,.1);t.x=Math.floor(t.x),t.y=Math.floor(t.y),i.x=Math.floor(i.x),i.y=Math.floor(i.y);let a=Om.dist(t.x,t.y,i.x,i.y);if(!r||a<7)return void S(t.x,t.y,i.x,i.y,!0);let o=Math.max(2,Math.round(a/4)),s=[];for(let r=0;r<=o;r++){let a=r/o,l=Math.pow(1-a,3),c=3*a*Math.pow(1-a,2),h=3*Math.pow(a,2)*(1-a),u=Math.pow(a,3);s.push({x:l*t.x+c*e.x+h*n.x+u*i.x,y:l*t.y+c*e.y+h*n.y+u*i.y})}for(let t=0;t<o;t++)S(Math.round(s[t].x),Math.round(s[t].y),Math.round(s[t+1].x),Math.round(s[t+1].y),!0)}function M(e,n,r,o,s){t.save(),p?(t.fillStyle=g?a:"#fff",t.globalCompositeOperation=d?"source-atop":"destination-out"):(t.fillStyle=g?a:i,d&&(t.globalCompositeOperation="source-atop")),t.globalAlpha=g?1:o,t.fillRect(Math.round(e+-r),Math.round(n+-r),Math.round(2*r),Math.round(2*r)),t.restore()}function I(e,n,i,r){function a(t){let e=Om.mix(m.pressure,r,t.t),n=c*(u?e*e:1),i=Math.max(.5,s*(h?e:1));M(t.x,t.y,i,n,t.angle)}function o(t){E(t.p1,t.p2,t.p3,t.p4)}if(null===x&&(x=new Om.BezierLine,x.add(f.x,f.y,0,(function(){}))),t.save(),1===Math.round(2*s))null===e?x.addFinal(4,null,o):x.add(e,n,4,null,o);else{let t=i*l;null===e?x.addFinal(t,a):x.add(e,n,t,a)}t.restore()}this.startLine=function(t,i,a){e={tool:["brush","PixelBrush"],actions:[]},e.actions.push({action:"sizePressure",params:[h]}),e.actions.push({action:"setSize",params:[s]}),e.actions.push({action:"setSpacing",params:[l]}),e.actions.push({action:"setOpacity",params:[c]}),e.actions.push({action:"setColor",params:[n]}),e.actions.push({action:"setLockAlpha",params:[d]}),e.actions.push({action:"setIsEraser",params:[p]}),e.actions.push({action:"setUseDither",params:[g]}),g&&C(),a=Math.max(0,Math.min(1,a));let o=u?c*a*a:c,x=h?Math.max(.5,a*s):Math.max(.5,s);y=!0,M(t,i,x,o),r=x*l,f.x=t,f.y=i,f.pressure=a,m=Om.copyObj(f),e.actions.push({action:"startLine",params:[t,i,a]})},this.goLine=function(t,n,i){if(!y)return;e.actions.push({action:"goLine",params:[t,n,i]});let r=Om.clamp(i,0,1);I(t,n,h?Math.max(.1,f.pressure*s):Math.max(.1,s),f.pressure),m=Om.copyObj(f),f.x=t,f.y=n,f.pressure=r},this.endLine=function(t,n){I(null,null,h?Math.max(.1,f.pressure*s):Math.max(.1,s),f.pressure),y=!1,x=null,e&&(e.actions.push({action:"endLine",params:[t,n]}),o.push(e),e=void 0)},this.drawLineSegment=function(t,e,i,a){if(f.x=i,f.y=a,f.pressure=1,y||void 0===t)return;if(g&&C(),1===Math.round(2*s))S(t,e,i,a,!0);else{Om.pointsToAngleDeg({x:t,y:e},{x:i,y:a});let n,o=Math.sqrt(Math.pow(i-t,2)+Math.pow(a-e,2)),h=(i-t)/o,u=(a-e)/o,d=s*l;for(r=s*l,n=r;n<=o;n+=d)M(t+h*n,e+u*n,s,c)}let u={tool:["brush","PixelBrush"],actions:[]};u.actions.push({action:"sizePressure",params:[h]}),u.actions.push({action:"setSize",params:[s]}),u.actions.push({action:"setSpacing",params:[l]}),u.actions.push({action:"setOpacity",params:[c]}),u.actions.push({action:"setColor",params:[n]}),u.actions.push({action:"setLockAlpha",params:[d]}),u.actions.push({action:"setIsEraser",params:[p]}),u.actions.push({action:"setUseDither",params:[g]}),u.actions.push({action:"drawLineSegment",params:[t,e,i,a]}),o.push(u)},this.isDrawing=function(){return y},this.setColor=function(t){n!==t&&(n=t,i="rgb("+n.r+","+n.g+","+n.b+")")},this.setContext=function(e){t=e},this.setHistory=function(t){o=t},this.setSize=function(t){s=t},this.setOpacity=function(t){c=t},this.setSpacing=function(t){l=t},this.sizePressure=function(t){h=t},this.opacityPressure=function(t){u=t},this.setLockAlpha=function(t){d=t},this.setIsEraser=function(t){p=!!t},this.setUseDither=function(t){g=!!t},this.getSpacing=function(){return l},this.getSize=function(){return s},this.getOpacity=function(){return c},this.getLockAlpha=function(){return d},this.getIsEraser=function(){return p},this.getUseDither=function(){return g}},ChemyBrush:class{updateCompleteRedrawBounds(t,e){let n={x1:t,y1:e,x2:t,y2:e};this.settingXSymmetry&&(n=Om.updateBounds(n,{x1:-t+this.copyCanvas.width,y1:e,x2:-t+this.copyCanvas.width,y2:e})),this.settingYSymmetry&&(n=Om.updateBounds(n,{x1:t,y1:-e+this.copyCanvas.height,x2:t,y2:-e+this.copyCanvas.height}));const i="stroke"===this.settingMode?this.settingSize+1:1;n.x1=Math.floor(n.x1-i),n.y1=Math.floor(n.y1-i),n.x2=Math.ceil(n.x2+i),n.y2=Math.ceil(n.y2+i),this.completeRedrawBounds=Om.updateBounds(this.completeRedrawBounds,n)}drawShape(){this.context.save(),this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.drawImage(this.copyCanvas,0,0);let t={...this.settingColor};if(this.settingIsEraser?(t.r=255,t.g=255,t.b=255,this.settingLockLayerAlpha?this.context.globalCompositeOperation="source-atop":this.context.globalCompositeOperation="destination-out"):this.settingLockLayerAlpha&&(this.context.globalCompositeOperation="source-atop"),this.path){const e=new Path2D;this.path.forEach(((t,n)=>{0===n?e.moveTo(t.x,t.y):e.lineTo(t.x,t.y)}));let n=Om.ColorConverter.toRgbaStr({r:t.r,g:t.g,b:t.b,a:this.settingOpacity});if(this.settingGradient){const e=this.path[0].x>this.path[this.path.length-1].x,i=this.context.createLinearGradient(0,e?this.minY:this.maxY,0,e?this.maxY:this.minY);i.addColorStop(0,Om.ColorConverter.toRgbaStr({r:t.r,g:t.g,b:t.b,a:this.settingOpacity})),i.addColorStop(1,Om.ColorConverter.toRgbaStr({r:t.r,g:t.g,b:t.b,a:0})),n=i}"fill"===this.settingMode?this.context.fillStyle=n:(this.context.lineWidth=2*this.settingSize,this.context.lineJoin="bevel",this.context.strokeStyle=n);const i=()=>{"fill"===this.settingMode?this.context.fill(e):this.context.stroke(e)};i(),this.settingXSymmetry&&(this.context.save(),this.context.translate(this.context.canvas.width/2,0),this.context.scale(-1,1),this.context.translate(-this.context.canvas.width/2,0),i(),this.context.restore()),this.settingYSymmetry&&(this.context.save(),this.context.translate(0,this.context.canvas.height/2),this.context.scale(1,-1),this.context.translate(0,-this.context.canvas.height/2),i(),this.context.restore(),this.settingXSymmetry&&(this.context.save(),this.context.translate(this.context.canvas.width/2,this.context.canvas.height/2),this.context.scale(-1,-1),this.context.translate(-this.context.canvas.width/2,-this.context.canvas.height/2),i(),this.context.restore()))}this.context.restore()}setHistory(t){this.history=t}getSize(){return"stroke"===this.settingMode?this.settingSize:0}setSize(t){this.settingSize=t}getOpacity(){return this.settingOpacity}setOpacity(t){this.settingOpacity=t}setColor(t){this.settingColor=Om.copyObj(t)}setContext(t){this.context=t}setMode(t){this.settingMode=t}getMode(){return this.settingMode}setDistort(t){this.settingDistort=Om.clamp(t,0,1)}getDistort(){return this.settingDistort}setXSymmetry(t){this.settingXSymmetry=!!t}getXSymmetry(){return this.settingXSymmetry}setYSymmetry(t){this.settingYSymmetry=!!t}getYSymmetry(){return this.settingYSymmetry}setGradient(t){this.settingGradient=!!t}getGradient(){return this.settingGradient}getLockAlpha(){return this.settingLockLayerAlpha}setLockAlpha(t){this.settingLockLayerAlpha=!!t}getIsEraser(){return this.settingIsEraser}setIsEraser(t){this.settingIsEraser=!!t}getIsDrawing(){return this.isDrawing}startLine(t,e){this.isDrawing=!0,this.path=[{x:t,y:e}],this.minY=e,this.maxY=e,this.copyCanvas=Om.canvas(this.context.canvas.width,this.context.canvas.height),this.copyCanvas.getContext("2d").drawImage(this.context.canvas,0,0),this.completeRedrawBounds=null,this.updateCompleteRedrawBounds(t,e)}goLine(t,e){if(!this.isDrawing)return;let n={x:t,y:e};this.settingDistort>0&&(n.x+=(Math.random()-.5)*this.settingDistort*80,n.y+=(Math.random()-.5)*this.settingDistort*80),this.minY=Math.min(this.minY,n.y),this.maxY=Math.max(this.maxY,n.y),this.path.push(n),this.updateCompleteRedrawBounds(t,e),this.drawShape()}endLine(){if(this.isDrawing=!1,this.completeRedrawBounds=Om.boundsInArea(this.completeRedrawBounds,this.copyCanvas.width,this.copyCanvas.height),this.path.length>1&&this.completeRedrawBounds){const t=Om.canvas(this.completeRedrawBounds.x2-this.completeRedrawBounds.x1+1,this.completeRedrawBounds.y2-this.completeRedrawBounds.y1+1);t.getContext("2d").drawImage(this.context.canvas,-this.completeRedrawBounds.x1,-this.completeRedrawBounds.y1),this.history.push({tool:["brush","ChemyBrush"],actions:[{action:"drawImage",params:[t,this.completeRedrawBounds.x1,this.completeRedrawBounds.y1]}]})}this.path=null,this.copyCanvas=null}drawImage(t,e,n){this.context.save(),this.context.clearRect(e,n,t.width,t.height),this.context.drawImage(t,e,n),this.context.restore()}drawLineSegment(t,e,n,i){}constructor(){this.settingSize=.25,this.settingOpacity=1,this.settingLockLayerAlpha=!1,this.settingIsEraser=!1,this.settingMode="fill",this.settingDistort=0,this.settingXSymmetry=!1,this.settingYSymmetry=!1,this.settingGradient=!1,this.isDrawing=!1}},SmudgeBrush:class{updateRedrawBounds(t){this.redrawBounds=Om.updateBounds(this.redrawBounds,t)}updateCompleteRedrawBounds(t,e,n,i){this.completeRedrawBounds=Om.updateBounds(this.completeRedrawBounds,{x1:t,y1:e,x2:n,y2:i})}copyFromCanvas(){const t=this.copiedCells.map((t=>!1)),e=[],n=Math.ceil(this.copyImageData.width/256);this.redrawBounds&&(e.push({x1:Math.floor(this.redrawBounds.x1/256),y1:Math.floor(this.redrawBounds.y1/256),x2:Math.floor(this.redrawBounds.x2/256),y2:Math.floor(this.redrawBounds.y2/256)}),e.forEach((e=>{for(let i=e.x1;i<=e.x2;i++)for(let r=e.y1;r<=e.y2;r++)t[r*n+i]=!0})),t.forEach(((t,e)=>{if(!t||this.copiedCells[e])return;this.copiedCells[e]=!0;const i=e%n,r=Math.floor(e/n),a=(Math.min(256*i+256,this.copyImageData.width)-1)%256+1,o=(Math.min(256*r+256,this.copyImageData.height)-1)%256+1,s=Om.canvas(a,o).getContext("2d");s.drawImage(this.context.canvas,256*-i,256*-r);const l=s.getImageData(0,0,a,o);for(let t=0;t<o;t++)for(let e=0,n=t*a*4,o=4*((256*r+t)*this.copyImageData.width+256*i);e<a;e++,n+=4,o+=4)this.copyImageData.data[o]=l.data[n],this.copyImageData.data[o+1]=l.data[n+1],this.copyImageData.data[o+2]=l.data[n+2],this.copyImageData.data[o+3]=l.data[n+3]})))}prepDot(t,e,n,i){if(!this.lastDot)return void(this.lastDot={x:t,y:e});n=Math.round(n);const r=Math.round(2*n),a=Math.round(2*n),o=function(t,e,n,i,r){if(n.x===i.x&&n.y===i.y)return null;n=Om.copyObj(n),i=Om.copyObj(i),r=Om.copyObj(r);{let a=0,o=0,s=0,l=0;if(n.x<0&&(l=-n.x),n.y<0&&(a=-n.y),i.x<0&&(l=Math.max(l,-i.x)),i.y<0&&(a=Math.max(a,-i.y)),n.x+r.w>t&&(o=n.x+r.w-t),n.y+r.h>e&&(s=n.y+r.h-e),i.x+r.w>t&&(o=Math.max(o,i.x+r.w-t)),i.y+r.h>e&&(s=Math.max(s,i.y+r.h-e)),n.x+=l,i.x+=l,n.y+=a,i.y+=a,r.w=r.w-l-o,r.h=r.h-a-s,r.w<=0||r.h<=0)return null}return{aP:{x:n.x,y:n.y},bP:{x:i.x,y:i.y},size:{w:r.w,h:r.h}}}(this.copyImageData.width,this.copyImageData.height,{x:Math.round(this.lastDot.x-n),y:Math.round(this.lastDot.y-n)},{x:Math.round(t-n),y:Math.round(e-n)},{w:r,h:a});if(o){const r={aP:o.aP,bP:o.bP,size:o.size,brush:{center:{x:t,y:e},size:n,opacity:i,alphaLock:this.settingLockLayerAlpha}};this.updateRedrawBounds({x1:r.bP.x,y1:r.bP.y,x2:r.bP.x+2*r.brush.size,y2:r.bP.y+2*r.brush.size}),this.drawBuffer.push(r)}this.lastDot={x:t,y:e}}continueLine(t,e,n,i){this.drawBuffer=[],null===this.bezierLine&&(this.bezierLine=new Om.BezierLine,this.bezierLine.add(this.lastInput.x,this.lastInput.y,0,(function(){})));const r=[],a=t=>{const e=Om.mix(this.lastInput2.pressure,i,t.t),n=this.settingOpacity*(this.settingHasOpacityPressure?e*e:1),a=Math.max(.1,this.settingSize*(this.settingHasSizePressure?e:1));r.push([t.x,t.y,a,n,t.angle])},o=n*this.settingSpacing/3;let s;null===t?this.bezierLine.addFinal(o,a):this.bezierLine.add(t,e,o,a);for(let t=0;t<r.length;t++){const e=r[t];this.prepDot(e[0],e[1],e[2],e[3]),s=e}this.copyFromCanvas();for(let t=0;t<this.drawBuffer.length;t++)lb(this.copyImageData,this.drawBuffer[t])}startLine(t,e,n){this.historyEntry={tool:["brush","SmudgeBrush"],actions:[]},n=Om.clamp(n,0,1);const i=this.settingHasOpacityPressure?this.settingOpacity*n*n:this.settingOpacity,r=this.settingHasSizePressure?Math.max(.1,n*this.settingSize):Math.max(.1,this.settingSize);this.lastDot=null,this.isDrawing=!0,this.copyImageData=new ImageData(this.context.canvas.width,this.context.canvas.height);const a=Math.ceil(this.context.canvas.width/256)*Math.ceil(this.context.canvas.height/256);this.copiedCells="0".repeat(a).split("").map((t=>!1)),this.prepDot(t,e,r,i),this.lineToolLastDot=r*this.settingSpacing,this.lastInput.x=t,this.lastInput.y=e,this.lastInput.pressure=n,this.lastInput2.pressure=n,this.completeRedrawBounds=null}goLine(t,e,n){if(!this.isDrawing)return;this.redrawBounds=null;const i=Om.clamp(n,0,1),r=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);this.continueLine(t,e,r,this.lastInput.pressure),this.redrawBounds&&(this.context.putImageData(this.copyImageData,0,0,this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2-this.redrawBounds.x1-1,this.redrawBounds.y2-this.redrawBounds.y1-1),this.updateCompleteRedrawBounds(this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2,this.redrawBounds.y2)),this.lastInput.x=t,this.lastInput.y=e,this.lastInput2.pressure=this.lastInput.pressure,this.lastInput.pressure=i}endLine(){this.redrawBounds=null;const t=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);if(this.context.save(),this.continueLine(null,null,t,this.lastInput.pressure),this.context.restore(),this.isDrawing=!1,this.bezierLine=null,this.redrawBounds&&(this.context.putImageData(this.copyImageData,0,0,this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2-this.redrawBounds.x1-1,this.redrawBounds.y2-this.redrawBounds.y1-1),this.updateCompleteRedrawBounds(this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2,this.redrawBounds.y2)),this.historyEntry&&this.completeRedrawBounds){let t=this.copyImageData;if(!(0===this.completeRedrawBounds.x1&&0===this.completeRedrawBounds.y1&&this.completeRedrawBounds.x2>=this.context.canvas.width-1&&this.completeRedrawBounds.y2>=this.context.canvas.height-1)){const e=Om.canvas(this.completeRedrawBounds.x2-this.completeRedrawBounds.x1+1,this.completeRedrawBounds.y2-this.completeRedrawBounds.y1+1);e.getContext("2d").drawImage(this.context.canvas,-this.completeRedrawBounds.x1,-this.completeRedrawBounds.y1),t=e}this.historyEntry.actions.push({action:"drawImage",params:[t,this.completeRedrawBounds.x1,this.completeRedrawBounds.y1]}),this.history.push(this.historyEntry),this.historyEntry=void 0}this.copyImageData=null}drawImage(t,e,n){t instanceof ImageData?this.context.putImageData(t,e,n):(this.context.clearRect(e,n,t.width,t.height),this.context.drawImage(t,e,n))}drawLineSegment(t,e,n,i){}getIsDrawing(){return this.isDrawing}setColor(t){this.settingColor.r===t.r&&this.settingColor.g===t.g&&this.settingColor.b===t.b||(this.settingColor={r:t.r,g:t.g,b:t.b},this.settingColorStr=Om.ColorConverter.toRgbStr(this.settingColor))}setContext(t){this.context=t}setHistory(t){this.history=t}setSize(t){this.settingSize=t}setOpacity(t){this.settingOpacity=t}setSpacing(t){this.settingSpacing=t}sizePressure(t){this.settingHasSizePressure=!!t}opacityPressure(t){this.settingHasOpacityPressure=!!t}setLockAlpha(t){this.settingLockLayerAlpha=!!t}getSpacing(){return this.settingSpacing}getSize(){return this.settingSize}getOpacity(){return this.settingOpacity}getLockAlpha(){return this.settingLockLayerAlpha}constructor(){this.history=new Fb.DecoyKlHistory,this.settingColor={r:0,g:0,b:0},this.settingSize=35,this.settingSpacing=.20446882736951905,this.settingOpacity=.8,this.settingHasSizePressure=!1,this.settingHasOpacityPressure=!1,this.settingLockLayerAlpha=!1,this.lastInput={x:0,y:0,pressure:0},this.lastInput2={x:0,y:0,pressure:0},this.isDrawing=!1,this.bezierLine=null,this.drawBuffer=[]}},EraserBrush:function(){let t,e,n,i,r=new Fb.DecoyKlHistory,a=30,o=1,s=!0,l=!1,c={x:0,y:0,pressure:0},h={x:0,y:0,pressure:0},u=!1,d=!1,p=!1;function g(e,n,i,r){t.save(),t.globalCompositeOperation=d?p?"destination-out":"source-atop":"destination-out";let a=t.createRadialGradient(i,i,0,i,i,i),o=Math.pow(r,2);o=Math.max(0,Math.min((i-1)/i,o));let s=Math.max(0,Math.min(1,r)),l=2*s-s*s;a.addColorStop(o,"rgba(255, 255, 255, "+l+")"),a.addColorStop(1,"rgba(255, 255, 255, 0)"),t.fillStyle=a,t.translate(e-i,n-i),t.fillRect(0,0,2*i,2*i),t.restore()}function f(t,e,n){let r,c;n=Math.max(0,Math.min(1,n));let u=s?Math.max(.1,n*a):Math.max(.1,a),d=Math.max(1,Math.max(.5,1-o)*u*.4);function p(t){let e=t.t;r=h.pressure*(1-e)+n*e,c=l?o*r*r:o,u=s?Math.max(.1,r*a):Math.max(.1,a),g(t.x,t.y,u,c)}null===t?i.addFinal(d,p):i.add(t,e,d,p)}this.startLine=function(r,f,m){e={tool:["brush","EraserBrush"],actions:[]},e.actions.push({action:"opacityPressure",params:[l]}),e.actions.push({action:"sizePressure",params:[s]}),e.actions.push({action:"setSize",params:[a]}),e.actions.push({action:"setOpacity",params:[o]}),e.actions.push({action:"setTransparentBG",params:[p]}),d=0===t.canvas.index,m=Math.max(0,Math.min(1,m));let y=l?o*m*m:o,x=s?Math.max(.1,m*a):Math.max(.1,a);u=!0,x>1&&g(r,f,x,y),n=.4*x,c.x=r,c.y=f,c.pressure=m,h=Om.copyObj(c),i=new Om.BezierLine,i.add(r,f,0,(function(){})),e.actions.push({action:"startLine",params:[r,f,m]})},this.goLine=function(t,n,i){u&&(e.actions.push({action:"goLine",params:[t,n,i]}),f(t,n,c.pressure),h=Om.copyObj(c),c.x=t,c.y=n,c.pressure=i)},this.endLine=function(){i&&f(null,null,c.pressure),u=!1,i=void 0,e&&(e.actions.push({action:"endLine",params:[]}),r.push(e),e=void 0)},this.drawLineSegment=function(e,i,h,f){if(d=0===t.canvas.index,c.x=h,c.y=f,u||void 0===e)return;let m,y=Math.sqrt(Math.pow(h-e,2)+Math.pow(f-i,2)),x=(h-e)/y,b=(f-i)/y,v=Math.max(1,Math.max(.5,1-o)*a*.4);for(n=0,m=n;m<=y;m+=v)g(e+x*m,i+b*m,a,o);let w={tool:["brush","EraserBrush"],actions:[]};w.actions.push({action:"opacityPressure",params:[l]}),w.actions.push({action:"sizePressure",params:[s]}),w.actions.push({action:"setSize",params:[a]}),w.actions.push({action:"setOpacity",params:[o]}),w.actions.push({action:"setTransparentBG",params:[p]}),w.actions.push({action:"drawLineSegment",params:[e,i,h,f]}),r.push(w)},this.isDrawing=function(){return u},this.setContext=function(e){t=e},this.setHistory=function(t){r=t},this.setSize=function(t){a=t},this.setOpacity=function(t){o=t},this.sizePressure=function(t){s=t},this.opacityPressure=function(t){l=t},this.setTransparentBG=function(t){p=1==t},this.getSize=function(){return a},this.getOpacity=function(){return o}}};var hb;hb=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("efRnq");const ub=function(){let t={image:n(hb),tooltip:Vm("brush-pen"),sizeSlider:{min:.5,max:100,curve:Om.quadraticSplineInput(.5,100,.1)},opacitySlider:{min:0,max:1,curve:[[0,.01],[.5,.3],[1,1]]},Ui:null},e=[Vm("brush-pen-circle"),Vm("brush-pen-chalk"),Vm("brush-pen-calligraphy"),Vm("brush-pen-square")];return Xm.subscribe((()=>{t.tooltip=Vm("brush-pen"),e=[Vm("brush-pen-circle"),Vm("brush-pen-chalk"),Vm("brush-pen-calligraphy"),Vm("brush-pen-square")]})),t.Ui=function(n){let i,r,a=document.createElement("div"),o=new cb.PenBrush;o.setHistory(zm),n.onSizeChange(o.getSize());let s=[],l=0;for(let t=0;t<4;t++)!function(t){let n=Om.el({title:e[t],onClick:()=>{h(t)}}),i=Om.canvas(70,70),r=i.getContext("2d");0===t||3===t?0===t?(r.beginPath(),r.arc(35,35,30,0,2*Math.PI),r.closePath(),r.fill()):r.fillRect(5,5,60,60):1===t?r.drawImage(eb(60),5,5):2===t&&r.drawImage(ib(60),5,5),n.style.backgroundImage="url("+i.toDataURL("image/png")+")",s.push(n)}(t);function c(){for(let t=0;t<s.length;t++)s[t].className=t===l?"brush-alpha-selected":"brush-alpha"}function h(t){l=t,o.setAlpha(t),c()}c();let u=new Gm({init:o.getLockAlpha(),label:Vm("brush-lock-alpha"),callback:function(t){o.setLockAlpha(t)},doHighlight:!0,title:Vm("brush-lock-alpha-title"),css:{cssFloat:"right",textAlign:"right"}}),d=new Om.SplineInterpolator([[0,15],[8,7],[14,4],[30,3],[50,2.7],[100,2]]);function p(t){o.setSize(t),o.setSpacing(Math.max(2,d.interpolate(t))/15)}!function(){i=new ny({label:Vm("brush-size"),width:225,height:30,min:t.sizeSlider.min,max:t.sizeSlider.max,initValue:o.getSize(),eventResMs:20,onChange:function(t){p(t),n.onSizeChange(t)},curve:t.sizeSlider.curve,formatFunc:function(t){return(t*=2)<10?Math.round(10*t)/10:Math.round(t)}}),r=new ny({label:Vm("opacity"),width:225,height:30,min:t.opacitySlider.min,max:t.opacitySlider.max,initValue:t.opacitySlider.max,eventResMs:20,onChange:function(t){o.setOpacity(t),n.onOpacityChange(t)},curve:t.opacitySlider.curve,formatFunc:function(t){return Math.round(100*t)}});let e=ty(!1,(function(t){o.sizePressure(t)})),l=ty(!1,(function(t){o.opacityPressure(t)}));a.append(Om.el({content:[i.getElement(),e],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),Om.el({content:[r.getElement(),l],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}}));let c=document.createElement("div");for(let t=0;t<s.length;t++)c.appendChild(s[t]);c.style.marginTop="10px",a.appendChild(c),c.appendChild(u.getElement())}(),this.increaseSize=function(t){o.isDrawing()||i.increaseValue(t)},this.decreaseSize=function(t){o.isDrawing()||i.decreaseValue(t)},this.getSize=function(){return o.getSize()},this.setSize=function(t){p(t),i.setValue(t)},this.getOpacity=function(){return o.getOpacity()},this.setOpacity=function(t){o.setOpacity(t),r.setValue(t)},this.setColor=function(t){o.setColor(t)},this.setContext=function(t){o.setContext(t)},this.startLine=function(t,e,n){o.startLine(t,e,n)},this.goLine=function(t,e,n){o.goLine(t,e,n)},this.endLine=function(t,e){o.endLine(t,e)},this.getBrush=function(){return o},this.isDrawing=function(){return o.isDrawing()},this.getElement=function(){return a}},t}();var db;db=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("lGY8s");const pb=function(){let t={image:n(db),tooltip:Vm("brush-blend"),sizeSlider:{min:.5,max:100,curve:Om.quadraticSplineInput(.5,100,.1)},opacitySlider:{min:.01,max:1},Ui:null};return Xm.subscribe((()=>{t.tooltip=Vm("brush-blend")})),t.Ui=function(e){let n,i,r=document.createElement("div"),a=new cb.BlendBrush;function o(t){a.setSize(t)}a.setHistory(zm),e.onSizeChange(a.getSize()),function(){n=new ny({label:Vm("brush-size"),width:225,height:30,min:t.sizeSlider.min,max:t.sizeSlider.max,initValue:29,eventResMs:20,onChange:function(t){o(t),e.onSizeChange(t)},curve:t.sizeSlider.curve,formatFunc:function(t){return t*=2,Math.round(t)}}),i=new ny({label:Vm("opacity"),width:225,height:30,min:t.opacitySlider.min,max:t.opacitySlider.max,initValue:a.getOpacity(),eventResMs:20,onChange:function(t){a.setOpacity(t),e.onOpacityChange(t)},formatFunc:function(t){return Math.round(100*t)}});let s=new ny({label:Vm("brush-blending"),width:225,height:30,min:0,max:100,initValue:100*a.getBlending(),eventResMs:20,onChange:function(t){a.setBlending(t/100)}});s.getElement().style.marginTop="10px";let l=ty(!1,(function(t){a.setSizePressure(t)})),c=ty(!1,(function(t){a.setOpacityPressure(t)})),h=new Gm({init:a.getLockAlpha(),label:Vm("brush-lock-alpha"),callback:function(t){a.setLockAlpha(t)},doHighlight:!0,title:Vm("brush-lock-alpha-title"),css:{marginTop:"10px",display:"inline-block"}});r.append(Om.el({content:[n.getElement(),l],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),Om.el({content:[i.getElement(),c],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}}),s.getElement(),h.getElement())}(),this.increaseSize=function(t){a.getIsDrawing()||n.increaseValue(t)},this.decreaseSize=function(t){a.getIsDrawing()||n.decreaseValue(t)},this.getSize=function(){return a.getSize()},this.setSize=function(t){o(t),n.setValue(t)},this.getOpacity=function(){return a.getOpacity()},this.setOpacity=function(t){a.setOpacity(t),i.setValue(t)},this.setColor=function(t){a.setColor(t)},this.setContext=function(t){a.setContext(t)},this.startLine=function(t,e,n){a.startLine(t,e,n)},this.goLine=function(t,e,n,i){a.goLine(t,e,n,i)},this.endLine=function(){a.endLine()},this.getBrush=function(){return a},this.isDrawing=function(){return a.getIsDrawing()},this.getElement=function(){return r}},t}();var gb;gb=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("jDXzO");const fb=function(){let t={image:n(gb),tooltip:Vm("brush-sketchy"),sizeSlider:{min:.5,max:10},opacitySlider:{min:.01,max:1},Ui:null};return Xm.subscribe((()=>{t.tooltip=Vm("brush-sketchy")})),t.Ui=function(e){let n,i,r=document.createElement("div"),a=new cb.SketchyBrush;a.setHistory(zm),e.onSizeChange(a.getSize()),function(){n=new ny({label:Vm("brush-size"),width:250,height:30,min:t.sizeSlider.min,max:t.sizeSlider.max,initValue:a.getSize(),eventResMs:20,onChange:function(t){a.setSize(t),e.onSizeChange(a.getSize())},formatFunc:function(t){return(t*=2)<10?Math.round(10*t)/10:Math.round(t)}}),i=new ny({label:Vm("opacity"),width:250,height:30,min:t.opacitySlider.min,max:t.opacitySlider.max,initValue:a.getOpacity(),eventResMs:20,onChange:function(t){a.setOpacity(t),e.onOpacityChange(t)},formatFunc:function(t){return Math.round(100*t)}});let o=new ny({label:Vm("brush-blending"),width:250,height:30,min:0,max:100,initValue:100*a.getBlending(),eventResMs:20,onChange:function(t){a.setBlending(t/100)}}),s=new ny({label:Vm("brush-sketchy-scale"),width:250,height:30,min:1,max:20,initValue:a.getScale(),eventResMs:20,onChange:function(t){a.setScale(t)}});i.getElement().style.marginTop="10px",o.getElement().style.marginTop="10px",s.getElement().style.marginTop="10px",r.appendChild(n.getElement()),r.appendChild(i.getElement()),r.appendChild(o.getElement()),r.appendChild(s.getElement())}(),this.increaseSize=function(t){a.isDrawing()||n.increaseValue(t)},this.decreaseSize=function(t){a.isDrawing()||n.decreaseValue(t)},this.getSize=function(){return a.getSize()},this.setSize=function(t){!function(t){a.setSize(t)}(t),n.setValue(t)},this.getOpacity=function(){return a.getOpacity()},this.setOpacity=function(t){a.setOpacity(t),i.setValue(t)},this.setColor=function(t){a.setColor(t)},this.setContext=function(t){a.setContext(t)},this.startLine=function(t,e,n){a.startLine(t,e,n)},this.goLine=function(t,e,n){a.goLine(t,e,n,null)},this.endLine=function(){a.endLine()},this.getSeed=function(){return parseInt(a.getSeed())},this.setSeed=function(t){a.setSeed(parseInt(t))},this.getBrush=function(){return a},this.isDrawing=function(){return a.isDrawing()},this.getElement=function(){return r}},t}();var mb;mb=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("hkoNI");const yb=function(){let t={image:n(mb),tooltip:Vm("brush-pixel"),sizeSlider:{min:.5,max:100,curve:Om.quadraticSplineInput(.5,100,.1)},opacitySlider:{min:0,max:1,curve:[[0,.01],[.5,.3],[1,1]]},Ui:null};return Xm.subscribe((()=>{t.tooltip=Vm("brush-pixel")})),t.Ui=function(e){let n,i,r=document.createElement("div"),a=new cb.PixelBrush;a.setHistory(zm),e.onSizeChange(a.getSize());let o=new Gm({init:a.getLockAlpha(),label:Vm("brush-lock-alpha"),callback:function(t){a.setLockAlpha(t)},doHighlight:!0,title:Vm("brush-lock-alpha-title"),css:{marginRight:"10px"}}),s=new Gm({init:a.getIsEraser(),label:Vm("eraser"),callback:function(t){a.setIsEraser(t)},css:{marginRight:"10px"}}),l=new Gm({init:a.getUseDither(),label:Vm("brush-pixel-dither"),callback:function(t){a.setUseDither(t)}}),c=new Om.SplineInterpolator([[.5,.45],[100,4]]);function h(t){a.setSize(t),a.setSpacing(c.interpolate(t)/t)}!function(){n=new ny({label:Vm("brush-size"),width:225,height:30,min:t.sizeSlider.min,max:t.sizeSlider.max,initValue:a.getSize(),eventResMs:20,onChange:function(t){h(t=Math.round(2*t)/2),e.onSizeChange(t)},curve:t.sizeSlider.curve,formatFunc:function(t){return t*=2,Math.round(t)}}),i=new ny({label:Vm("opacity"),width:225,height:30,min:t.opacitySlider.min,max:t.opacitySlider.max,initValue:t.opacitySlider.max,eventResMs:20,onChange:function(t){a.setOpacity(t),e.onOpacityChange(t)},curve:t.opacitySlider.curve,formatFunc:function(t){return Math.round(100*t)}});let c=ty(!1,(function(t){a.sizePressure(t)}));r.append(Om.el({content:[n.getElement(),c],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),i.getElement());let u=Om.el({parent:r,css:{display:"flex",marginTop:"10px"}});u.appendChild(o.getElement()),u.appendChild(s.getElement()),u.appendChild(l.getElement())}(),this.increaseSize=function(t){a.isDrawing()||n.increaseValue(t)},this.decreaseSize=function(t){a.isDrawing()||n.decreaseValue(t)},this.getSize=function(){return a.getSize()},this.setSize=function(t){h(t),n.setValue(t)},this.getOpacity=function(){return a.getOpacity()},this.setOpacity=function(t){a.setOpacity(t),i.setValue(t)},this.setColor=function(t){a.setColor(t)},this.setContext=function(t){a.setContext(t)},this.startLine=function(t,e,n){a.startLine(t,e,n)},this.goLine=function(t,e,n){a.goLine(t,e,n)},this.endLine=function(t,e){a.endLine(t,e)},this.getBrush=function(){return a},this.isDrawing=function(){return a.isDrawing()},this.getElement=function(){return r}},t}();var xb;xb=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("baIZM");const bb=function(){let t={image:n(xb),tooltip:Vm("eraser")+" [E]",sizeSlider:{min:.5,max:200,curve:Om.quadraticSplineInput(.5,200,.1)},opacitySlider:{min:.01,max:1},Ui:null};return Xm.subscribe((()=>{t.tooltip=Vm("eraser")+" [E]"})),t.Ui=function(e){let n,i,r=document.createElement("div"),a=new cb.EraserBrush;a.setHistory(zm),e.onSizeChange(a.getSize());let o=!1;function s(t){a.setSize(t)}!function(){n=new ny({label:Vm("brush-size"),width:225,height:30,min:t.sizeSlider.min,max:t.sizeSlider.max,initValue:30,eventResMs:20,onChange:function(t){s(t),e.onSizeChange(t)},curve:t.sizeSlider.curve,formatFunc:function(t){return(t*=2)<10?Math.round(10*t)/10:Math.round(t)}}),i=new ny({label:Vm("opacity"),width:225,height:30,min:t.opacitySlider.min,max:t.opacitySlider.max,initValue:1,eventResMs:20,onChange:function(t){a.setOpacity(t),e.onOpacityChange(t)},formatFunc:function(t){return Math.round(100*t)}});let l=ty(!1,(function(t){a.sizePressure(t)})),c=ty(!1,(function(t){a.opacityPressure(t)}));r.append(Om.el({content:[n.getElement(),l],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),Om.el({content:[i.getElement(),c],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}}));let h=new Gm({init:!1,label:Vm("brush-eraser-transparent-bg"),callback:function(t){o=t,a.setTransparentBG(t)},css:{marginTop:"10px"}});r.appendChild(h.getElement())}(),this.increaseSize=function(t){a.isDrawing()||n.increaseValue(t)},this.decreaseSize=function(t){a.isDrawing()||n.decreaseValue(t)},this.getSize=function(){return a.getSize()},this.setSize=function(t){s(t),n.setValue(t)},this.getOpacity=function(){return a.getOpacity()},this.setOpacity=function(t){a.setOpacity(t),i.setValue(t)},this.setColor=function(t){},this.setContext=function(t){a.setContext(t)},this.startLine=function(t,e,n){a.startLine(t,e,n)},this.goLine=function(t,e,n){a.goLine(t,e,n)},this.endLine=function(){a.endLine()},this.getBrush=function(){return a},this.getIsTransparentBg=function(){return o},this.isDrawing=function(){return a.isDrawing()},this.getElement=function(){return r}},t}();var vb;vb=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("91Av5");const wb=function(){let t={image:n(vb),tooltip:Vm("brush-smudge"),sizeSlider:{min:.5,max:100,curve:Om.quadraticSplineInput(.5,100,.1)},opacitySlider:{min:0,max:1,curve:[[0,.01],[.5,.3],[1,1]]},Ui:null};return Xm.subscribe((()=>{t.tooltip=Vm("brush-smudge")})),t.Ui=function(e){let n,i,r=document.createElement("div"),a=new cb.SmudgeBrush;a.setHistory(zm),e.onSizeChange(a.getSize());let o=new Gm({init:a.getLockAlpha(),label:Vm("brush-lock-alpha"),callback:function(t){a.setLockAlpha(t)},doHighlight:!0,title:Vm("brush-lock-alpha-title")}),s=new Om.SplineInterpolator([[0,15],[8,7],[14,4],[30,3],[50,2.7],[100,2]]);function l(t){a.setSize(t),a.setSpacing(Math.max(2,s.interpolate(t))/15)}!function(){n=new ny({label:Vm("brush-size"),width:225,height:30,min:t.sizeSlider.min,max:t.sizeSlider.max,initValue:a.getSize(),eventResMs:20,onChange:function(t){l(t),e.onSizeChange(t)},curve:t.sizeSlider.curve,formatFunc:function(t){return(t*=2)<10?Math.round(10*t)/10:Math.round(t)}}),i=new ny({label:Vm("opacity"),width:225,height:30,min:t.opacitySlider.min,max:t.opacitySlider.max,initValue:a.getOpacity(),eventResMs:20,onChange:function(t){a.setOpacity(t),e.onOpacityChange(t)},curve:t.opacitySlider.curve,formatFunc:function(t){return Math.round(100*t)}});let s=ty(!1,(function(t){a.sizePressure(t)})),c=ty(!1,(function(t){a.opacityPressure(t)}));r.append(Om.el({content:[n.getElement(),s],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),Om.el({content:[i.getElement(),c],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}})),Om.el({parent:r,css:{marginTop:"10px"}}).append(o.getElement())}(),this.increaseSize=function(t){a.getIsDrawing()||n.increaseValue(t)},this.decreaseSize=function(t){a.getIsDrawing()||n.decreaseValue(t)},this.getSize=function(){return a.getSize()},this.setSize=function(t){l(t),n.setValue(t)},this.getOpacity=function(){return a.getOpacity()},this.setOpacity=function(t){a.setOpacity(t),i.setValue(t)},this.setColor=function(t){a.setColor(t)},this.setContext=function(t){a.setContext(t)},this.startLine=function(t,e,n){a.startLine(t,e,n)},this.goLine=function(t,e,n){a.goLine(t,e,n)},this.endLine=function(t,e){a.endLine()},this.getBrush=function(){return a},this.isDrawing=function(){return a.getIsDrawing()},this.getElement=function(){return r}},t}();var Cb;Cb=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("aI6cE");class Sb{update(){this.value?Om.addClassName(this.el,"kl-box-toggle--active"):Om.removeClassName(this.el,"kl-box-toggle--active")}getValue(){return this.value}setValue(t){this.value=!!t,this.update()}getElement(){return this.el}destroy(){Om.destroyEl(this.el)}constructor(t){this.value=!!t.init,this.el=Om.el({content:t.label,title:t.title,className:"string"==typeof t.label?"kl-box-toggle":"kl-box-toggle kl-box-toggle--custom-el",onClick:()=>{this.value=!this.value,this.update(),t.onChange(this.value)},css:{cursor:"pointer"}}),"string"!=typeof t.label&&Om.css(t.label,{display:"block",pointerEvents:"none"}),this.update()}}const Eb=function(){const t={image:n(Cb),tooltip:Vm("brush-chemy"),sizeSlider:{min:.25,max:25,curve:Om.quadraticSplineInput(.25,25,.1),isDisabled:!0},opacitySlider:{min:.01,max:1},Ui:null};return Xm.subscribe((()=>{t.tooltip=Vm("brush-chemy")})),t.Ui=function(e){const n=document.createElement("div"),i=new cb.ChemyBrush;let r,a;function o(t){i.setSize(t)}i.setHistory(zm),e.onSizeChange(i.getSize()),function(){r=new ny({label:Vm("brush-size"),width:250,height:30,min:t.sizeSlider.min,max:t.sizeSlider.max,initValue:i.getSize(),eventResMs:20,isEnabled:"stroke"===i.getMode(),onChange:function(t){o(t),e.onSizeChange(i.getSize())},curve:t.sizeSlider.curve,formatFunc:function(t){return(t*=2)<5?Math.round(10*t)/10:Math.round(t)}}),a=new ny({label:Vm("opacity"),width:250,height:30,min:t.opacitySlider.min,max:t.opacitySlider.max,initValue:i.getOpacity(),eventResMs:20,onChange:function(t){i.setOpacity(t),e.onOpacityChange(t)},formatFunc:function(t){return Math.round(100*t)}}),Om.css(a.getElement(),{marginTop:"10px"});let s=new Gm({init:i.getIsEraser(),label:Vm("eraser"),callback:function(t){i.setIsEraser(t)},css:{marginTop:"10px",marginLeft:"10px"}});const l=new Gm({init:i.getLockAlpha(),label:Vm("brush-lock-alpha"),callback:function(t){i.setLockAlpha(t)},doHighlight:!0,title:Vm("brush-lock-alpha-title"),css:{marginTop:"10px"}}),c=Om.el({css:{display:"flex",marginTop:"10px"}}),h=new cy({optionArr:[{id:"fill",label:Om.createSvg({elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"#000",style:"transform-origin: 0 0; transform: translate(-0.5px, -0.5px) scale(19, 19) translate(0.5px, 0.5px)",d:"M 0,0 C 1.5,0 -0.5,1 1,1"}]}),title:Vm("brush-chemy-fill")},{id:"stroke",label:Om.createSvg({elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"none",stroke:"#000",style:"stroke-width: 0.12px; transform-origin: 0 0; transform: translate(-0.5px, -0.5px) scale(19, 19) translate(0.5px, 0.5px)",d:"M 0,0 C 1.5,0 -0.5,1 1,1"}]}),title:Vm("brush-chemy-stroke")}],initId:i.getMode(),onChange:n=>{i.setMode(n),t.sizeSlider.isDisabled="fill"===i.getMode(),r.setIsEnabled(!t.sizeSlider.isDisabled),r.setValue(i.getSize()),e.onSizeChange(i.getSize()),e.onConfigChange()}}),u=new Sb({label:Om.createSvg({elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"none",stroke:"#000",style:"stroke-width: 1px",d:"M 17.5,8 17.5,27"}]}),title:Vm("brush-chemy-mirror-x"),init:i.getXSymmetry(),onChange:t=>{i.setXSymmetry(t)}}),d=new Sb({label:Om.createSvg({elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"none",stroke:"#000",style:"stroke-width: 1px",d:"M 8,17.5 27,17.5"}]}),title:Vm("brush-chemy-mirror-y"),init:i.getYSymmetry(),onChange:t=>{i.setYSymmetry(t)}}),p=new Sb({label:Om.createSvg({elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"defs",childrenArr:[{elementType:"linearGradient",id:"gradient",x1:"0",y1:"0",x2:"0",y2:"1",childrenArr:[{elementType:"stop",offset:"0%","stop-color":"rgba(0,0,0,0)"},{elementType:"stop",offset:"100%","stop-color":"rgba(0,0,0,1)"}]}]},{elementType:"rect",fill:"url('#gradient')",x:"8",y:"8",width:"19",height:"19"}]}),title:Vm("brush-chemy-gradient"),init:i.getGradient(),onChange:t=>{i.setGradient(t)}});Om.css(u.getElement(),{marginLeft:"10px"});{const t={marginLeft:"4px"};Om.css(d.getElement(),t),Om.css(p.getElement(),t)}c.append(h.getElement(),u.getElement(),d.getElement(),p.getElement()),n.append(r.getElement(),a.getElement(),c,Om.el({content:[l.getElement(),s.getElement()],css:{display:"flex"}}))}(),this.increaseSize=function(t){i.getIsDrawing()||"stroke"!==i.getMode()||r.increaseValue(t)},this.decreaseSize=function(t){i.getIsDrawing()||"stroke"!==i.getMode()||r.decreaseValue(t)},this.getSize=function(){return i.getSize()},this.setSize=function(t){o(t),r.setValue(t)},this.getOpacity=function(){return i.getOpacity()},this.setOpacity=function(t){i.setOpacity(t),a.setValue(t)},this.setColor=function(t){i.setColor(t)},this.setContext=function(t){i.setContext(t)},this.startLine=function(t,e,n){i.startLine(t,e)},this.goLine=function(t,e,n,r){i.goLine(t,e)},this.endLine=function(){i.endLine()},this.getBrush=function(){return i},this.isDrawing=function(){return i.getIsDrawing()},this.getElement=function(){return n}},t}(),Mb={penBrush:ub,blendBrush:pb,sketchyBrush:fb,pixelBrush:yb,chemyBrush:Eb,smudgeBrush:wb,eraserBrush:bb};function Ib(t,e){if(!e&&(window.innerHeight<500||window.innerWidth<700))return void window.open(t);let n,i=Om.el({tagName:"iframe",custom:{src:t},css:{width:"100%",height:"100%"}}),r=Om.el({});e||(n=Om.el({tagName:"a",parent:r,content:Vm("modal-new-tab"),custom:{href:"help",target:"_blank"},onClick:function(){a.close()}}),i.onload=function(){Om.setAttributes(n,{href:""+i.contentWindow.location})});let a=new Km({title:r,content:i,width:880,isMaxHeight:!0,onClose:()=>{n&&Om.destroyEl(n)}})}class kb{updateAge(){if(!this.timestamp)return;let t,e=(new Date).getTime()-this.timestamp;e=Math.floor(e/1e3/60),t=Vm("file-storage-min-ago").replace("{x}",""+e),e>60&&(e=Math.floor(e/60),t=Vm("file-storage-hours-ago").replace("{x}",""+e),e>24&&(e=Math.floor(e/24),t=Vm("file-storage-days-ago").replace("{x}",""+e),e>31&&(t=Vm("file-storage-month-ago")))),this.ageEl.textContent=t}resetButtons(){this.timestamp?(this.storeEl.textContent=Vm("file-storage-overwrite"),this.storeEl.disabled=!1,this.clearEl.disabled=!1):(this.storeEl.textContent=Vm("file-storage-store"),this.storeEl.disabled=!1,this.clearEl.disabled=!0)}updateThumb(t,e){this.timestamp=t,this.timestamp?(Om.css(e,{display:"block",maxWidth:"calc(100% - 2px)",maxHeight:"calc(100% - 2px)",margin:"0 auto",background:"url('"+Om.createCheckerCanvas(4).toDataURL("image/png")+"')",boxShadow:"0 0 0 1px #aaa",pointerEvents:"none"}),this.previewEl.innerHTML="",this.updateAge(),this.previewEl.append(e,this.ageEl)):this.previewEl.innerHTML=Vm("file-storage-empty"),this.resetButtons()}async store(){this.storeEl.textContent=Vm("file-storage-storing"),this.storeEl.disabled=!0,this.clearEl.disabled=!0,await new Promise((t=>{setTimeout((()=>t(null)),20)}));try{await this.projectStore.store(this.getProject()),this.saveReminder.reset()}catch(t){this.resetButtons(),Fb.popup({target:this.klRootEl,type:"error",message:[`${Vm("file-storage-failed-1")}<ul>`,`<li>${Vm("file-storage-failed-2")}</li>`,`<li>${Vm("file-storage-failed-3")}</li>`,`<li>${Vm("file-storage-failed-4")}</li>`,"</ul>"].join(""),buttons:["Ok"]}),setTimeout((()=>{throw new Error("storage-ui: failed to store browser storage, "+t)}),0)}}async clear(){this.storeEl.disabled=!0,this.clearEl.disabled=!0;try{await this.projectStore.clear()}catch(t){this.resetButtons(),Fb.popup({target:this.klRootEl,type:"error",message:Vm("file-storage-failed-clear"),buttons:["Ok"]}),setTimeout((()=>{throw new Error("storage-ui: failed to clear browser storage, "+t)}),0)}}getElement(){return this.element}show(){}hide(){}constructor(t,e,i,r){this.projectStore=t,this.getProject=e,this.saveReminder=i,this.klRootEl=r,this.element=Om.el({css:{display:"grid",gridTemplateColumns:"1fr 0fr",gridTemplateRows:"0fr 0fr 0fr",gap:"0 0",gridTemplateAreas:'"title title" "preview store" "preview clear"'}});const a=Om.el({parent:this.element,content:Vm("file-storage"),css:{gridArea:"title",display:"flex",margin:"-5px 0"}});Om.el({parent:a,content:"?",title:Vm("file-storage-about"),css:{cursor:"pointer",marginLeft:"5px",width:"19px",height:"19px",borderRadius:"100%",textAlign:"center",lineHeight:"19px",fontWeight:"bold",boxShadow:"inset 0 0 0 1px #000"},onClick:()=>{Ib("./help/#help-browser-storage",!1)}});this.projectStore.isBroken()?Om.el({parent:this.element,content:"🔴 "+Vm("file-storage-cant-access"),css:{marginTop:"10px"}}):(this.previewEl=Om.el({parent:this.element,title:Vm("file-storage-thumb-title"),css:{gridArea:"preview",display:"flex",alignItems:"center",justifyContent:"center",marginTop:"10px",position:"relative",boxShadow:"inset 0 0 0 1px #aaa",background:"#cdcdcd",color:"#545454",colorScheme:"only light"}}),this.ageEl=Om.el({css:{position:"absolute",right:"0",bottom:"0",width:"100%",textAlign:"center",background:"rgba(0,0,0,0.7)",color:"#fff",textSize:"13px"}}),this.storeEl=Om.el({parent:this.element,tagName:"button",className:"gridButton",content:Vm("file-storage-store"),css:{gridArea:"store"},custom:{tabIndex:-1},onClick:()=>this.store()}),this.storeEl.tabIndex=-1,this.clearEl=Om.el({parent:this.element,tagName:"button",className:"gridButton",content:'<img src="'+n(fy)+'" height="20"/> '+Vm("file-storage-clear"),css:{gridArea:"clear"},custom:{tabIndex:-1},onClick:()=>this.clear()}),this.projectStore.subscribe({onUpdate:(t,e)=>{this.updateThumb(t,e)}}),setInterval((()=>this.updateAge()),6e4),(async()=>{try{const t=await this.projectStore.read();t?this.updateThumb(t.timestamp,t.thumbnail):this.updateThumb()}catch(t){setTimeout((()=>{throw new Error("storage-ui: failed initial read browser storage, "+t)}),0)}})())}}function Tb(t){let e=t.match(/data:([^;]*)(;base64)?,([0-9A-Za-z+/]+)/),n=atob(e[3]),i=new ArrayBuffer(n.length),r=new Uint8Array(i);for(let t=0;t<r.length;t++)r[t]=n.charCodeAt(t);return new Blob([r],{type:e[1]})}function Rb(t){return new Promise(((e,n)=>{const i=new Image;try{i.src=Om.imageBlobToUrl(t)}catch(t){return void n("imageBlobToUrl, "+t.message)}i.onload=()=>{e(i)},i.onabort=function(){n("layer image failed loading")},i.onerror=function(){n("layer image failed loading")}}))}class Lb{static createThumbnail(t){return My(t,Om.fitInto(t.width,t.height,240,240).width/t.width)}static createStorageProject(t){return{id:1,timestamp:(new Date).getTime(),thumbnail:Tb(Lb.createThumbnail(t).toDataURL("image/png")),width:t.width,height:t.height,layers:t.layers.map((t=>{let e;if(!(t.image instanceof HTMLCanvasElement))throw new Error("Not implemented");return e=Tb(t.image.toDataURL("image/png")),{name:t.name,opacity:t.opacity,mixModeStr:t.mixModeStr,blob:e}}))}}static async readStorageProject(t){const e={width:t.width,height:t.height,layers:(await Promise.all(t.layers.map((t=>Rb(t.blob))))).map(((e,n)=>({name:t.layers[n].name,opacity:t.layers[n].opacity,mixModeStr:t.layers[n].mixModeStr,image:e})))};let n;return n=t.thumbnail?await Rb(t.thumbnail):Lb.createThumbnail(e),{project:e,timestamp:t.timestamp,thumbnail:n}}}function Ab(t){return new Promise(((e,n)=>{t(e,n)}))}var Pb;let Ob;Pb=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("28TVy");var Db,Bb,zb={};Db=zb,Bb=function(){function t(t,e,n){var i=new XMLHttpRequest;i.open("GET",t),i.responseType="blob",i.onload=function(){o(i.response,e,n)},i.onerror=function(){console.error("could not download file")},i.send()}function n(t){var e=new XMLHttpRequest;e.open("HEAD",t,!1);try{e.send()}catch(t){}return 200<=e.status&&299>=e.status}function i(t){try{t.dispatchEvent(new MouseEvent("click"))}catch(n){var e=document.createEvent("MouseEvents");e.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),t.dispatchEvent(e)}}var r="object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof e&&e.global===e?e:void 0,a=r.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),o=r.saveAs||("object"!=typeof window||window!==r?function(){}:"download"in HTMLAnchorElement.prototype&&!a?function(e,a,o){var s=r.URL||r.webkitURL,l=document.createElement("a");a=a||e.name||"download",l.download=a,l.rel="noopener","string"==typeof e?(l.href=e,l.origin===location.origin?i(l):n(l.href)?t(e,a,o):i(l,l.target="_blank")):(l.href=s.createObjectURL(e),setTimeout((function(){s.revokeObjectURL(l.href)}),4e4),setTimeout((function(){i(l)}),0))}:"msSaveOrOpenBlob"in navigator?function(e,r,a){if(r=r||e.name||"download","string"!=typeof e)navigator.msSaveOrOpenBlob((s=e,void 0===(l=a)?l={autoBom:!1}:"object"!=typeof l&&(console.warn("Deprecated: Expected third argument to be a object"),l={autoBom:!l}),l.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(s.type)?new Blob(["\ufeff",s],{type:s.type}):s),r);else if(n(e))t(e,r,a);else{var o=document.createElement("a");o.href=e,o.target="_blank",setTimeout((function(){i(o)}))}var s,l}:function(e,n,i,o){if((o=o||open("","_blank"))&&(o.document.title=o.document.body.innerText="downloading..."),"string"==typeof e)return t(e,n,i);var s="application/octet-stream"===e.type,l=/constructor/i.test(r.HTMLElement)||r.safari,c=/CriOS\/[\d]+/.test(navigator.userAgent);if((c||s&&l||a)&&"undefined"!=typeof FileReader){var h=new FileReader;h.onloadend=function(){var t=h.result;t=c?t:t.replace(/^data:[^;]*;/,"data:attachment/file;"),o?o.location.href=t:location=t,o=null},h.readAsDataURL(e)}else{var u=r.URL||r.webkitURL,d=u.createObjectURL(e);o?o.location=d:location.href=d,o=null,setTimeout((function(){u.revokeObjectURL(d)}),4e4)}});r.saveAs=o.saveAs=o,zb=o},"function"==typeof define&&define.amd?define([],Bb):void 0!==zb?Bb():(Bb(),Db.FileSaver={});class jb{emit(t,e){for(let n=0;n<this.subscriberArr.length;n++)this.subscriberArr[n]!==e&&this.subscriberArr[n](t)}emitColor(t,e){this.emit({type:"color",value:t},e)}emitSize(t,e){this.emit({type:"size",value:t},e)}emitOpacity(t,e){this.emit({type:"opacity",value:t},e)}emitSliderConfig(t,e){this.emit({type:"sliderConfig",value:t},e)}setColor(t,e){this.onSetColor(t),this.emitColor(t,e)}setSize(t,e){this.onSetSize(t)}setOpacity(t,e){this.onSetOpacity(t)}getColor(){return this.onGetColor()}getSize(){return this.onGetSize()}getOpacity(){return this.onGetOpacity()}getSliderConfig(){return this.onGetSliderConfig()}subscribe(t){this.subscriberArr.includes(t)||this.subscriberArr.push(t)}unsubscribe(t){for(let e=0;e<this.subscriberArr.length;e++)t===this.subscriberArr[e]&&(this.subscriberArr.splice(e,1),e--)}constructor(t,e,n,i,r,a,o){if(this.onSetColor=t,this.onSetSize=e,this.onSetOpacity=n,this.onGetColor=i,this.onGetSize=r,this.onGetOpacity=a,this.onGetSliderConfig=o,this.subscriberArr=[],jb.instance)throw new Error("BrushSettingService already instantiated");jb.instance=this}}var Hb;Hb=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("8EUal");var _b;_b=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("lQWO9");const Fb={brushes:cb,brushesUI:Mb,BrushSettingService:jb,KlCanvas:class{init(t,e){if(!t||!e||isNaN(t)||isNaN(e)||t<1||e<1)throw new Error("init - invalid canvas size");this.width=t,this.height=e}emitChange(){this.changeListenerArr.forEach((t=>t()))}updateIndices(){this.layerCanvasArr.forEach(((t,e)=>{t.index=e}))}setHistory(t){this.history=t}reset(t){if(!t.width||!t.height||t.width<1||t.height<1||isNaN(t.width)||isNaN(t.height))throw new Error("invalid canvas size");if(this.history.pause(!0),this.width=t.width,this.height=t.height,this.layerCanvasArr.splice(1,Math.max(0,this.layerCanvasArr.length-1)),t.layers)for(let e=0;e<t.layers.length;e++){let n=t.layers[e];this.layerCanvasArr[e]||this.addLayer(),this.layerCanvasArr[e].name=n.name,this.layerCanvasArr[e].width=this.width,this.layerCanvasArr[e].height=this.height,this.layerCanvasArr[e].mixModeStr=n.mixModeStr?n.mixModeStr:"source-over",this.layerCanvasArr[e].getContext("2d").drawImage(n.image,0,0),this.layerOpacity(e,n.opacity)}else this.layerCanvasArr[0].name=t.layerName?t.layerName:Vm("layers-layer")+" 1",this.layerCanvasArr[0].width=this.width,this.layerCanvasArr[0].height=this.height,this.layerCanvasArr[0].mixModeStr="source-over",this.layerOpacity(0,1),t.color?this.layerFill(0,t.color):t.image&&this.layerCanvasArr[0].getContext("2d").drawImage(t.image,0,0);return this.updateIndices(),this.history.pause(!1),this.history.push({tool:["canvas"],action:"reset",params:[t]}),this.layerCanvasArr.length-1}isLayerLimitReached(){return this.layerCanvasArr.length>=16}getWidth(){return this.width}getHeight(){return this.height}copy(t){if(t.getWidth()<1||t.getHeight()<1||isNaN(t.getWidth())||isNaN(t.getHeight()))throw new Error("invalid canvas size");let e=t.getLayers();for(;this.layerCanvasArr.length>e.length;)this.removeLayer(this.layerCanvasArr.length-1);t.getWidth()==this.width&&t.getHeight()==this.height||this.init(t.getWidth(),t.getHeight());for(let t=0;t<e.length;t++)t>=this.layerCanvasArr.length?this.addLayer():(this.layerCanvasArr[t].width=this.width,this.layerCanvasArr[t].height=this.height),this.layerOpacity(t,e[t].opacity),this.layerCanvasArr[t].name=e[t].name,this.layerCanvasArr[t].mixModeStr=e[t].mixModeStr,this.layerCanvasArr[t].getContext("2d").drawImage(e[t].context.canvas,0,0);this.updateIndices()}getLayerCount(){return this.layerCanvasArr.length}resize(t,e,n="smooth"){if(!t||!e||t===this.width&&e===this.height||isNaN(t)||isNaN(e)||t<1||e<1)return!1;let i,r;if(t=Math.max(t,1),e=Math.max(e,1),"pixelated"===n){i=Om.canvas(t,e);let n=i.getContext("2d");n.imageSmoothingEnabled=!1;for(let r=0;r<this.layerCanvasArr.length;r++){r>0&&n.clearRect(0,0,t,e);let a=this.layerCanvasArr[r];n.drawImage(a,0,0,t,e),a.width=t,a.height=e,a.getContext("2d").drawImage(i,0,0)}}else{if("smooth"!==n)throw new Error("unknown resize algorithm");i=Om.canvas(),r=Om.canvas();for(let n=0;n<this.layerCanvasArr.length;n++)Om.resizeCanvas(this.layerCanvasArr[n],t,e,i,r)}return this.width=t,this.height=e,!0}resizeCanvas(t){const e=Math.round(t.left)+this.width+Math.round(t.right),n=Math.round(t.top)+this.height+Math.round(t.bottom),i=Math.round(t.left),r=Math.round(t.top);if(isNaN(e)||isNaN(n)||e<1||n<1)throw new Error("KlCanvas.resizeCanvas - invalid canvas size");for(let a=0;a<this.layerCanvasArr.length;a++){const o=Om.canvas(this.width,this.height);let s=this.layerCanvasArr[a],l=this.layerCanvasArr[a].getContext("2d");o.getContext("2d").drawImage(s,0,0),this.layerCanvasArr[a].width=e,this.layerCanvasArr[a].height=n,l.save(),0===a&&t.fillColor&&(l.fillStyle=Om.ColorConverter.toRgbStr(t.fillColor),l.fillRect(0,0,e,n),l.clearRect(i,r,this.width,this.height)),l.drawImage(o,i,r),l.restore()}this.width=e,this.height=n}addLayer(t){if(this.isLayerLimitReached())return!1;let e=Om.canvas(this.width,this.height);return e.mixModeStr="source-over",void 0===t?(this.layerCanvasArr[this.layerCanvasArr.length]=e,t=Math.max(0,this.layerCanvasArr.length-1)):(this.layerCanvasArr.splice(t+1,0,e),t++),e.name=Vm("layers-layer")+" "+(this.layerCanvasArr.length+this.layerNrOffset),this.history.pause(!0),this.layerOpacity(t,1),this.history.pause(!1),this.updateIndices(),this.history.push({tool:["canvas"],action:"addLayer",params:[t-1]}),t}duplicateLayer(t){if(!this.layerCanvasArr[t]||this.isLayerLimitReached())return!1;let e=Om.canvas(this.width,this.height);return this.layerCanvasArr.splice(t+1,0,e),e.name=this.layerCanvasArr[t].name+" "+Vm("layers-copy"),e.mixModeStr=this.layerCanvasArr[t].mixModeStr,e.getContext("2d").drawImage(this.layerCanvasArr[t],0,0),this.history.pause(!0),this.layerOpacity(t+1,this.layerCanvasArr[t].opacity),this.history.pause(!1),this.updateIndices(),this.history.push({tool:["canvas"],action:"duplicateLayer",params:[t]}),t+1}getLayerContext(t,e){if(this.layerCanvasArr[t])return this.layerCanvasArr[t].getContext("2d");if(e)return null;throw new Error("layer of index "+t+" not found (in "+this.layerCanvasArr.length+" layers)")}removeLayer(t){return!!this.layerCanvasArr[t]&&(this.layerCanvasArr.splice(t,1),this.updateIndices(),this.history.push({tool:["canvas"],action:"removeLayer",params:[t]}),Math.max(0,t-1))}renameLayer(t,e){return!!this.layerCanvasArr[t]&&(this.layerCanvasArr[t].name=e,this.history.push({tool:["canvas"],action:"renameLayer",params:[t,e]}),!0)}layerOpacity(t,e){this.layerCanvasArr[t]&&(e=Math.max(0,Math.min(1,e)),this.layerCanvasArr[t].opacity=e,this.history.push({tool:["canvas"],action:"layerOpacity",params:[t,e]}),this.emitChange())}moveLayer(t,e){if(0!==e&&this.layerCanvasArr[t]){const n=this.layerCanvasArr[t];this.layerCanvasArr.splice(t,1);const i=Math.max(0,Math.min(t+e,this.layerCanvasArr.length));return this.layerCanvasArr.splice(i,0,n),this.updateIndices(),this.history.push({tool:["canvas"],action:"moveLayer",params:[t,e]}),i}}mergeLayers(t,e,n){if(!this.layerCanvasArr[t]||!this.layerCanvasArr[e]||t===e)return;if(t>e){let n=t;t=e,e=n}let i=this.layerCanvasArr[e].opacity;if(0!==i&&i){let r=this.layerCanvasArr[t].getContext("2d");r.save(),"as-alpha"===n?(Om.convertToAlphaChannelCanvas(this.layerCanvasArr[e]),r.globalCompositeOperation="destination-in",r.globalAlpha=i,this.layerCanvasArr[t].getContext("2d").drawImage(this.layerCanvasArr[e],0,0)):(n&&(r.globalCompositeOperation=n),r.globalAlpha=i,this.layerCanvasArr[t].getContext("2d").drawImage(this.layerCanvasArr[e],0,0)),r.restore(),n&&(r.save(),r.fillStyle="rgba(0,0,0,0.01)",r.fillRect(-.9999999,-.9999999,1,1),r.restore())}return this.updateIndices(),this.history.pause(!0),this.removeLayer(e),this.history.pause(!1),this.history.push({tool:["canvas"],action:"mergeLayers",params:[t,e,n]}),t}rotate(t){for(;t<0;)t+=360;if((t%=360)%90!=0||0===t)return;let e=Om.canvas();0===t||180===t?(e.width=this.width,e.height=this.height):90!==t&&270!==t||(e.width=this.height,e.height=this.width);let n=e.getContext("2d");for(let i=0;i<this.layerCanvasArr.length;i++)n.clearRect(0,0,e.width,e.height),n.save(),n.translate(e.width/2,e.height/2),n.rotate(t*Math.PI/180),180===t?n.drawImage(this.layerCanvasArr[i],-e.width/2,-e.height/2):90!==t&&270!==t||n.drawImage(this.layerCanvasArr[i],-e.height/2,-e.width/2),this.layerCanvasArr[i].width=e.width,this.layerCanvasArr[i].height=e.height,this.layerCanvasArr[i].getContext("2d").clearRect(0,0,this.layerCanvasArr[i].width,this.layerCanvasArr[i].height),this.layerCanvasArr[i].getContext("2d").drawImage(e,0,0),n.restore();this.width=e.width,this.height=e.height}flip(t,e,n){if(!t&&!e)return;let i=Om.canvas(this.width,this.height);i.width=this.width,i.height=this.height;let r=i.getContext("2d");for(let a=0;a<this.layerCanvasArr.length;a++)(!n&&0!==n||a===n)&&(r.save(),r.clearRect(0,0,i.width,i.height),r.translate(i.width/2,i.height/2),r.scale(t?-1:1,e?-1:1),r.drawImage(this.layerCanvasArr[a],-i.width/2,-i.height/2),r.restore(),this.layerCanvasArr[a].getContext("2d").clearRect(0,0,this.layerCanvasArr[a].width,this.layerCanvasArr[a].height),this.layerCanvasArr[a].getContext("2d").drawImage(i,0,0))}layerFill(t,e,n){let i=this.layerCanvasArr[t].getContext("2d");i.save(),n&&(i.globalCompositeOperation=n),i.fillStyle="rgba("+e.r+","+e.g+","+e.b+",1)",i.fillRect(0,0,this.layerCanvasArr[t].width,this.layerCanvasArr[t].height),i.restore(),i.save(),i.fillStyle="rgba(0,0,0,0.01)",i.fillRect(-.9999999,-.9999999,1,1),i.restore(),this.history.push({tool:["canvas"],action:"layerFill",params:[t,e,n]})}floodFill(t,e,n,i,r,a,o,s,l){if(e<0||n<0||e>=this.width||n>=this.height||0===r)return;if(a=Math.round(a),!["above","current","all"].includes(o))throw new Error("invalid sampleStr");let c,h,u,d,p,g,f;if("all"===o){let i=1===this.layerCanvasArr.length?this.layerCanvasArr[0]:this.getCompleteCanvas(1);h=i.getContext("2d"),u=h.getImageData(0,0,this.width,this.height),d=u.data,c=Cy(d,this.width,this.height,e,n,a,Math.round(s),l),i=null,h=null,u=null,d=null,p=this.layerCanvasArr[t].getContext("2d"),g=p.getImageData(0,0,this.width,this.height)}else{let i="above"===o?t+1:t;if(i>=this.layerCanvasArr.length)return;h=this.layerCanvasArr[i].getContext("2d"),u=h.getImageData(0,0,this.width,this.height),d=u.data,c=Cy(d,this.width,this.height,e,n,a,Math.round(s),l),t!==i&&(h=null,u=null,d=null),p=t===i?h:this.layerCanvasArr[t].getContext("2d"),g=t===i?u:p.getImageData(0,0,this.width,this.height)}if(f=g.data,1===r)for(let t=0;t<this.width*this.height;t++)255===c.data[t]&&(f[4*t]=i.r,f[4*t+1]=i.g,f[4*t+2]=i.b,f[4*t+3]=255);else for(let t=0;t<this.width*this.height;t++)255===c.data[t]&&(f[4*t]=Om.mix(f[4*t],i.r,r),f[4*t+1]=Om.mix(f[4*t+1],i.g,r),f[4*t+2]=Om.mix(f[4*t+2],i.b,r),f[4*t+3]=Om.mix(f[4*t+3],255,r));p.putImageData(g,0,0),this.history.push({tool:["canvas"],action:"replaceLayer",params:[t,g]})}drawShape(t,e){Sy(this.layerCanvasArr[t].getContext("2d"),e),this.history.push({tool:["canvas"],action:"drawShape",params:[t,Om.copyObj(e)]})}text(t,e){Ey(this.layerCanvasArr[t],Om.copyObj(e)),this.history.push({tool:["canvas"],action:"text",params:[t,Om.copyObj(e)]})}replaceLayer(t,e){this.layerCanvasArr[t].getContext("2d").putImageData(e,0,0),this.history.push({tool:["canvas"],action:"replaceLayer",params:[t,e]})}clearLayer(t){let e=this.layerCanvasArr[t].getContext("2d");e.save(),e.clearRect(0,0,this.layerCanvasArr[t].width,this.layerCanvasArr[t].height),e.restore(),this.history.push({tool:["canvas"],action:"clearLayer",params:[t]})}getLayers(){return this.layerCanvasArr.map((t=>({context:t.getContext("2d"),opacity:t.opacity,name:t.name,mixModeStr:t.mixModeStr})))}getLayersFast(){return this.layerCanvasArr.map((t=>({canvas:t,opacity:t.opacity,name:t.name,mixModeStr:t.mixModeStr})))}getLayerIndex(t,e){for(let e=0;e<this.layerCanvasArr.length;e++)if(this.layerCanvasArr[e]===t)return e;if(!e)throw new Error("layer not found (in "+this.layerCanvasArr.length+" layers)");return null}getLayer(t,e){if(this.layerCanvasArr[t])return{context:this.layerCanvasArr[t].getContext("2d"),opacity:this.layerCanvasArr[t].opacity,name:this.layerCanvasArr[t].name,id:t};if(!e)throw new Error("layer of index "+t+" not found (in "+this.layerCanvasArr.length+" layers)");return null}getColorAt(t,e){t=Math.floor(t),e=Math.floor(e);let n=this.pickCanvas.getContext("2d");n.save(),n.imageSmoothingEnabled=!1,n.clearRect(0,0,1,1);for(let i=0;i<this.layerCanvasArr.length;i++)n.globalAlpha=this.layerCanvasArr[i].opacity,n.globalCompositeOperation=this.layerCanvasArr[i].mixModeStr,n.drawImage(this.layerCanvasArr[i],-t,-e);n.restore();let i=n.getImageData(0,0,1,1);return new Om.RGB(i.data[0],i.data[1],i.data[2])}getCompleteCanvas(t){return My(this.getProject(),t)}getProject(){return{width:this.width,height:this.height,layers:this.layerCanvasArr.map((t=>({name:t.name,opacity:t.opacity,mixModeStr:t.mixModeStr,image:t})))}}addChangeListener(t){this.changeListenerArr.includes(t)||this.changeListenerArr.push(t)}removeChangeListener(t){for(let e=0;e<this.changeListenerArr.length;e++)if(this.changeListenerArr[e]===t)return void this.changeListenerArr.splice(e,1)}setMixMode(t,e){if(!this.layerCanvasArr[t])throw new Error("invalid layer");this.layerCanvasArr[t].mixModeStr=e,this.history.push({tool:["canvas"],action:"setMixMode",params:[t,""+e]})}setComposite(t,e){if(!this.layerCanvasArr[t])throw new Error("invalid layer");this.layerCanvasArr[t].compositeObj=e}constructor(t,e=0){if(this.layerNrOffset=e,this.layerCanvasArr=[],this.pickCanvas=Om.canvas(1,1),this.history=new Bm,"copy"in t?(this.width=1,this.height=1):"width"in t&&"height"in t?(this.width=t.width,this.height=t.height):(this.width=1,this.height=1),this.init(this.width,this.height),this.changeListenerArr=[],"copy"in t)this.copy(t.copy);else if("projectObj"in t){const e=[].concat(t.projectObj.layers);if(this.init(t.projectObj.width,t.projectObj.height),!e.length)throw new Error("project.layers needs at least 1 layer");for(let t=0;t<e.length;t++){if(e[t].mixModeStr&&!Iy.includes(e[t].mixModeStr))throw new Error("unknown mixModeStr "+e[t].mixModeStr);this.addLayer(),this.layerOpacity(t,e[t].opacity),this.layerCanvasArr[t].name=e[t].name,this.layerCanvasArr[t].mixModeStr=e[t].mixModeStr?e[t].mixModeStr:"source-over",this.layerCanvasArr[t].getContext("2d").drawImage(e[t].image,0,0)}}this.updateIndices()}},drawProject:My,WorkspaceSvgOverlay:Ty,KlCanvasWorkspace:class{getRenderedTransform(){const t=this.renderedTransformObj;return t.x=this.highResTransformObj.x,t.y=this.highResTransformObj.y,t.scale=this.highResTransformObj.scale,t.angle=this.highResTransformObj.angle,t.angle%(Math.PI/2)==0&&t.scale%1==0&&(t.x=Math.round(t.x),t.y=Math.round(t.y)),t}updateChangeListener(){this.klCanvas.addChangeListener((()=>{this.lastRenderedState=-1,this.reqFrame()}))}updateCursor(t,e){if(t===this.currentMode&&!e)return;const i=this.currentMode;if(this.currentMode=t,this.lastRenderedState=-1,this.currentMode===Oy.Draw?this.rootEl.style.cursor="crosshair":this.currentMode===Oy.Hand?this.rootEl.style.cursor="grab":this.currentMode===Oy.HandGrabbing?this.rootEl.style.cursor="grabbing":this.currentMode===Oy.Pick?this.rootEl.style.cursor="url('"+n(Ry)+"') 0 15, crosshair":this.currentMode===Oy.Zoom?this.rootEl.style.cursor="url('"+n(Ly)+"') 7 7, zoom-in":this.currentMode===Oy.Rotate?this.rootEl.style.cursor="grab":this.currentMode===Oy.Rotating?this.rootEl.style.cursor="grabbing":this.currentMode===Oy.Fill?this.rootEl.style.cursor="url('"+n(Ay)+"') 1 12, crosshair":this.currentMode===Oy.Text?this.rootEl.style.cursor="url('"+n(Py)+"') 1 12, crosshair":this.currentMode===Oy.Shape&&(this.rootEl.style.cursor="crosshair"),[Oy.Draw,Oy.Pick,Oy.Fill,Oy.Text,Oy.Shape].includes(this.globalMode)){const t=[Oy.Hand,Oy.HandGrabbing].includes(i),e=[Oy.Hand,Oy.HandGrabbing].includes(this.currentMode);!t&&e&&this.mainDoubleTapper.setAllowedPointerTypeArr(["mouse","pen","touch"]),t&&!e&&this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])}this.currentMode!==Oy.Pick&&this.svgOverlay.updateColorPreview({isVisible:!1})}internalZoomByStep(t,e,n){let i=Math.log2(this.targetTransformObj.scale)/Math.abs(t);i+=t>0?1:-1,i=Math.round(i),i*=Math.abs(t);const r=Math.max(.0625,Math.min(64,Math.pow(2,i)));if(r===this.targetTransformObj.scale)return!1;const a=r/this.targetTransformObj.scale;this.targetTransformObj.scale=r;let o=Om.Matrix.getIdentity();o=Om.Matrix.multiplyMatrices(o,Om.Matrix.createTranslationMatrix(e,n)),o=Om.Matrix.multiplyMatrices(o,Om.Matrix.createScaleMatrix(a)),o=Om.Matrix.multiplyMatrices(o,Om.Matrix.createTranslationMatrix(-e,-n));let s=[this.targetTransformObj.x,this.targetTransformObj.y,0,1];return s=Om.Matrix.multiplyMatrixAndPoint(o,s),this.targetTransformObj.x=s[0],this.targetTransformObj.y=s[1],this.transformIsDirty=!0,!0}mixTransformObj(t,e,n){if(t.angle===e.angle)return t.scale=Om.mix(t.scale,e.scale,n),t.x=Om.mix(t.x,e.x,n),t.y=Om.mix(t.y,e.y,n),void(t.angle=Om.mix(t.angle,e.angle,n));const i=this.klCanvas.getWidth(),r=this.klCanvas.getHeight(),a=this.canvasToWorkspaceCoord({x:i/2,y:r/2},t),o=this.canvasToWorkspaceCoord({x:i/2,y:r/2},e);t.x=Om.mix(a.x,o.x,n),t.y=Om.mix(a.y,o.y,n),t.scale=Om.mix(t.scale,e.scale,n),t.angle=Om.mix(t.angle,e.angle,n);const s=this.canvasToWorkspaceCoord({x:-i/2,y:-r/2},t);t.x=s.x,t.y=s.y}render(){this.doResizeCanvas&&(this.doResizeCanvas=!1,this.renderTargetCanvas.width=this.renderWidth,this.renderTargetCanvas.height=this.renderHeight),this.renderContext(this.renderTargetCtx)}testBgVisible(){const t=[[0,0],[this.renderWidth,0],[this.renderWidth,this.renderHeight],[0,this.renderHeight]],e=this.getRenderedTransform();let n=Om.Matrix.getIdentity();n=Om.Matrix.multiplyMatrices(n,Om.Matrix.createScaleMatrix(1/e.scale)),n=Om.Matrix.multiplyMatrices(n,Om.Matrix.createRotationMatrix(-e.angle)),n=Om.Matrix.multiplyMatrices(n,Om.Matrix.createTranslationMatrix(-e.x,-e.y));for(let e=0;e<t.length;e++){let i=[t[e][0],t[e][1],0,1];if(i=Om.Matrix.multiplyMatrixAndPoint(n,i),!(0<=i[0]&&i[0]<=this.klCanvas.getWidth()&&0<=i[1]&&i[1]<=this.klCanvas.getHeight()))return!0}return!1}renderContext(t){const e=this.klCanvas.getWidth(),n=this.klCanvas.getHeight(),i=this.getRenderedTransform();i.scale>=4||1===i.scale&&0===i.angle?t.imageSmoothingEnabled=!1:(t.imageSmoothingEnabled=!0,t.imageSmoothingQuality="low"),t.save();{if(this.bgVisible?(t.fillStyle="rgb(158,158,158)",t.fillRect(0,0,this.renderWidth,this.renderHeight)):t.clearRect(0,0,this.renderWidth,this.renderHeight),this.bgVisible){t.save(),t.translate(i.x,i.y),t.scale(i.scale,i.scale),t.rotate(i.angle),t.imageSmoothingEnabled=!1;const r=1;t.globalAlpha=.2,t.drawImage(this.emptyCanvas,-r/i.scale,-r/i.scale,e+2*r/i.scale,n+2*r/i.scale),t.globalAlpha=1,t.globalCompositeOperation="destination-out",t.drawImage(this.emptyCanvas,0,0,e,n),t.restore()}t.translate(i.x,i.y),t.scale(i.scale,i.scale),t.rotate(i.angle);const r=this.klCanvas.getLayersFast();for(let i=0;i<r.length;i++)r[i].opacity>0&&(t.globalAlpha=r[i].opacity,t.globalCompositeOperation=r[i].mixModeStr,r[i].canvas.compositeObj?(this.compositeCanvas.width!==r[i].canvas.width||this.compositeCanvas.height!==r[i].canvas.height?(this.compositeCanvas.width=r[i].canvas.width,this.compositeCanvas.height=r[i].canvas.height):this.compositeCtx.clearRect(0,0,this.compositeCanvas.width,this.compositeCanvas.height),this.compositeCtx.drawImage(r[i].canvas,0,0),r[i].canvas.compositeObj.draw(this.compositeCtx),t.drawImage(this.compositeCanvas,0,0,e,n)):t.drawImage(r[i].canvas,0,0,e,n));t.globalAlpha=1}t.restore(),Oy.Rotate===this.currentMode||Oy.Rotating===this.currentMode?this.svgOverlay.updateCompass({isVisible:!0,angleDeg:i.angle/Math.PI*180}):this.svgOverlay.updateCompass({isVisible:!1})}workspaceToCanvasCoord(t){const e=this.getRenderedTransform();let n=Om.Matrix.getIdentity();n=Om.Matrix.multiplyMatrices(n,Om.Matrix.createScaleMatrix(1/e.scale)),n=Om.Matrix.multiplyMatrices(n,Om.Matrix.createRotationMatrix(-e.angle)),n=Om.Matrix.multiplyMatrices(n,Om.Matrix.createTranslationMatrix(-e.x,-e.y));let i=[t.x,t.y,0,1];return i=Om.Matrix.multiplyMatrixAndPoint(n,i),{x:i[0],y:i[1]}}canvasToWorkspaceCoord(t,e){let n=Om.Matrix.getIdentity();n=Om.Matrix.multiplyMatrices(n,Om.Matrix.createTranslationMatrix(e.x,e.y)),n=Om.Matrix.multiplyMatrices(n,Om.Matrix.createRotationMatrix(e.angle)),n=Om.Matrix.multiplyMatrices(n,Om.Matrix.createScaleMatrix(e.scale));let i=[t.x,t.y,0,1];return i=Om.Matrix.multiplyMatrixAndPoint(n,i),{x:i[0],y:i[1]}}snapAngleRad(t,e,n){let i=180*t/Math.PI;const r=Math.abs(i%e);return Math.min(r,e-r)<=n&&(i=Math.round(i/e)*e),i/180*Math.PI}minimizeAngleRad(t){return(t%=2*Math.PI)>Math.PI?t-=2*Math.PI:t<-Math.PI&&(t+=2*Math.PI),t}resetInputProcessor(){this.currentInputProcessor=null,this.updateCursor(this.globalMode),this.reqFrame(!0)}reqFrame(t){this.animationFrameRequested=!0,t&&(this.lastRenderedState=-1)}updateLoop(){window.requestAnimationFrame((()=>this.updateLoop()));const t=zm.getState(),e=this.lastRenderedState<t,n=performance.now(),i=60*(n-this.lastRenderTime)/1e3;this.lastRenderTime=n,(this.animationFrameRequested||e)&&(this.animationFrameRequested=!1,this.checkChange(i))}checkChange(t){const e=zm.getState(),n=this.lastRenderedState<e||this.highResTransformObj.scale!==this.targetTransformObj.scale||this.highResTransformObj.x!==this.targetTransformObj.x||this.highResTransformObj.y!==this.targetTransformObj.y;if(!this.doAnimateTranslate&&(this.highResTransformObj.scale===this.targetTransformObj.scale||Math.abs(this.highResTransformObj.scale-this.targetTransformObj.scale)<.008*this.targetTransformObj.scale))this.highResTransformObj.scale=this.targetTransformObj.scale,this.highResTransformObj.x=this.targetTransformObj.x,this.highResTransformObj.y=this.targetTransformObj.y,this.highResTransformObj.angle=this.targetTransformObj.angle,this.transformIsDirty&&(this.transformIsDirty=!1,this.bgVisible=this.testBgVisible()),this.svgOverlay.updateCursor({radius:this.brushRadius*this.highResTransformObj.scale});else if((this.highResTransformObj.x===this.targetTransformObj.x||Math.abs(this.highResTransformObj.x-this.targetTransformObj.x)<.5)&&(this.highResTransformObj.y===this.targetTransformObj.y||Math.abs(this.highResTransformObj.y-this.targetTransformObj.y)<.5)&&(this.highResTransformObj.scale===this.targetTransformObj.scale||Math.abs(this.highResTransformObj.scale-this.targetTransformObj.scale)<.008*this.targetTransformObj.scale))this.highResTransformObj.scale=this.targetTransformObj.scale,this.highResTransformObj.x=this.targetTransformObj.x,this.highResTransformObj.y=this.targetTransformObj.y,this.highResTransformObj.angle=this.targetTransformObj.angle,this.doAnimateTranslate=!1,this.transformIsDirty&&(this.transformIsDirty=!1,this.bgVisible=this.testBgVisible()),this.svgOverlay.updateCursor({radius:this.brushRadius*this.highResTransformObj.scale});else{this.reqFrame();const e=Math.min(1,.3*t);this.mixTransformObj(this.highResTransformObj,this.targetTransformObj,e),this.bgVisible=!0,this.svgOverlay.updateCursor({radius:this.brushRadius*this.highResTransformObj.scale})}if(this.pointer&&this.currentMode==Oy.Draw&&!this.usesCssCursor?this.svgOverlay.updateCursor({x:this.pointer.x,y:this.pointer.y,isVisible:!0}):this.svgOverlay.updateCursor({isVisible:!1}),n){this.lastRenderedState=e;const t=performance.now();this.render(),this.renderTime=Om.mix(this.renderTime,performance.now()-t,.05)}}getElement(){return this.rootEl}setCanvas(t){this.klCanvas=t,this.lastDrawEvent=null,this.resetView(),this.updateChangeListener(),this.lastRenderedState=-1,this.reqFrame()}setSize(t,e){const n=this.renderWidth,i=this.renderHeight;t===n&&e===i||(this.doResizeCanvas=!0,this.renderWidth=t,this.renderHeight=e,this.svgOverlay.setSize(t,e),this.targetTransformObj.x+=(t-n)/2,this.targetTransformObj.y+=(e-i)/2,this.highResTransformObj.x=this.targetTransformObj.x,this.highResTransformObj.y=this.targetTransformObj.y,this.bgVisible=this.testBgVisible(),this.lastRenderedState=-1,this.reqFrame())}setMode(t){"draw"===t&&(this.globalMode=Oy.Draw,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])),"fill"===t&&(this.globalMode=Oy.Fill,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])),"text"===t&&(this.globalMode=Oy.Text,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])),"shape"===t&&(this.globalMode=Oy.Shape,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])),"hand"===t&&(this.globalMode=Oy.Hand,this.mainDoubleTapper.setAllowedPointerTypeArr(["mouse","pen","touch"])),"pick"===t&&(this.globalMode=Oy.Pick,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"]))}setEnabled(t){}setCursorSize(t){this.brushRadius=t/2,this.svgOverlay.updateCursor({radius:this.brushRadius*this.highResTransformObj.scale}),null===this.pointer&&(clearTimeout(this.hideBrushCursorTimeout),this.svgOverlay.updateCursor({x:this.renderWidth/2,y:this.renderHeight/2,isVisible:!0}),this.hideBrushCursorTimeout=setTimeout((()=>{null===this.pointer&&this.svgOverlay.updateCursor({isVisible:!1})}),500))}zoomByStep(t){this.internalZoomByStep(t,this.renderWidth/2,this.renderHeight/2)&&(this.lastRenderedState=-1,this.reqFrame(),this.onViewChange({changed:["scale"],angle:this.targetTransformObj.angle,scale:this.targetTransformObj.scale}))}resetView(t){this.targetTransformObj.scale=1,this.targetTransformObj.angle=0,this.targetTransformObj.x=(this.renderWidth-this.klCanvas.getWidth())/2,this.targetTransformObj.y=(this.renderHeight-this.klCanvas.getHeight())/2,t?(this.doAnimateTranslate=!0,this.transformIsDirty=!0):this.highResTransformObj=JSON.parse(JSON.stringify(this.targetTransformObj)),this.bgVisible=this.testBgVisible(),this.reqFrame(),t&&this.onViewChange({changed:["scale","angle"],scale:this.targetTransformObj.scale,angle:this.targetTransformObj.angle})}fitView(){const t=[[0,0],[this.klCanvas.getWidth(),0],[this.klCanvas.getWidth(),this.klCanvas.getHeight()],[0,this.klCanvas.getHeight()],[this.klCanvas.getWidth()/2,this.klCanvas.getHeight()/2]];let e=Om.Matrix.getIdentity();e=Om.Matrix.multiplyMatrices(e,Om.Matrix.createRotationMatrix(this.targetTransformObj.angle));for(let n=0;n<t.length;n++){let i=[t[n][0],t[n][1],0,1];i=Om.Matrix.multiplyMatrixAndPoint(e,i),t[n][0]=i[0],t[n][1]=i[1]}const n={x0:null,y0:null,x1:null,y1:null};for(let e=0;e<t.length;e++)(null===n.x0||t[e][0]<n.x0)&&(n.x0=t[e][0]),(null===n.y0||t[e][1]<n.y0)&&(n.y0=t[e][1]),(null===n.x1||t[e][0]>n.x1)&&(n.x1=t[e][0]),(null===n.y1||t[e][1]>n.y1)&&(n.y1=t[e][1]);const i=n.x1-n.x0,r=n.y1-n.y0,a=Om.fitInto(i,r,this.renderWidth-40,this.renderHeight-40,1).width/i;this.targetTransformObj.x=this.renderWidth/2-(t[4][0]-t[0][0])*a,this.targetTransformObj.y=this.renderHeight/2-(t[4][1]-t[0][1])*a,this.targetTransformObj.scale=a,this.doAnimateTranslate=!0,this.transformIsDirty=!0,this.reqFrame(),this.onViewChange({changed:["scale","angle"],scale:this.targetTransformObj.scale,angle:this.targetTransformObj.angle})}setAngle(t,e){const n={x:this.renderWidth/2,y:this.renderHeight/2},i=this.targetTransformObj.angle,r=t/180*Math.PI;e?this.targetTransformObj.angle+=r:this.targetTransformObj.angle=r,this.targetTransformObj.angle=this.minimizeAngleRad(this.snapAngleRad(this.targetTransformObj.angle,90,4));let a=Om.Matrix.getIdentity();a=Om.Matrix.multiplyMatrices(a,Om.Matrix.createTranslationMatrix(n.x,n.y)),a=Om.Matrix.multiplyMatrices(a,Om.Matrix.createRotationMatrix(this.targetTransformObj.angle-i)),a=Om.Matrix.multiplyMatrices(a,Om.Matrix.createTranslationMatrix(-n.x,-n.y));let o=[this.targetTransformObj.x,this.targetTransformObj.y,0,1];o=Om.Matrix.multiplyMatrixAndPoint(a,o),this.targetTransformObj.x=o[0],this.targetTransformObj.y=o[1],this.highResTransformObj=JSON.parse(JSON.stringify(this.targetTransformObj)),this.transformIsDirty=!0,this.reqFrame(!0)}translateView(t,e){this.targetTransformObj.x+=40*t,this.targetTransformObj.y+=40*e,this.transformIsDirty=!0,this.doAnimateTranslate=!0,this.reqFrame(!0)}getIsDrawing(){return this.isDrawing}getScale(){return this.targetTransformObj.scale}getAngleDeg(){return 180*this.targetTransformObj.angle/Math.PI}getMaxScale(){return 64}getMinScale(){return.0625}requestFrame(){this.lastRenderedState=-1,this.reqFrame()}setLastDrawEvent(t,e,n){null!==t?(this.lastDrawEvent||(this.lastDrawEvent={x:0,y:0,pressure:0}),this.lastDrawEvent.x=t,this.lastDrawEvent.y=e,this.lastDrawEvent.pressure=n):this.lastDrawEvent=null}constructor(t){const e=this;this.rootEl=Om.el({css:{position:"absolute",left:"0",right:"0",top:"0",bottom:"0",cursor:"crosshair",userSelect:"none",colorScheme:"only light"}}),this.klCanvas=t.klCanvas,this.onViewChange=t.onViewChange,this.renderTargetCanvas=Om.canvas(t.width,t.height),this.renderTargetCtx=this.renderTargetCanvas.getContext("2d"),this.renderWidth=t.width,this.renderHeight=t.height,this.compositeCanvas=Om.canvas(1,1),this.compositeCtx=this.compositeCanvas.getContext("2d"),this.doResizeCanvas=!1,this.oldTransformObj=null,this.targetTransformObj={x:0,y:0,scale:1,angle:0},this.highResTransformObj={x:0,y:0,scale:1,angle:0},this.renderedTransformObj={x:null,y:null,scale:null,angle:null},this.cursorPos={x:0,y:0},this.usesCssCursor=!1,this.bgVisible=!0,this.transformIsDirty=!0,this.doAnimateTranslate=!0,this.svgOverlay=new Ty({width:t.width,height:t.height}),Om.css(this.renderTargetCanvas,{userSelect:"none",pointerEvents:"none"}),Om.createCheckerDataUrl(8,(t=>{this.renderTargetCanvas.style.background="url("+t+")"})),this.rootEl.appendChild(this.renderTargetCanvas),this.rootEl.appendChild(this.svgOverlay.getElement()),Om.addEventListener(this.rootEl,"touchend",(t=>(t.preventDefault(),!1))),Om.addEventListener(this.rootEl,"contextmenu",(t=>(t.preventDefault(),!1))),Om.addEventListener(this.rootEl,"dragstart",(t=>(t.preventDefault(),!1))),this.emptyCanvas=Om.canvas(1,1);this.emptyCanvas.getContext("2d").fillRect(0,0,1,1);this.keyListener=new Om.KeyListener({onDown:(t,e,n,i)=>{if("alt"===t&&e.preventDefault(),!i)if(this.currentInputProcessor)this.currentInputProcessor.onKeyDown(t,e,n,i);else{if([Oy.Draw,Oy.Pick,Oy.Fill,Oy.Text,Oy.Shape].includes(this.globalMode)&&"space"===n)return this.currentInputProcessor=this.inputProcessorObj.spaceHand,void this.currentInputProcessor.onKeyDown(t,e,n,i);if([Oy.Draw,Oy.Hand,Oy.Fill,Oy.Text,Oy.Shape].includes(this.globalMode)&&"alt"===n)return this.currentInputProcessor=this.inputProcessorObj.altPicker,void this.currentInputProcessor.onKeyDown(t,e,n,i);if(["r","shift+r"].includes(n))return this.currentInputProcessor=this.inputProcessorObj.rotate,void this.currentInputProcessor.onKeyDown(t,e,n,i);if("z"===n)return this.currentInputProcessor=this.inputProcessorObj.zoom,void this.currentInputProcessor.onKeyDown(t,e,n,i)}},onUp:(t,e,n)=>{this.currentInputProcessor&&this.currentInputProcessor.onKeyUp(t,e,n)}}),this.updateChangeListener(),this.currentMode=Oy.Draw,this.globalMode=Oy.Draw,this.renderTime=0,this.lastDrawEvent=null,this.linetoolProcessor=new Om.EventChain.LinetoolProcessor({onDraw:e=>{const n=()=>{const t=this.getRenderedTransform();let e=Om.Matrix.getIdentity();return e=Om.Matrix.multiplyMatrices(e,Om.Matrix.createScaleMatrix(1/t.scale)),e=Om.Matrix.multiplyMatrices(e,Om.Matrix.createRotationMatrix(-t.angle)),e=Om.Matrix.multiplyMatrices(e,Om.Matrix.createTranslationMatrix(-t.x,-t.y)),e};if("line"===e.type&&!this.lastDrawEvent){const t=n();let i=[e.x1,e.y1,0,1];return i=Om.Matrix.multiplyMatrixAndPoint(t,i),void(this.lastDrawEvent={x:i[0],y:i[1],pressure:e.pressure1})}if("x"in e||"x0"in e){const t=n();if("x"in e){let n=[e.x,e.y,0,1];n=Om.Matrix.multiplyMatrixAndPoint(t,n),e.x=n[0],e.y=n[1]}if("x0"in e){e.x0=this.lastDrawEvent.x,e.y0=this.lastDrawEvent.y,e.pressure0=this.lastDrawEvent.pressure;let n=[e.x1,e.y1,0,1];n=Om.Matrix.multiplyMatrixAndPoint(t,n),e.x1=n[0],e.y1=n[1],this.lastDrawEvent={x:e.x1,y:e.y1,pressure:e.pressure1}}}["down","move"].includes(e.type)&&(this.lastDrawEvent=e),t.onDraw(e)}}),this.pointer=null,this.isDrawing=!1,this.inputProcessorObj={draw:{onPointer:t=>{this.reqFrame(),this.updateCursor(Oy.Draw);const e=this.keyListener.getComboStr(),n={scale:this.highResTransformObj.scale};if(n.shiftIsPressed="shift"===e,n.pressure=t.pressure,n.isCoalesced=!!t.isCoalesced,"pointerdown"===t.type)this.isDrawing=!0,n.type="down";else{if(!t.button)return"pointerup"===t.type?(this.isDrawing=!1,n.type="up",this.linetoolProcessor.process(n),void this.resetInputProcessor()):void 0;n.type="move"}n.x=t.relX,n.y=t.relY,this.linetoolProcessor.process(n)},onKeyDown:(t,e,n,i)=>{},onKeyUp:(t,e,n)=>{}},fill:{onPointer:e=>{if(this.reqFrame(),this.updateCursor(Oy.Fill),"pointerdown"===e.type){const n=this.workspaceToCanvasCoord({x:e.relX,y:e.relY});t.onFill(Math.floor(n.x),Math.floor(n.y))}else if("pointerup"===e.type)return void this.resetInputProcessor()},onKeyDown:(t,e,n,i)=>{},onKeyUp:(t,e,n)=>{}},text:{onPointer:e=>{if(this.reqFrame(),this.updateCursor(Oy.Text),"pointerdown"===e.type){const n=this.workspaceToCanvasCoord({x:e.relX,y:e.relY});t.onText(Math.floor(n.x),Math.floor(n.y),this.renderedTransformObj.angle)}else if("pointerup"===e.type)return void this.resetInputProcessor()},onKeyDown:(t,e,n,i)=>{},onKeyUp:(t,e,n)=>{}},shape:{onPointer:e=>{this.reqFrame(),this.updateCursor(Oy.Shape);const n=this.workspaceToCanvasCoord({x:e.relX,y:e.relY});"pointerdown"===e.type?(this.isDrawing=!0,t.onShape("down",n.x,n.y,this.renderedTransformObj.angle)):"pointermove"===e.type?t.onShape("move",n.x,n.y,this.renderedTransformObj.angle):"pointerup"===e.type&&(this.isDrawing=!1,t.onShape("up",n.x,n.y,this.renderedTransformObj.angle),this.resetInputProcessor())},onKeyDown:(t,e,n,i)=>{},onKeyUp:(t,e,n)=>{}},hand:{onPointer:t=>{this.updateCursor(Oy.Hand),["left","middle"].includes(t.button)?(this.updateCursor(Oy.HandGrabbing),this.targetTransformObj.x+=t.dX,this.targetTransformObj.y+=t.dY,this.highResTransformObj=JSON.parse(JSON.stringify(this.targetTransformObj)),this.doAnimateTranslate=!1,this.transformIsDirty=!0,this.reqFrame(!0)):"pointerup"===t.type&&this.resetInputProcessor()},onKeyDown:(t,e,n,i)=>{},onKeyUp:(t,e,n)=>{}},spaceHand:{onPointer:t=>{this.updateCursor(Oy.Hand),["left","middle"].includes(t.button)&&(this.updateCursor(Oy.HandGrabbing),this.targetTransformObj.x+=t.dX,this.targetTransformObj.y+=t.dY,this.highResTransformObj=JSON.parse(JSON.stringify(this.targetTransformObj)),this.doAnimateTranslate=!1,this.transformIsDirty=!0,this.reqFrame(!0))},onKeyDown:(t,e,n,i)=>{"space"!==n?this.resetInputProcessor():this.updateCursor(Oy.Hand)},onKeyUp:(t,e,n)=>{this.resetInputProcessor()}},zoom:{onPointer:t=>{if(this.updateCursor(Oy.Zoom),"left"===t.button&&!t.isCoalesced&&0!=t.dX){const e=t.pageX-t.relX,n=t.pageY-t.relY;this.internalZoomByStep(t.dX/175,t.downPageX-e,t.downPageY-n),this.highResTransformObj=JSON.parse(JSON.stringify(this.targetTransformObj)),this.lastRenderedState=-1,this.reqFrame(),this.onViewChange({changed:["scale"],angle:this.targetTransformObj.angle,scale:this.targetTransformObj.scale})}},onKeyDown:(t,e,n,i)=>{"z"!==n?this.resetInputProcessor():this.updateCursor(Oy.Zoom)},onKeyUp:(t,e,n)=>{this.resetInputProcessor()}},picker:{onPointer:e=>{if(this.updateCursor(Oy.Pick),["left","right"].includes(e.button)&&!e.isCoalesced||"pointerup"===e.type){const n=this.workspaceToCanvasCoord({x:e.relX,y:e.relY}),i=this.klCanvas.getColorAt(n.x,n.y);t.onPick(i,"pointerup"===e.type),this.svgOverlay.updateColorPreview({x:e.relX,y:e.relY,color:i,isVisible:"pointerup"!==e.type}),"pointerup"===e.type&&this.resetInputProcessor()}},onKeyDown:(t,e,n,i)=>{},onKeyUp:(t,e,n)=>{}},altPicker:{onPointer:e=>{if(this.updateCursor(Oy.Pick),["left","right"].includes(e.button)&&!e.isCoalesced||"pointerup"===e.type){const n=this.workspaceToCanvasCoord({x:e.relX,y:e.relY}),i=this.klCanvas.getColorAt(n.x,n.y);t.onPick(i,"pointerup"===e.type),this.svgOverlay.updateColorPreview({x:e.relX,y:e.relY,color:i,isVisible:"pointerup"!==e.type})}},onKeyDown:(t,e,n,i)=>{"alt"!==n?this.resetInputProcessor():this.updateCursor(Oy.Pick)},onKeyUp:(t,e,n)=>{this.resetInputProcessor()}},rotate:{onPointer:t=>{if(this.updateCursor("left"===t.button?Oy.Rotating:Oy.Rotate),"pointerdown"===t.type&&"left"===t.button)this.oldTransformObj=JSON.parse(JSON.stringify(this.targetTransformObj));else if("left"===t.button&&!t.isCoalesced&&this.oldTransformObj){const e=t.pageX-t.relX,n=t.pageY-t.relY,i={x:this.renderWidth/2,y:this.renderHeight/2},r=Om.Vec2.angle(i,{x:t.downPageX-e,y:t.downPageY-n});let a=Om.Vec2.angle(i,{x:t.pageX-e,y:t.pageY-n})-r;this.targetTransformObj=JSON.parse(JSON.stringify(this.oldTransformObj)),this.targetTransformObj.angle+=a,this.keyListener.isPressed("shift")&&(this.targetTransformObj.angle=Math.round(this.targetTransformObj.angle/Math.PI*8)*Math.PI/8,a=this.targetTransformObj.angle-this.oldTransformObj.angle),this.targetTransformObj.angle=this.minimizeAngleRad(this.targetTransformObj.angle);let o=Om.Matrix.getIdentity();o=Om.Matrix.multiplyMatrices(o,Om.Matrix.createTranslationMatrix(i.x,i.y)),o=Om.Matrix.multiplyMatrices(o,Om.Matrix.createRotationMatrix(a)),o=Om.Matrix.multiplyMatrices(o,Om.Matrix.createTranslationMatrix(-i.x,-i.y));let s=[this.targetTransformObj.x,this.targetTransformObj.y,0,1];s=Om.Matrix.multiplyMatrixAndPoint(o,s),this.targetTransformObj.x=s[0],this.targetTransformObj.y=s[1],this.highResTransformObj=JSON.parse(JSON.stringify(this.targetTransformObj)),this.transformIsDirty=!0,this.lastRenderedState=-1,this.reqFrame(),this.onViewChange({changed:["angle"],scale:this.targetTransformObj.scale,angle:this.targetTransformObj.angle})}},onKeyDown:(t,e,n,i)=>{["r","r+shift","shift+r","r+left","r+right","r+left+right","r+right+left","r+up"].includes(n)?this.updateCursor(Oy.Rotate):this.resetInputProcessor()},onKeyUp:(t,e,n)=>{const i=this.keyListener.getComboStr();["r","r+shift","shift+r","r+left","r+right","r+left+right","r+right+left","r+up"].includes(i)?this.updateCursor(Oy.Rotate):this.resetInputProcessor()}}},this.currentInputProcessor=null,this.angleIsExtraSticky=!1,this.pinchZoomer=new Om.EventChain.PinchZoomer({onPinch:t=>{if("move"===t.type){this.oldTransformObj||(this.oldTransformObj=JSON.parse(JSON.stringify(this.targetTransformObj)),this.angleIsExtraSticky=this.targetTransformObj.angle%(Math.PI/2)==0),this.targetTransformObj=JSON.parse(JSON.stringify(this.oldTransformObj)),t.scale=Math.max(.0625,Math.min(64,this.targetTransformObj.scale*t.scale))/this.targetTransformObj.scale,this.targetTransformObj.scale*=t.scale,this.targetTransformObj.angle+=t.angleRad,this.targetTransformObj.angle=this.minimizeAngleRad(this.snapAngleRad(this.targetTransformObj.angle,90,this.angleIsExtraSticky?12:4)),this.targetTransformObj.angle%(Math.PI/2)!=0&&(this.angleIsExtraSticky=!1),t.angleRad=this.targetTransformObj.angle-this.oldTransformObj.angle;{let e=Om.Matrix.getIdentity();e=Om.Matrix.multiplyMatrices(e,Om.Matrix.createTranslationMatrix(t.relX,t.relY)),e=Om.Matrix.multiplyMatrices(e,Om.Matrix.createScaleMatrix(t.scale)),e=Om.Matrix.multiplyMatrices(e,Om.Matrix.createRotationMatrix(t.angleRad)),e=Om.Matrix.multiplyMatrices(e,Om.Matrix.createTranslationMatrix(-t.relX,-t.relY)),e=Om.Matrix.multiplyMatrices(e,Om.Matrix.createTranslationMatrix(t.relX-t.downRelX,t.relY-t.downRelY));let n=[this.targetTransformObj.x,this.targetTransformObj.y,0,1];n=Om.Matrix.multiplyMatrixAndPoint(e,n),this.targetTransformObj.x=n[0],this.targetTransformObj.y=n[1]}this.highResTransformObj=Om.copyObj(this.targetTransformObj),this.onViewChange({changed:["scale","angle"],scale:this.targetTransformObj.scale,angle:this.targetTransformObj.angle}),this.reqFrame(),this.transformIsDirty=!0,this.lastRenderedState=-1}else"end"===t.type&&(this.oldTransformObj=null)}});const n=()=>{let t=JSON.parse(JSON.stringify(this.targetTransformObj));e.fitView(),this.lastRenderedState=-1,this.reqFrame(),t.scale===this.targetTransformObj.scale&&t.angle===this.targetTransformObj.angle||this.onViewChange({changed:["scale","angle"],angle:this.targetTransformObj.angle,scale:this.targetTransformObj.scale})};this.mainDoubleTapper=new Om.EventChain.DoubleTapper({onDoubleTap:n}),this.middleDoubleTapper=new Om.EventChain.DoubleTapper({onDoubleTap:n}),this.middleDoubleTapper.setAllowedButtonArr(["middle"]),this.twoFingerTap=new Om.EventChain.NFingerTapper({fingers:2,onTap:()=>{t.onUndo()}}),this.threeFingerTap=new Om.EventChain.NFingerTapper({fingers:3,onTap:()=>{t.onRedo()}}),this.pointerEventChain=new Om.EventChain.EventChain({chainArr:[this.twoFingerTap,this.threeFingerTap,this.mainDoubleTapper,this.middleDoubleTapper,this.pinchZoomer,new Om.EventChain.OnePointerLimiter,new Om.EventChain.CoalescedExploder]}),this.pointerEventChain.setChainOut((t=>{if(this.cursorPos.x=t.relX,this.cursorPos.y=t.relY,"pointerup"===t.type&&"touch"===t.pointerType?(this.pointer=null,this.lastRenderedState=-1,this.reqFrame()):(this.pointer||(this.pointer={x:0,y:0}),this.pointer.x=t.relX,this.pointer.y=t.relY),this.currentInputProcessor)this.currentInputProcessor.onPointer(t);else{let e=this.keyListener.getComboStr();this.globalMode===Oy.Draw?["","shift","ctrl"].includes(e)&&"pointerdown"===t.type&&"left"===t.button?(this.currentInputProcessor=this.inputProcessorObj.draw,this.currentInputProcessor.onPointer(t)):[""].includes(e)&&"pointerdown"===t.type&&"right"===t.button?(this.currentInputProcessor=this.inputProcessorObj.picker,this.currentInputProcessor.onPointer(t)):[""].includes(e)&&"pointerdown"===t.type&&"middle"===t.button?(this.currentInputProcessor=this.inputProcessorObj.hand,this.currentInputProcessor.onPointer(t)):(this.updateCursor(Oy.Draw),this.reqFrame()):this.globalMode===Oy.Hand?"pointerdown"===t.type&&["left","middle"].includes(t.button)?(this.currentInputProcessor=this.inputProcessorObj.hand,this.currentInputProcessor.onPointer(t)):[""].includes(e)&&"pointerdown"===t.type&&"right"===t.button?(this.currentInputProcessor=this.inputProcessorObj.picker,this.currentInputProcessor.onPointer(t)):this.updateCursor(Oy.Hand):this.globalMode===Oy.Pick?"pointerdown"===t.type&&["left","right"].includes(t.button)?(this.currentInputProcessor=this.inputProcessorObj.picker,this.currentInputProcessor.onPointer(t)):[""].includes(e)&&"pointerdown"===t.type&&"middle"===t.button?(this.currentInputProcessor=this.inputProcessorObj.hand,this.currentInputProcessor.onPointer(t)):this.updateCursor(Oy.Pick):this.globalMode===Oy.Fill?"pointerdown"===t.type&&"left"===t.button?(this.currentInputProcessor=this.inputProcessorObj.fill,this.currentInputProcessor.onPointer(t)):[""].includes(e)&&"pointerdown"===t.type&&"right"===t.button?(this.currentInputProcessor=this.inputProcessorObj.picker,this.currentInputProcessor.onPointer(t)):[""].includes(e)&&"pointerdown"===t.type&&"middle"===t.button?(this.currentInputProcessor=this.inputProcessorObj.hand,this.currentInputProcessor.onPointer(t)):(this.updateCursor(Oy.Fill),this.reqFrame()):this.globalMode===Oy.Text?"pointerdown"===t.type&&"left"===t.button?(this.currentInputProcessor=this.inputProcessorObj.text,this.currentInputProcessor.onPointer(t)):[""].includes(e)&&"pointerdown"===t.type&&"right"===t.button?(this.currentInputProcessor=this.inputProcessorObj.picker,this.currentInputProcessor.onPointer(t)):[""].includes(e)&&"pointerdown"===t.type&&"middle"===t.button?(this.currentInputProcessor=this.inputProcessorObj.hand,this.currentInputProcessor.onPointer(t)):(this.updateCursor(Oy.Text),this.reqFrame()):this.globalMode===Oy.Shape&&(["","shift","ctrl"].includes(e)&&"pointerdown"===t.type&&"left"===t.button?(this.currentInputProcessor=this.inputProcessorObj.shape,this.currentInputProcessor.onPointer(t)):[""].includes(e)&&"pointerdown"===t.type&&"right"===t.button?(this.currentInputProcessor=this.inputProcessorObj.picker,this.currentInputProcessor.onPointer(t)):[""].includes(e)&&"pointerdown"===t.type&&"middle"===t.button?(this.currentInputProcessor=this.inputProcessorObj.hand,this.currentInputProcessor.onPointer(t)):(this.updateCursor(Oy.Shape),this.reqFrame()))}})),Om.addEventListener(this.rootEl,"wheel",(t=>{t.preventDefault()})),setTimeout((()=>{this.pointerListener=new Om.PointerListener({target:this.rootEl,fixScribble:!0,onPointer:t=>{if("pointerdown"===t.type&&"middle"===t.button)try{t.eventPreventDefault()}catch(t){}this.pointerEventChain.chainIn(t)},onWheel:t=>{if(this.isDrawing)return;this.reqFrame(),this.internalZoomByStep(-t.deltaY/(this.keyListener.isPressed("shift")?8:2),t.relX,t.relY)&&this.onViewChange({changed:["scale"],angle:this.targetTransformObj.angle,scale:this.targetTransformObj.scale}),this.lastRenderedState=-1},onEnterLeave:t=>{t||this.isDrawing||(this.pointer=null,this.lastRenderedState=-1)},maxPointers:4})}),1),this.brushRadius=1,this.animationFrameRequested=!1,this.lastRenderedState=-2,this.lastRenderTime=performance.now(),window.requestAnimationFrame((()=>this.updateLoop())),this.resetView()}},KlCanvasPreview:By,filterLibStatus:Yx,filterLib:Xx,UndoRedoCatchup:class{ignoreTest(){return!this.doIgnore&&(this.doIgnore=!0,setTimeout((()=>{this.doIgnore=!1}),0),!0)}undo(){if(!this.ignoreTest())return!1;if(!zm.canUndo())return!1;const t=zm.undo();zm.pause(!0);const e=this.getInitState(),n=this.getKlCanvas().getWidth(),i=this.getKlCanvas().getHeight();this.getKlCanvas().copy(e.canvas);let r=e.focus;this.setCurrentLayerCtx(this.getKlCanvas().getLayerContext(r));const a={};for(let t in Fb.brushes)Fb.brushes.hasOwnProperty(t)&&(a[t]=new Fb.brushes[t],a[t].setContext(this.getCurrentLayerCtx()));a.SketchyBrush.setSeed(e.brushes.SketchyBrush.getSeed());for(let e=0;e<t.length;e++)(e=>{if("brush"===t[e].tool[0]){const n=a[t[e].tool[1]];if(t[e].actions)for(let i=0;i<t[e].actions.length;i++){const r=t[e].actions[i].params;n[t[e].actions[i].action].apply(n,r)}else{const i=t[e].params;n[t[e].action].apply(n,i)}}else if("canvas"===t[e].tool[0]){const n=t[e].params,i=this.getKlCanvas()[t[e].action].apply(this.getKlCanvas(),n);if("number"==typeof i){r=i,this.setCurrentLayerCtx(this.getKlCanvas().getLayerContext(r));for(let t in a)a.hasOwnProperty(t)&&a[t].setContext(this.getCurrentLayerCtx())}}else if("filter"===t[e].tool[0]){const n=[{context:this.getCurrentLayerCtx(),canvas:this.getKlCanvas(),input:t[e].params[0].input,history:new Fb.DecoyKlHistory}];Fb.filterLib[t[e].tool[1]][t[e].action].apply(null,n)}else if("misc"===t[e].tool[0]&&"focusLayer"===t[e].action){r=t[e].params[0],this.setCurrentLayerCtx(this.getKlCanvas().getLayerContext(t[e].params[0]));for(let t in a)a.hasOwnProperty(t)&&a[t].setContext(this.getCurrentLayerCtx())}else if("misc"===t[e].tool[0]&&"importImage"===t[e].action){const n=this.getKlCanvas().addLayer();if("number"==typeof n){r=n,t[e].params[1]&&this.getKlCanvas().renameLayer(r,t[e].params[1]),this.setCurrentLayerCtx(this.getKlCanvas().getLayerContext(r));for(let t in a)a.hasOwnProperty(t)&&a[t].setContext(this.getCurrentLayerCtx())}this.getCurrentLayerCtx().drawImage(t[e].params[0],0,0)}})(e);return n===this.getKlCanvas().getWidth()&&i===this.getKlCanvas().getHeight()||(this.klCanvasWorkspace.resetView(),this.handUi.update(this.klCanvasWorkspace.getScale(),this.klCanvasWorkspace.getAngleDeg())),this.layerManager.update(r),this.layerPreview.setLayer(this.getKlCanvas().getLayer(r)),this.brushUiObj.sketchyBrush.setSeed(a.SketchyBrush.getSeed()),this.getCurrentBrush().setContext(this.getCurrentLayerCtx()),this.klCanvasWorkspace.setLastDrawEvent(null),zm.pause(!1),!0}redo(){if(!this.ignoreTest())return!1;if(!zm.canRedo())return!1;const t=zm.redo();zm.pause(!0);const e=this.getKlCanvas().getWidth(),n=this.getKlCanvas().getHeight();let i;const r={};for(let t in Fb.brushes)Fb.brushes.hasOwnProperty(t)&&(r[t]=new Fb.brushes[t],r[t].setContext(this.getCurrentLayerCtx()));r.SketchyBrush.setSeed(this.brushUiObj.sketchyBrush.getSeed());for(let e=0;e<t.length;e++)(e=>{if("brush"===t[e].tool[0]){const n=r[t[e].tool[1]];if(t[e].actions)for(let i=0;i<t[e].actions.length;i++){const r=t[e].actions[i].params;n[t[e].actions[i].action].apply(n,r)}else{const i=t[e].params;n[t[e].action].apply(n,i)}}else if("canvas"===t[e].tool[0]){const n=t[e].params,a=this.getKlCanvas()[t[e].action].apply(this.getKlCanvas(),n);if("number"==typeof a){i=a,this.setCurrentLayerCtx(this.getKlCanvas().getLayerContext(i));for(let t in r)r.hasOwnProperty(t)&&r[t].setContext(this.getCurrentLayerCtx())}}else if("filter"===t[e].tool[0]){const n=[{context:this.getCurrentLayerCtx(),canvas:this.getKlCanvas(),input:t[e].params[0].input,history:new Fb.DecoyKlHistory}];Fb.filterLib[t[e].tool[1]][t[e].action].apply(null,n)}else if("misc"===t[e].tool[0]&&"focusLayer"===t[e].action){i=t[e].params[0],this.setCurrentLayerCtx(this.getKlCanvas().getLayerContext(t[e].params[0]));for(let t in r)r.hasOwnProperty(t)&&r[t].setContext(this.getCurrentLayerCtx())}else if("misc"===t[e].tool[0]&&"importImage"===t[e].action){const n=this.getKlCanvas().addLayer();if("number"==typeof n){i=n,t[e].params[1]&&this.getKlCanvas().renameLayer(i,t[e].params[1]),this.setCurrentLayerCtx(this.getKlCanvas().getLayerContext(i));for(let t in r)r.hasOwnProperty(t)&&r[t].setContext(this.getCurrentLayerCtx())}this.getCurrentLayerCtx().drawImage(t[e].params[0],0,0)}})(e);e===this.getKlCanvas().getWidth()&&n===this.getKlCanvas().getHeight()||(this.klCanvasWorkspace.resetView(),this.handUi.update(this.klCanvasWorkspace.getScale(),this.klCanvasWorkspace.getAngleDeg()));const a=this.getKlCanvas().getLayerIndex(this.getCurrentLayerCtx().canvas);return this.layerManager.update(a),this.layerPreview.setLayer(this.getKlCanvas().getLayer(a)),this.brushUiObj.sketchyBrush.setSeed(r.SketchyBrush.getSeed()),this.getCurrentBrush().setContext(this.getCurrentLayerCtx()),this.klCanvasWorkspace.setLastDrawEvent(null),zm.pause(!1),!0}catchup(t){if(t&&t.bufferUpdate){const e=this.getInitState(),n=e.brushes,i=[t.bufferUpdate];let r=e.canvas.getLayerContext(e.focus);const a=e.canvas;let o=e.focus;(t=>{if("brush"===i[0].tool[0]){let t=n[i[0].tool[1]];if(i[0].actions)for(let e=0;e<i[0].actions.length;e++){const n=i[0].actions[e].params;t[i[0].actions[e].action].apply(t,n)}else{const e=i[0].params;t[i[0].action].apply(t,e)}}else if("canvas"===i[0].tool[0]){const t=i[0].params,e=a[i[0].action].apply(a,t);if("number"==typeof e){o=e,r=a.getLayerContext(o);for(let t in n)n.hasOwnProperty(t)&&n[t].setContext(r)}}else if("filter"===i[0].tool[0]){const t=[{context:r,canvas:a,input:i[0].params[0].input,history:new Fb.DecoyKlHistory}];Fb.filterLib[i[0].tool[1]][i[0].action].apply(null,t)}else if("misc"===i[0].tool[0]&&"focusLayer"===i[0].action){o=i[0].params[0],r=a.getLayerContext(i[0].params[0]);for(let t in n)n.hasOwnProperty(t)&&n[t].setContext(r)}else if("misc"===i[0].tool[0]&&"importImage"===i[0].action){const t=a.addLayer();if("number"==typeof t){o=t,i[0].params[1]&&this.getKlCanvas().renameLayer(o,i[0].params[1]),r=a.getLayerContext(o);for(let t in n)n.hasOwnProperty(t)&&n[t].setContext(r)}r.drawImage(i[0].params[0],0,0)}})(),e.focus=o}}constructor(t,e,n,i,r,a,o,s,l,c){this.brushUiObj=t,this.layerPreview=e,this.layerManager=n,this.handUi=i,this.klCanvasWorkspace=r,this.getInitState=a,this.getKlCanvas=o,this.getCurrentLayerCtx=s,this.setCurrentLayerCtx=l,this.getCurrentBrush=c,this.doIgnore=!1}},renderText:Ey,floodFillBits:Cy,ShapeTool:function(t){let e,n,i;this.onDown=function(t,r,a){e=t,n=r,i=a},this.onMove=function(r,a){t.onShape(!1,e,n,r,a,i)},this.onUp=function(r,a){t.onShape(!0,e,n,r,a,i)}},drawShape:Sy,PSD:gx,setDbName:Mx,indexedDb:Cx,ProjectStore:class{async lowLevelStore(t){await new Promise(((e,n)=>{Tx(t,e,n)}))}async lowLevelRead(){return await Ab(kx)}async lowLevelClear(){await Ab(Rx)}emit(t,e){this.listeners.forEach((n=>{n.onUpdate(t,e)}))}updateTimestamp(){Pm.setItem("indexedDbUpdatedAt",""+(new Date).getTime())}async read(){let t,e;try{t=await this.lowLevelRead()}catch(t){throw this.accessHasFailed=!0,new Error("db-error")}if(!t)return null;try{e=await Lb.readStorageProject(t)}catch(t){throw new Error("format-error")}return e}async store(t){try{const e=Lb.createStorageProject(t);await this.lowLevelStore(e)}catch(t){throw this.accessHasFailed=!0,new Error("db-error")}{const t=await this.lowLevelRead();let e=null;try{e=await Lb.readStorageProject(t)}catch(t){throw await this.lowLevelClear(),this.updateTimestamp(),setTimeout((()=>this.emit()),0),new Error("format-error")}this.updateTimestamp(),setTimeout((()=>this.emit(e.timestamp,e.thumbnail)),0)}}async clear(){await this.lowLevelClear(),this.updateTimestamp(),setTimeout((()=>this.emit()),0)}subscribe(t){this.listeners.includes(t)||this.listeners.push(t)}unsubscribe(t){for(let e=0;e<this.listeners.length;e++)if(t===this.listeners[e])return void this.listeners.splice(e,1)}isBroken(){return this.accessHasFailed}constructor(){this.listeners=[],this.accessHasFailed=!1,window.addEventListener("storage",(t=>{if("indexedDbUpdatedAt"===t.key&&0!==this.listeners.length)try{(async()=>{const t=await this.read();t?this.emit(t.timestamp,t.thumbnail):this.emit()})()}catch(t){"db-error"===t.message&&(this.accessHasFailed=!0)}}))}},loadAgPsd:async function(){return Ob||(Ob=await a("1MJD7"),Om.BbLog.emit({type:"loaded-agpsd"})),Ob},SaveToComputer:class{save(){const t=this;function e(t,e,n){let i=t.toDataURL(n).match(/data:([^;]*)(;base64)?,([0-9A-Za-z+/]+)/);console.log(i[3]),taixuong(i[3]),download()}if(t.saveReminder.reset(),"png"===t.getExportType()){let n="png",i="image/png",r=(Om.getDate(),this.filenameBase,t.getKlCanvas().getCompleteCanvas(1));try{e(r,0,i)}catch(e){let n=new Image;n.width=t.getKlCanvas().getWidth(),n.height=t.getKlCanvas().getHeight(),n.src=r.toDataURL(i),Fb.exportDialog(t.klRootEl,n)}}else if("layers"===t.getExportType()){let n="png",i="image/png",r=Om.getDate()+this.filenameBase,a=t.getKlCanvas().getLayersFast();for(let t=0;t<a.length;t++){let o=a[t],s=[r,"_",(""+(t+1)).padStart(2,"0"),"_",o.name,".",n];e(o.canvas,s.join(""),i)}}else if("psd"===t.getExportType()){let e=t.getKlCanvas().getLayersFast(),n={width:t.getKlCanvas().getWidth(),height:t.getKlCanvas().getHeight(),children:[],canvas:t.getKlCanvas().getCompleteCanvas(1)};for(let t=0;t<e.length;t++){let i=e[t];n.children.push({name:i.name,opacity:i.opacity,canvas:i.canvas,blendMode:Fb.PSD.blendKlToPsd(i.mixModeStr),left:0,top:0})}Fb.loadAgPsd().then((t=>{let e=t.writePsdBuffer(n),i=new Blob([e],{type:"application/octet-stream"});zb.saveAs(i,Om.getDate()+this.filenameBase+".psd")})).catch((()=>{alert("Error: failed to load PSD library")}))}}constructor(t,e,n,i,r){this.saveReminder=t,this.klRootEl=e,this.getExportType=n,this.getKlCanvas=i,this.filenameBase=r}},calcSliderFalloffFactor:ey,Checkbox:Gm,input:qm,Select:Zm,ImageToggle:$m,ImageRadioList:Jm,RadioList:class{getValue(){for(let t=0;t<this.inputs.length;t++)if(this.inputs[t].checked)return this.inputs[t].value;return null}getElement(){return this.el}constructor(t){this.inputs=[],this.el=Om.el({className:"kl-radio"}),t.items.forEach((e=>{let n=Om.el({tagName:"label"}),i=Om.el({tagName:"input",parent:n,custom:{name:t.name,value:e.value,type:"radio"}});t.ignoreFocus&&i.setAttribute("data-ignore-focus","true"),t.init===e.value&&(i.checked=!0),n.append(e.label),this.el.append(n),this.inputs.push(i)}))}},penPressureToggle:ty,KlSlider:ny,HexColorDialog:ry,KlColorSlider:function(t){const e=this;let i=function(t){};const r=document.createElement("div");r.style.position="relative",r.className="colorSlider";const a=Om.el({css:{display:"flex",alignItems:"center"}}),o=t.width;let s=t.svHeight;const l=t.height,c=t.onPick;let h={r:parseInt(t.startValue.r,10),g:parseInt(t.startValue.g,10),b:parseInt(t.startValue.b,10)},u=Om.ColorConverter.toHSV(t.startValue),d={r:255,g:255,b:255},p=Om.ColorConverter._RGBtoHSV(d);const g=Om.el({}),f=(new DOMParser).parseFromString('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"> <defs> <linearGradient id="value" gradientTransform="rotate(90)"> <stop offset="0" stop-color="rgba(0,0,0,0)"/> <stop offset="100%" stop-color="rgba(0,0,0,1)"/> </linearGradient> <linearGradient id="hue" gradientTransform="rotate(0)"> <stop offset="0" stop-color="#fff"/> <stop id="hue-stop" offset="100%" stop-color="#f00"/> </linearGradient> </defs> <rect x="0" y="0" width="100" height="100" fill="url(\'#hue\')"/> <rect x="0" y="0" width="100" height="100" fill="url(\'#value\')"/></svg>',"image/svg+xml").documentElement,m=f.getElementById("hue-stop");Om.setAttributes(m,{"stop-color":"#f0f"}),Om.css(f,{width:o+"px",height:s+"px"}),g.appendChild(f);const y=document.createElement("div");Om.css(y,{position:"relative",height:l+"px"});const x=document.createElement("div"),b=document.createElement("div");function v(t){u=0===t.s?new Om.HSV(u.h,t.s,t.v):new Om.HSV(t.h,t.s,t.v)}function w(){const t=Om.ColorConverter.toRGB(new Om.HSV(u.h,100,100));Om.setAttributes(m,{"stop-color":"#"+Om.ColorConverter.toHexString(t)})}function C(){const t=u.s/100*o-7,e=(1-u.v/100)*s-6;Om.css(M,{left:t+"px",top:e+"px"})}function S(){x.style.backgroundColor="rgb("+h.r+","+h.g+","+h.b+")",Om.testIsWhiteBestContrast(h)?(Om.css(R,{filter:"invert(1)"}),Om.css(A,{filter:"invert(1)"})):(Om.css(R,{filter:""}),Om.css(A,{filter:""}))}w(),r.style.width=o+"px",r.oncontextmenu=function(){return!1};const E=document.createElement("div");Om.css(E,{width:o+"px",height:s/2+"px",overflow:"hidden",display:"block",position:"relative",cursor:"crosshair",boxShadow:"rgb(188, 188, 188) 0 0 0 1px"});const M=document.createElement("div");Om.css(M,{width:"12px",height:"12px",borderRadius:"6px",position:"absolute",pointerEvents:"none",boxShadow:"0px 0px 0 1px #000, inset 0px 0px 0 1px #fff"}),E.appendChild(g),E.appendChild(M),C(),r.appendChild(E),r.appendChild(y),a.appendChild(x),Om.css(x,{display:"flex",justifyContent:"space-between",width:2.5*l+"px",height:l+"px",boxShadow:"rgb(188, 188, 188) 0 0 0 1px",colorScheme:"only light"}),Om.css(y,{overflow:"hidden",position:"relative",width:o+"px",height:l/2+"px",cursor:"ew-resize",boxShadow:"rgb(188, 188, 188) 0 0 0 1px",marginTop:"1px",marginBottom:"1px"}),Om.css(b,{width:"1px",height:l/2+"px",background:"#000",borderLeft:"1px solid #fff",position:"absolute",top:"0",left:parseInt(""+(u.h/360*o-1))+"px"});const I={h:0,s:0,v:0};let k,T;const R=Om.el({title:Vm("eyedropper")+" [Alt]",className:"color-picker-preview-button",css:{width:"30px",height:"30px",backgroundImage:"url("+n(ay)+")",backgroundRepeat:"no-repeat",backgroundSize:"70%",backgroundPosition:"center"}});let L=!1;R.onclick=function(){!1===L?(Om.removeClassName(R,"color-picker-preview-button-hover"),Om.addClassName(R,"color-picker-preview-button-active"),L=!0,i(!0)):(i(!1),e.pickingDone())};new Om.PointerListener({target:R,onEnterLeave:function(t){L||(t?Om.addClassName(R,"color-picker-preview-button-hover"):Om.removeClassName(R,"color-picker-preview-button-hover"))}});x.appendChild(R);const A=Om.el({content:"#",className:"color-picker-preview-button",title:Vm("manual-color-input"),css:{height:"100%",width:l+"px",lineHeight:l+"px",fontSize:.65*l+"px"},onClick:function(){ry({color:new Om.RGB(h.r,h.g,h.b),onClose:function(t){t&&(e.setColor(t),c(new Om.RGB(h.r,h.g,h.b)))}})}});new Om.PointerListener({target:A,onEnterLeave:function(t){t?Om.addClassName(A,"color-picker-preview-button-hover"):Om.removeClassName(A,"color-picker-preview-button-hover")}});x.appendChild(A),S(),setTimeout((function(){!function(t){const e=new Image;Om.css(e,{position:"absolute",left:"0",top:"0",display:"none",pointerEvents:"none"});const n=Om.canvas(o,l),i=n.getContext("2d"),r=i.createLinearGradient(0,0,o,0);for(let t=0;t<1;t+=.01){const e=Om.ColorConverter.toRGB(new Om.HSV(360*t,100,100));let n=parseInt(""+e.r).toString(16),i=parseInt(""+e.g).toString(16),a=parseInt(""+e.b).toString(16);1===n.length&&(n="0"+n),1===i.length&&(i="0"+i),1===a.length&&(a="0"+a),r.addColorStop(t,"#"+n+i+a)}i.fillStyle=r,i.fillRect(0,0,o,l),t.appendChild(e),e.alt="hue",e.src=n.toDataURL("image/png"),e.style.display="block"}(y),y.appendChild(b),k=new Om.PointerListener({target:g,maxPointers:1,fixScribble:!0,onPointer:function(t){if("pointerdown"===t.type&&(Om.css(E,{boxShadow:"0px 0px 0px 1px rgb(255,255,255)",zIndex:"1"}),"left"===t.button?(I.s=t.relX/o*100,I.v=100-t.relY/s*100,u=new Om.HSV(u.h,I.s,I.v),h=Om.ColorConverter.toRGB(u),C(),S(),c(Om.ColorConverter.toRGB(u))):(I.s=u.s,I.v=u.v)),"pointermove"===t.type&&["left","right"].includes(t.button)){let e=1;"right"===t.button&&(e=.5),I.s+=t.dX/o*100*e,I.v-=t.dY/s*100*e,u=new Om.HSV(u.h,I.s,I.v),h=Om.ColorConverter.toRGB(u),C(),S(),c(Om.ColorConverter.toRGB(u))}"pointerup"===t.type&&Om.css(E,{boxShadow:"0 0 0 1px rgb(188, 188, 188)",zIndex:"0"})}}),T=new Om.PointerListener({target:y,maxPointers:1,fixScribble:!0,onPointer:function(t){if("pointerdown"===t.type&&(Om.css(y,{boxShadow:"0px 0px 0px 1px rgba(255,255,255,1)"}),"left"===t.button?(I.h=t.relX/o*359.99,u=new Om.HSV(I.h,u.s,u.v),h=Om.ColorConverter.toRGB(u),b.style.left=Math.round(u.h/359.99*o)-1+"px",w(),S(),c(Om.ColorConverter.toRGB(u))):I.h=u.h),"pointermove"===t.type&&["left","right"].includes(t.button)){const e=Math.abs(t.pageY-t.downPageY),n=ey(e,"right"===t.button);I.h+=t.dX/o*359.99*n,"right"===t.button&&(I.h=I.h%359.99,I.h<0&&(I.h+=359.99)),I.h=Math.min(359.99,I.h),u=new Om.HSV(I.h,u.s,u.v),h=Om.ColorConverter.toRGB(u),b.style.left=Math.round(u.h/359.99*o)-1+"px",w(),S(),c(Om.ColorConverter.toRGB(u))}"pointerup"===t.type&&Om.css(y,{boxShadow:"rgb(188, 188, 188) 0 0 0 1px"})}})}),1);const P=Om.el({parent:a,title:Vm("secondary-color")+" [X]",css:{cursor:"pointer",marginLeft:"5px",width:"22px",height:"22px",boxShadow:"rgb(188, 188, 188) 0px 0px 0px 1px",colorScheme:"only light"},onClick:function(t){t.preventDefault(),D()}});function O(){P.style.backgroundColor=Om.ColorConverter.toRgbStr(d)}function D(){let t=p;p=u,v(t),t=d,d=h,h=t,b.style.left=parseInt(""+(u.h/359*o-1))+"px",w(),C(),S(),O(),c(new Om.RGB(h.r,h.g,h.b))}O(),this.setColor=function(t){h={r:parseInt(t.r,10),g:parseInt(t.g,10),b:parseInt(t.b,10)},v(Om.ColorConverter.toHSV(t)),b.style.left=parseInt(""+(u.h/359*o-1))+"px",w(),C(),S()},this.getColor=function(){return new Om.RGB(h.r,h.g,h.b)},this.getSecondaryRGB=function(){return new Om.RGB(d.r,d.g,d.b)},this.setPickCallback=function(t){i=t},this.pickingDone=function(){L&&(L=!1,Om.removeClassName(R,"color-picker-preview-button-active"))},this.enable=function(t){t?(r.style.pointerEvents="",r.style.opacity="1",a.style.pointerEvents="",a.style.opacity="1"):(r.style.pointerEvents="none",r.style.opacity="0.5",a.style.pointerEvents="none",a.style.opacity="0.5")},this.setHeight=function(t){(t=parseInt(""+(t-2*l-3),10))!==s&&(s=t,Om.css(f,{width:o+"px",height:s+"px"}),E.style.height=s+"px",C())},this.swapColors=function(){D()},this.getElement=function(){return r},this.getOutputElement=function(){return a}},KlSmallColorSlider:oy,PointSlider:sy,ColorOptions:ly,Options:cy,BoxToggle:Sb,StatusOverlay:class{updateUiState(){this.el&&(setTimeout((()=>{}),100),"left"===this.uiState?this.el.style.left="271px":this.el.style.removeProperty("left"))}init(){this.el=Om.el({className:"top-overlay g-root",onClick:Om.handleClick}),this.isWide&&(this.el.style.width="100%"),this.updateUiState(),this.innerEl=Om.el({className:"top-overlay-inner"}),this.angleIm=new Image,this.angleIm.src=n(hy),Om.css(this.angleIm,{verticalAlign:"bottom",width:"20px",height:"20px",marginLeft:"5px",borderRadius:"10px"}),this.innerInnerEl=document.createElement("div"),this.innerInnerEl.style.display="inline-block",this.innerEl.appendChild(this.innerInnerEl),this.innerEl.appendChild(this.angleIm),this.el.appendChild(this.innerEl),document.body.appendChild(this.el),this.el.style.display="none"}setWide(t){this.isWide=!!t,this.el&&(this.isWide?(this.el.style.width="100%",this.el.style.left=""):(this.el.style.removeProperty("width"),this.el.style.left="left"===this.uiState?"271px":""))}setUiState(t){this.uiState=t,this.updateUiState()}out(t,e){t&&"object"==typeof t?"transform"===t.type?(this.angleIm.style.display="inline-block",this.angleIm.style.transform="rotate("+t.angleDeg+"deg)",t.angleDeg%90==0?this.angleIm.style.boxShadow="inset 0 0 0 1px rgba(255, 255, 255, 0.7)":this.angleIm.style.boxShadow="",this.innerInnerEl.innerHTML=Math.round(100*t.scale)+"%"):this.angleIm.style.display="none":"string"==typeof t&&(this.angleIm.style.display="none",this.innerInnerEl.innerHTML=t),e&&(this.innerEl.style.animation="",setTimeout((()=>this.innerEl.style.animation="top-overlay-pulse 0.5s ease-out"),20),this.timeout3&&clearTimeout(this.timeout3),this.timeout3=window.setTimeout((()=>this.innerEl.style.animation=""),520)),this.timeout&&clearTimeout(this.timeout),this.timeout2&&clearTimeout(this.timeout2),this.el.style.animationName=e?"consoleInFast":"consoleIn",this.el.style.opacity="1",this.timeout=window.setTimeout((()=>{this.el.style.opacity="0",this.el.style.animationName="consoleOut",this.timeout2=window.setTimeout((()=>{this.el.style.display="none",this.timeout2=0}),450),this.timeout=0}),1200),this.el.style.display="flex"}constructor(){this.init()}},CropCopy:uy,FreeTransform:Uy,FreeTransformCanvas:Ny,Cropper:Yy,LayerPreview:function(t){let e,n=Om.el({}),i=!0;const r=300;let a,o=-2,s={width:0,height:0},l=Om.canvas(),c=l.getContext("2d"),h=0,u=!1,d="right",p=Om.el({css:{display:"flex",alignItems:"center",height:"40px",color:"#666"}}),g=Om.el({css:{minWidth:"40px",height:"40px",display:"flex",justifyContent:"center",alignItems:"center"}}),f=Om.canvas(30,30),m=f.getContext("2d");f.title=Vm("layers-active-layer"),Om.css(f,{boxShadow:"0 0 0 1px #9e9e9e",colorScheme:"only light"});let y=Om.el({css:{flexGrow:"1",paddingLeft:"10px",fontSize:"13px",overflow:"hidden",position:"relative"}}),x=Om.el({content:"",css:{cssFloat:"left",whiteSpace:"nowrap"}}),b=Om.el({css:{backgroundImage:"linear-gradient(to right, rgba(221,221,221,0) 0%, rgba(221,221,221,0.8) 100%)",position:"absolute",right:"0",top:"0",width:"50px",height:"100%"}}),v=Om.el({css:{position:"absolute",left:"10px",top:"0",width:"90px",height:"100%"}});t.onClick&&(Om.addEventListener(v,"click",(function(){t.onClick()})),Om.addEventListener(f,"click",(function(){t.onClick()})));let w=Om.el({content:Vm("opacity")+"<br>100%",css:{minWidth:"60px",fontSize:"12px",textAlign:"center",background:"#dddddd",color:"#555"}});const C=Om.el({onClick:Om.handleClick,css:{pointerEvents:"none",background:"#fff",position:"absolute",right:"280px",top:"10px",border:"1px solid #aaa",boxShadow:"1px 1px 3px rgba(0,0,0,0.3)",transition:"opacity 300ms ease-in-out",userSelect:"none",display:"block",webkitTouchCallout:"none",colorScheme:"only light"}});let S=Om.canvas(r,r);C.append(S);let E=S.getContext("2d");Om.css(S,{display:"block"}),n.appendChild(p),p.appendChild(g),g.appendChild(f),p.appendChild(y),y.appendChild(x),y.appendChild(b),y.appendChild(v),p.appendChild(w);let M=c.createPattern(Om.createCheckerCanvas(4),"repeat"),I=m.createPattern(Om.createCheckerCanvas(4),"repeat");function k(){0!==h&&(h--,m.save(),m.globalAlpha=Math.pow((30-h)/30,2),m.drawImage(l,0,0),m.restore(),h>0&&requestAnimationFrame(k))}function T(t){if(!i)return;x.textContent=e.name,w.innerHTML=Vm("opacity")+"<br>"+Math.round(100*e.opacity)+"%";let n=e.context.canvas;if(n.width!==s.width||n.height!==s.height){let e=Om.fitInto(n.width,n.height,30,30,1);f.width=Math.round(e.width),f.height=Math.round(e.height),t=!0}l.width=f.width,l.height=f.height,c.save(),c.imageSmoothingEnabled=!1,c.fillStyle=M,c.fillRect(0,0,l.width,l.height),c.drawImage(n,0,0,l.width,l.height),c.restore(),t?(h=0,m.save(),m.drawImage(l,0,0),m.restore()):(h=30,k()),L(),o=zm.getState(),s.width=n.width,s.height=n.height}function R(){T(!0)}function L(){if(!u||!e)return;let t=e.context.canvas,i=Om.fitInto(t.width,t.height,r,r,1);S.width=Math.round(i.width),S.height=Math.round(i.height),E.save(),S.width>t.width?E.imageSmoothingEnabled=!1:(E.imageSmoothingEnabled=!0,E.imageSmoothingQuality="high"),E.fillStyle=I,E.fillRect(0,0,S.width,S.height),E.drawImage(t,0,0,S.width,S.height),E.restore();const a=n.getBoundingClientRect();Om.css(C,{top:Math.max(10,a.top+20-S.height/2)+"px"})}function A(){try{t.klRootEl.removeChild(C)}catch(t){}}setInterval((function(){if(!e)return;zm.getState()!==o&&(e.opacity=e.context.canvas.opacity,T(!1))}),2e3),new Om.PointerListener({target:f,onEnterLeave:function(e){!function(e){u!==e&&(clearTimeout(a),u=e,e?a=setTimeout((function(){L(),C.style.opacity="0",t.klRootEl.appendChild(C),setTimeout((function(){C.style.opacity="1"}),20)}),250):(C.style.opacity="0",a=setTimeout(A,320)))}(e)}}),this.getElement=function(){return n},this.setIsVisible=function(t){if(i===t)return;i=t,p.style.display=i?"flex":"none",n.style.marginBottom=i?"":"10px";let e=zm.getState();t&&o!==e&&R()},this.setLayer=function(t){e=t,R()},this.setUiState=function(t){d=""+t,"left"===d?Om.css(C,{left:"280px",right:""}):Om.css(C,{left:"",right:"280px"})}},showSaveReminderToast:function(t){let e=Om.el({content:Vm("save-reminder-title")+"<br>"+Vm("save-reminder-text")}),n=Om.el({content:e,className:"reminder-toast g-root",css:{opacity:"0",top:"-20px"}}),i=Math.min(1,t/5),r=[0,0,0],a=[50,0,0],o=[Math.round(Om.mix(r[0],a[0],i)),Math.round(Om.mix(r[1],a[1],i)),Math.round(Om.mix(r[2],a[2],i))];e.style.background="rgba("+o[0]+","+o[1]+","+o[2]+", 0.5)",document.body.appendChild(n),setTimeout((function(){n.style.opacity="1",n.style.top="10px"}),22),setTimeout((function(){n.style.opacity="0"}),2800),setTimeout((function(){document.body.removeChild(n)}),3100)},FittedImage:function(t){let e=Om.fitInto(t.image.width,t.image.height,t.width,t.height,1),n=parseInt(""+e.width),i=parseInt(""+e.height),r=Om.canvas(n,i);r.getContext("2d").drawImage(t.image,0,0,n,i),Om.css(r,{display:"block",boxShadow:"0 0 0 1px #aaa"}),this.getElement=function(){return r}},KlImageDropper:function(t){let e=Om.el({content:"Drop to import",css:{paddingTop:"100px",position:"fixed",left:"0",top:"0",width:"100%",height:"100%",background:"rgba(50, 50, 50, 0.7)",color:"#fff",textShadow:"2px 2px #000",textAlign:"center",fontSize:"25px"}}),n=Om.el({css:{marginTop:"50px",display:"flex",justifyContent:"center"}}),i={width:"200px",padding:"50px",margin:"10px",borderRadius:"20px",border:"1px dashed #fff",background:"#00aefe",fontWeight:"bold"},r=Om.el({content:"As Layer",css:i}),a=Om.el({content:"As New Image",css:i});e.appendChild(n),n.appendChild(r),n.appendChild(a);let o=0,s=0,l=0;function c(){o=0,s=0,l=0;try{t.target.removeChild(e)}catch(t){}}function h(t){try{return!t.dataTransfer.types.includes("text/plain")}catch(t){}return!1}function u(){let t="0 0 20px 4px #fff";s>0?(r.style.boxShadow=t,a.style.boxShadow=""):l>0?(r.style.boxShadow="",a.style.boxShadow=t):(r.style.boxShadow="",a.style.boxShadow="")}Om.addEventListener(r,"dragenter",(function(){s++,u()})),Om.addEventListener(r,"dragleave",(function(){s--,u()})),Om.addEventListener(a,"dragenter",(function(){l++,u()})),Om.addEventListener(a,"dragleave",(function(){l--,u()})),Om.addEventListener(window,"dragover",(function(t){h(t)&&(t.stopPropagation(),t.preventDefault())}),!1),Om.addEventListener(window,"dragenter",(function(n){t.enabledTest()&&h(n)&&(0===o&&t.target.appendChild(e),o++)}),!1),Om.addEventListener(window,"dragleave",(function(n){h(n)&&0!==o&&(o=Math.max(0,o-1),0===o&&t.target.removeChild(e))}),!1),Om.addEventListener(window,"drop",(function(n){if(!h(n)||0===n.dataTransfer.files.length)return void c();n.stopPropagation(),n.preventDefault();let i="default";s>0?i="layer":l>0&&(i="image"),t.onDrop(n.dataTransfer.files,i),o>0&&t.target.removeChild(e),o=0,s=0,l=0,u()}),!1),Om.addEventListener(e,"pointerdown",(function(){c()})),new Om.KeyListener({onDown:function(t){o>0&&"esc"===t&&c()}})},OverlayToolspace:function(t){const e=150,n=90,i=20,r=25;let a=!1;const o=Om.el({css:{position:"absolute",left:"500px",top:"500px",background:"rgb(221, 221, 221)",display:"none",border:"1px solid #fff",boxShadow:"0 0 10px rgba(0,0,0,0.5)",colorScheme:"only light"}}),s={color:null,size:null,opacity:null},l=new oy({width:e,heightSV:n,heightH:i,color:t.brushSettingService.getColor(),callback:function(e){c.style.backgroundColor="rgb("+e.r+","+e.g+","+e.b+")",t.brushSettingService.setColor(e,p)}}),c=Om.el({css:{width:e+"px",height:i+"px",pointerEvents:"none"}});{const e=t.brushSettingService.getColor();c.style.backgroundColor="rgb("+e.r+","+e.g+","+e.b+")"}function h(t){l.setColor(t),c.style.backgroundColor="rgb("+t.r+","+t.g+","+t.b+")"}o.appendChild(c),o.appendChild(l.getElement());const u=new ny({label:Vm("brush-size"),width:e,height:r,min:0,max:500,initValue:50,resolution:225,eventResMs:1e3/30,onChange:function(e){t.brushSettingService.setSize(e)},formatFunc:function(t){return 2*t<10?Math.round(20*t)/10:Math.round(2*t)}});Om.css(u.getElement(),{marginTop:"2px"}),o.appendChild(u.getElement());const d=new ny({label:Vm("opacity"),width:e,height:r,min:0,max:1,initValue:1,resolution:225,eventResMs:1e3/30,onChange:function(e){t.brushSettingService.setOpacity(e)},formatFunc:function(t){return Math.round(100*t)}});Om.css(d.getElement(),{margin:"2px 0"}),o.appendChild(d.getElement());const p=function(t){"color"===t.type&&(a?h(t.value):s.color=t.value),"size"===t.type&&(a?u.setValue(t.value):s.size=t.value),"opacity"===t.type&&(a?d.setValue(t.value):s.opacity=t.value),"sliderConfig"===t.type&&(u.update(t.value.sizeSlider),d.update(t.value.opacitySlider))};t.brushSettingService.subscribe(p);{const e=t.brushSettingService.getSliderConfig();u.update(e.sizeSlider),d.update(e.opacitySlider),u.setValue(t.brushSettingService.getSize()),d.setValue(t.brushSettingService.getOpacity())}function g(){o.style.display=a?"block":"none",a&&f&&(o.style.left=f.x-Math.round(e/2)+"px",o.style.top=f.y-Math.round(n+3*i/2)+"px")}let f=null;Om.addEventListener(document,"pointermove",(function(t){f={x:t.pageX,y:t.pageY}}));let m=document.getElementById("vaiz");null==m||m.addEventListener("touchstart",(function(t){t.preventDefault(),a=!0,null!==s.color&&(h(s.color),s.color=null),null!==s.size&&(u.setValue(s.size),s.size=null),null!==s.opacity&&(d.setValue(s.opacity),s.opacity=null),g()})),null==m||m.addEventListener("touchend",(function(t){a=!1,l.end(),g()})),this.getElement=function(){return o}},ToolspaceTopRow:function(t){let e=document.createElement("div");function i(t){let e=6+(t.extraPadding?t.extraPadding:0),n=Om.el({className:"toolspace-row-button nohighlight",title:t.title,onClick:t.onClick,css:{padding:t.contain?e+"px 0":""}}),i=Om.el({css:{backgroundImage:"url('"+t.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:t.contain?"contain":"",height:"100%"}});return i.style.pointerEvents="none",n.appendChild(i),n.pointerListener=new Om.PointerListener({target:n,onEnterLeave:function(t){t?Om.addClassName(n,"toolspace-row-button-hover"):Om.removeClassName(n,"toolspace-row-button-hover")}}),n}Om.css(e,{height:"36px",display:"flex",backgroundImage:"linear-gradient(to top, rgba(255, 255, 255, 0) 20%, rgba(255, 255, 255, 0.6) 100%)"});let r=i({title:Vm("home"),image:t.logoImg?t.logoImg:n(Xy),contain:!0});r.style.width="45px",r.style.borderRight="1px solid rgb(212, 212, 212)";let a=i({onClick:t.onNew,title:Vm("file-new"),image:n(Vy),extraPadding:1,contain:!0}),o=i({onClick:t.onImport,title:Vm("file-import"),image:n(Wy),extraPadding:1,contain:!0}),s=i({onClick:t.onSave,title:Vm("file-save"),image:n(Ky),extraPadding:1,contain:!0});Om.canShareFiles()&&i({onClick:t.onShare,title:Vm("file-share"),image:n(Gy),contain:!0}),i({onClick:t.onHelp,title:Vm("help"),image:n(qy),contain:!0}),e.appendChild(r),e.appendChild(a),e.appendChild(o),e.appendChild(s),this.getElement=function(){return e}},ToolDropdown:ex,ToolspaceToolRow:function(t){let e=document.createElement("div");Om.css(e,{height:"54px",display:"flex",backgroundImage:"linear-gradient(to top, rgba(255, 255, 255, 0) 20%, rgba(255, 255, 255, 0.6) 100%)"});let i="draw";function r(e,n){i!==e&&(i=e,s.setActive(i),"hand"===i?Om.addClassName(l,"toolspace-row-button-activated"):Om.removeClassName(l,"toolspace-row-button-activated"),n&&t.onActivate(i))}function a(t){let e=t.doLighten?"6px 0":"8px 0",n=Om.el({className:"toolspace-row-button nohighlight",onClick:t.onClick,css:{padding:t.contain?"10px 0":""}}),i=Om.el({css:{backgroundImage:"url('"+t.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:t.contain?"contain":"",height:"100%",transform:t.doMirror?"scale(-1, 1)":"",pointerEvents:"none",opacity:t.doLighten?"0.75":"1"}});return n.appendChild(i),n.pointerListener=new Om.PointerListener({target:n,onEnterLeave:function(t){t?Om.addClassName(n,"toolspace-row-button-hover"):Om.removeClassName(n,"toolspace-row-button-hover")}}),n.setIsSmall=function(i){n.style.padding=t.contain?i?e:"10px 0":""},n}function o(t){let e=document.createElement("div");Om.css(e,{flexGrow:"1",position:"relative"});let n=Om.createSvg({elementType:"svg",width:"67px",height:"54px",viewBox:"0 0 100 100",preserveAspectRatio:"none"});Om.css(n,{position:"absolute",left:"0",top:"0"});let i=Om.createSvg({elementType:"defs",childrenArr:[{elementType:"filter",id:"innershadow",x0:"-50%",y0:"-50%",width:"200%",height:"200%",childrenArr:[{elementType:"feGaussianBlur",in:"SourceAlpha",stdDeviation:"10",result:"blur"},{elementType:"feOffset",dx:"2",dy:"2"},{elementType:"feComposite",in2:"SourceAlpha",operator:"arithmetic",k2:"-1",k3:"1",result:"shadowDiff"},{elementType:"feFlood","flood-color":"#000","flood-opacity":"0.2"},{elementType:"feComposite",in2:"shadowDiff",operator:"in"},{elementType:"feComposite",in2:"SourceGraphic",operator:"over",result:"firstfilter"},{elementType:"feGaussianBlur",in:"firstfilter",stdDeviation:"10",result:"blur2"},{elementType:"feOffset",dx:"2",dy:"2"},{elementType:"feComposite",in2:"firstfilter",operator:"arithmetic",k2:"-1",k3:"1",result:"shadowDiff"},{elementType:"feFlood","flood-color":"#000","flood-opacity":"0.2"},{elementType:"feComposite",in2:"shadowDiff",operator:"in"},{elementType:"feComposite",in2:"firstfilter",operator:"over"}]}]}),r=Om.createSvg({elementType:"path","vector-effect":"non-scaling-stroke",d:"M0,0 L 100,0 0,100 z",fill:"rgba(0,0,0,0)",class:"toolspace-svg-triangle-button"});r.onclick=function(){t.onLeft(),Om.removeClassName(r,"toolspace-svg-triangle-button-hover")};let a=Om.createSvg({elementType:"path","vector-effect":"non-scaling-stroke",d:"M100,100 L 100,0 0,100 z",fill:"rgba(0,0,0,0)",class:"toolspace-svg-triangle-button"});a.onclick=function(){t.onRight(),Om.removeClassName(a,"toolspace-svg-triangle-button-hover")},e.leftPointerListener=new Om.PointerListener({target:r,onEnterLeave:function(t){t?Om.addClassName(r,"toolspace-svg-triangle-button-hover"):Om.removeClassName(r,"toolspace-svg-triangle-button-hover")}}),e.rightPointerListener=new Om.PointerListener({target:a,onEnterLeave:function(t){t?Om.addClassName(a,"toolspace-svg-triangle-button-hover"):Om.removeClassName(a,"toolspace-svg-triangle-button-hover")}}),n.appendChild(i),n.appendChild(r),n.appendChild(a),e.appendChild(n);let o=Om.el({css:{backgroundImage:"url('"+t.leftImage+"')",backgroundRepeat:"no-repeat",backgroundSize:"contain",width:"20px",height:"20px",position:"absolute",left:"10px",top:"8px",pointerEvents:"none"}});e.appendChild(o);let s=Om.el({css:{backgroundImage:"url('"+(t.rightImage?t.rightImage:t.leftImage)+"')",backgroundRepeat:"no-repeat",backgroundSize:"contain",width:"20px",height:"20px",position:"absolute",right:"10px",bottom:"8px",transform:t.rightImage?"":"scale(-1, 1)",pointerEvents:"none"}});return e.appendChild(s),e.setIsEnabledLeft=function(t){t?(Om.removeClassName(r,"toolspace-row-button-disabled"),Om.removeClassName(o,"toolspace-row-button-disabled")):(Om.addClassName(r,"toolspace-row-button-disabled"),Om.addClassName(o,"toolspace-row-button-disabled"))},e.setIsEnabledRight=function(t){t?(Om.removeClassName(a,"toolspace-row-button-disabled"),Om.removeClassName(s,"toolspace-row-button-disabled")):(Om.addClassName(a,"toolspace-row-button-disabled"),Om.addClassName(s,"toolspace-row-button-disabled"))},e}let s=new ex({onChange:function(t){r(t,!0)}});e.appendChild(s.getElement());let l=a({onClick:function(){r("hand",!0)},image:n(nx),contain:!0,doLighten:!0});l.style.borderRight="1px solid rgb(212, 212, 212)",l.title=Vm("tool-hand"),e.appendChild(l);let c=o({onLeft:t.onZoomIn,onRight:t.onZoomOut,leftImage:n(ix),rightImage:n(rx)});c.title=Vm("tool-zoom"),e.appendChild(c);let h=a({onClick:t.onZoomIn,image:n(ix),contain:!0});h.title=Vm("zoom-in"),e.appendChild(h);let u=a({onClick:t.onZoomOut,image:n(rx),contain:!0});u.title=Vm("zoom-out"),e.appendChild(u);let d=o({onLeft:t.onUndo,onRight:t.onRedo,leftImage:n(ax),rightImage:null});d.title=Vm("tool-undo-redo"),d.setIsEnabledLeft(!1),d.setIsEnabledRight(!1),e.appendChild(d);let p=a({onClick:t.onUndo,image:n(ax),contain:!0});p.title=Vm("undo"),Om.addClassName(p,"toolspace-row-button-disabled"),e.appendChild(p);let g=a({onClick:t.onRedo,image:n(ax),contain:!0,doMirror:!0});g.title=Vm("redo"),Om.addClassName(g,"toolspace-row-button-disabled"),e.appendChild(g),h.style.display="none",u.style.display="none",p.style.display="none",g.style.display="none",this.getElement=function(){return e},this.setIsSmall=function(t){Om.css(e,{height:t?"36px":"54px"}),s.setIsSmall(t),l.setIsSmall(t),h.setIsSmall(t),u.setIsSmall(t),p.setIsSmall(t),g.setIsSmall(t),t?(c.style.display="none",d.style.display="none",h.style.display="block",u.style.display="block",p.style.display="block",g.style.display="block"):(c.style.display="block",d.style.display="block",h.style.display="none",u.style.display="none",p.style.display="none",g.style.display="none")},this.setEnableZoomIn=function(t){t?Om.removeClassName(h,"toolspace-row-button-disabled"):Om.addClassName(h,"toolspace-row-button-disabled"),c.setIsEnabledLeft(t)},this.setEnableZoomOut=function(t){t?Om.removeClassName(u,"toolspace-row-button-disabled"):Om.addClassName(u,"toolspace-row-button-disabled"),c.setIsEnabledRight(t)},this.setEnableUndo=function(t){t?Om.removeClassName(p,"toolspace-row-button-disabled"):Om.addClassName(p,"toolspace-row-button-disabled"),d.setIsEnabledLeft(t)},this.setEnableRedo=function(t){t?Om.removeClassName(g,"toolspace-row-button-disabled"):Om.addClassName(g,"toolspace-row-button-disabled"),d.setIsEnabledRight(t)},this.setActive=function(t){r(t)},this.getActive=function(){return i}},ToolspaceStabilizerRow:function(t){let e=Om.el({tagName:"label",content:Vm("stabilizer")+"&nbsp;",title:Vm("stabilizer-title"),css:{display:"flex",alignItems:"center",fontSize:"13px",color:"rgba(0,0,0,0.6)"}}),n=new Zm({optionArr:[["0","0"],["1","1"],["2","2"],["3","3"],["4","4"],["5","5"]],initValue:t.smoothing,onChange:function(e){t.onSelect(parseInt(e))}});e.appendChild(n.getElement()),new Om.PointerListener({target:e,onWheel:function(t){n.setDeltaValue(t.deltaY)}}),this.getElement=function(){return e}},TabRow:function(t){let e=this,i=Om.el({className:"tabrow",css:{height:"35px"}}),r=[],a=null;const o=Om.el({css:{width:"10px",height:"10px",backgroundImage:`url('${n(ox)}')`,backgroundSize:"cover",position:"absolute",right:"-10px",bottom:"0",pointerEvents:"none"}}),s=Om.el({css:{width:"10px",height:"10px",backgroundImage:`url('${n(ox)}')`,backgroundSize:"cover",position:"absolute",left:"-10px",bottom:"0",transform:"scale(-1,1)",pointerEvents:"none"}});function l(t,n,r){let l={id:t.id,isVisible:!("isVisible"in t)||t.isVisible,onOpen:t.onOpen,onClose:t.onClose,update:function(t){c.className=t===l?r?"tabrow-tab tabrow-tab-opened-accented":"tabrow-tab tabrow-tab-opened":"tabrow-tab",c.style.display=l.isVisible?"block":"none"}},c=Om.el({content:"label"in t?t.label:"",title:"title"in t?t.title:void 0,className:n===l.id?r?"tabrow-tab tabrow-tab-opened-accented":"tabrow-tab tabrow-tab-opened":"tabrow-tab",css:{lineHeight:"35px",display:l.isVisible?"block":"none",zIndex:"0"},onClick:function(){a!==l&&e.open(l.id)}});l.div=c,"image"in t&&Om.css(c,{backgroundImage:"url('"+t.image+"')",backgroundSize:"28px"}),"css"in t&&Om.css(c,t.css),i.appendChild(c);new Om.PointerListener({target:c,onEnterLeave:function(t){t?Om.addClassName(c,"tabrow-tab-hover"):Om.removeClassName(c,"tabrow-tab-hover")}});return n===l.id?(l.onOpen(),l.div.appendChild(o),l.div.appendChild(s)):l.onClose(),l}for(let e=0;e<t.tabArr.length;e++)r.push(l(t.tabArr[e],t.initialId,t.useAccent));for(let e=0;e<r.length;e++)r[e].id===t.initialId&&(a=r[e]);if(null===a)throw"invalid initialId";function c(){for(let t=0;t<r.length;t++)r[t].update(a)}this.getElement=function(){return i},this.open=function(t){for(let e=0;e<r.length;e++)if(r[e].id===t){if(a===r[e])return;return a.onClose(),a=r[e],a.onOpen(),a.div.appendChild(o),a.div.appendChild(s),void c()}throw"TabRow.open - invalid tabId"},this.getOpenedTabId=function(){return""+a.id},this.setIsVisible=function(t,e){for(let n=0;n<r.length;n++)if(r[n].id===t)return r[n].isVisible=!!e,void c();throw"TabRow.setIsVisible - invalid tabId"}},ToolspaceCollapser:function(t){let e=!0,i="right";function r(){o.style.transform="left"===i?e?"rotate(180deg)":"":e?"":"rotate(180deg)"}let a=Om.el({css:{width:"25px",height:"25px",background:"#5c67ff",color:"#fff",position:"absolute",top:"0",textAlign:"center",lineHeight:"25px",cursor:"pointer",userSelect:"none",padding:"2px",boxSizing:"border-box"},title:Vm("toggle-show-tools"),onClick:function(n){n.preventDefault(),e=!e,r(),t.onChange()},id:"ngungu"}),o=Om.el({parent:a,css:{backgroundImage:`url(${n(lx)})`,width:"100%",height:"100%",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundPosition:"center",userSelect:"none"}});a.oncontextmenu=function(){return!1},this.isOpen=function(){return e},this.setDirection=function(t){i=t,r()},this.getElement=function(){return a}},BrowserStorageUi:kb,SaveReminder:class{init(){function t(t){t.preventDefault(),t.returnValue=""}null===this.oldActionNumber&&(this.oldActionNumber=this.history.getActionNumber(),this.showReminder&&setInterval((()=>{if("visible"!==document.visibilityState)return;let t=this.history.getActionNumber(),e=Math.abs(t-this.oldActionNumber);this.lastReminderResetAt+12e5<performance.now()&&e>=30&&(this.reset(!0),Fb.showSaveReminderToast(this.remindersShowed++))}),6e4),this.history.addListener((()=>{let e=this.history.getActionNumber();this.oldActionNumber!==e?Om.setEventListener(window,"onbeforeunload",t):Om.setEventListener(window,"onbeforeunload",null)})),this.changeTitle&&document.addEventListener("visibilitychange",(()=>{if("visible"===document.visibilityState)document.title=this.title,clearInterval(this.unsavedInterval);else{let t=this.history.getActionNumber();if(this.oldActionNumber!==t){document.title=Vm("unsaved")+" - "+this.title;let t=0;this.unsavedInterval=setInterval((()=>{t=(t+1)%2,document.title=1===t?Vm("unsaved")+" · "+this.title:Vm("unsaved")+" - "+this.title}),18e4)}}})))}reset(t){null!==this.oldActionNumber&&(t||(this.remindersShowed=0),this.lastReminderResetAt=performance.now(),this.oldActionNumber=this.history.getActionNumber(),Om.setEventListener(window,"onbeforeunload",null))}constructor(t,e,n,i="Klecks"){this.history=t,this.showReminder=e,this.changeTitle=n,this.title=i,this.oldActionNumber=null,this.remindersShowed=0}},ToolspaceScroller:class{update(){this.toolspace.scrollHeight>this.toolspace.offsetHeight+3?(this.upInterval||(this.upBtn.style.display=0===this.toolspace.scrollTop?"none":"block"),this.downInterval||(this.downBtn.style.display=this.toolspace.scrollTop+this.toolspace.offsetHeight+1>=this.toolspace.scrollHeight?"none":"block")):(this.upBtn.style.display="none",this.downBtn.style.display="none")}updateUiState(t){Om.css(this.upBtn,{left:"left"===t?"0":null,right:"right"===t?"0":null}),Om.css(this.downBtn,{left:"left"===t?"0":null,right:"right"===t?"0":null})}constructor(t){this.toolspace=t.toolspace,this.upBtn=Om.el({parent:this.toolspace,title:Vm("scroll"),className:"kl-scroller",css:{top:"0",transform:"rotate(180deg)"}}),this.downBtn=Om.el({parent:this.toolspace,title:Vm("scroll"),className:"kl-scroller",css:{bottom:"0"}}),this.updateUiState(t.uiState);new Om.PointerListener({target:this.upBtn,onPointer:t=>{"pointerdown"===t.type&&(this.upInterval=setInterval((()=>{this.toolspace.scrollBy(0,-10),this.update()}),20)),"pointerup"===t.type&&(clearInterval(this.upInterval),setTimeout((()=>{this.upInterval=null,this.update()}),50))},onWheel:t=>{this.toolspace.scrollBy(0,20*t.deltaY),this.update()}}),new Om.PointerListener({target:this.downBtn,onPointer:t=>{"pointerdown"===t.type&&(this.downInterval=setInterval((()=>{this.toolspace.scrollBy(0,10),this.update()}),20)),"pointerup"===t.type&&(clearInterval(this.downInterval),setTimeout((()=>{this.downInterval=null,this.update()}),50))},onWheel:t=>{this.toolspace.scrollBy(0,20*t.deltaY),this.update()}});this.update();new MutationObserver((()=>this.update())).observe(this.toolspace,{attributes:!0,childList:!0,subtree:!0}),window.addEventListener("resize",(()=>this.update())),jm.subscribe((t=>{this.upBtn.style.opacity=t>=1?"0":"",this.downBtn.style.opacity=t>=1?"0":""}))}},dialogCounter:jm,popup:Wm,Popup:Km,exportDialog:function(t,e){let n,i,r,a,o,s,l,c,h,u,d,p;n=44,p=22,i=function(){},a=!1,o=!1,r=document.createElement("div"),Om.css(r,{width:"308px"}),s=document.createElement("div"),l=new Image,l.src=e.src,s.appendChild(l),s.appendChild(e),Om.css(s,{width:"264px",height:"176px",marginTop:"21px",marginLeft:"21px",position:"relative",overflow:"hidden",boxShadow:"0 0 10px 4px rgba(255,255,255, 0)",border:"1px solid rgba(255, 255, 255, 1)",transition:"box-shadow 0.7s linear"}),Om.css(e,{position:"absolute",left:"0",top:"0",width:"264px",height:"176px",opacity:"0"}),c={width:264,height:264/e.width*e.height},c.height<176&&(c.height=176,c.width=c.height/e.height*e.width),Om.css(l,{position:"absolute",top:"88px",left:"132px",width:c.width+"px",height:c.height+"px",marginLeft:-c.width/2+"px",marginTop:-c.height/2+"px"}),function t(){a||(o=!o,o?Om.css(s,{border:"1px solid rgba(0, 0, 0, 1)"}):Om.css(s,{border:"1px solid rgba(200, 200, 200, 1)"}),setTimeout(t,510))}(),h=document.createElement("div"),h.innerHTML="Right-Click or Press-Hold on the image, then save.",h.ontouchstart=function(){return!1},Om.css(h,{fontSize:"17.6px",color:"#666",padding:"10px",textAlign:"center"}),r.appendChild(s),r.appendChild(h),u=!1,e.ontouchstart=function(){Om.css(s,{boxShadow:"0 0 10px 8px rgba(0,255,255, 1)"}),u=!0,d=setTimeout((function(){u=!1,Om.css(s,{boxShadow:"0 0 10px 4px rgba(0,255,255, 0)"})}),1500)},e.ontouchmove=function(){Om.css(s,{boxShadow:"0 0 10px 4px rgba(0,255,255, 0)"}),u=!1,clearTimeout(d)},e.ontouchend=function(){Om.css(s,{boxShadow:"0 0 10px 4px rgba(0,255,255, 0)"}),u=!1,clearTimeout(d)},Wm({target:t,message:"<b>Save Image</b>",div:r,buttons:["Close"],callback:function(t){a=!0}})},clipboardDialog:function(t,e,n,i,r){const a=document.createElement("div"),o=window.innerWidth<550||window.innerHeight<550;let s=Om.el({content:Vm("crop-drag-to-crop"),css:{textAlign:"center"}});a.appendChild(s);let l=new uy({width:o?340:540,height:o?300:350,canvas:e});function c(){const t=l.getCroppedImage().toDataURL("image/png");setTimeout((async function(){try{const e=await fetch(t),n=await e.blob();await navigator.clipboard.write([new ClipboardItem({[n.type]:n})]),setTimeout((function(){i.out(Vm("cropcopy-copied"),!0)}),200)}catch(t){console.error(t.name,t.message)}}),0)}Om.css(l.getEl(),{marginTop:"10px",marginLeft:"-20px",borderTop:"1px solid #bbb",borderBottom:"1px solid #bbb"}),a.appendChild(l.getEl());let h,u=new Om.KeyListener({onDown:function(t,e,n){"ctrl+c"===n&&(c(),h())}});function d(){h()}Om.addEventListener(window,"blur",d),Wm({target:t,message:"<b>"+(r?`${Vm("cropcopy-title-copy")} / ${Vm("cropcopy-title-crop")}`:`${Vm("cropcopy-title-copy")}`)+"</b>",div:a,style:o?{}:{width:"500px"},buttons:r?[Vm("cropcopy-btn-copy"),Vm("cropcopy-btn-crop"),"Cancel"]:[Vm("cropcopy-btn-copy"),"Cancel"],primaries:[Vm("cropcopy-btn-copy")],callback:function(t){if(t===Vm("cropcopy-btn-copy"))c();else if(t===Vm("cropcopy-btn-crop")){let t=l.getRect();n({left:Math.round(-t.x),right:Math.round(t.x+t.width-e.width),top:Math.round(-t.y),bottom:Math.round(t.y+t.height-e.height)})}Om.removeEventListener(window,"blur",d),l.destroy(),u.destroy()},clickOnEnter:Vm("cropcopy-btn-copy"),closefunc:function(t){h=t}})},showImportAsLayerDialog:function(t){let e=document.createElement("div");if(Om.appendTextDiv(e,Vm("import-as-layer-description")),t.klCanvas.isLayerLimitReached()){let t=Om.el({content:Vm("import-as-layer-limit-reached"),css:{background:"#ff0",padding:"10px",marginTop:"5px",marginBottom:"5px",border:"1px solid #e7d321",borderRadius:"5px"}});e.appendChild(t)}let n=window.innerWidth<550,i=Om.el({css:{display:"flex"}}),r=Om.el({tagName:"button",content:"1:1",css:{marginRight:"10px"},onClick:function(){l.reset()}}),a=Om.el({tagName:"button",content:Vm("import-as-layer-fit"),css:{marginRight:"10px"},onClick:function(){l.setTransformFit()}}),o=Om.el({tagName:"button",content:Vm("center"),css:{marginRight:"10px"},onClick:function(){l.setTransformCenter()}});i.appendChild(r),i.appendChild(a),i.appendChild(o),e.appendChild(i);let s=[];{let e=t.klCanvas.getLayers();for(let t=0;t<e.length;t++)s.push({image:e[t].context.canvas,opacity:e[t].opacity,mixModeStr:e[t].mixModeStr})}s.push({image:t.importImage,opacity:1,mixModeStr:"source-over"});let l=new Ny({elementWidth:n?340:540,elementHeight:n?280:350,imageWidth:t.klCanvas.getLayerContext(0).canvas.width,imageHeight:t.klCanvas.getLayerContext(0).canvas.height,layers:s,transformIndex:s.length-1});function c(t,e){l.move(t,e)}Om.css(l.getElement(),{marginTop:"10px",marginLeft:"-20px"}),e.appendChild(l.getElement());let h=new Om.KeyListener({onDown:function(t){"left"===t&&c(-1,0),"right"===t&&c(1,0),"up"===t&&c(0,-1),"down"===t&&c(0,1)}});Wm({target:t.target,message:`<b>${Vm("import-as-layer-title")}</b>`,div:e,style:n?null:{width:"500px"},buttons:["Ok","Cancel"],clickOnEnter:"Ok",callback:function(e){h.destroy(),l.destroy(),Om.destroyEl(r),Om.destroyEl(a),Om.destroyEl(o),"Ok"===e?t.callback(l.getTransformation(),l.getIsPixelated()):t.callback()}})},newImageDialog:function(t){let e=t.currentColor,n=t.secondaryColor,i=t.maxCanvasSize,r=t.canvasWidth,a=t.canvasHeight,o=t.workspaceWidth,s=t.workspaceHeight,l=t.onConfirm,c=t.onCancel;function h(t,e,n,r,a){return Om.fitInto(t,e,Math.min(i,n-a),Math.min(i,r-a),1)}let u=document.createElement("div"),d=document.createElement("div"),p=document.createElement("div"),g=document.createElement("input"),f=document.createElement("div"),m=document.createElement("input"),y=document.createElement("div");d.style.position="relative",d.style.width="145px",d.style.height="35px",d.style.lineHeight="30px",p.style.width="145px",p.style.height="35px",p.style.lineHeight="30px",f.innerText=Vm("new-px"),f.style.color="#888",f.style.fontSize="12px",f.style.marginLeft="5px",f.style.cssFloat="right",y.innerText=Vm("new-px"),y.style.color="#888",y.style.fontSize="12px",y.style.marginLeft="5px",y.style.cssFloat="right",g.setAttribute("data-ignore-focus","true"),m.setAttribute("data-ignore-focus","true"),g.type="number",g.min="1",g.max=i,g.style.cssFloat="right",g.style.width="70px",m.type="number",m.min="1",m.max=i,m.style.cssFloat="right",m.style.width="70px",g.value=r,m.value=a,g.onclick=function(){this.focus(),z()},m.onclick=function(){this.focus(),z()},d.appendChild(f),d.appendChild(g),Om.appendTextDiv(d,Vm("width")+": "),p.appendChild(y),p.appendChild(m),Om.appendTextDiv(p,Vm("height")+": ");let x=document.createElement("div");x.style.marginTop="5px",x.style.color="#888";let b=document.createElement("div"),v=document.createElement("button");b.style.marginBottom="10px";let w=document.createElement("button"),C=document.createElement("button"),S=document.createElement("button"),E=document.createElement("button"),M=document.createElement("button");w.textContent=Vm("new-current"),v.textContent=Vm("new-fit"),M.textContent=Vm("new-oversize"),S.textContent=Vm("new-landscape"),E.textContent=Vm("new-portrait"),C.textContent=Vm("new-square"),w.style.marginRight="5px",v.style.marginRight="5px",M.style.marginRight="5px",S.style.marginTop="5px",S.style.marginRight="5px",E.style.marginTop="5px",E.style.marginRight="5px",b.appendChild(w),b.appendChild(v),b.appendChild(M),b.appendChild(C),b.appendChild(S),b.appendChild(E),w.onclick=function(){g.value=r,m.value=a,z()},v.onclick=function(){g.value=o,m.value=s,z()},M.onclick=function(){g.value=o+500,m.value=s+500,z()},C.onclick=function(){let t=h(1,1,o,s,50);g.value=""+Math.round(t.width),m.value=""+Math.round(t.height),z()},S.onclick=function(){let t=h(4,3,o,s,50);g.value=""+Math.round(t.width),m.value=""+Math.round(t.height),z()},E.onclick=function(){let t=h(3,4,o,s,50);g.value=""+Math.round(t.width),m.value=""+Math.round(t.height),z()};let I=new Zm({isFocusable:!0,optionArr:[["screen",Vm("new-screen")],["16 9",Vm("new-video")+" 16:9"],["3 2","3:2"],["5 3","5:3"],["2 1","2:1"],["paper",Vm("new-din-paper")+" √2:1"],["9 16","9:16"],["2 3","2:3"],["3 5","3:5"],["1 2","1:2"],["1 1.4142135623730951","1:√2"]],onChange:function(t){if("screen"===t)g.value=""+window.screen.width,m.value=""+window.screen.height;else if("paper"===t){let t=h(Math.sqrt(2),1,o,s,50);g.value=""+Math.round(t.width),m.value=""+Math.round(t.height)}else{let e=t.split(" "),n=h(parseFloat(e[0]),parseFloat(e[1]),o,s,50);g.value=""+Math.round(n.width),m.value=""+Math.round(n.height)}z(),I.setValue(null)}});setTimeout((()=>{I.setValue(null)}),0),Om.css(I.getElement(),{width:"80px"}),b.appendChild(I.getElement());let k={r:255,g:255,b:255,a:1},T=[{r:255,g:255,b:255,a:1},{r:0,g:0,b:0,a:1},{r:0,g:0,b:0,a:0}];T.push({r:e.r,g:e.g,b:e.b,a:1}),T.push({r:n.r,g:n.g,b:n.b,a:1});let R=new ly({colorArr:T,onChange:function(t){k=t,A.style.backgroundColor="rgba("+t.r+","+t.g+","+t.b+", "+t.a+")"}}),L=document.createElement("div");Om.css(L,{boxSizing:"border-box",width:"340px",height:"140px",display:"table",backgroundColor:"#9e9e9e",padding:"10px",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",marginLeft:"-20px",colorScheme:"only light"});let A=document.createElement("div");Om.css(A,{width:"200px",height:"100px",backgroundColor:"#fff",marginLeft:"auto",marginRight:"auto",color:"#aaa",fontSize:"16px",fontWeight:"bold",textAlign:"center",verticalAlign:"center",display:"table",overflow:"hidden",boxShadow:"0px 0px 3px rgba(0,0,0,0.5)"});let P=document.createElement("div");P.style.display="table-cell",P.style.verticalAlign="middle",P.appendChild(A),L.appendChild(P);let O=Om.appendTextDiv(A,"");O.style.display="table-cell",O.style.verticalAlign="middle";let D=parseInt(g.value),B=parseInt(m.value);function z(){g.value=""+Math.min(i,parseInt(g.value)),m.value=""+Math.min(i,parseInt(m.value));let t=parseInt(g.value),e=parseInt(m.value);(t<1||t>i||e<1||e>i)&&(t>i?t=i:e>i&&(e=i),g.value=""+t,m.value=""+e);let n=[[1,2],[2,1],[2,3],[3,2],[3,4],[4,3],[4,5],[5,4],[16,9],[9,16],[3,2],[2,3],[5,3],[3,5],[2,1],[1,2],[1.414,1],[1,1.414]],r=Om.reduce(t,e),a=null,o=null;for(let t=0;t<n.length;t++)(0===t||Math.abs(n[t][0]/n[t][1]-r[0]/r[1])<o)&&(a=n[t],o=Math.abs(n[t][0]/n[t][1]-r[0]/r[1]));x.innerText=o>0&&o<.005?Vm("new-ratio")+": ~"+a[0]+":"+a[1]:Vm("new-ratio")+": "+r[0]+":"+r[1],D=t,B=e;let s=t,l=function(t,e){let n=t,i=e;for(;;){if(!(n%=i))return i;if(!(i%=n))return n}}(t,e);t/=l,e/=l,t*=260,e*=260,t>260&&(e*=260/t,t=260),e>100&&(t*=100/e,e=100),A.style.width=t+"px",A.style.height=e+"px",Om.createCheckerDataUrl(parseInt(""+t/s*30),(function(t){L.style.background="url("+t+")"}))}g.onchange=function(){(""===g.value||parseInt(g.value)<0)&&(g.value="1"),z()},g.onkeyup=function(){z()},m.onchange=function(){(""===m.value||parseFloat(m.value)<0)&&(m.value="1"),z()},m.onkeyup=function(){z()},z(),u.appendChild(b);let j=Om.el({parent:u,css:{display:"flex",justifyContent:"space-between",alignItems:"flex-end"}}),H=Om.el({parent:j});H.appendChild(d),H.appendChild(p),H.appendChild(x),j.appendChild(R.getElement()),u.appendChild(L),Wm({target:document.body,message:`<b>${Vm("new-title")}</b>`,div:u,buttons:["Ok","Cancel"],callback:function(t){g.onclick=null,m.onclick=null,w.onclick=null,v.onclick=null,M.onclick=null,C.onclick=null,S.onclick=null,E.onclick=null,g.onchange=null,g.onkeyup=null,m.onchange=null,m.onkeyup=null,I.destroy(),R.destroy(),"Cancel"===t||parseInt(g.value)<=0||parseInt(m.value)<=0||isNaN(parseInt(g.value))||isNaN(parseInt(m.value))?c():l(parseInt(g.value),parseInt(m.value),k)},clickOnEnter:"Ok"})},textToolDialog:function(t){let e=Om.el({}),i=window.innerWidth<550,r=window.innerHeight<630,a=i?340:540,o=i?r?210:260:r?230:350,s=1,l=t.klCanvas.getLayersFast(),c=Om.canvas(t.klCanvas.getWidth(),t.klCanvas.getHeight()),h=c.getContext("2d"),u=Om.canvas(a,o),d=u.getContext("2d"),p=Om.canvas(a,o),g=p.getContext("2d"),f=Om.canvas(a,o),m=f.getContext("2d");Om.css(f,{display:"block"});let y=Om.el({parent:e,css:{position:"relative",width:a+"px",marginLeft:"-20px",cursor:"move",colorScheme:"only light",touchAction:"none"},onClick:function(){W.focus()}});Om.el({parent:y,css:{position:"absolute",left:"0",top:"0",right:"0",bottom:"0",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",pointerEvents:"none"}}),y.appendChild(f);let x=m.createPattern(Om.createCheckerCanvas(8),"repeat"),b=Om.canvas(1,1);function v(){h.clearRect(0,0,c.width,c.height);let e={...t.color,a:X.getValue()},n=Ey(c,{x:t.x,y:t.y,textStr:W.value,align:U.getValue(),isItalic:N.getValue(),isBold:Y.getValue(),size:parseFloat(_.value),font:D.getValue(),color:Om.ColorConverter.toRgbaStr(e),angleRad:t.angleRad});n.width=Math.max(n.width,1),n.height=Math.max(n.height,1);let i=Om.rotate(n.x,n.y,-t.angleRad/Math.PI*180),r=Om.rotate(n.width,n.height,-t.angleRad/Math.PI*180),y=t.x+i.x+r.x/2,v=t.y+i.y+r.y/2,w=Om.fitInto(n.width,n.height,a-100,o-100);s=Math.min(1,w.width/n.width),s=Math.min(4,s*Math.pow(2,L)),d.save(),s>=4?d.imageSmoothingEnabled=!1:(d.imageSmoothingEnabled=!0,d.imageSmoothingQuality=s>=1?"low":"medium"),d.clearRect(0,0,f.width,f.height),d.translate(a/2,o/2),d.scale(s,s),d.rotate(t.angleRad),d.drawImage(l[t.layerIndex].canvas,-y,-v),d.drawImage(c,-y,-v),d.restore(),g.save(),g.fillStyle="rgb(158,158,158)",g.fillRect(0,0,a,o);{g.save(),g.translate(a/2,o/2),g.scale(s,s),g.rotate(t.angleRad),g.imageSmoothingEnabled=!1;let e=1/s;g.globalAlpha=.2,g.drawImage(b,-y-e,-v-e,c.width+2*e,c.height+2*e),g.globalAlpha=1,g.globalCompositeOperation="destination-out",g.drawImage(b,-y,-v,c.width,c.height),g.restore()}s>=4?g.imageSmoothingEnabled=!1:(g.imageSmoothingEnabled=!0,g.imageSmoothingQuality=s>=1?"low":"medium"),g.save(),g.translate(a/2,o/2),g.scale(s,s),g.rotate(t.angleRad);for(var C=0;C<t.layerIndex;C++)l[C].opacity>0&&(g.globalAlpha=l[C].opacity,g.globalCompositeOperation=l[C].mixModeStr,g.drawImage(l[C].canvas,-y,-v));g.restore(),g.globalAlpha=l[t.layerIndex].opacity,g.globalCompositeOperation=l[t.layerIndex].mixModeStr,g.drawImage(u,0,0),g.save(),g.translate(a/2,o/2),g.scale(s,s),g.rotate(t.angleRad);for(let e=t.layerIndex+1;e<l.length;e++)l[e].opacity>0&&(g.globalAlpha=l[e].opacity,g.globalCompositeOperation=l[e].mixModeStr,g.drawImage(l[e].canvas,-y,-v));g.restore(),g.restore(),m.save(),m.fillStyle=x,m.fillRect(0,0,f.width,f.height),m.drawImage(p,0,0),m.restore(),m.save(),m.globalCompositeOperation="difference",m.strokeStyle="#fff",m.lineWidth=1,m.strokeRect(Math.round(a/2-n.width/2*s),Math.round(o/2-n.height/2*s),Math.round(n.width*s),Math.round(n.height*s)),m.restore()}function w(e,n){let i=Om.rotate(e,n,-t.angleRad/Math.PI*180);t.x+=i.x/s,t.y+=i.y/s,v()}b.getContext("2d").fillRect(0,0,1,1);let C=new Om.PointerListener({target:f,pointers:1,onPointer:function(t){"pointermove"===t.type&&t.button&&(t.eventPreventDefault(),w(-t.dX,-t.dY))},onWheel:function(t){A(-t.deltaY)}});const S=t=>{t.preventDefault()};Om.addEventListener(f,"wheel",S);let E=Om.el({parent:e,css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:"10px"}}),M=Om.el({parent:e,css:i?{}:{display:"flex",alignItems:"center",justifyContent:"space-between"}}),I=Om.el({parent:M,css:{display:"flex",alignItems:"center",marginTop:"5px"}}),k=Om.el({parent:M,css:{display:"flex",alignItems:"center",justifyContent:"space-between",marginTop:"5px",width:i?"":"300px"}}),T=[{r:0,g:0,b:0,a:1},{r:255,g:255,b:255,a:1}];T.unshift({r:t.secondaryColor.r,g:t.secondaryColor.g,b:t.secondaryColor.b,a:1}),T.unshift({r:t.color.r,g:t.color.g,b:t.color.b,a:1});let R=new ly({colorArr:T,initialIndex:0,onChange:function(e){t.color=e,v()}});R.getElement().title=Vm("text-color"),R.getElement().style.marginLeft="-5px",E.appendChild(R.getElement());let L=0;function A(t){L=Math.min(2,Math.max(-2,L+t)),v(),j.disabled=!P(1),H.disabled=!P(-1)}function P(t){return L!==Math.min(2,Math.max(-2,L+t))}let O,D,B,z=Om.el({parent:E,css:{}}),j=Om.el({parent:z,content:`<img height="20" src="${n(ix)}">`,title:Vm("zoom-in"),tagName:"button",onClick:function(){A(1)},css:{fontWeight:"bold"}}),H=Om.el({parent:z,content:`<img height="20" src="${n(rx)}">`,title:Vm("zoom-out"),tagName:"button",onClick:function(){A(-1)},css:{fontWeight:"bold",marginLeft:"5px"}}),_=Om.el({parent:I,tagName:"input",title:Vm("text-size"),custom:{type:"number",min:1,max:1e4,value:t.size},css:{width:"60px"},onChange:function(){_.value=""+Math.max(1,Math.min(1e4,parseInt(_.value))),v()}}),F=new Om.PointerListener({target:_,onWheel:function(t){_.value=""+Math.max(1,Math.min(1e3,parseInt(_.value)-t.deltaY)),v()}});O=Om.el({css:{fontSize:"15px",marginLeft:"10px"}}),D=new Zm({isFocusable:!0,optionArr:[["sans-serif","Sans-serif"],["serif","Serif"],["monospace","Monospace"],["cursive","Cursive"],["fantasy","Fantasy"]],initValue:t.font,onChange:function(t){v()}}),O.appendChild(D.getElement()),I.appendChild(O),B=new Om.PointerListener({target:D.getElement(),onWheel:function(t){D.setDeltaValue(t.deltaY)}});let U=new Jm({optionArr:[{id:"left",title:Vm("text-left"),image:n(cx)},{id:"center",title:Vm("text-center"),image:n(hx)},{id:"right",title:Vm("text-right"),image:n(ux)}],initId:t.align,onChange:function(t){v()}});k.appendChild(U.getElement());let N=new $m({image:n(dx),title:Vm("text-italic"),initValue:t.isItalic,onChange:function(t){v()}});k.appendChild(N.getElement());let Y=new $m({image:n(px),title:Vm("text-bold"),initValue:t.isBold,onChange:function(t){v()}});k.appendChild(Y.getElement());let X=new ny({label:Vm("opacity"),width:150,height:30,min:0,max:1,initValue:t.opacity,resolution:225,eventResMs:1e3/30,onChange:function(t){v()},formatFunc:function(t){return Math.round(100*t)}});k.appendChild(X.getElement());let V,W=Om.el({parent:e,tagName:"textarea",custom:{placeholder:Vm("text-placeholder"),"data-ignore-focus":"true"},css:{whiteSpace:"nowrap",overflow:"auto",width:"100%",height:"70px",resize:"vertical",marginTop:"10px"},onChange:function(){v()}});W.addEventListener("input",v),setTimeout((function(){W.focus(),W.select()}));let K=new Om.KeyListener({onDown:function(t,e,n){Om.isInputFocused(!0)||("left"===t&&w(-1,0),"right"===t&&w(1,0),"up"===t&&w(0,-1),"down"===t&&w(0,1))}});function G(){window.scrollTo(0,0)}window.addEventListener("scroll",G),Wm({target:document.body,message:`<b>${Vm("text-title")}</b>`,div:e,buttons:["Ok","Cancel"],style:i?{}:{width:"500px"},callback:function(e){window.removeEventListener("scroll",G),C.destroy(),F.destroy(),B.destroy(),Om.removeEventListener(f,"wheel",S),K.destroy(),"Ok"===e&&t.onConfirm({x:t.x,y:t.y,textStr:W.value,align:U.getValue(),isItalic:N.getValue(),isBold:Y.getValue(),color:t.color,size:_.value,font:D.getValue(),opacity:X.getValue()})},autoFocus:!1,clickOnEnter:"Ok",ignoreBackground:!0,closefunc:function(t){V=t}}),v()},showImportImageDialog:function(t){const e=Om.el({}),n=window.innerWidth<550||window.innerHeight<550,i=n?{}:{width:"500px"};let r;const a=new uy({width:n?340:540,height:n?300:400,canvas:t.image.canvas,isNotCopy:!0,onChange:function(t,e){r&&o(t,e)}});function o(e,n){const i=Om.fitInto(e,n,t.maxSize,t.maxSize);i.width<e?(r.innerHTML=`<span style="color:#f00">${e} X ${n}</span> ⟶ ${Math.round(i.width)} X ${Math.round(i.height)}`,r.title=Vm("import-too-large")):(r.innerHTML=`${e} X ${n}`,r.title="")}Om.css(a.getEl(),{marginLeft:"-20px",borderTop:"1px solid #bbb",borderBottom:"1px solid #bbb"}),a.getEl().title=Vm("crop-drag-to-crop"),e.appendChild(a.getEl()),r=Om.el({parent:e,css:{marginTop:"10px",textAlign:"center",color:"#888",lineHeight:"20px"}}),o(t.image.width,t.image.height);let s,l=!1;if("psd"===t.image.type){const n={background:"rgba(255,255,0,0.5)",padding:"10px",marginTop:"5px",marginBottom:"5px",border:"1px solid #e7d321",borderRadius:"5px"};if(t.image.layers){if(s=new Gm({init:l,label:Vm("import-flatten"),callback:function(t){l=t}}),e.appendChild(s.getElement()),t.image.warningArr){const i=Om.el({content:Vm("import-psd-limited-support"),css:n});i.appendChild(Om.el({tagName:"a",content:"Details",onClick:function(){!function(t){let e=[],n={mask:"Masks not supported. Mask was applied.",clipping:"Clipping not supported. Clipping layers were merged.",group:"Groups not supported. Layers were ungrouped.",adjustment:"Adjustment layers not supported.","layer-effect":"Layer effects not supported.","smart-object":"Smart objects not supported.","blend-mode":"Unsupported layer blend mode.","bits-per-channel":"Unsupported color depth. Only 8bit per channel supported."};for(let i=0;i<t.length;i++)e.push("- "+n[t[i]]);alert(e.join("\n"))}(t.image.warningArr)}})),e.appendChild(i)}}else{const t=Om.el({content:Vm("import-psd-unsupported"),css:n});e.appendChild(t)}}Wm({target:t.target,message:`<b>${Vm("import-title")}</b>`,div:e,style:i,buttons:[Vm("import-btn-as-layer"),Vm("import-btn-as-image"),"Cancel"],callback:function(e){const n=a.getCroppedImage(),i=a.getRect();a.destroy(),s&&s.destroy(),e===Vm("import-btn-as-layer")?t.callback({type:"as-layer",image:n}):e===Vm("import-btn-as-image")?"psd"===t.image.type?(l&&(t.image.layers=null),t.callback({type:"as-image-psd",image:t.image,cropObj:i})):"image"===t.image.type&&t.callback({type:"as-image",image:n}):t.callback({type:"cancel"})},autoFocus:"As Image"})},showIframePopup:Ib,imgurUpload:function(t,e,i,r){if(!r)throw new Error("imgur key missing");let a=document.createElement("input");a.type="text",a.value=Vm("upload-title-untitled");let o=Om.el({tagName:"textarea",custom:{rows:2},css:{width:"100%",maxWidth:"100%"}}),s=document.createElement("div");s.textContent=Vm("upload-name")+":";let l=Om.el({content:Vm("upload-caption")+":",css:{marginTop:"10px"}}),c=document.createElement("div");c.innerHTML=`<br/><a href="https://imgur.com/tos" target="_blank" rel="noopener noreferrer">${Vm("upload-tos")}</a> ${Vm("upload-tos-2")}`;const h=new Fb.RadioList({name:"filetype",init:"jpeg",items:[{label:"JPG",value:"jpeg"},{label:"PNG",value:"png"}],ignoreFocus:!0});Om.css(h.getElement(),{marginBottom:"10px"});let u=document.createElement("div"),d=document.createElement("div");d.className="info-hint",d.textContent=Vm("upload-link-notice"),u.append(d,h.getElement(),s,a,l,o,c),Fb.popup({target:e,message:`<b>${Vm("upload-title")}</b>`,type:"upload",div:u,buttons:[Vm("upload-submit"),"Cancel"],clickOnEnter:Vm("upload-submit"),primaries:[Vm("upload-submit")],autoFocus:Vm("upload-submit"),callback:async function(s){if(s===Vm("upload-submit")||"Yes"===s||"Ok"===s)try{const s=await async function(t,e,i,r,a){let o=Tb(t.toDataURL("image/"+r)),s=window.open(),l=s.document.createElement("div"),c=s.document.createElement("img");c.src=n(Pb),l.appendChild(c),Om.css(c,{filter:"invert(1)"}),s.document.body.style.backgroundColor="#121211",s.document.body.style.backgroundImage="linear-gradient(#2b2b2b 0%, #121211 50%)",s.document.body.style.backgroundRepeat="no-repeat";let h,u=s.document.createElement("div");u.style.marginTop="10px",l.appendChild(u),u.textContent=Vm("upload-uploading"),s.document.body.appendChild(l),Om.css(l,{marginLeft:"auto",marginRight:"auto",marginTop:"100px",fontFamily:"Arial, sans-serif",fontSize:"20px",textAlign:"center",transition:"opacity 0.3s ease-in-out",opacity:"0",color:"#ccc"}),setTimeout((function(){l.style.opacity="1"}),20);try{const t=new FormData;t.append("title",e),t.append("description",i),t.append("image",o),h=await fetch("https://api.imgur.com/3/image",{method:"POST",headers:{Authorization:"Client-ID "+a},body:t})}catch(t){throw s.close(),new Error(t)}if(!h.ok)throw s.close(),new Error;let d=(await h.json()).data;return s.location.href=d.link.replace(/\.(jpg|png)/,""),d}(t.getCompleteCanvas(1),a.value,o.value,h.getValue(),r);Fb.popup({target:e,type:"ok",message:`<h3>${Vm("upload-success")}</h3><br>${Vm("upload-delete")}<br><a target='_blank' rel="noopener noreferrer" href='https://imgur.com/delete/${s.deletehash}'>imgur.com/<b>delete</b>/${s.deletehash}</a><br><br>`,buttons:["Ok"]}),i.reset()}catch(t){Fb.popup({target:e,type:"error",message:Vm("upload-failed"),buttons:["Ok"]})}}})},HandUi:function(t){let e=Om.el({css:{margin:"10px"}}),i=!0,r=t.scale,a=t.angleDeg,o=Om.el({css:{marginBottom:"10px",display:"flex"}}),s=Om.el({css:{display:"flex",marginBottom:"10px"}}),l=Om.el({css:{display:"flex"}});e.append(o,s,l);let c=Om.el({css:{width:"55px",userSelect:"none"}});o.appendChild(c);let h=new Image;h.src=n(hy),Om.css(h,{verticalAlign:"bottom",width:"20px",height:"20px",marginRight:"5px",borderRadius:"10px",background:"rgba(0,0,0,0.2)",userSelect:"none"}),o.appendChild(h);let u=Om.el({css:{userSelect:"none"}});function d(){c.innerHTML=Math.round(100*r)+"%",u.innerHTML=Math.round(a)+"°",h.style.transform="rotate("+a+"deg)",h.style.boxShadow=a%90==0?"inset 0 0 0 1px rgba(255,255,255, 1), 0 0 0 1px rgba(0, 0, 0, 0.3)":""}o.appendChild(u),d();let p=Om.el({tagName:"button",content:Vm("hand-reset"),onClick:t.onReset});Om.makeUnfocusable(p);let g=Om.el({tagName:"button",content:Vm("hand-fit"),css:{marginLeft:"10px"},onClick:t.onFit});Om.makeUnfocusable(g),s.append(p,g);let f=Om.el({tagName:"button",content:'<img height="20" src="'+n(sx)+'" alt="Rotate" style="transform: scale(-1, 1)"/>',onClick:function(){t.onAngleChange(-15,!0)}});Om.makeUnfocusable(f);let m=Om.el({tagName:"button",content:"0°",css:{marginLeft:"10px"},onClick:function(){t.onAngleChange(0)}});Om.makeUnfocusable(m);let y=Om.el({tagName:"button",content:'<img height="20" src="'+n(sx)+'" alt="Rotate"/>',css:{marginLeft:"10px"},onClick:function(){t.onAngleChange(15,!0)}});Om.makeUnfocusable(y),l.append(f,m,y),this.getElement=function(){return e},this.setIsVisible=function(t){i=!!t,e.style.display=i?"block":"none",i&&d()},this.update=function(t,e){r=t,a=e,i&&d()}},FillUi:function(t){let e=Om.el({css:{margin:"10px"}}),n=!0,i=Om.el({parent:e,css:{marginBottom:"10px"}}),r=new ny({label:Vm("opacity"),width:250,height:30,min:0,max:1,initValue:1,onChange:function(t){},formatFunc:function(t){return Math.round(100*t)}});e.appendChild(r.getElement());let a=new ny({label:Vm("bucket-tolerance"),width:250,height:30,min:0,max:255,initValue:51,onChange:function(t){},formatFunc:function(t){return Math.round(t/255*100)}});Om.css(a.getElement(),{marginTop:"10px"}),e.appendChild(a.getElement());let o,s,l,c,h=Om.el({parent:e,css:{display:"flex",marginTop:"10px"}});o=Om.el({content:Vm("bucket-sample")+"&nbsp;",title:Vm("bucket-sample-title"),css:{fontSize:"15px"}}),s=new Zm({optionArr:[["all",Vm("bucket-sample-all")],["current",Vm("bucket-sample-active")],["above",Vm("bucket-sample-above")]],initValue:"all",onChange:function(t){}}),new Om.PointerListener({target:s.getElement(),onWheel:function(t){s.setDeltaValue(t.deltaY)}}),o.appendChild(s.getElement()),h.appendChild(o),l=Om.el({content:Vm("bucket-grow")+"&nbsp;",title:Vm("bucket-grow-title"),css:{fontSize:"15px",marginLeft:"10px"}}),c=new Zm({optionArr:[["0","0"],["1","1"],["2","2"],["3","3"],["4","4"],["5","5"],["6","6"],["7","7"]],initValue:"0",onChange:function(t){}}),new Om.PointerListener({target:c.getElement(),onWheel:function(t){c.setDeltaValue(t.deltaY)}}),l.appendChild(c.getElement()),h.appendChild(l);let u=!0,d=new Gm({init:!0,label:Vm("bucket-contiguous"),title:Vm("bucket-contiguous-title"),callback:function(t){u=t},css:{marginTop:"10px",paddingRight:"5px",display:"inline-block"}});e.appendChild(d.getElement()),this.getElement=function(){return e},this.setIsVisible=function(r){n=!!r,e.style.display=n?"block":"none",n&&(i.appendChild(t.colorSlider.getElement()),i.appendChild(t.colorSlider.getOutputElement()))},this.getTolerance=function(){return a.getValue()},this.getOpacity=function(){return r.getValue()},this.getSample=function(){return s.getValue()},this.getGrow=function(){return parseInt(c.getValue(),10)},this.getContiguous=function(){return u}},TextUi:function(t){let e=Om.el({css:{margin:"10px"}}),n=!0,i=Om.el({parent:e,css:{marginBottom:"10px"}});Om.el({parent:e,content:Vm("text-instruction")}),this.getElement=function(){return e},this.setIsVisible=function(r){n=!!r,e.style.display=n?"block":"none",n&&(i.appendChild(t.colorSlider.getElement()),i.appendChild(t.colorSlider.getOutputElement()))}},ShapeUi:function(t){let e,n,i=Om.el({css:{margin:"10px"}}),r=!0,a=Om.el({parent:i,css:{marginBottom:"10px"}}),o=Om.createSvg({elementType:"rect",x:"8",width:"19"}),s=Om.createSvg({elementType:"svg",width:"35",height:"35"});s.appendChild(o),Om.css(s,{display:"block"});let l=Om.createSvg({elementType:"rect",x:"8",width:"19"}),c=Om.createSvg({elementType:"svg",width:"35",height:"35"});c.appendChild(l),Om.css(c,{display:"block"});let h=Om.createSvg({elementType:"ellipse",cx:"17.5",cy:"17.5",rx:"9.5"}),u=Om.createSvg({elementType:"svg",width:"35",height:"35"});u.appendChild(h),Om.css(u,{display:"block"});let d=Om.createSvg({elementType:"ellipse",cx:"17.5",cy:"17.5",rx:"9.5"}),p=Om.createSvg({elementType:"svg",width:"35",height:"35"});p.appendChild(d),Om.css(p,{display:"block"});let g=Om.createSvg({elementType:"line",x1:"8",x2:"27"}),f=Om.createSvg({elementType:"svg",width:"35",height:"35"});function m(){let t=Om.clamp(Math.round(v.getValue()/10),1,10)+"px";Om.css(o,{fill:"none",stroke:"black",strokeWidth:t}),Om.css(l,{fill:"black",stroke:"none"}),Om.css(h,{fill:"none",stroke:"black",strokeWidth:t}),Om.css(d,{fill:"black",stroke:"none"}),Om.css(g,{fill:"none",stroke:"black",strokeWidth:t}),E.getValue()?(o.setAttribute("y","8"),o.setAttribute("height","19"),l.setAttribute("y","8"),l.setAttribute("height","19"),h.setAttribute("ry","9.5"),d.setAttribute("ry","9.5")):(o.setAttribute("y","10.8"),o.setAttribute("height","13.399999999999999"),l.setAttribute("y","10.8"),l.setAttribute("height","13.399999999999999"),h.setAttribute("ry",""+(17.5-10.8)),d.setAttribute("ry",""+(17.5-10.8))),M.getValue()?(g.setAttribute("y1","27"),g.setAttribute("y2","8")):(g.setAttribute("y1","24.2"),g.setAttribute("y2","10.8"))}f.appendChild(g),Om.css(f,{display:"block"});let y=Om.el({parent:i,css:{display:"flex",justifyContent:"space-between",alignItems:"start"}}),x=new cy({optionArr:[{id:"rect-stroke",label:s,title:Vm("shape-rect")+" "+Vm("shape-stroke")},{id:"ellipse-stroke",label:u,title:Vm("shape-ellipse")+" "+Vm("shape-stroke")},{id:"line",label:f,title:Vm("shape-line")},{id:"rect-fill",label:c,title:Vm("shape-rect")+" "+Vm("shape-fill")},{id:"ellipse-fill",label:p,title:Vm("shape-ellipse")+" "+Vm("shape-fill")}],initId:"rect",onChange:function(t){let i=t.split("-");e=i[0],n=i[1],Om.css(E.getElement(),{display:"line"===e?"none":null}),Om.css(M.getElement(),{display:"line"===e?null:"none"}),Om.css(v.getElement(),{display:"line"!==e&&"fill"===n?"none":null})},changeOnInit:!0});x.getElement().style.width="120px",y.appendChild(x.getElement());let b=new Gm({init:!1,label:Vm("eraser"),callback:function(t){m()}});y.appendChild(b.getElement());let v=new ny({label:Vm("shape-line-width"),width:250,height:30,min:1,max:200,initValue:4,curve:"quadratic",onChange:function(t){m()},formatFunc:function(t){return Math.round(t)}});Om.css(v.getElement(),{marginTop:"10px"}),i.appendChild(v.getElement());let w=new ny({label:Vm("opacity"),width:250,height:30,min:0,max:1,initValue:1,onChange:function(t){},formatFunc:function(t){return Math.round(100*t)}});Om.css(w.getElement(),{marginTop:"10px"}),i.appendChild(w.getElement());let C=Om.el({parent:i,css:{display:"flex",alignItems:"center",marginTop:"10px"}}),S=new Gm({init:!1,label:Vm("shape-outwards"),callback:function(t){},css:{width:"50%",marginRight:"10px"}});C.appendChild(S.getElement());let E=new Gm({init:!1,label:Vm("shape-fixed"),callback:function(t){m()},css:{flexGrow:"1"}});C.appendChild(E.getElement());let M=new Gm({init:!1,label:Vm("shape-snap"),title:Vm("shape-snap-title"),callback:function(t){m()},css:{flexGrow:"1"}});C.appendChild(M.getElement()),m(),this.getElement=function(){return i},this.setIsVisible=function(e){r=!!e,i.style.display=r?"block":"none",r&&(a.appendChild(t.colorSlider.getElement()),a.appendChild(t.colorSlider.getOutputElement()))},this.getShape=function(){return e},this.getMode=function(){return n},this.getIsEraser=function(){return b.getValue()},this.getOpacity=function(){return w.getValue()},this.getLineWidth=function(){return v.getValue()},this.getIsOutwards=function(){return S.getValue()},this.getIsFixed=function(){return E.getValue()},this.getIsSnap=function(){return M.getValue()}},FileTab:class{refresh(){}getElement(){return this.div}setIsVisible(t){t&&this.refresh()}triggerImport(){this.importButton.click()}constructor(t,e,i,r,a,o,s,l,c,h,u,d){this.exportType=r;const p=this;this.div=document.createElement("div");setTimeout((()=>{let c=document.createElement("div"),h=document.createElement("button"),u=document.createElement("button");h.style.cssFloat="left",Om.css(u,{cssFloat:"left",clear:"both"}),h.tabIndex=-1,u.tabIndex=-1,h.innerHTML=`<img src='${n(Vy)}' alt='icon' height='20'/>${Vm("file-new")}`,u.innerHTML=`<img src='${n(Ky)}' alt='icon' height='20'/>${Vm("file-save")}`,h.className="gridButton",u.className="gridButton",this.importButton=document.createElement("input"),this.importButton.tabIndex=-1,this.importButton.type="file",this.importButton.multiple=!0,this.importButton.accept="image",this.importButton.size="71",this.importButton.textContent="Import";let g,f,m=this.importButton;!function(){m=document.createElement("div"),m.className="gridButton",m.style.position="relative",m.style.cursor="pointer",m.style.cssFloat="left";let t=document.createElement("div");t.style.width="120px",t.style.height="28px",t.style.overflow="hidden",t.style.cursor="pointer",t.style.position="relative",m.appendChild(t),t.appendChild(p.importButton);let e=document.createElement("button");e.innerHTML="<img style='float:left' height='20' src='"+n(Wy)+"' alt='icon'/>"+Vm("file-import"),e.tabIndex=-1,Om.css(e,{width:"120px",display:"box",position:"absolute",left:"0",top:"0",cursor:"pointer"}),Om.css(p.importButton,{display:"none"}),m.appendChild(e),e.onclick=function(){p.importButton.click()}}(),this.importButton.onchange=function(t){o(p.importButton.files,"default"),p.importButton.value=""},g=Om.el({css:{display:"none",fontSize:"15px",marginLeft:"10px",marginTop:"10px",cssFloat:"left",width:"calc(50% - 15px)",height:"30px"}}),f=new Fb.Select({optionArr:[["png",Vm("file-save-png")],["psd",Vm("file-save-psd")],["layers",Vm("file-save-layers")]],initValue:r,onChange:function(t){a(r=t),s()}}),Om.css(f.getElement(),{width:"120px",height:"30px"}),g.appendChild(f.getElement()),h.onclick=l,u.onclick=function(){s()};let y=document.createElement("div");function x(){let t=document.createElement("div"),e=document.createElement("div"),n=document.createElement("div");return t.appendChild(e),t.appendChild(n),Om.css(e,{clear:"both"}),Om.css(n,{display:"none",marginLeft:"10px",marginRight:"10px",marginTop:"10px",borderBottom:"1px solid rgba(0,0,0,0.2)",clear:"both"}),t}y.textContent="⚠️ "+Vm("file-no-autosave"),Om.css(y,{textAlign:"center",marginTop:"10px",background:"rgb(243, 243, 161)",padding:"5px 0px",color:"rgba(0,0,0,0.65)",fontSize:"15px"}),p.fileBrowserStorage=new kb(e,i,d,t),Om.css(p.fileBrowserStorage.getElement(),{display:"none",margin:"10px"}),Om.append(c,[y,h,m,Om.el({css:{clear:"both"}}),u,g,Om.el({css:{clear:"both"}}),Om.el({css:{clear:"both"}}),x(),p.fileBrowserStorage.getElement(),x()]),this.div.appendChild(c)}),1)}},FilterTab:class{init(){const t=this;let e=Om.hasWebGl(),n=Fb.filterLib,i=[];if(Om.BbLog.emit({type:"init-filters"}),!Fb.filterLibStatus.isLoaded)throw new Error("filters not loaded");function r(e,n){let r=document.createElement("button"),a=n[e].buttonLabel?n[e].buttonLabel:n[e].name,o='<img height="20" width="18" src="'+n[e].icon+'" alt="icon" />';return r.innerHTML=o+a,r.className="gridButton",Om.css(r,{lineHeight:"20px",fontSize:"12px"}),r.tabIndex=-1,r.onclick=function(){if("apply"in n[e])if(n[e].isInstant)r.blur(),i(null),t.statusOverlay.out('"'+n[e].name+'" '+Vm("filter-applied"),!0);else{let r,a=t.klColorSlider.getSecondaryRGB(),o=n[e].getDialog({context:t.getCurrentLayerCtx(),canvas:t.getKlCanvas(),maxWidth:t.getKlMaxCanvasSize(),maxHeight:t.getKlMaxCanvasSize(),currentColorRgb:{r:t.getCurrentColor().r,g:t.getCurrentColor().g,b:t.getCurrentColor().b},secondaryColorRgb:{r:a.r,g:a.g,b:a.b}});if(!o)return;o.errorCallback=function(t){setTimeout((function(){throw alert("Error: could not perform action"),t}),0),r()};let s={};"width"in o&&(s.width=o.width+"px"),Fb.popup({target:t.klRootEl,message:"<b>"+n[e].name+"</b>",div:o.element,style:s,buttons:["Ok","Cancel"],clickOnEnter:"Ok",callback:function(t){!function(t,r){if("Cancel"==t)return void(r.destroy&&r.destroy());let a;try{a=r.getInput()}catch(t){throw-1!==t.message.indexOf(".getInput is not a function")?"filterDialog.getInput is not a function, filter: "+n[e].name:t}i(a)}(t,o)},closefunc:function(t){r=t}})}else alert("Application not fully loaded");function i(i){!1===n[e].apply({context:t.getCurrentLayerCtx(),canvas:t.getKlCanvas(),history:zm,input:i})&&alert("Couldn't apply the edit action"),!0===n[e].updateContext&&t.setCurrentLayer(t.getKlCanvas().getLayer(t.layerManager.getSelected())),!0===n[e].updatePos&&(t.klCanvasWorkspace.resetView(),t.handUi.update(t.klCanvasWorkspace.getScale(),t.klCanvasWorkspace.getAngleDeg())),t.layerManager.update()}},i[i.length]=r,r}function a(t,e){if(!e[t].webgl&&!e[t].ieFails)return;if(e[t].ieFails&&"Microsoft Internet Explorer"!==navigator.appName)return;let n=e[t].buttonLabel?e[t].buttonLabel:e[t].name,i=document.createElement("button"),r='<img style="opacity: 0.5" src="img/'+e[t].icon+'" />',a=e[t].name;return a.length>11&&(a="<span style='font-size: 12px'>"+n+"</span>"),i.innerHTML=r+a,i.className="gridButton",i.disabled=!0,i}function o(n,i,o){for(let s in i)!i.hasOwnProperty[s]&&n.includes(s)&&(t.isEmbed&&!i[s].inEmbed||(i[s].webgl&&e||i[s].neededWithWebGL||!i[s].webgl&&!e&&(!i[s].ieFails||"Microsoft Internet Explorer"!=navigator.appName)?o.appendChild(r(s,i)):(o.appendChild(a(s,i)),i[s]=void 0)))}let s=["cropExtend","flip","glPerspective","resize","rotate","transform"],l=[];for(let t in n)n.hasOwnProperty[t]||s.includes(t)||l.push(t);o(s,n,t.div);let c=document.createElement("div");if(c.className="gridHr",t.div.appendChild(c),o(l,n,t.div),!e){let e=Om.appendTextDiv(t.div,"Some actions are disabled because WebGL isn't working.");e.style.margin="10px",Om.css(e,{fontSize:"11px",color:"#555",background:"#ffe",padding:"10px",borderRadius:"10px",textAlign:"center"})}this.isInit=!0}getElement(){return this.div}show(){this.isInit||this.init(),this.div.style.display="block"}hide(){this.div.style.display="none"}constructor(t,e,n,i,r,a,o,s,l,c,h,u){this.klRootEl=t,this.klColorSlider=e,this.layerManager=n,this.setCurrentLayer=i,this.klCanvasWorkspace=r,this.handUi=a,this.getCurrentColor=o,this.getKlMaxCanvasSize=s,this.getKlCanvas=l,this.getCurrentLayerCtx=c,this.isEmbed=h,this.statusOverlay=u,this.isInit=!1,this.div=document.createElement("div")}},SettingsTab:class{getElement(){return this.el}constructor(t,e){const i=Xm.getLanguage();this.el=Om.el({content:`\n${Vm("settings-language")}: ${i.name} (${i.code})\n            `,css:{margin:"10px"}});const r=Om.el({content:Vm("settings-preferred-language")+":<br>",css:{marginTop:"10px"}}),o=[["auto",Vm("auto")]].concat(Um.map((t=>[t.code,t.name+` (${t.code})`]))),s=new Fb.Select({initValue:Pm.getItem("klecks-language")?Pm.getItem("klecks-language"):"auto",optionArr:o,onChange:t=>{"auto"===t?Pm.removeItem("klecks-language"):Pm.setItem("klecks-language",t),l.style.display="block"}}),l=Om.el({content:Vm("settings-language-reload"),css:{display:"none",marginTop:"5px"}});if(r.append(s.getElement(),l),this.el.append(r),Om.el({tagName:"button",parent:this.el,content:'<img height="20" width="18" src="'+n(_b)+'" alt="icon" style="margin-right: 5px"/>'+Vm("switch-ui-left-right"),onClick:()=>t(),css:{marginTop:"20px"},custom:{tabIndex:"-1"}}),this.el.append(Om.el({className:"gridHr",css:{margin:"10px 0"}})),e&&(this.el.append(e),!e.innerHTML)){Om.el({parent:e,css:{textAlign:"center"}}).append(Om.el({content:`<img alt="icon" height="20" style="vertical-align:middle" src="${n(Hb)}"> <a href="https://bitbof.com" target="_blank" tabIndex="-1">bitbof</a> © 2022<br>`}),Om.el({tagName:"a",content:Vm("licenses"),onClick:()=>{a("dYA4n").then((t=>{new Km({title:Om.el({content:Vm("licenses")}),content:Om.el({content:Om.el({content:t.licenses.replace(/\n/g,"<br>"),css:{padding:"20px"}}),css:{height:"100%",overflowY:"scroll"}}),width:800,isMaxHeight:!0})}))}}))}window.addEventListener("storage",(t=>{"klecks-language"===t.key&&s.setValue(Pm.getItem("klecks-language")?Pm.getItem("klecks-language"):"auto")}))}},klLayerManager:function(t,e,i){let r,a=t,o=[],s=e,l="right",c=Om.el({onClick:Om.handleClick,css:{position:"absolute",right:"280px",top:"500px",background:"#aaa",boxShadow:"1px 1px 3px rgba(0,0,0,0.3)",pointerEvents:"none",padding:"0",border:"1px solid #aaa",transition:"opacity 0.3s ease-out",userSelect:"none",colorScheme:"only light"}});Om.createCheckerDataUrl(4,(function(t){c.style.backgroundImage="url("+t+")"}));let h,u,d=document.createElement("canvas");d.style.display="block",d.width=200,d.height=200,c.appendChild(d);let p=!1,g=a.getLayers(),f=g.length-1,m=document.createElement("div");m.style.marginRight="10px",m.style.marginBottom="10px",m.style.marginLeft="10px",m.style.marginTop="10px",m.style.cursor="default";let y=document.createElement("div");function x(t){let e=document.createElement("div"),r=Om.el({content:Vm("layers-rename-name")+":",css:{marginRight:"5px"}});const o=Om.el({css:{display:"flex"}});let l=document.createElement("input");l.value=a.getLayer(t).name,l.setAttribute("data-ignore-focus","true");const c=Om.el({tagName:"Button",content:'<img src="'+n(fy)+'" height="20"/>',title:Vm("layers-rename-clear"),css:{marginLeft:"10px"},onClick:()=>{l.value="",l.focus()}}),h=[Vm("layers-rename-sketch"),Vm("layers-rename-colors"),Vm("layers-rename-lines"),Vm("background"),Vm("layers-rename-foreground")],u=[],d=Om.el({css:{display:"flex",flexWrap:"wrap",marginTop:"5px",marginLeft:"-5px"}});h.forEach((t=>{const e=Om.el({parent:d,tagName:"Button",content:t,onClick:()=>{l.value=e.textContent},css:{margin:"5px 0 0 5px"}});u.push(e)})),e.appendChild(r),r.append(o,d),o.append(l,c),setTimeout((function(){l.focus(),l.select()}),10),Wm({target:i,message:`<b>${Vm("layers-rename-title")}</b>`,div:e,buttons:[Vm("layers-rename"),"Cancel"],primaries:[Vm("layers-rename")],callback:function(e){if(Om.destroyEl(c),u.forEach((t=>{Om.destroyEl(t)})),u.splice(0,u.length),e===Vm("layers-rename")){if(l.value===a.getLayer(t).name)return;a.renameLayer(t,l.value),k(),zm.pause(!0),s(t),zm.pause(!1)}},clickOnEnter:Vm("layers-rename")})}Om.css(y,{width:"250px",position:"relative"});let b=Om.el({});m.disableButtons=function(){},m.enableButtons=function(){};let v,w,C=document.createElement("button"),S=document.createElement("button"),E=document.createElement("button"),M=document.createElement("button"),I=document.createElement("button");function k(){function t(t){let e=a.getLayer(t).name,n=g[t].opacity,i=g[t].context.canvas,r=document.createElement("div");r.className="layerBox",o[t]=r,r.posY=35*(g.length-1)-35*t,Om.css(r,{width:"250px",height:"34px",backgroundColor:"rgb( 220, 220, 220)",border:"1px solid #aaa",position:"absolute",left:"0 px",top:r.posY+"px",transition:"all 0.1s linear",borderRadius:"5px",boxSizing:"border-box"});let l=document.createElement("div");Om.css(l,{position:"relative"});let y=document.createElement("div");Om.css(y,{width:"250px",height:"34px"});let v,w=document.createElement("div");r.appendChild(l),l.appendChild(y),l.appendChild(w),r.spot=t;{let t=Om.fitInto(i.width,i.height,30,30,1),e=r.thumb=Om.canvas(t.width,t.height),n=e.getContext("2d");n.save(),e.width>i.width&&(n.imageSmoothingEnabled=!1),n.drawImage(i,0,0,e.width,e.height),n.restore(),Om.css(r.thumb,{position:"absolute",left:(32-r.thumb.width)/2+"px",top:(32-r.thumb.height)/2+"px",colorScheme:"only light"}),Om.createCheckerDataUrl(4,(function(t){e.style.backgroundImage="url("+t+")"}))}r.label=document.createElement("div"),r.lname=e,r.label.append(r.lname),Om.css(r.label,{position:"absolute",left:"38px",top:"1px",fontSize:"13px",width:"170px",height:"20px",overflow:"hidden",color:"#666",whiteSpace:"nowrap"}),r.label.ondblclick=function(){x(r.spot)},r.opacityLabel=document.createElement("div"),r.opacity=n,r.opacityLabel.append(parseInt(""+100*r.opacity)+"%"),Om.css(r.opacityLabel,{position:"absolute",left:"194px",top:"1px",fontSize:"13px",textAlign:"right",width:"50px",color:"#666",transition:"color 0.2s ease-in-out"});let C=new sy({init:r.opacity,width:204,pointSize:14,callback:function(t,e,n){return e?(v=a.getLayer(r.spot).opacity,void zm.pause(!0)):n?(zm.pause(!1),void(v!==t&&a.layerOpacity(r.spot,t))):(r.opacityLabel.innerHTML=Math.round(100*t)+"%",void a.layerOpacity(r.spot,t))}});Om.css(C.getEl(),{position:"absolute",left:"39px",top:"17px"}),r.opacitySlider=C,Om.setEventListener(r.thumb,"onpointerover",(function(t){if(0!==t.buttons&&(!t.pointerType||"touch"!==t.pointerType))return;let e=Om.fitInto(i.width,i.height,250,250,1);d.width===e.width&&d.height===e.height||(d.width=e.width,d.height=e.height);let n=d.getContext("2d");n.save(),d.width>i.width&&(n.imageSmoothingEnabled=!1),n.imageSmoothingQuality="high",n.clearRect(0,0,d.width,d.height),n.drawImage(i,0,0,d.width,d.height),n.restore(),Om.css(c,{top:t.clientY-d.height/2+"px",opacity:"0"}),!1===p&&(document.body.appendChild(c),p=!0),clearTimeout(u),u=setTimeout((function(){Om.css(c,{opacity:"1"})}),20),clearTimeout(h)})),Om.setEventListener(r.thumb,"onpointerout",(function(){clearTimeout(u),Om.css(c,{opacity:"0"}),clearTimeout(h),h=setTimeout((function(){p&&(document.body.removeChild(c),p=!1)}),300)})),y.appendChild(r.thumb),y.appendChild(r.label),y.appendChild(r.opacityLabel),y.appendChild(C.getEl());let S=!1,M=!1;r.pointerListener=new Om.PointerListener({target:y,maxPointers:1,onPointer:function(t){if("pointerdown"===t.type&&"left"===t.button)Om.css(r,{transition:"box-shadow 0.3s ease-in-out"}),r.style.zIndex="1",R=r.spot,M=!1,r.isSelected||(M=!0,m.activateLayer(r.spot)),S=!0;else if("pointermove"===t.type&&"left"===t.button){S&&(S=!1,Om.css(r,{boxShadow:"1px 3px 5px rgba(0,0,0,0.4)"})),r.posY+=t.dY;let e=Math.max(0,Math.min(35*(g.length-1),r.posY));r.style.top=e+"px",function(t,e){if((e=Math.min(g.length-1,Math.max(0,e)))===R)return;for(let n=0;n<g.length;n++){if(o[n].spot===t)continue;let i=o[n].spot;o[n].spot>t&&i--,i>=e&&i++,o[n].posY=35*(g.length-i-1),o[n].style.top=o[n].posY+"px"}R=e}(r.spot,T(r.posY))}if("pointerup"===t.type){Om.css(r,{transition:"all 0.1s linear"}),setTimeout((function(){Om.css(r,{boxShadow:""})}),20),r.posY=Math.max(0,Math.min(35*(g.length-1),r.posY)),r.style.zIndex="";let t=T(r.posY),e=r.spot;!function(t,e){if(isNaN(t)||isNaN(e))throw"layermanager - invalid move";for(let n=0;n<g.length;n++)!function(n){let i=o[n].spot;o[n].spot===t?i=e:(o[n].spot>t&&i--,i>=e&&i++),o[n].spot=i,o[n].posY=35*(g.length-i-1),o[n].style.top=o[n].posY+"px"}(n);if(t===e)return;a.moveLayer(f,e-t),g=a.getLayers(),f=e,E.disabled=0===f}(r.spot,t),e!=t&&(zm.pause(!0),s(f),zm.pause(!1)),e===t&&M&&s(f),M=!1}}}),b.appendChild(r)}for(r=zm.getState(),o=[];b.firstChild;){let t=b.firstChild;t.pointerListener.destroy(),t.opacitySlider.destroy(),b.removeChild(t)}for(let e=0;e<g.length;e++)t(e);m.activateLayer(f),b.style.height=35*o.length+"px"}function T(t){let e=parseInt(""+(t/35+.5));return e=Math.min(g.length-1,Math.max(0,e)),e=g.length-e-1,e}m.appendChild(function(){let t=document.createElement("div");return setTimeout((function(){Om.makeUnfocusable(C),Om.makeUnfocusable(S),Om.makeUnfocusable(E),Om.makeUnfocusable(M),Om.makeUnfocusable(I),C.style.cssFloat="left",S.style.cssFloat="left",E.style.cssFloat="left",M.style.cssFloat="left",I.style.cssFloat="left",C.title=Vm("layers-new"),S.title=Vm("layers-duplicate"),M.title=Vm("layers-remove"),E.title=Vm("layers-merge"),I.title=Vm("layers-rename-title"),C.style.paddingLeft="5px",C.style.paddingRight="3px",M.style.paddingLeft="5px",M.style.paddingRight="3px",S.style.paddingLeft="5px",S.style.paddingRight="3px",E.style.paddingLeft="5px",E.style.paddingRight="3px",I.style.height="30px",I.style.lineHeight="20px",C.innerHTML="<img src='"+n(dy)+"' height='20'/>",S.innerHTML="<img src='"+n(py)+"' height='20'/>",E.innerHTML="<img src='"+n(gy)+"' height='20'/>",M.innerHTML="<img src='"+n(fy)+"' height='20'/>",I.innerHTML="<img src='"+n(my)+"' height='20'/>",C.style.marginRight="5px",M.style.marginRight="5px",S.style.marginRight="5px",E.style.marginRight="5px",t.appendChild(C),t.appendChild(M),t.appendChild(S),t.appendChild(E),t.appendChild(I),t.appendChild(Om.el({css:{clear:"both"}}));let e=document.createElement("div");e.style.clear="both",e.style.height="10px",t.appendChild(e),C.onclick=function(){!1!==a.addLayer(f)&&(g=a.getLayers(),16===g.length&&(C.disabled=!0,S.disabled=!0),M.disabled=!1,f+=1,k(),zm.pause(!0),s(f),zm.pause(!1))},S.onclick=function(){!1!==a.duplicateLayer(f)&&(g=a.getLayers(),16===g.length&&(C.disabled=!0,S.disabled=!0),M.disabled=!1,f++,k(),zm.pause(!0),s(f),zm.pause(!1))},M.onclick=function(){o.length<=1||(a.removeLayer(f),f>0&&f--,g=a.getLayers(),k(),zm.pause(!0),s(f),zm.pause(!1),1===g.length&&(M.disabled=!0),g.length<16&&(C.disabled=!1,S.disabled=!1))},E.onclick=function(){f<=0||function(t){let e=document.createElement("div");e.innerHTML=Vm("layers-merge-description");let n=new cy({optionArr:[{id:t.mixModeStr,label:ky(t.mixModeStr)},{id:"source-in",label:"source-in"},{id:"source-out",label:"source-out"},{id:"source-atop",label:"source-atop"},{id:"destination-in",label:"destination-in"},{id:"destination-out",label:"destination-out"},{id:"destination-atop",label:"destination-atop"},{id:"xor",label:"xor"}],initId:t.mixModeStr,onChange:function(t){l()},isSmall:!0});n.getElement().style.marginTop="5px",e.appendChild(n.getElement());let r=document.createElement("canvas");r.title=Vm("preview");let a=document.createElement("div");a.innerHTML="<br/>",a.style.clear="both",e.appendChild(a),e.appendChild(r);let o=Om.fitInto(t.topCanvas.width,t.topCanvas.height,200,200,1);r.width=o.width,r.height=o.height,Om.css(r,{display:"block",marginLeft:"auto",marginRight:"auto",colorScheme:"only light"}),r.style.boxShadow="0 0 3px rgba(0,0,0,0.5)",Om.createCheckerDataUrl(4,(function(t){r.style.backgroundImage="url("+t+")"}));let s=Om.copyCanvas(r);function l(){let e=r.getContext("2d");e.save(),e.clearRect(0,0,r.width,r.height),r.width>t.topCanvas.width&&(e.imageSmoothingEnabled=!1),e.drawImage(t.bottomCanvas,0,0,r.width,r.height),"as-alpha"===n.getValue()?(e.globalCompositeOperation="destination-in",e.globalAlpha=t.topOpacity,e.drawImage(s,0,0,r.width,r.height)):(e.globalCompositeOperation=n.getValue(),e.globalAlpha=t.topOpacity,e.drawImage(t.topCanvas,0,0,r.width,r.height)),e.restore()}s.getContext("2d").drawImage(t.topCanvas,0,0,s.width,s.height),Om.convertToAlphaChannelCanvas(s),l();let c=new Om.KeyListener({onDown:function(t){"right"===t&&n.next(),"left"===t&&n.previous()}});Wm({target:i,message:`<b>${Vm("layers-merge-modal-title")}</b>`,div:e,buttons:["Ok","Cancel"],clickOnEnter:"Ok",callback:function(e){c.destroy(),n.destroy(),"Ok"===e&&t.callback(n.getValue())}})}({topCanvas:g[f].context.canvas,bottomCanvas:g[f-1].context.canvas,topOpacity:a.getLayer(f).opacity,mixModeStr:g[f].mixModeStr,callback:function(t){a.mergeLayers(f,f-1,t),g=a.getLayers(),f--,1===g.length&&(M.disabled=!0),g.length<16&&(C.disabled=!1,S.disabled=!1),k(),zm.pause(!0),s(f),zm.pause(!1)}})},I.onclick=function(){x(f)}}),1),t}()),v=Om.el({content:Vm("layers-blending")+"&nbsp;",css:{fontSize:"15px"}}),w=new Zm({optionArr:["source-over",null,"darken","multiply","color-burn",null,"lighten","screen","color-dodge",null,"overlay","soft-light","hard-light",null,"difference","exclusion",null,"hue","saturation","color","luminosity"].map((t=>t?[t,ky(t)]:null)),onChange:function(t){a.setMixMode(f,t),m.update(f)},css:{marginBottom:"10px"}}),v.appendChild(w.getElement()),m.appendChild(v),y.appendChild(b),m.appendChild(y);let R=0;return setInterval((function(){if("block"!==m.style.display)return;let t=zm.getState();if(t!==r){r=t;for(let t=0;t<o.length;t++)if(f===o[t].spot&&g[o[t].spot]){let e=o[t].thumb.getContext("2d");e.save(),e.clearRect(0,0,e.canvas.width,e.canvas.height),g[o[t].spot].context.canvas.width<o[t].thumb.width&&(e.imageSmoothingEnabled=!1),e.drawImage(g[o[t].spot].context.canvas,0,0,o[t].thumb.width,o[t].thumb.height),e.restore()}}}),1),m.update=function(t){g=a.getLayers(),(t||0===t)&&(f=t),M.disabled=1===g.length,16===g.length?(C.disabled=!0,S.disabled=!0):(C.disabled=!1,S.disabled=!1),setTimeout((function(){k()}),1)},m.getSelected=function(){return f},m.activateLayer=function(t){if(t<0||t>o.length-1)throw"invalid spotIndex "+t+", layerElArr.length "+o.length;f=t,w.setValue(g[f].mixModeStr);for(let t=0;t<o.length;t++)f===o[t].spot?(o[t].style.backgroundColor="rgb( 250, 250, 250)",o[t].label.style.color="#000",o[t].style.boxShadow="",o[t].style.border="1px solid var(--active-highlight-color)",o[t].opacitySlider.setActive(!0),o[t].isSelected=!0):(o[t].style.backgroundColor="rgb( 220, 220, 220)",o[t].label.style.color="#666",o[t].style.boxShadow="",o[t].style.border="1px solid rgb(158, 158, 158)",o[t].opacitySlider.setActive(!1),o[t].isSelected=!1);E.disabled=0===f},m.setUiState=function(t){l=""+t,"left"===l?Om.css(c,{left:"280px",right:""}):Om.css(c,{left:"",right:"280px"})},k(),m},klHistory:zm,DecoyKlHistory:Bm};class Ub{getElement(){return this.el}constructor(t){let e=document.createElement("div");function i(t){let e=6+(t.extraPadding?t.extraPadding:0),n=Om.el({className:"toolspace-row-button nohighlight",title:t.title,onClick:t.onClick,css:{padding:t.content?"":t.contain?e+"px 0":""}});if(t.content)n.appendChild(t.content);else{let e=Om.el({css:{backgroundImage:"url('"+t.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:t.contain?"contain":"",height:"100%"}});e.style.pointerEvents="none",n.appendChild(e)}return n.pointerListener=new Om.PointerListener({target:n,onEnterLeave:function(t){t?Om.addClassName(n,"toolspace-row-button-hover"):Om.removeClassName(n,"toolspace-row-button-hover")}}),n}this.el=e,Om.css(e,{height:"36px",display:"flex",backgroundImage:"linear-gradient(to top, rgba(255, 255, 255, 0) 20%, rgba(255, 255, 255, 0.6) 100%)"});let r=i({onClick:t.onSubmit,title:Vm("submit-title"),content:Om.el({content:Vm("submit"),className:"toolspace-row-button__submit",css:{display:"flex",alignItems:"center",justifyContent:"center",width:"100%",height:"100%"}}),contain:!0});r.style.width="45px";let a=i({onClick:t.onHelp,title:Vm("help"),image:n(qy),contain:!0}),o=i({onClick:t.onLeftRight,title:Vm("switch-ui-left-right"),image:n(_b),contain:!0});e.appendChild(r),e.appendChild(o),e.appendChild(a)}}const Nb=function(){let t={};var e;function n(t,e,n){return Math.max(t,Math.min(e,n))}function i(t){return{_:t,loadContentsOf:function(t){e=this._.gl,this._.loadContentsOf(t)},destroy:function(){e=this._.gl,this._.destroy()}}}function r(t){return i(y.fromElement(t))}function a(t,n){let i=e.UNSIGNED_BYTE;if(e.getExtension("OES_texture_float")&&e.getExtension("OES_texture_float_linear")){let t=new y(100,100,e.RGBA,e.FLOAT);try{t.drawTo((function(){i=e.FLOAT}))}catch(t){}t.destroy()}this._.texture&&this._.texture.destroy(),this._.spareTexture&&this._.spareTexture.destroy(),this.width=t,this.height=n,this._.texture=new y(t,n,e.RGBA,i),this._.spareTexture=new y(t,n,e.RGBA,i),this._.extraTexture=this._.extraTexture||new y(0,0,e.RGBA,i),this._.flippedShader=this._.flippedShader||new f(null,"        uniform sampler2D texture;        varying vec2 texCoord;        void main() {            gl_FragColor = texture2D(texture, vec2(texCoord.x, 1.0 - texCoord.y));        }    ","flippedShader"),this._.isInitialized=!0}function o(t,e,n){return this._.isInitialized&&t._.width==this.width&&t._.height==this.height||a.call(this,e||t._.width,n||t._.height),t._.use(),this._.texture.drawTo((function(){f.getDefaultShader().drawRect()})),this}function s(){return this._.texture.use(),this._.flippedShader.drawRect(),this}function l(t,e,n,i){(n||this._.texture).use(),this._.spareTexture.drawTo((function(){t.uniforms(e).drawRect()})),this._.spareTexture.swapWith(i||this._.texture)}function c(t){return t.parentNode.insertBefore(this,t),t.parentNode.removeChild(t),this}function h(){let t=new y(this._.texture.width,this._.texture.height,e.RGBA,e.UNSIGNED_BYTE);return this._.texture.use(),t.drawTo((function(){f.getDefaultShader().drawRect()})),i(t)}function u(){let t=this._.texture.width,n=this._.texture.height,i=new Uint8Array(t*n*4);return this._.texture.drawTo((function(){e.readPixels(0,0,t,n,e.RGBA,e.UNSIGNED_BYTE,i)})),i}function d(t){return function(){return e=this._.gl,t.apply(this,arguments)}}function p(t,e,n,i,r,a,o,s){let l=n-r,c=i-a,h=o-r,u=s-a,d=t-n+r-o,p=e-i+a-s,g=l*u-h*c,f=(d*u-h*p)/g,m=(l*p-d*c)/g;return[n-t+f*n,i-e+f*i,f,o-t+m*o,s-e+m*s,m,t,e,1]}function g(t){let e=t[0],n=t[1],i=t[2],r=t[3],a=t[4],o=t[5],s=t[6],l=t[7],c=t[8],h=e*a*c-e*o*l-n*r*c+n*o*s+i*r*l-i*a*s;return[(a*c-o*l)/h,(i*l-n*c)/h,(n*o-i*a)/h,(o*s-r*c)/h,(e*c-i*s)/h,(i*r-e*o)/h,(r*l-a*s)/h,(n*s-e*l)/h,(e*a-n*r)/h]}!function(){function t(){}try{document.createElement("canvas").getContext("experimental-webgl")}catch(t){}if(!e||-1!==e.getSupportedExtensions().indexOf("OES_texture_float_linear"))return;let n,i;(function(t){if(!t.getExtension("OES_texture_float"))return!1;let e=t.createFramebuffer(),n=t.createTexture();t.bindTexture(t.TEXTURE_2D,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,null),t.bindFramebuffer(t.FRAMEBUFFER,e),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,n,0);let i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,2,2,0,t.RGBA,t.FLOAT,new Float32Array([2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));let r=t.createProgram(),a=t.createShader(t.VERTEX_SHADER),o=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(a,"      attribute vec2 vertex;      void main() {        gl_Position = vec4(vertex, 0.0, 1.0);      }    "),t.shaderSource(o,"      uniform sampler2D texture;      void main() {        gl_FragColor = texture2D(texture, vec2(0.5));      }    "),t.compileShader(a),t.compileShader(o),t.attachShader(r,a),t.attachShader(r,o),t.linkProgram(r);let s=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0]),t.STREAM_DRAW),t.enableVertexAttribArray(0),t.vertexAttribPointer(0,2,t.FLOAT,!1,0,0);let l=new Uint8Array(4);return t.useProgram(r),t.viewport(0,0,1,1),t.bindTexture(t.TEXTURE_2D,i),t.drawArrays(t.POINTS,0,1),t.readPixels(0,0,1,1,t.RGBA,t.UNSIGNED_BYTE,l),127===l[0]||128===l[0]})(e)&&(n=WebGLRenderingContext.prototype.getExtension,i=WebGLRenderingContext.prototype.getSupportedExtensions,WebGLRenderingContext.prototype.getExtension=function(e){return"OES_texture_float_linear"===e?(void 0===(i=this).$OES_texture_float_linear$&&Object.defineProperty(i,"$OES_texture_float_linear$",{enumerable:!1,configurable:!1,writable:!1,value:new t}),i.$OES_texture_float_linear$):n.call(this,e);var i},WebGLRenderingContext.prototype.getSupportedExtensions=function(){let t=i.call(this);return-1===t.indexOf("OES_texture_float_linear")&&t.push("OES_texture_float_linear"),t})}(),t.canvas=function(){let t=document.createElement("canvas");try{e=t.getContext("experimental-webgl",{premultipliedAlpha:!1})}catch(t){e=null}if(!e)throw"This browser does not support WebGL";return t._={gl:e,isInitialized:!1,texture:null,spareTexture:null,flippedShader:null},t.texture=d(r),t.draw=d(o),t.update=d(s),t.replace=d(c),t.contents=d(h),t.getPixelArray=d(u),t.brightnessContrast=d(v),t.hexagonalPixelate=d(j),t.hueSaturation=d(E),t.colorHalftone=d(D),t.triangleBlur=d(P),t.unsharpMask=d(k),t.perspective=d(U),t.matrixWarp=d(F),t.bulgePinch=d(_),t.tiltShift=d(A),t.dotScreen=d(B),t.edgeWork=d(z),t.lensBlur=d(L),t.zoomBlur=d(O),t.noise=d(M),t.denoise=d(S),t.curves=d(C),t.swirl=d(N),t.ink=d(H),t.vignette=d(R),t.vibrance=d(T),t.sepia=d(I),t.invert=d(Y),t.toAlpha=d(X),t},t.splineInterpolate=w;var f=function(){function t(t){return"[object Number]"==Object.prototype.toString.call(t)}function n(t,n,i){let r=e.createShader(t);if(e.shaderSource(r,n),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS))throw"compile error: "+i+" - "+e.getShaderInfoLog(r);return r}let i=null;function r(t){let n=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,t);return null!==n&&0!==n.precision}function a(t,a,o){if(this.vertexAttribute=null,this.texCoordAttribute=null,this.program=e.createProgram(),t=t||"    attribute vec2 vertex;    attribute vec2 _texCoord;    varying vec2 texCoord;    void main() {        texCoord = _texCoord;        gl_Position = vec4(vertex * 2.0 - 1.0, 0.0, 1.0);    }",a=a||"    uniform sampler2D texture;    varying vec2 texCoord;    void main() {        gl_FragColor = texture2D(texture, texCoord);    }",null===i&&(i=r(e.HIGH_FLOAT)?"highp":r(e.MEDIUM_FLOAT)?"mediump":"lowp"),a="precision "+i+" float;"+a,e.attachShader(this.program,n(e.VERTEX_SHADER,t,o+"(vertex)")),e.attachShader(this.program,n(e.FRAGMENT_SHADER,a,o+"(fragment)")),e.linkProgram(this.program),!e.getProgramParameter(this.program,e.LINK_STATUS))throw"link error: "+e.getProgramInfoLog(this.program)}return a.prototype.destroy=function(){e.deleteProgram(this.program),this.program=null},a.prototype.uniforms=function(n){for(var i in e.useProgram(this.program),n){if(!n.hasOwnProperty(i))continue;let a=e.getUniformLocation(this.program,i);if(null===a)continue;let o=n[i];if(r=o,"[object Array]"==Object.prototype.toString.call(r))switch(o.length){case 1:e.uniform1fv(a,new Float32Array(o));break;case 2:e.uniform2fv(a,new Float32Array(o));break;case 3:e.uniform3fv(a,new Float32Array(o));break;case 4:e.uniform4fv(a,new Float32Array(o));break;case 9:e.uniformMatrix3fv(a,!1,new Float32Array(o));break;case 16:e.uniformMatrix4fv(a,!1,new Float32Array(o));break;default:throw"dont't know how to load uniform \""+i+'" of length '+o.length}else{if(!t(o))throw'attempted to set uniform "'+i+'" to invalid value '+(o||"undefined").toString();e.uniform1f(a,o)}}var r;return this},a.prototype.textures=function(t){for(var n in e.useProgram(this.program),t)t.hasOwnProperty(n)&&e.uniform1i(e.getUniformLocation(this.program,n),t[n]);return this},a.prototype.drawRect=function(t,n,i,r){let a,o=e.getParameter(e.VIEWPORT);n=n!==a?(n-o[1])/o[3]:0,t=t!==a?(t-o[0])/o[2]:0,i=i!==a?(i-o[0])/o[2]:1,r=r!==a?(r-o[1])/o[3]:1,null==e.vertexBuffer&&(e.vertexBuffer=e.createBuffer()),e.bindBuffer(e.ARRAY_BUFFER,e.vertexBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array([t,n,t,r,i,n,i,r]),e.STATIC_DRAW),null==e.texCoordBuffer&&(e.texCoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,e.texCoordBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,1]),e.STATIC_DRAW)),null==this.vertexAttribute&&(this.vertexAttribute=e.getAttribLocation(this.program,"vertex"),e.enableVertexAttribArray(this.vertexAttribute)),null==this.texCoordAttribute&&(this.texCoordAttribute=e.getAttribLocation(this.program,"_texCoord"),e.enableVertexAttribArray(this.texCoordAttribute)),e.useProgram(this.program),e.bindBuffer(e.ARRAY_BUFFER,e.vertexBuffer),e.vertexAttribPointer(this.vertexAttribute,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,e.texCoordBuffer),e.vertexAttribPointer(this.texCoordAttribute,2,e.FLOAT,!1,0,0),e.drawArrays(e.TRIANGLE_STRIP,0,4)},a.getDefaultShader=function(){return e.defaultShader=e.defaultShader||new a,e.defaultShader},a}();function m(t){let e=t.length;this.xa=[],this.ya=[],this.u=[],this.y2=[],t.sort((function(t,e){return t[0]-e[0]}));for(var n=0;n<e;n++)this.xa.push(t[n][0]),this.ya.push(t[n][1]);this.u[0]=0,this.y2[0]=0;for(n=1;n<e-1;++n){let t=this.xa[n+1]-this.xa[n-1],e=(this.xa[n]-this.xa[n-1])/t,i=e*this.y2[n-1]+2;this.y2[n]=(e-1)/i;let r=(this.ya[n+1]-this.ya[n])/(this.xa[n+1]-this.xa[n])-(this.ya[n]-this.ya[n-1])/(this.xa[n]-this.xa[n-1]);this.u[n]=(6*r/t-e*this.u[n-1])/i}this.y2[e-1]=0;for(n=e-2;n>=0;--n)this.y2[n]=this.y2[n]*this.y2[n+1]+this.u[n]}m.prototype.interpolate=function(t){let e=0,n=this.ya.length-1;for(;n-e>1;){let i=n+e>>1;this.xa[i]>t?n=i:e=i}let i=this.xa[n]-this.xa[e],r=(this.xa[n]-t)/i,a=(t-this.xa[e])/i;return r*this.ya[e]+a*this.ya[n]+((r*r*r-r)*this.y2[e]+(a*a*a-a)*this.y2[n])*(i*i)/6};var y=function(){function t(t,n,i,r){this.gl=e,this.id=e.createTexture(),this.width=t,this.height=n,this.format=i,this.type=r,e.bindTexture(e.TEXTURE_2D,this.id),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),t&&n&&e.texImage2D(e.TEXTURE_2D,0,this.format,t,n,0,this.format,this.type,null)}t.fromElement=function(n){let i=new t(0,0,e.RGBA,e.UNSIGNED_BYTE);return i.loadContentsOf(n),i},t.prototype.loadContentsOf=function(t){this.width=t.width||t.videoWidth,this.height=t.height||t.videoHeight,e.bindTexture(e.TEXTURE_2D,this.id),e.texImage2D(e.TEXTURE_2D,0,this.format,this.format,this.type,t)},t.prototype.initFromBytes=function(t,n,i){this.width=t,this.height=n,this.format=e.RGBA,this.type=e.UNSIGNED_BYTE,e.bindTexture(e.TEXTURE_2D,this.id),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,n,0,e.RGBA,this.type,new Uint8Array(i))},t.prototype.destroy=function(){e.deleteTexture(this.id),this.id=null},t.prototype.use=function(t){e.activeTexture(e.TEXTURE0+(t||0)),e.bindTexture(e.TEXTURE_2D,this.id)},t.prototype.unuse=function(t){e.activeTexture(e.TEXTURE0+(t||0)),e.bindTexture(e.TEXTURE_2D,null)},t.prototype.ensureFormat=function(t,n,i,r){if(1==arguments.length){let e=arguments[0];t=e.width,n=e.height,i=e.format,r=e.type}t==this.width&&n==this.height&&i==this.format&&r==this.type||(this.width=t,this.height=n,this.format=i,this.type=r,e.bindTexture(e.TEXTURE_2D,this.id),e.texImage2D(e.TEXTURE_2D,0,this.format,t,n,0,this.format,this.type,null))},t.prototype.drawTo=function(t){if(e.framebuffer=e.framebuffer||e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,e.framebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.id,0),e.checkFramebufferStatus(e.FRAMEBUFFER)!==e.FRAMEBUFFER_COMPLETE)throw new Error("incomplete framebuffer");e.viewport(0,0,this.width,this.height),t(),e.bindFramebuffer(e.FRAMEBUFFER,null)};let n=null;function i(t){null==n&&(n=document.createElement("canvas")),n.width=t.width,n.height=t.height;let e=n.getContext("2d");return e.clearRect(0,0,n.width,n.height),e}return t.prototype.fillUsingCanvas=function(t){return t(i(this)),this.format=e.RGBA,this.type=e.UNSIGNED_BYTE,e.bindTexture(e.TEXTURE_2D,this.id),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,n),this},t.prototype.toImage=function(t){this.use(),f.getDefaultShader().drawRect();let r=this.width*this.height*4,a=new Uint8Array(r),o=i(this),s=o.createImageData(this.width,this.height);e.readPixels(0,0,this.width,this.height,e.RGBA,e.UNSIGNED_BYTE,a);for(var l=0;l<r;l++)s.data[l]=a[l];o.putImageData(s,0,0),t.src=n.toDataURL()},t.prototype.swapWith=function(t){let e;e=t.id,t.id=this.id,this.id=e,e=t.width,t.width=this.width,this.width=e,e=t.height,t.height=this.height,this.height=e,e=t.format,t.format=this.format,this.format=e},t}();function x(t,e){return new f(null,t+"    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;    void main() {        vec2 coord = texCoord * texSize;        "+e+"        gl_FragColor = texture2D(texture, coord / texSize);        vec2 clampedCoord = clamp(coord, vec2(0.0), texSize);        if (coord != clampedCoord) {            /* fade to transparent if we are outside the image */            gl_FragColor.a *= max(0.0, 1.0 - length(coord - clampedCoord));        }    }","warp")}var b="    float random(vec3 scale, float seed) {        /* use the fragment position for a different seed per-pixel */        return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);    }";function v(t,i){return e.brightnessContrast=e.brightnessContrast||new f(null,"        uniform sampler2D texture;        uniform float brightness;        uniform float contrast;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);            color.rgb += brightness;            if (contrast > 0.0) {                color.rgb = (color.rgb - 0.5) / (1.0 - contrast) + 0.5;            } else {                color.rgb = (color.rgb - 0.5) * (1.0 + contrast) + 0.5;            }            gl_FragColor = color;        }    ","brightnessContrast"),l.call(this,e.brightnessContrast,{brightness:n(-1,t,1),contrast:n(-1,i,1)}),this}function w(t){let e=new m(t),i=[];for(var r=0;r<256;r++)i.push(n(0,Math.floor(256*e.interpolate(r/255)),255));return i}function C(t,n,i){t=w(t),1==arguments.length?n=i=t:(n=w(n),i=w(i));let r=[];for(var a=0;a<256;a++)r.splice(r.length,0,t[a],n[a],i[a],255);return this._.extraTexture.initFromBytes(256,1,r),this._.extraTexture.use(1),e.curves=e.curves||new f(null,"        uniform sampler2D texture;        uniform sampler2D map;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);            color.r = texture2D(map, vec2(color.r)).r;            color.g = texture2D(map, vec2(color.g)).g;            color.b = texture2D(map, vec2(color.b)).b;            gl_FragColor = color;        }    ","curves"),e.curves.textures({map:1}),l.call(this,e.curves,{}),this}function S(t){e.denoise=e.denoise||new f(null,"        uniform sampler2D texture;        uniform float exponent;        uniform float strength;        uniform vec2 texSize;        varying vec2 texCoord;        void main() {            vec4 center = texture2D(texture, texCoord);            vec4 color = vec4(0.0);            float total = 0.0;            for (float x = -4.0; x <= 4.0; x += 1.0) {                for (float y = -4.0; y <= 4.0; y += 1.0) {                    vec4 sample = texture2D(texture, texCoord + vec2(x, y) / texSize);                    float weight = 1.0 - abs(dot(sample.rgb - center.rgb, vec3(0.25)));                    weight = pow(weight, exponent);                    color += sample * weight;                    total += weight;                }            }            gl_FragColor = color / total;        }    ","denoise");for(var n=0;n<2;n++)l.call(this,e.denoise,{exponent:Math.max(0,t),texSize:[this.width,this.height]});return this}function E(t,i){return e.hueSaturation=e.hueSaturation||new f(null,"        uniform sampler2D texture;        uniform float hue;        uniform float saturation;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);                        /* hue adjustment, wolfram alpha: RotationTransform[angle, {1, 1, 1}][{x, y, z}] */            float angle = hue * 3.14159265;            float s = sin(angle), c = cos(angle);            vec3 weights = (vec3(2.0 * c, -sqrt(3.0) * s - c, sqrt(3.0) * s - c) + 1.0) / 3.0;            float len = length(color.rgb);            color.rgb = vec3(                dot(color.rgb, weights.xyz),                dot(color.rgb, weights.zxy),                dot(color.rgb, weights.yzx)            );                        /* saturation adjustment */            float average = (color.r + color.g + color.b) / 3.0;            if (saturation > 0.0) {                color.rgb += (average - color.rgb) * (1.0 - 1.0 / (1.001 - saturation));            } else {                color.rgb += (average - color.rgb) * (-saturation);            }                        gl_FragColor = color;        }    ","hueSaturation"),l.call(this,e.hueSaturation,{hue:n(-1,t,1),saturation:n(-1,i,1)}),this}function M(t){return e.noise=e.noise||new f(null,"        uniform sampler2D texture;        uniform float amount;        varying vec2 texCoord;        float rand(vec2 co) {            return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);        }        void main() {            vec4 color = texture2D(texture, texCoord);                        float diff = (rand(texCoord) - 0.5) * amount;            color.r += diff;            color.g += diff;            color.b += diff;                        gl_FragColor = color;        }    ","noise"),l.call(this,e.noise,{amount:n(0,t,1)}),this}function I(t){return e.sepia=e.sepia||new f(null,"        uniform sampler2D texture;        uniform float amount;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);            float r = color.r;            float g = color.g;            float b = color.b;                        color.r = min(1.0, (r * (1.0 - (0.607 * amount))) + (g * (0.769 * amount)) + (b * (0.189 * amount)));            color.g = min(1.0, (r * 0.349 * amount) + (g * (1.0 - (0.314 * amount))) + (b * 0.168 * amount));            color.b = min(1.0, (r * 0.272 * amount) + (g * 0.534 * amount) + (b * (1.0 - (0.869 * amount))));                        gl_FragColor = color;        }    ","sepia"),l.call(this,e.sepia,{amount:n(0,t,1)}),this}function k(t,n){return e.unsharpMask=e.unsharpMask||new f(null,"        uniform sampler2D blurredTexture;        uniform sampler2D originalTexture;        uniform float strength;        uniform float threshold;        varying vec2 texCoord;        void main() {            vec4 blurred = texture2D(blurredTexture, texCoord);            vec4 original = texture2D(originalTexture, texCoord);            gl_FragColor = mix(blurred, original, 1.0 + strength);        }    ","unsharpMask"),this._.extraTexture.ensureFormat(this._.texture),this._.texture.use(),this._.extraTexture.drawTo((function(){f.getDefaultShader().drawRect()})),this._.extraTexture.use(1),this.triangleBlur(t),e.unsharpMask.textures({originalTexture:1}),l.call(this,e.unsharpMask,{strength:n}),this._.extraTexture.unuse(1),this}function T(t){return e.vibrance=e.vibrance||new f(null,"        uniform sampler2D texture;        uniform float amount;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);            float average = (color.r + color.g + color.b) / 3.0;            float mx = max(color.r, max(color.g, color.b));            float amt = (mx - average) * (-amount * 3.0);            color.rgb = mix(color.rgb, vec3(mx), amt);            gl_FragColor = color;        }    ","vibrance"),l.call(this,e.vibrance,{amount:n(-1,t,1)}),this}function R(t,i){return e.vignette=e.vignette||new f(null,"        uniform sampler2D texture;        uniform float size;        uniform float amount;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);                        float dist = distance(texCoord, vec2(0.5, 0.5));            color.rgb *= smoothstep(0.8, size * 0.799, dist * (amount + size));                        gl_FragColor = color;        }    ","vignette"),l.call(this,e.vignette,{size:n(0,t,1),amount:n(0,i,1)}),this}function L(t,i,r){e.lensBlurPrePass=e.lensBlurPrePass||new f(null,"        uniform sampler2D texture;        uniform float power;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);            color = pow(color, vec4(power));            gl_FragColor = vec4(color);        }    ","lensBlurPrePass");let a="        uniform sampler2D texture0;        uniform sampler2D texture1;        uniform vec2 delta0;        uniform vec2 delta1;        uniform float power;        varying vec2 texCoord;        "+b+"        vec4 sample(vec2 delta) {            /* randomize the lookup values to hide the fixed number of samples */            float offset = random(vec3(delta, 151.7182), 0.0);                        vec4 color = vec4(0.0);            float total = 0.0;            for (float t = 0.0; t <= 30.0; t++) {                float percent = (t + offset) / 30.0;                color += texture2D(texture0, texCoord + delta * percent);                total += 1.0;            }            return color / total;        }    ";e.lensBlur0=e.lensBlur0||new f(null,a+"        void main() {            gl_FragColor = sample(delta0);        }    ","lensBlur0"),e.lensBlur1=e.lensBlur1||new f(null,a+"        void main() {            gl_FragColor = (sample(delta0) + sample(delta1)) * 0.5;        }    ","lensBlur1"),e.lensBlur2=e.lensBlur2||new f(null,a+"        void main() {            vec4 color = (sample(delta0) + 2.0 * texture2D(texture1, texCoord)) / 3.0;            gl_FragColor = pow(color, vec4(power));        }    ","lensBlur2").textures({texture1:1});let o=[];for(var s=0;s<3;s++){let e=r+s*Math.PI*2/3;o.push([t*Math.sin(e)/this.width,t*Math.cos(e)/this.height])}let c=Math.pow(10,n(-1,i,1));return l.call(this,e.lensBlurPrePass,{power:c}),this._.extraTexture.ensureFormat(this._.texture),l.call(this,e.lensBlur0,{delta0:o[0]},this._.texture,this._.extraTexture),l.call(this,e.lensBlur1,{delta0:o[1],delta1:o[2]},this._.extraTexture,this._.extraTexture),l.call(this,e.lensBlur0,{delta0:o[1]}),this._.extraTexture.use(1),l.call(this,e.lensBlur2,{power:1/c,delta0:o[2]}),this}function A(t,n,i,r,a,o){e.tiltShift=e.tiltShift||new f(null,"        uniform sampler2D texture;        uniform float blurRadius;        uniform float gradientRadius;        uniform vec2 start;        uniform vec2 end;        uniform vec2 delta;        uniform vec2 texSize;        varying vec2 texCoord;        "+b+"        void main() {            vec4 color = vec4(0.0);            float total = 0.0;                        /* randomize the lookup values to hide the fixed number of samples */            float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);                        vec2 normal = normalize(vec2(start.y - end.y, end.x - start.x));            float radius = smoothstep(0.0, 1.0, abs(dot(texCoord * texSize - start, normal)) / gradientRadius) * blurRadius;            for (float t = -30.0; t <= 30.0; t++) {                float percent = (t + offset - 0.5) / 30.0;                float weight = 1.0 - abs(percent);                vec4 sample = texture2D(texture, texCoord + delta / texSize * percent * radius);                                /* switch to pre-multiplied alpha to correctly blur transparent images */                sample.rgb *= sample.a;                                color += sample * weight;                total += weight;            }                        gl_FragColor = color / total;                        /* switch back from pre-multiplied alpha */            gl_FragColor.rgb /= gl_FragColor.a + 0.00001;        }    ","tiltShift");let s=i-t,c=r-n,h=Math.sqrt(s*s+c*c);return l.call(this,e.tiltShift,{blurRadius:a,gradientRadius:o,start:[t,n],end:[i,r],delta:[s/h,c/h],texSize:[this.width,this.height]}),l.call(this,e.tiltShift,{blurRadius:a,gradientRadius:o,start:[t,n],end:[i,r],delta:[-c/h,s/h],texSize:[this.width,this.height]}),this}function P(t){return e.triangleBlur=e.triangleBlur||new f(null,"        uniform sampler2D texture;        uniform vec2 delta;        varying vec2 texCoord;        "+b+"        void main() {            vec4 color = vec4(0.0);            float total = 0.0;                        /* randomize the lookup values to hide the fixed number of samples */            float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);                        for (float t = -30.0; t <= 30.0; t++) {                float percent = (t + offset - 0.5) / 30.0;                float weight = 1.0 - abs(percent);                vec4 sample = texture2D(texture, texCoord + delta * percent);                                /* switch to pre-multiplied alpha to correctly blur transparent images */                sample.rgb *= sample.a;                                color += sample * weight;                total += weight;            }                        gl_FragColor = color / total;                        /* switch back from pre-multiplied alpha */            gl_FragColor.rgb /= gl_FragColor.a + 0.00001;        }    ","triangleBlur"),l.call(this,e.triangleBlur,{delta:[t/this.width,0]}),l.call(this,e.triangleBlur,{delta:[0,t/this.height]}),this}function O(t,n,i){return e.zoomBlur=e.zoomBlur||new f(null,"        uniform sampler2D texture;        uniform vec2 center;        uniform float strength;        uniform vec2 texSize;        varying vec2 texCoord;        "+b+"        void main() {            vec4 color = vec4(0.0);            float total = 0.0;            vec2 toCenter = center - texCoord * texSize;                        /* randomize the lookup values to hide the fixed number of samples */            float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);                        for (float t = 0.0; t <= 40.0; t++) {                float percent = (t + offset) / 40.0;                float weight = 4.0 * (percent - percent * percent);                vec4 sample = texture2D(texture, texCoord + toCenter * percent * strength / texSize);                                /* switch to pre-multiplied alpha to correctly blur transparent images */                sample.rgb *= sample.a;                                color += sample * weight;                total += weight;            }                        gl_FragColor = color / total;                        /* switch back from pre-multiplied alpha */            gl_FragColor.rgb /= gl_FragColor.a + 0.00001;        }    ","zoomBlur"),l.call(this,e.zoomBlur,{center:[t,n],strength:i,texSize:[this.width,this.height]}),this}function D(t,n,i,r){return e.colorHalftone=e.colorHalftone||new f(null,"        uniform sampler2D texture;        uniform vec2 center;        uniform float angle;        uniform float scale;        uniform vec2 texSize;        varying vec2 texCoord;                float pattern(float angle) {            float s = sin(angle), c = cos(angle);            vec2 tex = texCoord * texSize - center;            vec2 point = vec2(                c * tex.x - s * tex.y,                s * tex.x + c * tex.y            ) * scale;            return (sin(point.x) * sin(point.y)) * 4.0;        }                void main() {            vec4 color = texture2D(texture, texCoord);            vec3 cmy = 1.0 - color.rgb;            float k = min(cmy.x, min(cmy.y, cmy.z));            cmy = (cmy - k) / (1.0 - k);            cmy = clamp(cmy * 10.0 - 3.0 + vec3(pattern(angle + 0.26179), pattern(angle + 1.30899), pattern(angle)), 0.0, 1.0);            k = clamp(k * 10.0 - 5.0 + pattern(angle + 0.78539), 0.0, 1.0);            gl_FragColor = vec4(1.0 - cmy - k, color.a);        }    ","colorHalftone"),l.call(this,e.colorHalftone,{center:[t,n],angle:i,scale:Math.PI/r,texSize:[this.width,this.height]}),this}function B(t,n,i,r){return e.dotScreen=e.dotScreen||new f(null,"        uniform sampler2D texture;        uniform vec2 center;        uniform float angle;        uniform float scale;        uniform vec2 texSize;        varying vec2 texCoord;                float pattern() {            float s = sin(angle), c = cos(angle);            vec2 tex = texCoord * texSize - center;            vec2 point = vec2(                c * tex.x - s * tex.y,                s * tex.x + c * tex.y            ) * scale;            return (sin(point.x) * sin(point.y)) * 4.0;        }                void main() {            vec4 color = texture2D(texture, texCoord);            float average = (color.r + color.g + color.b) / 3.0;            gl_FragColor = vec4(vec3(average * 10.0 - 5.0 + pattern()), color.a);        }    ","dotScreen"),l.call(this,e.dotScreen,{center:[t,n],angle:i,scale:Math.PI/r,texSize:[this.width,this.height]}),this}function z(t){return e.edgeWork1=e.edgeWork1||new f(null,"        uniform sampler2D texture;        uniform vec2 delta;        varying vec2 texCoord;        "+b+"        void main() {            vec2 color = vec2(0.0);            vec2 total = vec2(0.0);                        /* randomize the lookup values to hide the fixed number of samples */            float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);                        for (float t = -30.0; t <= 30.0; t++) {                float percent = (t + offset - 0.5) / 30.0;                float weight = 1.0 - abs(percent);                vec3 sample = texture2D(texture, texCoord + delta * percent).rgb;                float average = (sample.r + sample.g + sample.b) / 3.0;                color.x += average * weight;                total.x += weight;                if (abs(t) < 15.0) {                    weight = weight * 2.0 - 1.0;                    color.y += average * weight;                    total.y += weight;                }            }            gl_FragColor = vec4(color / total, 0.0, 1.0);        }    ","edgeWork1"),e.edgeWork2=e.edgeWork2||new f(null,"        uniform sampler2D texture;        uniform vec2 delta;        varying vec2 texCoord;        "+b+"        void main() {            vec2 color = vec2(0.0);            vec2 total = vec2(0.0);                        /* randomize the lookup values to hide the fixed number of samples */            float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);                        for (float t = -30.0; t <= 30.0; t++) {                float percent = (t + offset - 0.5) / 30.0;                float weight = 1.0 - abs(percent);                vec2 sample = texture2D(texture, texCoord + delta * percent).xy;                color.x += sample.x * weight;                total.x += weight;                if (abs(t) < 15.0) {                    weight = weight * 2.0 - 1.0;                    color.y += sample.y * weight;                    total.y += weight;                }            }            float c = clamp(10000.0 * (color.y / total.y - color.x / total.x) + 0.5, 0.0, 1.0);            gl_FragColor = vec4(c, c, c, 1.0);        }    ","edgeWork2"),l.call(this,e.edgeWork1,{delta:[t/this.width,0]}),l.call(this,e.edgeWork2,{delta:[0,t/this.height]}),this}function j(t,n,i){return e.hexagonalPixelate=e.hexagonalPixelate||new f(null,"        uniform sampler2D texture;        uniform vec2 center;        uniform float scale;        uniform vec2 texSize;        varying vec2 texCoord;        void main() {            vec2 tex = (texCoord * texSize - center) / scale;            tex.y /= 0.866025404;            tex.x -= tex.y * 0.5;                        vec2 a;            if (tex.x + tex.y - floor(tex.x) - floor(tex.y) < 1.0) a = vec2(floor(tex.x), floor(tex.y));            else a = vec2(ceil(tex.x), ceil(tex.y));            vec2 b = vec2(ceil(tex.x), floor(tex.y));            vec2 c = vec2(floor(tex.x), ceil(tex.y));                        vec3 TEX = vec3(tex.x, tex.y, 1.0 - tex.x - tex.y);            vec3 A = vec3(a.x, a.y, 1.0 - a.x - a.y);            vec3 B = vec3(b.x, b.y, 1.0 - b.x - b.y);            vec3 C = vec3(c.x, c.y, 1.0 - c.x - c.y);                        float alen = length(TEX - A);            float blen = length(TEX - B);            float clen = length(TEX - C);                        vec2 choice;            if (alen < blen) {                if (alen < clen) choice = a;                else choice = c;            } else {                if (blen < clen) choice = b;                else choice = c;            }                        choice.x += choice.y * 0.5;            choice.y *= 0.866025404;            choice *= scale / texSize;            gl_FragColor = texture2D(texture, choice + center / texSize);        }    ","hexagonalPixelate"),l.call(this,e.hexagonalPixelate,{center:[t,n],scale:i,texSize:[this.width,this.height]}),this}function H(t){return e.ink=e.ink||new f(null,"        uniform sampler2D texture;        uniform float strength;        uniform vec2 texSize;        varying vec2 texCoord;        void main() {            vec2 dx = vec2(1.0 / texSize.x, 0.0);            vec2 dy = vec2(0.0, 1.0 / texSize.y);            vec4 color = texture2D(texture, texCoord);            float bigTotal = 0.0;            float smallTotal = 0.0;            vec3 bigAverage = vec3(0.0);            vec3 smallAverage = vec3(0.0);            for (float x = -2.0; x <= 2.0; x += 1.0) {                for (float y = -2.0; y <= 2.0; y += 1.0) {                    vec3 sample = texture2D(texture, texCoord + dx * x + dy * y).rgb;                    bigAverage += sample;                    bigTotal += 1.0;                    if (abs(x) + abs(y) < 2.0) {                        smallAverage += sample;                        smallTotal += 1.0;                    }                }            }            vec3 edge = max(vec3(0.0), bigAverage / bigTotal - smallAverage / smallTotal);            gl_FragColor = vec4(color.rgb - dot(edge, edge) * strength * 100000.0, color.a);        }    ","ink"),l.call(this,e.ink,{strength:t*t*t*t*t,texSize:[this.width,this.height]}),this}function _(t,i,r,a){return e.bulgePinch=e.bulgePinch||x("        uniform float radius;        uniform float strength;        uniform vec2 center;    ","        coord -= center;        float distance = length(coord);        if (distance < radius) {            float percent = distance / radius;            if (strength > 0.0) {                coord *= mix(1.0, smoothstep(0.0, radius / distance, percent), strength * 0.75);            } else {                coord *= mix(1.0, pow(percent, 1.0 + strength * 0.75) * radius / distance, 1.0 - percent);            }        }        coord += center;    "),l.call(this,e.bulgePinch,{radius:r,strength:n(-1,a,1),center:[t,i],texSize:[this.width,this.height]}),this}function F(t,n,i){if(e.matrixWarp=e.matrixWarp||x("        uniform mat3 matrix;        uniform bool useTextureSpace;    ","        if (useTextureSpace) coord = coord / texSize * 2.0 - 1.0;        vec3 warp = matrix * vec3(coord, 1.0);        coord = warp.xy / warp.z;        if (useTextureSpace) coord = (coord * 0.5 + 0.5) * texSize;    "),4==(t=Array.prototype.concat.apply([],t)).length)t=[t[0],t[1],0,t[2],t[3],0,0,0,1];else if(9!=t.length)throw"can only warp with 2x2 or 3x3 matrix";return l.call(this,e.matrixWarp,{matrix:n?g(t):t,texSize:[this.width,this.height],useTextureSpace:0|i}),this}function U(t,e){let n=p.apply(null,e),i=p.apply(null,t),r=function(t,e){return[t[0]*e[0]+t[1]*e[3]+t[2]*e[6],t[0]*e[1]+t[1]*e[4]+t[2]*e[7],t[0]*e[2]+t[1]*e[5]+t[2]*e[8],t[3]*e[0]+t[4]*e[3]+t[5]*e[6],t[3]*e[1]+t[4]*e[4]+t[5]*e[7],t[3]*e[2]+t[4]*e[5]+t[5]*e[8],t[6]*e[0]+t[7]*e[3]+t[8]*e[6],t[6]*e[1]+t[7]*e[4]+t[8]*e[7],t[6]*e[2]+t[7]*e[5]+t[8]*e[8]]}(g(n),i);return this.matrixWarp(r)}function N(t,n,i,r){return e.swirl=e.swirl||x("        uniform float radius;        uniform float angle;        uniform vec2 center;    ","        coord -= center;        float distance = length(coord);        if (distance < radius) {            float percent = (radius - distance) / radius;            float theta = percent * percent * angle;            float s = sin(theta);            float c = cos(theta);            coord = vec2(                coord.x * c - coord.y * s,                coord.x * s + coord.y * c            );        }        coord += center;    "),l.call(this,e.swirl,{radius:i,center:[t,n],angle:r,texSize:[this.width,this.height]}),this}function Y(){return e.invert=e.invert||new f(null,"    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;        void main() {        vec4 color = texture2D(texture, texCoord);        gl_FragColor = vec4(1.0 - color.r, 1.0 - color.g, 1.0 - color.b, color.a);    }","invert"),l.call(this,e.invert,{texSize:[this.width,this.height]}),this}function X(t,n){return e.toAlpha=e.toAlpha||new f(null,"    uniform bool isInverted;    uniform vec4 replace;    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;        void main() {        vec4 color = texture2D(texture, texCoord);        float alpha = (color.r + color.g + color.b) / 3.0;        if (isInverted) alpha = 1.0 - alpha;        alpha = min(color.a, alpha);        if (replace.a > 0.0) color = replace;        gl_FragColor = vec4(color.r, color.g, color.b, alpha);    }","toAlpha"),l.call(this,e.toAlpha,{isInverted:t?1:0,replace:n?[n.r/255,n.g/255,n.b/255,n.a]:[0,0,0,0],texSize:[this.width,this.height]}),this}return t}();let Yb=null;try{Yb=Nb.canvas()}catch(t){}function Xb(){if(!Yb||Yb._.gl.isContextLost())try{Yb=Nb.canvas()}catch(t){}return Yb}const Vb={getDialog(t){let e=document.createElement("div"),n={element:e},i=t.context,r=t.canvas;if(!i||!r)return!1;let a=r.getLayers(),o=r.getLayerIndex(i.canvas),s=Om.fitInto(i.canvas.width,i.canvas.height,280,200,1),l=parseInt(""+s.width),c=parseInt(""+s.height),h=Om.canvas(l,c);{const t=h.getContext("2d");t.save(),h.width>i.canvas.width&&(t.imageSmoothingEnabled=!1),t.drawImage(i.canvas,0,0,l,c),t.restore()}return setTimeout((function(){let t=0,i=0;e.innerHTML=Vm("filter-bright-contrast-description")+"<br/><br/>";let r=Xb();if(!r)return;let s=r.texture(h);r.draw(s).update();let u=new ny({label:Vm("filter-bright-contrast-brightness"),width:300,height:30,min:0,max:100,initValue:50*(t+1),eventResMs:60,onChange:function(e){t=e/50-1,r.draw(s).brightnessContrast(t,i).update(),f.render()}}),d=new ny({label:Vm("filter-bright-contrast-contrast"),width:300,height:30,min:0,max:100,initValue:50*(i+1),eventResMs:60,onChange:function(e){i=e/50-1,r.draw(s).brightnessContrast(t,i).update(),f.render()}});u.getElement().style.marginBottom="10px",e.appendChild(u.getElement()),e.appendChild(d.getElement());let p=document.createElement("div");Om.css(p,{width:"340px",marginLeft:"-20px",height:"220px",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",position:"relative",userSelect:"none",display:"flex",alignItems:"center",justifyContent:"center",colorScheme:"only light"});let g=[];for(let t=0;t<a.length;t++)g.push({image:t===o?r:a[t].context.canvas,opacity:a[t].opacity,mixModeStr:a[t].mixModeStr});let f=new By({width:parseInt(""+l),height:parseInt(""+c),layers:g}),m=Om.el({css:{position:"relative",boxShadow:"0 0 5px rgba(0,0,0,0.5)",width:parseInt(""+l)+"px",height:parseInt(""+c)+"px"}});m.appendChild(f.getElement()),p.appendChild(m),e.appendChild(p);try{r.draw(s).brightnessContrast(t,i).update(),f.render()}catch(t){e.errorCallback(t)}n.destroy=()=>{u.destroy(),d.destroy(),s.destroy()},n.getInput=function(){return n.destroy(),{brightness:t,contrast:i}}}),1),n},apply(t){let e=t.context,n=t.input.brightness,i=t.input.contrast,r=t.history;if(!e||null===n||null===i||!r)return!1;r.pause(!0);let a=Xb();if(!a)return!1;let o=a.texture(e.canvas);return a.draw(o).brightnessContrast(n,i).update(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.drawImage(a,0,0),o.destroy(),r.pause(!1),r.push({tool:["filter","glBrightnessContrast"],action:"apply",params:[{input:t.input}]}),!0}},Wb={getDialog(t){const e=t.canvas;if(!e)return!1;const n=Om.canvas();{let t=Om.fitInto(e.getWidth(),e.getHeight(),560,400,1),i=parseInt(""+t.width),r=parseInt(""+t.height),a=i/e.getWidth();n.width=i,n.height=r,n.style.display="block",n.getContext("2d").drawImage(e.getCompleteCanvas(a),0,0,i,r)}const i=document.createElement("div"),r={element:i};i.innerHTML=Vm("filter-crop-description")+"<br/><br/>";let a=0,o=0,s=0,l=0,c=!1,h=!1,u=!1,d=!1;const p=t.maxWidth,g=t.maxHeight;let f;const m=Om.el({css:{lineHeight:"30px",height:"35px"}}),y=Om.el({css:{lineHeight:"30px",height:"35px"}});i.appendChild(m),i.appendChild(y);const x=qm({init:0,type:"number",min:-e.getWidth(),max:p,css:{width:"75px",marginRight:"20px"},callback:function(t){c=!0,S()}}),b=qm({init:0,type:"number",min:-e.getWidth(),max:p,css:{width:"75px"},callback:function(t){h=!0,S()}}),v=qm({init:0,type:"number",min:-e.getHeight(),max:g,css:{width:"75px",marginRight:"20px"},callback:function(t){u=!0,S()}}),w=qm({init:0,type:"number",min:-e.getHeight(),max:g,css:{width:"75px"},callback:function(t){d=!0,S()}}),C={display:"inline-block",width:"60px"};function S(){a=parseInt(x.value),o=parseInt(b.value),s=parseInt(v.value),l=parseInt(w.value);let t=e.getWidth()+a+o,n=e.getHeight()+s+l;t<=0&&(c&&(a=-e.getWidth()-o+1,x.value=""+a),h&&(o=-e.getWidth()-a+1,b.value=""+o),t=1),t>p&&(c&&(a=-e.getWidth()-o+p,x.value=""+a),h&&(o=-e.getWidth()-a+p,b.value=""+o),t=p),n<=0&&(u&&(s=-e.getHeight()-l+1,v.value=""+s),d&&(l=-e.getHeight()-s+1,w.value=""+l),n=1),n>g&&(u&&(s=-e.getHeight()-l+g,v.value=""+s),d&&(l=-e.getHeight()-s+g,w.value=""+l),n=g),D.setTransform({x:-a,y:-s,width:t,height:n}),c=!1,h=!1,u=!1,d=!1}m.append(Om.el({content:Vm("filter-crop-left")+":",css:C}),x,Om.el({content:Vm("filter-crop-right")+":",css:C}),b),y.append(Om.el({content:Vm("filter-crop-top")+":",css:C}),v,Om.el({content:Vm("filter-crop-bottom")+":",css:C}),w);let E=!0,M=new Gm({init:!0,label:Vm("filter-crop-rule-thirds"),allowTab:!0,callback:function(t){E=t,D.showThirds(E)}});i.appendChild(Om.el({css:{clear:"both"}}));let I={r:0,g:0,b:0,a:0};const k=[{r:0,g:0,b:0,a:0},{r:255,g:255,b:255,a:1},{r:0,g:0,b:0,a:1}];k.push({r:t.currentColorRgb.r,g:t.currentColorRgb.g,b:t.currentColorRgb.b,a:1}),k.push({r:t.secondaryColorRgb.r,g:t.secondaryColorRgb.g,b:t.secondaryColorRgb.b,a:1});const T=new ly({label:Vm("filter-crop-fill"),colorArr:k,onChange:function(t){I=t,function(t){let e;0===t.a?(e="rgba(0,0,0,0.5)",P.style.background="",n.style.background=""):(e=t.r+t.g+t.b<382.5?"rgba(255,255,255,0.5)":"rgba(0,0,0,0.5)",P.style.background=Om.ColorConverter.toRgbStr(t),Om.createCheckerDataUrl(parseInt(""+50*f),(function(t){n.style.background="url("+t+")"})));n.style.boxShadow="0 0 3px 1px "+e}(t)}}),R=Om.el({css:{display:"flex",justifyContent:"space-between"}});function L(t){const i=Om.fitInto(t.width,t.height,260,180,1);f=i.width/t.width;const r=Om.centerWithin(340,220,i.width,i.height);n.style.width=e.getWidth()*f+"px",n.style.height=e.getHeight()*f+"px",O.style.left=r.x-t.x*f+"px",O.style.top=r.y-t.y*f+"px",a=parseInt(""+-t.x),s=parseInt(""+-t.y),o=parseInt(""+(t.x+t.width-e.getWidth())),l=parseInt(""+(t.y+t.height-e.getHeight())),x.value=""+a,v.value=""+s,b.value=""+o,w.value=""+l,Om.createCheckerDataUrl(parseInt(""+50*f),(function(t){A.style.background="url("+t+")",0!==I.a&&(n.style.background="url("+t+")")})),A.style.backgroundPosition=r.x+"px "+r.y+"px",D.setScale(f)}i.appendChild(R),R.appendChild(M.getElement()),R.appendChild(T.getElement());const A=Om.el({css:{width:"340px",marginTop:"10px",marginLeft:"-20px",height:"220px",backgroundColor:"#9e9e9e",position:"relative",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",userSelect:"none",colorScheme:"only light",touchAction:"none"}});A.oncontextmenu=function(){return!1};const P=Om.el({css:{position:"absolute",left:"0",top:"0",bottom:"0",right:"0"}});A.appendChild(P);const O=document.createElement("div");O.style.position="absolute",O.style.left="0px",O.style.top="0px",A.appendChild(O);Om.appendTextDiv(O,"").appendChild(n),n.style.boxShadow="0 0 3px 1px rgba(0,0,0,0.5)",n.style.position="absolute",n.style.left="0px",n.style.top="0px",i.appendChild(A);const D=new Yy({x:0,y:0,width:e.getWidth(),height:e.getHeight(),scale:f,callback:L,maxW:p,maxH:g});return L(D.getTransform()),O.appendChild(D.getElement()),r.destroy=()=>{D.destroy(),M.destroy()},r.getInput=function(){return r.destroy(),{left:a,right:o,top:s,bottom:l,fillColor:0===I.a?null:I}},r},apply(t){const e=t.canvas,n=t.history;return!(!e||!n||isNaN(t.input.left)||isNaN(t.input.right)||isNaN(t.input.top)||isNaN(t.input.bottom))&&(n.pause(!0),e.resizeCanvas(t.input),n.pause(!1),n.push({tool:["filter","cropExtend"],action:"apply",params:[{input:JSON.parse(JSON.stringify(t.input))}]}),!0)}},Kb={getDialog(t){let e=t.context,n=t.canvas;if(!e||!n)return!1;let i=n.getLayers(),r=n.getLayerIndex(e.canvas),a=Om.fitInto(e.canvas.width,e.canvas.height,280,200,1),o=parseInt(""+a.width),s=parseInt(""+a.height),l=Om.canvas(o,s);{const t=l.getContext("2d");t.save(),l.width>e.canvas.width&&(t.imageSmoothingEnabled=!1),t.drawImage(e.canvas,0,0,o,s),t.restore()}let c,h=document.createElement("div"),u={element:h};return setTimeout((function(){e.canvas.width,h.innerHTML=Vm("filter-curves-description")+"<br/><br/>";let t={r:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]],g:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]],b:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]]},n=Xb();if(!n)return;let a,d=n.texture(l);n.draw(d).update();let p=new function(t){let e=document.createElement("div");e.oncontextmenu=function(){return!1},e.style.position="relative",e.style.marginBottom="10px";let n="All",i=t.curves;a=new cy({optionArr:[{id:"All",label:Vm("filter-curves-all")},{id:"Red",label:Vm("red")},{id:"Green",label:Vm("green")},{id:"Blue",label:Vm("blue")}],initialId:"All",onChange:function(t){n=t,"All"===n&&(i={r:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]],g:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]],b:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]]});let e=i.r;"Green"===n&&(e=i.g),"Blue"===n&&(e=i.b),p.setPos(0,s-e[0][1]*s),g.setPos(e[1][0]*o,s-e[1][1]*s),f.setPos(e[2][0]*o,s-e[2][1]*s),m.setPos(o,s-e[3][1]*s),y()}}),e.appendChild(a.getElement());let r=document.createElement("div");Om.css(r,{position:"relative",marginTop:"10px",colorScheme:"only light"}),e.appendChild(r);let o=300,s=100,l=document.createElement("canvas");l.width=o,l.height=s,Om.css(l,{background:"#c6c6c6",boxShadow:"0 0 0 1px rgba(0,0,0,0.3)"});let c=l.getContext("2d");function h(t){return Math.max(0,Math.min(1,t))}function u(t,e,n,i){let a=e,l=t,c=document.createElement("div");return Om.css(c,{position:"absolute",left:t-7+"px",top:e-7+"px",width:"14px",height:"14px",background:"#fff",cursor:"move",borderRadius:"14px",boxShadow:"inset 0 0 0 2px #000",userSelect:"none",touchAction:"none"}),c.pointerListener=new Om.PointerListener({target:c,maxPointers:1,onPointer:function(r){r.eventPreventDefault(),"pointerdown"===r.type&&(l=t,a=e),"left"===r.button&&"pointermove"===r.type&&(i||(l+=r.dX),t=Math.max(0,Math.min(o,l)),a+=r.dY,e=Math.max(0,Math.min(s,a)),Om.css(c,{left:t-7+"px",top:e-7+"px"}),n({x:t,y:e}))}}),r.appendChild(c),c.setPos=function(n,i){a=e=i,l=t=n,Om.css(c,{left:t-7+"px",top:e-7+"px"})},c}function d(t,e,r){"All"===n&&(i.r[t]=[h(e/o),h(1-r/s)],i.g[t]=[h(e/o),h(1-r/s)],i.b[t]=[h(e/o),h(1-r/s)]),"Red"===n&&(i.r[t]=[h(e/o),h(1-r/s)]),"Green"===n&&(i.g[t]=[h(e/o),h(1-r/s)]),"Blue"===n&&(i.b[t]=[h(e/o),h(1-r/s)])}r.appendChild(l);let p=u(0,s,(function(t){d(0,t.x,t.y),y()}),!0),g=u(o/3,s/3*2,(function(t){d(1,t.x,t.y),y()})),f=u(o/3*2,s/3,(function(t){d(2,t.x,t.y),y()})),m=u(o,0,(function(t){d(3,t.x,t.y),y()}),!0);function y(){l.width=l.width,c=l.getContext("2d");let e={r:[],g:[],b:[]};for(let t=0;t<i.r.length;t++)e.r.push(i.r[t]),e.g.push(i.g[t]),e.b.push(i.b[t]);function r(t){c.beginPath();let e=new Om.SplineInterpolator(t);for(let t=0;t<100;t++){let n=e.interpolate(t/100);n=Math.max(0,Math.min(1,n)),0===t?c.moveTo(t/100*o,s-n*s):c.lineTo(t/100*o,s-n*s)}c.stroke()}c.save(),"All"===n?(c.strokeStyle="black",r(e.r)):(c.globalAlpha=.5,c.strokeStyle="red",r(e.r),c.strokeStyle="green",r(e.g),c.strokeStyle="blue",r(e.b)),c.restore(),t.callback(e)}y(),this.getDiv=function(){return e},this.destroy=function(){p.pointerListener.destroy(),g.pointerListener.destroy(),f.pointerListener.destroy(),m.pointerListener.destroy()}}({curves:t,callback:function(e){t=e,function(){try{n.draw(d).curves(t.r,t.g,t.b).update(),c&&c.render()}catch(t){h.errorCallback(t)}}()}});h.appendChild(p.getDiv());let g=document.createElement("div");Om.css(g,{width:"340px",marginLeft:"-20px",height:"220px",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",position:"relative",userSelect:"none",display:"flex",alignItems:"center",justifyContent:"center",colorScheme:"only light"});let f=[];for(let t=0;t<i.length;t++)f.push({image:t===r?n:i[t].context.canvas,opacity:i[t].opacity,mixModeStr:i[t].mixModeStr});c=new By({width:parseInt(""+o),height:parseInt(""+s),layers:f});let m=Om.el({css:{position:"relative",boxShadow:"0 0 5px rgba(0,0,0,0.5)",width:parseInt(""+o)+"px",height:parseInt(""+s)+"px"}});m.appendChild(c.getElement()),g.appendChild(m),h.appendChild(g),u.destroy=()=>{p.destroy(),d.destroy(),a.destroy()},u.getInput=function(){return u.destroy(),{curves:t}}}),1),u},apply(t){let e=t.context,n=t.input.curves,i=t.history;if(!e||null===n||!i)return!1;i.pause(!0);let r=Xb();if(!r)return!1;let a=r.texture(e.canvas);return r.draw(a).curves(n.r,n.g,n.b).update(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.drawImage(r,0,0),a.destroy(),i.pause(!1),i.push({tool:["filter","glCurves"],action:"apply",params:[{input:t.input}]}),!0}};var Gb;Gb=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("grSoY");const qb={getDialog(t){let e=t.context,i=t.canvas;if(!e||!i)return!1;let r=i.getLayers(),a=i.getLayerIndex(e.canvas),o=Om.fitInto(e.canvas.width,e.canvas.height,280,200,1),s=parseInt(""+o.width),l=parseInt(""+o.height),c=document.createElement("div"),h={element:c},u=!0,d=!1,p=!0;c.innerHTML=Vm("filter-flip-description")+"<br/><br/>";let g=new Gm({init:u,label:Vm("filter-flip-horizontal")+" ⟷",allowTab:!0,callback:function(t){u=t,S()},css:{marginBottom:"10px"}}),f=new Gm({init:d,label:Vm("filter-flip-vertical")+" ↕",allowTab:!0,callback:function(t){d=t,S()},css:{marginBottom:"10px"}});c.appendChild(g.getElement()),c.appendChild(f.getElement());let m=document.createElement("div");Om.setEventListener(m,"onpointerdown",(function(){return!1})),m.textContent=Vm("filter-flip-image"),m.style.width="150px",m.style.height="30px",m.style.paddingTop="10px",m.style.textAlign="center",m.style.cssFloat="left",m.style.paddingBottom="0px",m.style.borderTopLeftRadius="10px",m.style.boxShadow="inset 0px 5px 10px rgba(0,0,0,0.5)",m.style.background="url("+n(Gb)+") no-repeat 12px 16px",m.style.backgroundSize="8%",m.style.backgroundColor="#9e9e9e";let y=document.createElement("div");Om.setEventListener(y,"onpointerdown",(function(){return!1})),y.textContent=Vm("filter-flip-layer"),y.style.width="150px",y.style.height="30px",y.style.paddingTop="10px",y.style.textAlign="center",y.style.cssFloat="left",y.style.paddingBottom="0px",y.style.borderTopRightRadius="10px",y.style.cursor="pointer",y.style.backgroundColor="rgba(0, 0, 0, 0.1)",y.style.backgroundSize="8%",Om.setEventListener(m,"onpointerover",(function(){!1===p&&(m.style.backgroundColor="#ccc")})),Om.setEventListener(m,"onpointerout",(function(){!1===p&&(m.style.backgroundColor="rgba(0, 0, 0, 0.1)")})),Om.setEventListener(y,"onpointerover",(function(){!0===p&&(y.style.backgroundColor="#ccc")})),Om.setEventListener(y,"onpointerout",(function(){!0===p&&(y.style.backgroundColor="rgba(0, 0, 0, 0.1)")})),m.onclick=function(){p=!0,y.style.background="",y.style.backgroundColor="rgba(0, 0, 0, 0.1)",y.style.boxShadow="",y.style.cursor="pointer",m.style.background="url("+n(Gb)+") no-repeat 12px 16px",m.style.backgroundSize="8%",m.style.backgroundColor="#9e9e9e",m.style.cursor="default",m.style.boxShadow="inset 0px 5px 10px rgba(0,0,0,0.5)",S()},y.onclick=function(){p=!1,m.style.background="",m.style.backgroundColor="rgba(0, 0, 0, 0.1)",m.style.boxShadow="",m.style.cursor="pointer",y.style.background="url("+n(Gb)+") no-repeat 12px 16px",y.style.backgroundSize="8%",y.style.backgroundColor="#9e9e9e",y.style.cursor="default",y.style.boxShadow="inset 0px 5px 10px rgba(0,0,0,0.5)",S()};let x=document.createElement("div");x.appendChild(m),x.appendChild(y),c.appendChild(x);let b=document.createElement("div");Om.css(b,{width:"340px",marginLeft:"-20px",height:"220px",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",position:"relative",userSelect:"none",display:"flex",alignItems:"center",justifyContent:"center",colorScheme:"only light"});let v={image:Om.canvas(Math.round(s),Math.round(l)),opacity:1,mixModeStr:"source-over"},w=new By({width:Math.round(s),height:Math.round(l),layers:[v]}),C=Om.el({css:{position:"relative",boxShadow:"0 0 5px rgba(0,0,0,0.5)",width:parseInt(""+s)+"px",height:parseInt(""+l)+"px"}});function S(){let t=v.image.getContext("2d");t.save(),t.clearRect(0,0,v.image.width,v.image.height),p&&(u&&(t.translate(v.image.width,0),t.scale(-1,1)),d&&(t.translate(0,v.image.height),t.scale(1,-1)));for(let e=0;e<r.length;e++)t.save(),p||a!==e||(u&&(t.translate(v.image.width,0),t.scale(-1,1)),d&&(t.translate(0,v.image.height),t.scale(1,-1))),t.canvas.width>r[e].context.canvas.width&&(t.imageSmoothingEnabled=!1),t.globalAlpha=r[e].opacity,t.globalCompositeOperation=r[e].mixModeStr,t.drawImage(r[e].context.canvas,0,0,v.image.width,v.image.height),t.restore();w.render(),t.restore()}return C.appendChild(w.getElement()),b.appendChild(C),setTimeout(S,0),c.appendChild(b),h.destroy=()=>{g.destroy(),f.destroy()},h.getInput=function(){return h.destroy(),{horizontal:u,vertical:d,flipCanvas:p}},h},apply(t){let e=t.context,n=t.canvas,i=t.history,r=t.input.horizontal,a=t.input.vertical,o=t.input.flipCanvas;return!!(e&&n&&i)&&(i.pause(!0),n.flip(r,a,o?null:n.getLayerIndex(e.canvas)),i.pause(!1),i.push({tool:["filter","flip"],action:"apply",params:[{input:t.input}]}),!0)}},Zb={getDialog(t){let e=t.context,n=t.canvas;if(!e||!n)return!1;let i=n.getLayers(),r=n.getLayerIndex(e.canvas),a=Om.fitInto(e.canvas.width,e.canvas.height,280,200,1),o=parseInt(""+a.width),s=parseInt(""+a.height),l=Om.canvas(o,s);{const t=l.getContext("2d");t.save(),l.width>e.canvas.width&&(t.imageSmoothingEnabled=!1),t.drawImage(e.canvas,0,0,o,s),t.restore()}let c=document.createElement("div"),h={element:c};return setTimeout((function(){let t=0,e=0;c.innerHTML=Vm("filter-hue-sat-description")+"<br/><br/>";let n=Xb();if(!n)return;let a=n.texture(l);n.draw(a).update();let u=new ny({label:Vm("filter-hue-sat-hue"),width:300,height:30,min:-100,max:100,initValue:100*t,eventResMs:60,onChange:function(i){t=i/100,n.draw(a).hueSaturation(t,e).update(),f.render()}}),d=new ny({label:Vm("filter-hue-sat-saturation"),width:300,height:30,min:0,max:100,initValue:50*(e+1),eventResMs:60,onChange:function(i){e=i/50-1,n.draw(a).hueSaturation(t,e).update(),f.render()}});u.getElement().style.marginBottom="10px",c.appendChild(u.getElement()),c.appendChild(d.getElement());let p=document.createElement("div");Om.css(p,{width:"340px",marginLeft:"-20px",height:"220px",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",position:"relative",userSelect:"none",display:"flex",alignItems:"center",justifyContent:"center",colorScheme:"only light"});let g=[];for(let t=0;t<i.length;t++)g.push({image:t===r?n:i[t].context.canvas,opacity:i[t].opacity,mixModeStr:i[t].mixModeStr});let f=new By({width:parseInt(""+o),height:parseInt(""+s),layers:g}),m=Om.el({css:{position:"relative",boxShadow:"0 0 5px rgba(0,0,0,0.5)",width:parseInt(""+o)+"px",height:parseInt(""+s)+"px"}});m.appendChild(f.getElement()),p.appendChild(m),c.appendChild(p);try{n.draw(a).hueSaturation(t,e).update(),f.render()}catch(t){c.errorCallback(t)}h.destroy=()=>{u.destroy(),d.destroy(),a.destroy()},h.getInput=function(){return h.destroy(),{hue:t,Saturation:e}}}),1),h},apply(t){let e=t.context,n=t.input.hue,i=t.history,r=t.input.Saturation;if(!e||null===n||null===r||!i)return!1;i.pause(!0);let a=Xb();if(!a)return!1;let o=a.texture(e.canvas);return a.draw(o).hueSaturation(n,r).update(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.drawImage(a,0,0),o.destroy(),i.pause(!1),i.push({tool:["filter","glHueSaturation"],action:"apply",params:[{input:t.input}]}),!0}},$b={apply(t){let e=t.context,n=t.history;if(!e||!n)return!1;n.pause(!0);let i=Xb();if(!i)return!1;let r=i.texture(e.canvas);return i.draw(r).invert().update(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.drawImage(i,0,0),r.destroy(),n.pause(!1),n.push({tool:["filter","invert"],action:"apply",params:[{input:t.input}]}),!0}},Jb={getDialog(t){let e=t.context,i=t.canvas;if(!e||!i)return!1;let r=window.innerWidth<550,a=i.getLayers(),o=i.getLayerIndex(e.canvas),s=Om.fitInto(e.canvas.width,e.canvas.height,r?280:490,r?200:240,1),l=parseInt(""+s.width),c=parseInt(""+s.height),h=Math.min(l,e.canvas.width),u=Math.min(c,e.canvas.height),d=Om.canvas(h,u);{const t=d.getContext("2d");t.save(),h>e.canvas.width&&(t.imageSmoothingEnabled=!1),t.drawImage(e.canvas,0,0,h,u),t.restore()}let p=l/e.canvas.width,g=document.createElement("div"),f={element:g};r||(f.width=500);let m=[];return setTimeout((function(){g.innerHTML=Vm("filter-perspective-description")+"<br/><br/>";let t=Xb();if(!t)return;let e,i,s,y,x,b,v,w,C=t.texture(d);function S(){try{t.draw(C).perspective([e.x,e.y,i.x,i.y,s.x,s.y,y.x,y.y].map(((t,e)=>e%2==0?t/l*h:t/c*u)),[x.x,x.y,b.x,b.y,v.x,v.y,w.x,w.y].map(((t,e)=>e%2==0?t/l*h:t/c*u))).update(),P.render()}catch(t){g.errorCallback(t)}}function E(t,e,n){let i=document.createElement("div");i.x=t,i.y=e,Om.css(i,{width:"14px",height:"14px",backgroundColor:"#fff",boxShadow:"inset 0 0 0 2px #000",borderRadius:"14px",position:"absolute",cursor:"move",left:i.x-7+"px",top:i.y-7+"px",userSelect:"none",touchAction:"none"});let r=new Om.PointerListener({target:i,maxPointers:1,onPointer:function(t){t.eventPreventDefault(),"left"===t.button&&"pointermove"===t.type&&(i.x+=t.dX,i.y+=t.dY,i.style.left=i.x-7+"px",i.style.top=i.y-7+"px",n&&n(),S())}});return i.copy=function(t){i.x=t.x,i.y=t.y,i.style.left=i.x-7+"px",i.style.top=i.y-7+"px"},m.push(r),i}function M(){x.copy(e),b.copy(i),v.copy(s),w.copy(y)}t.draw(C).update(),e=E(0,0,M),i=E(l,0,M),s=E(l,c,M),y=E(0,c,M),x=E(0,0),b=E(l,0),v=E(l,c),w=E(0,c);let I=!1,k=document.createElement("div");Om.setEventListener(k,"onpointerdown",(function(){return!1})),k.textContent=Vm("filter-perspective-before"),k.style.width="150px",k.style.height="30px",k.style.marginLeft=r?"0":"100px",k.style.paddingTop="10px",k.style.textAlign="center",k.style.cssFloat="left",k.style.paddingBottom="0px",k.style.borderTopLeftRadius="10px",k.style.cursor="pointer",k.style.backgroundColor="rgba(0, 0, 0, 0.1)",k.style.backgroundSize="8%";let T=document.createElement("div");Om.setEventListener(T,"onpointerdown",(function(){return!1})),T.textContent=Vm("filter-perspective-after"),T.style.width="150px",T.style.height="30px",T.style.paddingTop="10px",T.style.textAlign="center",T.style.cssFloat="left",T.style.paddingBottom="0px",T.style.borderTopRightRadius="10px",T.style.boxShadow="inset 0px 5px 10px rgba(0,0,0,0.5)",T.style.background="url("+n(Gb)+") no-repeat 12px 16px",T.style.backgroundSize="8%",T.style.backgroundColor="#9e9e9e",Om.setEventListener(k,"onpointerover",(function(){!1===I&&(k.style.backgroundColor="#ccc")})),Om.setEventListener(k,"onpointerout",(function(){!1===I&&(k.style.backgroundColor="rgba(0, 0, 0, 0.1)")})),Om.setEventListener(T,"onpointerover",(function(){!0===I&&(T.style.backgroundColor="#ccc")})),Om.setEventListener(T,"onpointerout",(function(){!0===I&&(T.style.backgroundColor="rgba(0, 0, 0, 0.1)")})),k.onclick=function(){k.style.background="url("+n(Gb)+") no-repeat 12px 16px",k.style.backgroundSize="8%",k.style.backgroundColor="#9e9e9e",k.style.boxShadow="inset 0px 5px 10px rgba(0,0,0,0.5)",k.style.cursor="default",T.style.background="",T.style.backgroundColor="rgba(0, 0, 0, 0.1)",T.style.boxShadow="",T.style.cursor="pointer",x.style.display="none",b.style.display="none",v.style.display="none",w.style.display="none",e.style.display="block",i.style.display="block",s.style.display="block",y.style.display="block",e.copy(x),i.copy(b),s.copy(v),y.copy(w),I=!0,S()},T.onclick=function(){I=!1,T.style.background="url("+n(Gb)+") no-repeat 12px 16px",T.style.backgroundSize="8%",T.style.backgroundColor="#9e9e9e",T.style.boxShadow="inset 0px 5px 10px rgba(0,0,0,0.5)",T.style.cursor="default",k.style.background="",k.style.backgroundColor="rgba(0, 0, 0, 0.1)",k.style.boxShadow="",k.style.cursor="pointer",e.style.display="none",i.style.display="none",s.style.display="none",y.style.display="none",x.style.display="block",b.style.display="block",v.style.display="block",w.style.display="block",x.copy(e),b.copy(i),v.copy(s),w.copy(y)};let R=document.createElement("div");R.appendChild(k),R.appendChild(T),g.appendChild(R);let L=document.createElement("div");L.oncontextmenu=function(){return!1},Om.css(L,{width:r?"340px":"540px",marginLeft:"-20px",height:r?"260px":"300px",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",position:"relative",userSelect:"none",display:"flex",alignItems:"center",justifyContent:"center",colorScheme:"only light"});let A=[];for(let e=0;e<a.length;e++){let n=e===o?t:a[e].context.canvas;A.push({image:n,opacity:a[e].opacity,mixModeStr:a[e].mixModeStr})}let P=new By({width:parseInt(""+l),height:parseInt(""+c),layers:A}),O=Om.el({css:{position:"relative",boxShadow:"0 0 5px rgba(0,0,0,0.5)",width:parseInt(""+l)+"px",height:parseInt(""+c)+"px"}});O.appendChild(P.getElement()),L.appendChild(O),O.appendChild(x),O.appendChild(b),O.appendChild(v),O.appendChild(w),e.style.display="none",i.style.display="none",s.style.display="none",y.style.display="none",O.appendChild(e),O.appendChild(i),O.appendChild(s),O.appendChild(y),g.appendChild(L),S(),f.destroy=()=>{for(let t=0;t<m.length;t++)m[t].destroy();C.destroy()},f.getInput=function(){return f.destroy(),{before:[e.x/p,e.y/p,i.x/p,i.y/p,s.x/p,s.y/p,y.x/p,y.y/p],after:[x.x/p,x.y/p,b.x/p,b.y/p,v.x/p,v.y/p,w.x/p,w.y/p]}}}),1),f},apply(t){let e=t.context,n=t.history,i=t.input.before,r=t.input.after;if(!(e&&i&&r&&n))return!1;n.pause(!0);let a=Xb();if(!a)return!1;let o=a.texture(e.canvas);e.canvas.width,e.canvas.height;return a.draw(o).perspective(i,r).update(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.drawImage(a,0,0),o.destroy(),n.pause(!1),n.push({tool:["filter","glPerspective"],action:"apply",params:[{input:t.input}]}),!0}};var Qb;Qb=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("2xc61");const tv={getDialog(t){let e=t.canvas;if(!e)return!1;let i=Om.fitInto(e.getWidth(),e.getHeight(),280,200,1),r=parseInt(""+i.width),a=parseInt(""+i.height),o=r/e.getWidth(),s=e.getCompleteCanvas(1),l=document.createElement("div"),c={element:l},h=e.getWidth(),u=e.getHeight();l.innerHTML=Vm("filter-resize-description")+"<br/><br/>";let d=t.maxWidth,p=t.maxHeight,g=Om.el({css:{width:"150px",height:"35px",lineHeight:"30px"}}),f=Om.el({css:{width:"150px",height:"35px",lineHeight:"30px"}}),m=Om.el({tagName:"input",css:{cssFloat:"right",width:"90px"},custom:{type:"number",min:"1",max:""+d,value:""+e.getWidth()}}),y=Om.el({tagName:"input",css:{cssFloat:"right",width:"90px"},custom:{type:"number",min:"1",max:""+p,value:""+e.getHeight()}});m.onclick=function(){this.focus(),v=!0,T()},y.onclick=function(){this.focus(),b=!0,T()},m.onchange=function(){v=!0,T()},y.onchange=function(){b=!0,T()},g.append(Vm("width")+": ",m),f.append(Vm("height")+": ",y);let x=Om.el({css:{background:"url("+n(Qb)+") no-repeat 140px 5px",backgroundSize:"50px 52px"}});x.append(g,f),l.appendChild(x);let b=!1,v=!1,w=e.getWidth()/e.getHeight();let C=!0,S=new Gm({init:!0,label:Vm("constrain-proportions"),allowTab:!0,callback:function(t){C=t,C?(m.value=""+e.getWidth(),y.value=""+e.getHeight(),x.style.background="url("+n(Qb)+") no-repeat 140px 5px",x.style.backgroundSize="50px 52px",T()):x.style.background=""}});l.appendChild(Om.el({css:{clear:"both"}}));let E=new Zm({isFocusable:!0,optionArr:[["smooth",Vm("algorithm-smooth")],["pixelated",Vm("algorithm-pixelated")]],title:Vm("scaling-algorithm"),initValue:"smooth",onChange:function(){T()}}),M=Om.el({parent:l,css:{display:"flex",justifyContent:"space-between"}});M.appendChild(S.getElement()),M.appendChild(E.getElement());let I=Om.canvas(r,a);I.style.imageRendering="pixelated";let k=I.getContext("2d");function T(){if(0===m.value.length&&v||0===y.value.length&&b)return b=!1,void(v=!1);if(m.value=""+Math.max(1,parseInt(m.value)),y.value=""+Math.max(1,parseInt(y.value)),C&&(b&&(m.value=""+parseInt(""+parseInt(y.value)*w)),v&&(y.value=""+parseInt(""+parseInt(m.value)/w)),parseInt(m.value)>d||parseInt(y.value)>p)){let t=Om.fitInto(parseInt(m.value),parseInt(y.value),d,p,1);m.value=""+parseInt(""+t.width),y.value=""+parseInt(""+t.height)}parseInt(m.value)>d&&(m.value=""+d),parseInt(y.value)>p&&(y.value=""+p),b=!1,v=!1,h=parseInt(m.value),u=parseInt(y.value);let t=Om.fitInto(h,u,280,200,1),n=parseInt(""+t.width),i=parseInt(""+t.height);o=n/h;let r=Om.centerWithin(340,220,n,i);"smooth"===E.getValue()?(I.style.imageRendering=o>1?"pixelated":"",I.width=e.getWidth(),I.height=e.getHeight(),k.save(),k.imageSmoothingQuality="high",k.drawImage(s,0,0),Om.resizeCanvas(I,h,u),k.restore()):(I.style.imageRendering="pixelated",I.width=h,I.height=u,k.save(),k.imageSmoothingEnabled=!1,k.drawImage(s,0,0,I.width,I.height),k.restore()),I.style.width=Math.max(1,n)+"px",I.style.height=Math.max(1,i)+"px",L.style.left=r.x+"px",L.style.top=r.y+"px",L.style.width=Math.max(1,n)+"px",L.style.height=Math.max(1,i)+"px"}let R=document.createElement("div");Om.css(R,{width:"340px",marginLeft:"-20px",height:"220px",display:"table",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",position:"relative",userSelect:"none",colorScheme:"only light"});let L=Om.appendTextDiv(R,"");return L.appendChild(I),L.style.width=r+"px",L.style.height=a+"px",L.style.position="absolute",L.style.overflow="hidden",L.style.boxShadow="0 0 5px rgba(0,0,0,0.8)",L.style.overflow="hidden",Om.createCheckerDataUrl(8,(function(t){R.style.background="url("+t+")"})),l.appendChild(R),T(),c.destroy=()=>{S.destroy()},c.getInput=function(){return c.destroy(),{width:h,height:u,algorithm:E.getValue()}},c},apply(t){let e=t.canvas,n=t.history,i=t.input.width,r=t.input.height,a=t.input.algorithm;return!(!e||!n)&&(n.pause(!0),e.resize(i,r,a),n.pause(!1),n.push({tool:["filter","resize"],action:"apply",params:[{input:t.input}]}),!0)}},ev={getDialog(t){let e=t.canvas;if(!e)return!1;let n=Om.fitInto(e.getWidth(),e.getHeight(),280,200,1),i=parseInt(""+n.width),r=parseInt(""+n.height),a=i/e.getWidth(),o=Om.canvas(i,r);o.style.display="block",o.getContext("2d").drawImage(e.getCompleteCanvas(a),0,0,i,r);let s=document.createElement("div"),l={element:s},c=0;s.innerHTML=Vm("filter-rotate-description")+"<br/><br/>";function h(){if(f.style.WebkitTransform="rotate("+c+"deg)",f.style.MozTransform="rotate("+c+"deg)",f.style.OTransform="rotate("+c+"deg)",f.style.msTransform="rotate("+c+"deg)",90===Math.abs(c%180)){let t=Om.fitInto(r,i,280,200,1),e=parseInt(""+t.height)/i;f.style.WebkitTransform="rotate("+c+"deg) scale("+e+")",f.style.MozTransform="rotate("+c+"deg) scale("+e+")",f.style.OTransform="rotate("+c+"deg) scale("+e+")",f.style.msTransform="rotate("+c+"deg) scale("+e+")"}}let u=document.createElement("button");u.innerHTML="<span style='font-size: 1.3em'>⟳</span> 90°";let d=document.createElement("button");d.innerHTML="<span style='font-size: 1.3em'>⟲</span> 90°",d.style.marginRight="5px",u.onclick=function(){c+=90,h()},d.onclick=function(){c-=90,h()},s.appendChild(d),s.appendChild(u);let p=document.createElement("div");Om.css(p,{width:"340px",marginLeft:"-20px",height:"220px",display:"table",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",position:"relative",userSelect:"none",colorScheme:"only light"});let g=document.createElement("div");g.style.display="table-cell",g.style.verticalAlign="middle";let f=Om.appendTextDiv(g,"");return f.appendChild(o),p.appendChild(g),f.style.width=i+"px",f.style.height=r+"px",f.style.marginLeft="auto",f.style.marginRight="auto",f.style.boxShadow="0 0 5px rgba(0,0,0,0.8)",f.style.overflow="hidden",Om.createCheckerDataUrl(4,(function(t){f.style.background="url("+t+")"})),f.style.transition="all 0.2s ease-out",s.appendChild(p),h(),l.getInput=function(){return{deg:c}},l},apply(t){let e=t.canvas,n=t.history,i=t.input.deg;return!(!e||!n)&&(n.pause(!0),e.rotate(i),n.pause(!1),n.push({tool:["filter","rotate"],action:"apply",params:[{input:t.input}]}),!0)}},nv={getDialog(t){let e=t.context,n=t.canvas;if(!e||!n)return!1;let i=n.getLayers(),r=n.getLayerIndex(e.canvas),a=Om.fitInto(e.canvas.width,e.canvas.height,280,200,1),o=parseInt(""+a.width),s=parseInt(""+a.height),l=Math.min(o,e.canvas.width),c=Math.min(s,e.canvas.height),h=Om.canvas(l,c);{const t=h.getContext("2d");t.save(),l>e.canvas.width&&(t.imageSmoothingEnabled=!1),t.drawImage(e.canvas,0,0,l,c),t.restore()}let u=l/e.canvas.width,d=o/e.canvas.width,p=document.createElement("div"),g={element:p},f=[];return setTimeout((function(){let t=20,e=200;p.innerHTML=Vm("filter-tilt-shift-description")+"<br/><br/>";let n=Xb();if(!n)return;let a,l,c=n.texture(h);function m(){try{n.draw(c).tiltShift(a.x/d*u,a.y/d*u,l.x/d*u,l.y/d*u,t*u,e*u).update(),C.render()}catch(t){p.errorCallback(t)}}function y(t,e){let n=Om.el({css:{width:"14px",height:"14px",backgroundColor:"#fff",boxShadow:"inset 0 0 0 2px #000",borderRadius:"14px",position:"absolute",cursor:"move",left:t-7+"px",top:e-7+"px",userSelect:"none",touchAction:"none"}});n.x=t,n.y=e;let i=new Om.PointerListener({target:n,maxPointers:1,onPointer:function(t){t.eventPreventDefault(),"left"===t.button&&"pointermove"===t.type&&(n.x+=t.dX,n.y+=t.dY,n.style.left=n.x-7+"px",n.style.top=n.y-7+"px",m())}});return f.push(i),n}n.draw(c).update(),a=y(parseInt(""+o/6),parseInt(""+s/2)),l=y(parseInt(""+(o-o/6)),parseInt(""+(s-s/3)));let x=new ny({label:Vm("filter-tilt-shift-blur"),width:300,height:30,min:0,max:200,initValue:t,eventResMs:60,onChange:function(e){t=e,m()}});x.getElement().style.marginBottom="10px",p.appendChild(x.getElement());let b=new ny({label:Vm("filter-tilt-shift-gradient"),width:300,height:30,min:0,max:1e3,initValue:e,eventResMs:60,onChange:function(t){e=t,m()}});p.appendChild(b.getElement());let v=document.createElement("div");v.oncontextmenu=function(){return!1},Om.css(v,{width:"340px",marginLeft:"-20px",height:"220px",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",position:"relative",userSelect:"none",display:"flex",alignItems:"center",justifyContent:"center",colorScheme:"only light"});let w=[];for(let t=0;t<i.length;t++)w.push({image:t===r?n:i[t].context.canvas,opacity:i[t].opacity,mixModeStr:i[t].mixModeStr});let C=new By({width:parseInt(""+o),height:parseInt(""+s),layers:w}),S=Om.el({css:{position:"relative",boxShadow:"0 0 5px rgba(0,0,0,0.5)",width:parseInt(""+o)+"px",height:parseInt(""+s)+"px"}});S.appendChild(C.getElement()),v.appendChild(S),S.appendChild(a),S.appendChild(l),p.appendChild(v),m(),g.destroy=()=>{for(let t=0;t<f.length;t++)f[t].destroy();x.destroy(),b.destroy(),c.destroy()},g.getInput=function(){return g.destroy(),{a:{x:a.x/d,y:a.y/d},b:{x:l.x/d,y:l.y/d},blur:t,gradient:e}}}),1),g},apply(t){let e=t.context,n=t.history,i=t.input.a,r=t.input.b,a=t.input.blur,o=t.input.gradient;if(!e||!n)return!1;n.pause(!0);let s=Xb();if(!s)return!1;let l=s.texture(e.canvas);return s.draw(l).tiltShift(i.x,i.y,r.x,r.y,a,o).update(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.drawImage(s,0,0),l.destroy(),n.pause(!1),n.push({tool:["filter","glTiltShift"],action:"apply",params:[{input:t.input}]}),!0}},iv={getDialog(t){let e,n=t.context,i=t.canvas;if(!n||!i)return!1;let r,a=window.innerWidth<550,o=i.getLayers(),s=i.getLayerIndex(n.canvas),l=Om.fitInto(n.canvas.width,n.canvas.height,a?280:490,a?200:240,1),c=parseInt(""+l.width),h=parseInt(""+l.height),u=Math.min(c,n.canvas.width),d=Math.min(h,n.canvas.height),p=c/n.canvas.width,g={x:0,y:0,width:0,height:0};{let t={x1:null,y1:null,x2:null,y2:null},i=n.getImageData(0,0,n.canvas.width,n.canvas.height);if(i.data[3]>0&&i.data[i.data.length-1]>0)t.x1=0,t.y1=0,t.x2=n.canvas.width-1,t.y2=n.canvas.height-1;else for(e=3;e<i.data.length;e+=4)if(i.data[e]>0){let i=(e-3)/4%n.canvas.width,r=Math.floor((e-3)/4/n.canvas.width);(t.x1>i||null===t.x1)&&(t.x1=i),null===t.y1&&(t.y1=r),(t.x2<i||null===t.x2)&&(t.x2=i),(t.y2<r||null===t.y2)&&(t.y2=r)}if(null===t.x1||null===t.y1)return alert(Vm("filter-transform-empty")),!1;g.x=t.x1,g.y=t.y1,g.width=t.x2-t.x1+1,g.height=t.y2-t.y1+1}const f={x:g.x+g.width/2,y:g.y+g.height/2,width:g.width,height:g.height,angleDeg:0};let m=document.createElement("div"),y={element:m};a||(y.width=500),m.innerHTML=Vm("filter-transform-description");let x=new Om.KeyListener({onDown:function(t){Om.isInputFocused(!0)||("left"===t&&(S.value=""+(parseFloat(S.value)-1),F()),"right"===t&&(S.value=""+(parseFloat(S.value)+1),F()),"up"===t&&(C.value=""+(parseFloat(C.value)-1),F()),"down"===t&&(C.value=""+(parseFloat(C.value)+1),F()))}}),b=document.createElement("div"),v=document.createElement("div"),w=document.createElement("div"),C=document.createElement("input"),S=document.createElement("input"),E=document.createElement("input");if(b.style.width="100px",b.style.height="30px",v.style.width="100px",v.style.height="30px",v.style.display="inline-block",b.style.display="inline-block",w.style.display="inline-block",w.style.width="150px",w.style.height="30px",C.type="number",S.type="number",E.type="number",S.style.width="70px",C.style.width="70px",E.style.width="70px",C.value="0",S.value="0",E.value="0",C.onclick=function(){this.focus(),F()},S.onclick=function(){this.focus(),F()},E.onclick=function(){this.focus(),F()},C.onchange=function(){F()},S.onchange=function(){F()},E.onchange=function(){F()},C.onkeyup=function(){F()},S.onkeyup=function(){F()},E.onkeyup=function(){F()},b.append("X: ",S),v.append("Y: ",C),w.append(Vm("filter-transform-rotation")+": ",E),!a){Om.el({parent:m,css:{marginTop:"10px"}}).append(b,v,w)}const M={marginLeft:"10px",marginTop:"10px"},I=Om.el({parent:m,css:{display:"flex",flexWrap:"wrap",marginLeft:"-10px"}});Om.el({parent:I,tagName:"button",content:Vm("filter-transform-flip")+" X",onClick:()=>{const t=r.getTransform();r.setSize(-t.width,t.height)},css:M}),Om.el({parent:I,tagName:"button",content:Vm("filter-transform-flip")+" Y",onClick:()=>{const t=r.getTransform();r.setSize(t.width,-t.height)},css:M}),Om.el({parent:I,tagName:"button",content:"-90°",onClick:()=>{const t=r.getTransform();t.angleDeg-=90,t.angleDeg%=360,r.setAngleDeg(t.angleDeg),E.value=""+Math.round(t.angleDeg),_()},css:M}),Om.el({parent:I,tagName:"button",content:"+90°",onClick:()=>{const t=r.getTransform();t.angleDeg+=90,t.angleDeg%=360,r.setAngleDeg(t.angleDeg),E.value=""+Math.round(t.angleDeg),_()},css:M}),Om.el({parent:I,tagName:"button",content:"2x",onClick:()=>{const t=r.getTransform();T.getValue()?r.setSize(r.getRatio()*t.height*2,2*t.height):r.setSize(2*t.width,2*t.height)},css:M}),Om.el({parent:I,tagName:"button",content:"1/2x",onClick:()=>{const t=r.getTransform();r.setSize(Math.round(t.width/2),Math.round(t.height/2))},css:M}),Om.el({parent:I,tagName:"button",content:Vm("center"),onClick:()=>{const t=r.getTransform();r.setPos({x:n.canvas.width/2,y:n.canvas.height/2}),r.setAngleDeg(t.angleDeg),_()},css:M});let k=!0,T=new Gm({init:!0,label:Vm("filter-transform-constrain"),title:Vm("constrain-proportions"),allowTab:!0,callback:function(t){k=t,r.setConstrained(k)},css:{display:"inline-block"}}),R=!1,L=new Gm({init:!0,label:Vm("filter-transform-snap"),title:Vm("filter-transform-snap-title"),allowTab:!0,callback:function(t){R=t,r.setSnapping(R)},css:{display:"inline-block",marginLeft:"10px"}});const A=Om.el({});A.append(T.getElement(),L.getElement()),m.appendChild(Om.el({css:{clear:"both",height:"10px"}}));const P=Om.el({parent:m,css:{display:"flex",justifyContent:"space-between"}});let O=new Zm({isFocusable:!0,optionArr:[["smooth",Vm("algorithm-smooth")],["pixelated",Vm("algorithm-pixelated")]],initValue:"smooth",title:Vm("scaling-algorithm"),onChange:function(){_(!0)}});P.append(A,O.getElement());let D=document.createElement("div");D.oncontextmenu=function(){return!1},Om.css(D,{width:a?"340px":"540px",marginLeft:"-20px",height:a?"260px":"300px",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",position:"relative",userSelect:"none",display:"flex",alignItems:"center",justifyContent:"center",colorScheme:"only light"});let B=[];for(let t=0;t<o.length;t++){let e;if(t===s){e=Om.canvas(parseInt(""+u),parseInt(""+d)),e.getContext("2d").drawImage(o[t].context.canvas,0,0,e.width,e.height)}else e=o[t].context.canvas;B.push({image:e,opacity:o[t].opacity,mixModeStr:o[t].mixModeStr})}let z,j=new By({width:parseInt(""+c),height:parseInt(""+h),layers:B}),H=Om.el({css:{position:"relative",boxShadow:"0 0 5px rgba(0,0,0,0.5)",width:parseInt(""+c)+"px",height:parseInt(""+h)+"px"}});function _(t=!1){if(!r)return;let e=r.getTransform();if(JSON.stringify(e)===z&&!t)return;z=JSON.stringify(e),p<1&&(e.x*=p,e.y*=p,e.width*=p,e.height*=p);let n=B[s].image,i=n.getContext("2d");i.save(),i.clearRect(0,0,n.width,n.height),Om.drawTransformedImageWithBounds(i,o[s].context.canvas,e,g,"pixelated"===O.getValue()||Om.testShouldPixelate(e,e.width/f.width,e.height/f.height)),i.restore(),j.render()}function F(){r.setPos({x:parseInt(S.value)+f.x,y:parseInt(C.value)+f.y}),r.setAngleDeg(parseInt(E.value)),_()}return H.appendChild(j.getElement()),D.appendChild(H),r=new Uy({x:f.x,y:f.y,width:f.width,height:f.height,angleDeg:f.angleDeg,isConstrained:!0,snapX:[0,n.canvas.width],snapY:[0,n.canvas.height],callback:function(t){S.value=""+Math.round(t.x-f.x),C.value=""+Math.round(t.y-f.y),E.value=""+Math.round(t.angleDeg),_()},scale:p}),Om.css(r.getElement(),{position:"absolute",left:"0",top:"0"}),H.appendChild(r.getElement()),_(),m.appendChild(D),y.destroy=()=>{x.destroy(),r.destroy(),T.destroy(),L.destroy()},y.getInput=function(){const t=r.getTransform();let e={transform:t,bounds:g,isPixelated:"pixelated"===O.getValue()||Om.testShouldPixelate(t,t.width/f.width,t.height/f.height)};return y.destroy(),JSON.parse(JSON.stringify(e))},y},apply(t){const e=t.context,n=t.history;if(!e||!n)return!1;n.pause(!0);const i=t.input;let r=Om.copyCanvas(e.canvas);return e.clearRect(0,0,e.canvas.width,e.canvas.height),Om.drawTransformedImageWithBounds(e,r,i.transform,i.bounds,i.isPixelated),n.pause(!1),n.push({tool:["filter","transform"],action:"apply",params:[{input:i}]}),!0}},rv={getDialog(t){let e=t.canvas,n=t.context;if(!e||!n)return!1;let i=e.getLayers(),r=e.getLayerIndex(n.canvas),a=Om.fitInto(n.canvas.width,n.canvas.height,280,200,1),o=parseInt(""+a.width),s=parseInt(""+a.height),l=Math.min(o,n.canvas.width),c=Math.min(s,n.canvas.height),h=Om.canvas(l,c);{const t=h.getContext("2d");t.save(),l>n.canvas.width&&(t.imageSmoothingEnabled=!1),t.drawImage(n.canvas,0,0,l,c),t.restore()}let u=l/n.canvas.width,d=document.createElement("div"),p={element:d};return setTimeout((function(){let t=10;d.innerHTML=Vm("filter-triangle-blur-description")+"<br/><br/>";let e=Xb();if(!e)return;let n=e.texture(h);e.draw(n).update();let a=new ny({label:Vm("radius"),width:300,height:30,min:1,max:200,initValue:t,eventResMs:60,onChange:function(i){t=i,e.draw(n).triangleBlur(t*u).update(),g.render()}});d.appendChild(a.getElement());let l=document.createElement("div");Om.css(l,{width:"340px",marginLeft:"-20px",height:"220px",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",position:"relative",userSelect:"none",display:"flex",alignItems:"center",justifyContent:"center",colorScheme:"only light"});let c=[];for(let t=0;t<i.length;t++)c.push({image:t===r?e:i[t].context.canvas,opacity:i[t].opacity,mixModeStr:i[t].mixModeStr});let g=new By({width:parseInt(""+o),height:parseInt(""+s),layers:c}),f=Om.el({css:{position:"relative",boxShadow:"0 0 5px rgba(0,0,0,0.5)",width:parseInt(""+o)+"px",height:parseInt(""+s)+"px"}});f.appendChild(g.getElement()),l.appendChild(f),d.appendChild(l);try{e.draw(n).triangleBlur(t*u).update(),g.render()}catch(t){d.errorCallback(t)}p.destroy=()=>{n.destroy(),a.destroy()},p.getInput=function(){return p.destroy(),{radius:t}}}),1),p},apply(t){let e=t.context,n=t.history,i=t.input.radius;if(!e||!i||!n)return!1;n.pause(!0);let r=Xb();if(!r)return!1;let a=r.texture(e.canvas);return r.draw(a).triangleBlur(i).update(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.drawImage(r,0,0),a.destroy(),n.pause(!1),n.push({tool:["filter","glBlur"],action:"apply",params:[{input:t.input}]}),!0}},av={getDialog(t){let e=t.context,n=t.canvas;if(!e||!n)return!1;let i=n.getLayers(),r=n.getLayerIndex(e.canvas),a=Om.fitInto(e.canvas.width,e.canvas.height,280,200,1),o=parseInt(""+a.width),s=parseInt(""+a.height),l=Math.min(o,e.canvas.width),c=Math.min(s,e.canvas.height),h=Om.canvas(l,c);{const t=h.getContext("2d");t.save(),l>e.canvas.width&&(t.imageSmoothingEnabled=!1),t.drawImage(e.canvas,0,0,l,c),t.restore()}let u=l/e.canvas.width,d=document.createElement("div"),p={element:d};return setTimeout((function(){let t=2,e=.51;d.innerHTML=Vm("filter-unsharp-mask-description")+"<br/><br/>";let n=Xb();if(!n)return;let a=n.texture(h);n.draw(a).update();let l=new ny({label:Vm("radius"),width:300,height:30,min:0,max:200,initValue:2,eventResMs:60,onChange:function(i){t=i,n.draw(a).unsharpMask(t*u,e).update(),m.render()},curve:[[0,0],[.1,2],[.5,50],[1,200]]}),c=new ny({label:Vm("filter-unsharp-mask-strength"),width:300,height:30,min:0,max:50,initValue:5.1,eventResMs:60,onChange:function(i){e=i/10,n.draw(a).unsharpMask(t*u,e).update(),m.render()},curve:[[0,0],[.1,2],[.5,10],[1,50]]});l.getElement().style.marginBottom="10px",d.appendChild(l.getElement()),d.appendChild(c.getElement());let g=document.createElement("div");Om.css(g,{width:"340px",marginLeft:"-20px",height:"220px",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",position:"relative",userSelect:"none",display:"flex",alignItems:"center",justifyContent:"center",colorScheme:"only light"});let f=[];for(let t=0;t<i.length;t++)f.push({image:t===r?n:i[t].context.canvas,opacity:i[t].opacity,mixModeStr:i[t].mixModeStr});let m=new By({width:parseInt(""+o),height:parseInt(""+s),layers:f}),y=Om.el({css:{position:"relative",boxShadow:"0 0 5px rgba(0,0,0,0.5)",width:parseInt(""+o)+"px",height:parseInt(""+s)+"px"}});y.appendChild(m.getElement()),g.appendChild(y),d.appendChild(g);try{n.draw(a).unsharpMask(t*u,e).update(),m.render()}catch(t){d.errorCallback(t)}p.destroy=()=>{l.destroy(),c.destroy(),a.destroy()},p.getInput=function(){return p.destroy(),{radius:t,strength:e}}}),1),p},apply(t){let e=t.context,n=t.history,i=t.input.radius,r=t.input.strength;if(!e||null===i||null===r||!n)return!1;n.pause(!0);let a=Xb();if(!a)return!1;let o=a.texture(e.canvas);return a.draw(o).unsharpMask(i,r).update(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.drawImage(a,0,0),o.destroy(),n.pause(!1),n.push({tool:["filter","glUnsharpMask"],action:"apply",params:[{input:t.input}]}),!0}},ov={getDialog(t){let e=t.context,n=t.canvas;if(!e||!n)return!1;let i=n.getLayers(),r=n.getLayerIndex(e.canvas),a=Om.fitInto(e.canvas.width,e.canvas.height,280,200,1),o=parseInt(""+a.width),s=parseInt(""+a.height),l=Om.canvas(o,s);{const t=l.getContext("2d");t.save(),l.width>e.canvas.width&&(t.imageSmoothingEnabled=!1),t.drawImage(e.canvas,0,0,o,s),t.restore()}let c=document.createElement("div"),h={element:c};return setTimeout((function(){c.appendChild(Om.el({content:Vm("filter-to-alpha-description"),css:{marginBottom:"5px"}}));let e=Xb();if(!e)return;let n=e.texture(l);function a(){e.draw(n).toAlpha("inverted-luminance"===u,p).update(),x.render()}e.draw(n).update();let u="inverted-luminance",d=new cy({optionArr:[{id:"inverted-luminance",label:Vm("filter-to-alpha-inverted-lum")},{id:"luminance",label:Vm("filter-to-alpha-lum")}],initialId:u,onChange:function(t){u=t,a()}});c.appendChild(d.getElement());let p={r:0,g:0,b:0,a:1},g=[null,{r:0,g:0,b:0,a:1},{r:255,g:255,b:255,a:1}];g.push({r:t.currentColorRgb.r,g:t.currentColorRgb.g,b:t.currentColorRgb.b,a:1}),g.push({r:t.secondaryColorRgb.r,g:t.secondaryColorRgb.g,b:t.secondaryColorRgb.b,a:1});let f=new ly({label:Vm("filter-to-alpha-replace"),colorArr:g,initialIndex:1,onChange:function(t){p=t,a()}});f.getElement().style.marginTop="10px",c.appendChild(f.getElement());let m=document.createElement("div");Om.css(m,{width:"340px",marginLeft:"-20px",height:"220px",backgroundColor:"#9e9e9e",marginTop:"10px",boxShadow:"rgba(0, 0, 0, 0.2) 0px 1px inset, rgba(0, 0, 0, 0.2) 0px -1px inset",overflow:"hidden",position:"relative",userSelect:"none",display:"flex",alignItems:"center",justifyContent:"center",colorScheme:"only light"});let y=[];for(let t=0;t<i.length;t++)y.push({image:t===r?e:i[t].context.canvas,opacity:i[t].opacity,mixModeStr:i[t].mixModeStr});let x=new By({width:parseInt(""+o),height:parseInt(""+s),layers:y}),b=Om.el({css:{position:"relative",boxShadow:"0 0 5px rgba(0,0,0,0.5)",width:parseInt(""+o)+"px",height:parseInt(""+s)+"px"}});b.appendChild(x.getElement()),m.appendChild(b),c.appendChild(m),setTimeout((function(){try{a()}catch(t){c.errorCallback(t)}}),1),h.destroy=()=>{n.destroy(),d.destroy()},h.getInput=function(){return h.destroy(),{sourceId:u,selectedRgbaObj:p}}}),1),h},apply(t){let e=t.context,n=t.history,i=t.input.sourceId,r=t.input.selectedRgbaObj;if(!e||!i||!n)return!1;n.pause(!0);let a=Xb();if(!a)return!1;let o=a.texture(e.canvas);return a.draw(o).toAlpha("inverted-luminance"===i,r).update(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.drawImage(a,0,0),o.destroy(),n.pause(!1),n.push({tool:["filter","toAlpha"],action:"apply",params:[{input:t.input}]}),!0}};let sv;function lv(t,e){e.getDialog&&(t.getDialog=e.getDialog),t.apply=e.apply}var cv;cv=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("gXLuy");var hv,uv;function dv(t,e){let i=Math.min(4096,Math.max(2048,Math.max(window.screen.width,window.screen.height))),r=e.embed?"left":Pm.getItem("uiState")?Pm.getItem("uiState"):"left";const o=e.app&&e.app.filenameBase?e.app.filenameBase:"Klecks",s=e.projectStore;let l=document.createElement("div");l.className="g-root kl-initialized";let c=Math.max(0,window.innerWidth),h=Math.max(0,window.innerHeight);const u=271;let d="png",p=new Fb.KlCanvas(t?{projectObj:t}:{width:Math.min(i,window.innerWidth<820?c:c-u),height:Math.min(i,h)},e.embed?-1:0);p.setHistory(zm);let g,f=null;function m(t){return 1==t?.5:2==t?.84:3==t?.965:4==t?.9825:5==t?.99125:t}e.saveReminder||(e.saveReminder={init:()=>{},reset:()=>{}});let y=!0;t?t=null:(zm.pause(!0),p.addLayer(),p.layerFill(0,{r:255,g:255,b:255}),zm.pause(!1)),f={canvas:new Fb.KlCanvas({copy:p},e.embed?-1:0),focus:p.getLayerCount()-1,brushes:{}};for(let t in Fb.brushes)Fb.brushes.hasOwnProperty(t)&&(f.brushes[t]=new Fb.brushes[t],f.canvas&&f.brushes[t].setContext(f.canvas.getLayerContext(f.focus)));let x,b,v=new Om.RGB(0,0,0),w=0,C=p.getLayerContext(p.getLayerCount()-1);function S(t){E.emitSize(t),R&&R.setCursorSize(2*t)}const E=new Fb.BrushSettingService((t=>{Q.setColor(t),x.setColor(t),v=Om.copyObj(t)}),(t=>{x.setSize(t),R.setCursorSize(2*t)}),(t=>{x.setOpacity(t)}),(()=>Q.getColor()),(()=>X[b].getSize()),(()=>X[b].getOpacity()),(()=>({sizeSlider:Fb.brushesUI[b].sizeSlider,opacitySlider:Fb.brushesUI[b].opacitySlider})));let M=new Om.EventChain.LineSmoothing({smoothing:m(1)}),I=new Om.EventChain.LineSanitizer,k=new Om.EventChain.EventChain({chainArr:[I,M]});k.setChainOut((function(t){"down"===t.type&&(W.style.pointerEvents="none",x.startLine(t.x,t.y,t.pressure),R.requestFrame()),"move"===t.type&&(x.goLine(t.x,t.y,t.pressure,!1,t.isCoalesced),R.setLastDrawEvent(t.x,t.y,t.pressure),R.requestFrame()),"up"===t.type&&(W.style.pointerEvents="",x.endLine(),R.requestFrame()),"line"===t.type&&(x.getBrush().drawLineSegment(t.x0,t.y0,t.x1,t.y1),R.requestFrame())}));let T={size:20,align:"left",isBold:!1,isItalic:!1,font:"sans-serif",opacity:1};const R=new Fb.KlCanvasWorkspace({klCanvas:p,width:Math.max(0,c-u),height:h,onDraw:k.chainIn,onPick:function(t,e){E.setColor(t),e&&(Q.pickingDone(),R.setMode(tt.getActive()))},onFill:function(t,e){let n=p.getLayerIndex(C.canvas);p.floodFill(n,t,e,Q.getColor(),st.getOpacity(),st.getTolerance(),st.getSample(),st.getGrow(),st.getContiguous()),R.requestFrame()},onText:function(t,e,n){Fb.dialogCounter.get()>0||Fb.textToolDialog({klCanvas:p,layerIndex:p.getLayerIndex(C.canvas),x:t,y:e,angleRad:n,color:Q.getColor(),secondaryColor:Q.getSecondaryRGB(),size:T.size,align:T.align,isBold:T.isBold,isItalic:T.isItalic,font:T.font,opacity:T.opacity,onConfirm:function(t){let e=t.color;e.a=t.opacity,T.size=t.size,T.align=t.align,T.isBold=t.isBold,T.isItalic=t.isItalic,T.font=t.font,T.opacity=t.opacity;let i=p.getLayerIndex(C.canvas);p.text(i,{textStr:t.textStr,x:t.x,y:t.y,size:t.size,font:t.font,align:t.align,isBold:t.isBold,isItalic:t.isItalic,angleRad:n,color:Om.ColorConverter.toRgbaStr(e)}),R.requestFrame()}})},onShape:function(t,e,n,i){"down"===t&&ht.onDown(e,n,i),"move"===t&&ht.onMove(e,n),"up"===t&&ht.onUp(e,n)},onViewChange:function(t){t.changed.includes("scale")&&V.out({type:"transform",scale:t.scale,angleDeg:180*t.angle/Math.PI}),tt.setEnableZoomIn(t.scale!==R.getMaxScale()),tt.setEnableZoomOut(t.scale!==R.getMinScale()),ot.update(t.scale,180*t.angle/Math.PI)},onUndo:function(){zm.canUndo()&&gt.undo()&&V.out(Vm("undo"),!0)},onRedo:function(){zm.canRedo()&&gt.redo()&&V.out(Vm("redo"),!0)}});let L=document.getElementById("vaiz1");null==L||L.addEventListener("touchstart",(function(t){t.preventDefault(),R.setMode("draw"),tt.setActive("draw"),g.open("draw"),vt(),at.open("penBrush")}));let A=document.getElementById("vaiz2");null==A||A.addEventListener("touchstart",(function(t){t.preventDefault(),R.setMode("draw"),tt.setActive("draw"),g.open("draw"),vt(),at.open("eraserBrush")}));let P=document.getElementById("vaiz3");null==P||P.addEventListener("touchstart",(function(t){t.preventDefault(),R.setMode("draw"),tt.setActive("draw"),g.open("draw"),vt(),at.open("pixelBrush")}));let O=document.getElementById("vaiz4");null==O||O.addEventListener("touchstart",(function(t){t.preventDefault(),R.setMode("draw"),tt.setActive("draw"),g.open("draw"),vt(),at.open("chemyBrush")}));let D=document.getElementById("vaiz5");null==D||D.addEventListener("touchstart",(function(t){t.preventDefault(),R.setMode("draw"),tt.setActive("draw"),g.open("draw"),vt(),at.open("smudgeBrush")}));let B=document.getElementById("vaiz6");null==B||B.addEventListener("touchstart",(function(t){t.preventDefault(),R.setMode("draw"),tt.setActive("draw"),g.open("draw"),vt(),at.open("sketchyBrush")}));let z=document.getElementById("vaiz7");null==z||z.addEventListener("touchstart",(function(t){t.preventDefault(),R.setMode("draw"),tt.setActive("draw"),g.open("draw"),vt(),at.open("blendBrush")}));let j=document.getElementById("vaiz8");null==j||j.addEventListener("touchstart",(function(t){t.preventDefault(),R.setMode("text"),tt.setActive("text"),g.open("text"),vt()}));let H=document.getElementById("vaiz9");null==H||H.addEventListener("touchstart",(function(t){t.preventDefault(),R.setMode("shape"),tt.setActive("shape"),g.open("shape"),vt()}));let _=document.getElementById("vaiz10");null==_||_.addEventListener("touchstart",(function(t){t.preventDefault(),R.setMode("fill"),tt.setActive("fill"),g.open("fill"),vt()}));let F=document.getElementById("vaiz11");null==F||F.addEventListener("touchstart",(function(t){t.preventDefault(),(async()=>{let t=!0;try{await s.store(p.getProject())}catch(e){t=!1,setTimeout((()=>{throw new Error("keyboard-shortcut: failed to store browser storage, "+e)}),0),V.out("❌ "+Vm("file-storage-failed"),!0)}t&&(e.saveReminder.reset(),V.out(Vm("file-storage-stored"),!0))})()}));let U=document.getElementById("vaiz12");function N(t,e,n){function r(t,e){let n=parseInt(t),r=parseInt(e);return n>i&&(r*=i/n,n=i),r>i&&(n*=i/r,r=i),n=parseInt(""+n),r=parseInt(""+r),{width:n,height:r}}function a(t){let n=r(t.width,t.height),i=Om.canvas(t.width,t.height);i.getContext("2d").drawImage(t,0,0),Om.resizeCanvas(i,n.width,n.height),p.reset({width:n.width,height:n.height,image:i,layerName:e}),ut.update(0),et(p.getLayer(0)),R.resetView(),ot.update(R.getScale(),R.getAngleDeg()),y=!1}function o(t,e){function n(t,e,n){e.width=e.width,e.getContext("2d").drawImage(t,-n.x,-n.y),t.width=n.width,t.height=n.height,t.getContext("2d").drawImage(e,0,0)}if(e&&(e.width!==t.width||e.height!==t.height)){let i=Om.canvas(e.width,e.height);if(t.width=e.width,t.height=e.height,t.layers||n(t.canvas,i,e),t.layers)for(let r=0;r<t.layers.length;r++){n(t.layers[r].image,i,e)}}let i,a=r(t.width,t.height);if(t.width=a.width,t.height=a.height,t.layers||Om.resizeCanvas(t.canvas,t.width,t.height),t.layers)for(let e=0;e<t.layers.length;e++){let n=t.layers[e];Om.resizeCanvas(n.image,t.width,t.height)}i=t.layers?p.reset({width:t.width,height:t.height,layers:t.layers}):p.reset({width:t.width,height:t.height,image:t.canvas}),ut.update(i),et(p.getLayer(i)),R.resetView(),ot.update(R.getScale(),R.getAngleDeg()),y=!1}function s(t){Fb.showImportAsLayerDialog({target:l,klCanvas:p,importImage:t,callback:function(n,i){if(!n)return;zm.pause(!0),p.addLayer();let r=p.getLayers().length-1;e&&p.renameLayer(r,e);let a=p.getLayerContext(r);Om.drawTransformedImageWithBounds(a,t,n,null,i),et(p.getLayer(r)),ut.update(r),zm.pause(!1),zm.push({tool:["misc"],action:"importImage",params:[Om.copyCanvas(a.canvas),e]})}})}!t||isNaN(t.width)||isNaN(t.height)||t.width<=0||t.height<=0?Fb.popup({target:l,type:"error",message:Vm("import-broken-file"),buttons:["Ok"]}):("default"!==n&&n||Fb.showImportImageDialog({image:t,target:l,maxSize:i,callback:function(t){"as-image"===t.type?a(t.image):"as-image-psd"===t.type?o(t.image,t.cropObj):"as-layer"===t.type?s(t.image):t.type}}),"layer"===n&&s(t.canvas),"image"===n&&("psd"===t.type?o(t):a(t.canvas)))}function Y(t,e){function n(){Fb.popup({target:l,type:"warning",message:Vm("import-psd-unsupported")+"<br /><br />",buttons:["Ok"]})}let i=!1;for(let r,a=0;r=t[a];a++){let a=r.name.split(".");a=a[a.length-1].toLowerCase(),"psd"===a?function(i){let r=4096;if(i.size>=1073741824)return void Fb.popup({target:l,type:"error",message:"File too big. Unable to import.<br /><br />",buttons:["Ok"]});let a,o=1===t.length&&i.size>=26214400,s=!0;o&&Fb.popup({target:l,message:Vm("import-opening"),callback:function(t){s=!1,a=null},closefunc:function(t){a=t}});let c=new FileReader;c.onload=function(t){Fb.loadAgPsd().then((function(c){if(!o||s)try{let o;if(o=c.readPsd(t.target.result,{skipLayerImageData:!0,skipThumbnail:!0,skipCompositeImageData:!0}),o.width>r||o.height>r)return a&&a(),void Fb.popup({target:l,type:"error",message:Vm("import-psd-too-large").replace(/{x}/g,"4096")+"<br /><br />"+Vm("import-psd-size")+": "+o.width+" x "+o.height+" pixels<br /><br />",buttons:["Ok"]});o=null;try{o=c.readPsd(t.target.result)}catch(t){}if(o){let t=Fb.PSD.readPsd(o);"image"===e&&t.error&&n(),a&&a(),N(t,i.name,e)}else o=c.readPsd(t.target.result,{skipLayerImageData:!0,skipThumbnail:!0}),"image"===e&&n(),a&&a(),N({type:"psd",width:o.width,height:o.height,canvas:o.canvas,error:!0},i.name,e)}catch(t){a&&a(),Fb.popup({target:l,type:"error",message:"Failed to load PSD.<br /><br />",buttons:["Ok"]})}})).catch((()=>{a(),alert("Error: failed to load PSD library")}))},c.readAsArrayBuffer(i)}(r):r.type.match("image.*")?function(t){window.URL=window.URL||window.webkitURL;let n=window.URL.createObjectURL(t),i=new Image;i.src=n,Om.loadImage(i,(function(){N({type:"image",width:i.width,height:i.height,canvas:i},t.name,e)}))}(r):i=!0}i&&Fb.popup({target:l,message:Vm("import-unsupported-file"),type:"error",buttons:["OK"]})}null==U||U.addEventListener("touchstart",(function(t){t.preventDefault(),gt.undo()})),e.embed||(new Fb.KlImageDropper({target:document.body,onDrop:function(t,e){Fb.dialogCounter.get()>0||Y(t,e)},enabledTest:function(){return 0===Fb.dialogCounter.get()}}),Om.addEventListener(window,"paste",(function(t){Fb.dialogCounter.get()>0||(t.stopPropagation(),t.preventDefault(),t.clipboardData.files[0]?function(t,e){0==t.clipboardData&&"function"==typeof e&&e(void 0);let n=t.clipboardData.items;if(null==n)"function"==typeof e&&e(void 0);else for(let t=0;t<n.length;t++){if(-1==n[t].type.indexOf("image"))continue;let i=n[t].getAsFile();"function"==typeof e&&e(i)}}(t,(function(t){if(t){let e=new Image;e.onload=function(){N({type:"image",width:e.width,height:e.height,canvas:e},null,"default")};let n=window.URL||window.webkitURL;e.src=n.createObjectURL(t)}})):t.clipboardData.items[0]&&t.clipboardData.items[0].getAsString((function(t){if((t=t.trim()).match(/^https?/)){let e=new Image;e.onload=function(){N({type:"image",width:e.width,height:e.height,canvas:e},null,"default")},e.onerror=function(t){console.log("error loading",t)},e.crossOrigin="Anonymous",e.src=t}else if(t.match(/^#?([a-fA-F0-9]{6}|[a-fA-F0-9]{3})$/)){let e=Om.ColorConverter.hexToRGB(t.replace("#",""));E.setColor(e)}})))}),!1));const X={};for(let t in Fb.brushesUI)if(Fb.brushesUI.hasOwnProperty(t)){let e=new Fb.brushesUI[t].Ui({onSizeChange:S,onOpacityChange:function(t){E.emitOpacity(t)},onConfigChange:()=>{E.emitSliderConfig({sizeSlider:Fb.brushesUI[b].sizeSlider,opacitySlider:Fb.brushesUI[b].opacitySlider})}});X[t]=e,e.getElement().style.padding="10px"}Om.css(l,{position:"absolute",left:"0",top:"0",right:"0",bottom:"0"});let V=new Fb.StatusOverlay;const W=Om.el({}),K=Om.el({parent:W});W.oncontextmenu=function(){return!1},W.onclick=Om.handleClick;let G,q,Z=new Fb.ToolspaceCollapser({onChange:function(){$()}});function $(){c<820?(Z.getElement().style.display="block",Z.setDirection(r),Z.isOpen()?("left"===r?(Om.css(Z.getElement(),{left:"271px",right:""}),Om.css(R.getElement(),{left:"271px"})):(Om.css(Z.getElement(),{left:"",right:"271px"}),Om.css(R.getElement(),{left:"0"})),W.style.display="block",R.setSize(Math.max(0,c-u),h),V.setWide(!1)):("left"===r?(Om.css(Z.getElement(),{left:"0",right:""}),Om.css(R.getElement(),{left:"0"})):(Om.css(Z.getElement(),{left:"",right:"0"}),Om.css(R.getElement(),{left:"0"})),W.style.display="none",R.setSize(Math.max(0,c),h),V.setWide(!0))):(Z.getElement().style.display="none","left"===r?Om.css(R.getElement(),{left:"271px"}):Om.css(R.getElement(),{left:"0"}),W.style.display="block",R.setSize(Math.max(0,c-u),h),V.setWide(!1))}function J(){"left"===r?(Om.css(W,{left:"0",right:"",borderLeft:"none",borderRight:"1px solid rgb(135, 135, 135)"}),Om.css(R.getElement(),{left:"271px"})):(Om.css(W,{left:"",right:"0",borderLeft:"1px solid rgb(135, 135, 135)",borderRight:"none"}),Om.css(R.getElement(),{left:"0"})),V.setUiState(r),dt.setUiState(""+r),ut.setUiState(""+r),$(),St.updateUiState(r)}$(),setTimeout((function(){G=new Fb.OverlayToolspace({enabledTest:function(){return 0===Fb.dialogCounter.get()&&!I.getIsDrawing()},brushSettingService:E}),l.appendChild(G.getElement())}),0),Om.append(l,[R.getElement(),W,Z.getElement()]),Om.css(W,{position:"absolute",right:"0",top:"0",bottom:"0",width:"270px",overflow:"hidden",backgroundColor:"#ddd",borderLeft:"1px solid rgb(135, 135, 135)",userSelect:"none",touchAction:"none"}),q=e.embed?new Ub({onHelp:()=>{Ib(e.embed.url+"/help.html",!!e.embed)},onSubmit:()=>{Fb.popup({target:l,message:Vm("submit-prompt"),buttons:[Vm("submit"),"Cancel"],callback:async t=>{if(t!==Vm("submit"))return;let n=Om.el({parent:l,className:"upload-overlay",content:'<div class="spinner"></div> '+Vm("submit-submitting")});e.embed.onSubmit((()=>{e.saveReminder.reset(),l.removeChild(n)}),(()=>{l.removeChild(n)}))}})},onLeftRight:()=>{r="left"===r?"right":"left",J()}}):new Fb.ToolspaceTopRow({logoImg:e.logoImg,onLogo:function(){Ib("./home/",!!e.embed)},onNew:function(){ft()},onImport:function(){xt.triggerImport()},onSave:function(){yt.save()},onShare:function(){mt()},onHelp:function(){Ib("./help/",!!e.embed)}}),Om.addClassName(q.getElement(),"toolspace-row-shadow"),q.getElement().style.marginBottom="10px";let Q,tt=new Fb.ToolspaceToolRow({onActivate:function(t){if("draw"===t)R.setMode("draw");else if("hand"===t)R.setMode("hand");else if("fill"===t)R.setMode("fill");else if("text"===t)R.setMode("text");else{if("shape"!==t)throw new Error("unknown activeStr");R.setMode("shape")}g.open(t),vt(),Q.pickingDone()},onZoomIn:function(){R.zoomByStep(keyListener.isPressed("shift")?1/8:.5)},onZoomOut:function(){R.zoomByStep(keyListener.isPressed("shift")?-1/8:-.5)},onUndo:function(){gt.undo()},onRedo:function(){gt.redo()}});function et(t){C=t.context,x.setContext(t.context),dt.setLayer(t)}tt.setIsSmall(h<540),zm.addListener((function(){tt.setEnableUndo(zm.canUndo()),tt.setEnableRedo(zm.canRedo())})),Om.addClassName(tt.getElement(),"toolspace-row-shadow"),Q=new Fb.KlColorSlider({width:250,height:30,svHeight:100,startValue:new Om.RGB(0,0,0),onPick:function(t){v=t,x.setColor(t),E.emitColor(t),Q.pickingDone()}}),Q.setHeight(Math.max(163,Math.min(400,h-505))),Q.setPickCallback((function(t){t?R.setMode("pick"):(R.setMode(tt.getActive()),vt())}));let nt=document.createElement("div"),it=document.createElement("div");Om.css(it,{margin:"10px",display:"flex",flexWrap:"wrap",justifyContent:"space-between",alignItems:"flex-end"});let rt=new Fb.ToolspaceStabilizerRow({smoothing:1,onSelect:function(t){M.setSmoothing(m(t))}});nt.appendChild(it),Om.append(it,[Q.getElement(),Q.getOutputElement(),rt.getElement()]);let at=new Fb.TabRow({initialId:"penBrush",useAccent:!0,tabArr:function(){let t=[];function e(t){return{id:t,image:Fb.brushesUI[t].image,title:Fb.brushesUI[t].tooltip,onOpen:function(){var e;X[t].getElement().style.display="block","eraserBrush"!==(e=t)&&(w=e),Q&&("eraserBrush"===e?Q.enable(!1):Q.enable(!0)),b=e,x=X[e],x.setColor(v),x.setContext(C),R.setMode("draw"),tt.setActive("draw"),vt(),Q.pickingDone(),E.emitSliderConfig({sizeSlider:Fb.brushesUI[t].sizeSlider,opacitySlider:Fb.brushesUI[t].opacitySlider}),S(X[t].getSize()),E.emitOpacity(X[t].getOpacity())},onClose:function(){X[t].getElement().style.display="none"}}}let n=Object.keys(X);for(let i=0;i<n.length;i++)t.push(e(n[i]));return t}()});for(let t in Fb.brushesUI)Fb.brushesUI.hasOwnProperty(t)&&nt.appendChild(X[t].getElement());const ot=new Fb.HandUi({scale:1,angleDeg:0,onReset:function(){R.resetView(!0),ot.update(R.getScale(),R.getAngleDeg())},onFit:function(){R.fitView(),ot.update(R.getScale(),R.getAngleDeg())},onAngleChange:function(t,e){R.setAngle(t,e),ot.update(R.getScale(),R.getAngleDeg())}});let st=new Fb.FillUi({colorSlider:Q}),lt=new Fb.TextUi({colorSlider:Q}),ct=new Fb.ShapeUi({colorSlider:Q}),ht=new Fb.ShapeTool({onShape:function(t,e,n,i,r,a){let o=p.getLayerIndex(C.canvas),s={type:ct.getShape(),x1:e,y1:n,x2:i,y2:r,angleRad:a,isOutwards:ct.getIsOutwards(),opacity:ct.getOpacity(),isEraser:ct.getIsEraser()};"line"===ct.getShape()||"stroke"===ct.getMode()?(s.strokeRgb=Q.getColor(),s.lineWidth=ct.getLineWidth()):s.fillRgb=Q.getColor(),t?(p.setComposite(o,null),p.drawShape(o,s)):p.setComposite(o,{draw:function(t){Fb.drawShape(t,s)}}),R.requestFrame()}});const ut=Fb.klLayerManager(p,(function(t){et(p.getLayer(t)),zm.push({tool:["misc"],action:"focusLayer",params:[t]})}),l),dt=new Fb.LayerPreview({klRootEl:l,onClick:function(){g.open("layers")}});dt.setIsVisible(h>=579),dt.setLayer(p.getLayer(p.getLayerIndex(C.canvas)));const pt=new Fb.FilterTab(l,Q,ut,et,R,ot,(()=>v),(()=>i),(()=>p),(()=>C),!!e.embed,V),gt=new Fb.UndoRedoCatchup(X,dt,ut,ot,R,(()=>{if(!f)throw new Error("initState not initialized");return f}),(()=>p),(()=>C),(t=>{C=t}),(()=>x));function ft(){Fb.newImageDialog({currentColor:v,secondaryColor:Q.getSecondaryRGB(),maxCanvasSize:i,canvasWidth:p.getWidth(),canvasHeight:p.getHeight(),workspaceWidth:window.innerWidth<820?c:c-u,workspaceHeight:h,onConfirm:function(t,e,n){p.reset({width:t,height:e,color:1===n.a?n:null}),ut.update(0),et(p.getLayer(0)),R.resetView(),ot.update(R.getScale(),R.getAngleDeg()),y=!1},onCancel:function(){}})}function mt(t){Om.shareCanvas({canvas:p.getCompleteCanvas(1),fileName:Om.getDate()+o+".png",title:Om.getDate()+o+".png",callback:t||function(){}})}zm.addListener((t=>{gt.catchup(t)}));const yt=new Fb.SaveToComputer(e.saveReminder,l,(()=>d),(()=>p),o),xt=e.embed?null:new Fb.FileTab(l,s,(()=>p.getProject()),d,(t=>{d=t}),Y,(()=>{yt.save()}),ft,mt,(()=>{Fb.imgurUpload(p,l,e.saveReminder,e.app&&e.app.imgurKey?e.app.imgurKey:null)}),(function(t){Fb.clipboardDialog(l,p.getCompleteCanvas(1),(function(t){if(0===t.left&&0===t.right&&0===t.top&&0===t.bottom)return;let e={context:C,canvas:p,input:t,history:zm};Fb.filterLib.cropExtend.apply(e),ut.update(),R.resetView(),ot.update(R.getScale(),R.getAngleDeg())}),V,t)}),e.saveReminder),bt=new Fb.SettingsTab((()=>{r="left"===r?"right":"left",J(),e.embed||Pm.setItem("uiState",r)}),e.aboutEl);function vt(){if(!g)return;let t=tt.getActive(),e=g.getOpenedTabId(),n=Object.keys({draw:{},hand:{},fill:{},text:{},shape:{}});for(let i=0;i<n.length;i++)t===n[i]?g.setIsVisible(n[i],!0):(g.setIsVisible(n[i],!1),e===n[i]&&g.open(t))}g=new Fb.TabRow({initialId:"draw",tabArr:[{id:"draw",title:Vm("tool-brush"),image:n(Zy),onOpen:function(){"eraserBrush"===b&&Q.enable(!1),Om.append(it,[Q.getElement(),Q.getOutputElement(),rt.getElement()]),nt.style.display="block"},onClose:function(){nt.style.display="none"},css:{minWidth:"45px"}},{id:"hand",title:Vm("tool-hand"),image:n(nx),isVisible:!1,onOpen:function(){ot.setIsVisible(!0)},onClose:function(){ot.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"fill",title:Vm("tool-paint-bucket"),image:n($y),isVisible:!1,onOpen:function(){Q.enable(!0),st.setIsVisible(!0)},onClose:function(){st.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"text",title:Vm("tool-text"),image:n(Jy),isVisible:!1,onOpen:function(){Q.enable(!0),lt.setIsVisible(!0)},onClose:function(){lt.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"shape",title:Vm("tool-shape"),image:n(Qy),isVisible:!1,onOpen:function(){Q.enable(!0),ct.setIsVisible(!0)},onClose:function(){ct.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"layers",title:Vm("tab-layers"),image:n(hv),onOpen:function(){ut.update(),ut.style.display="block"},onClose:function(){ut.style.display="none"},css:{minWidth:"45px"}},{id:"edit",label:Vm("tab-edit"),onOpen:function(){pt.show()},onClose:function(){pt.hide()},css:{padding:"0 7px"}},{id:"file",label:Vm("tab-file"),isVisible:!!xt,onOpen:function(){xt&&(xt.getElement().style.display="block",xt.setIsVisible(!0))},onClose:function(){xt&&(xt.getElement().style.display="none",xt.setIsVisible(!1))},css:{padding:"0 7px"}},{id:"settings",title:Vm("tab-settings"),image:n(cv),onOpen:function(){bt.getElement().style.display="block"},onClose:function(){bt.getElement().style.display="none"},css:{minWidth:"45px"}}]});const wt=Om.el({css:{width:"270px",position:"absolute",bottom:"0",left:"0"}});if(e.bottomBar){wt.append(e.bottomBar);new MutationObserver((()=>Ct())).observe(K,{attributes:!0,childList:!0,subtree:!0})}function Ct(){if(!e.bottomBar)return;const t=617<window.innerHeight&&K.scrollHeight+50<window.innerHeight;wt.style.display=t?"":"none"}Om.append(K,[dt.getElement(),g.getElement(),nt,ot.getElement(),st.getElement(),lt.getElement(),ct.getElement(),ut,pt.getElement(),xt?xt.getElement():null,bt.getElement(),Om.el({css:{height:"10px"}}),wt||null]);const St=new Fb.ToolspaceScroller({toolspace:W,uiState:r});this.getEl=()=>l,this.resize=(t,e)=>{window.scrollY>0&&window.scrollTo(0,0),c===Math.max(0,t)&&h===Math.max(0,e)||(c=Math.max(0,t),h=Math.max(0,e),$(),Ct(),dt.setIsVisible(h>=579),Q.setHeight(Math.max(163,Math.min(400,h-505))),tt.setIsSmall(h<540))},this.out=t=>{V.out(t)},this.getPNG=function(){return Tb(p.getCompleteCanvas(1).toDataURL("image/png"))},this.getPSD=async function(){return await async function(t){let e=t.getLayersFast(),n={width:t.getWidth(),height:t.getHeight(),children:[]};for(let t=0;t<e.length;t++){let i=e[t];n.children.push({name:i.name,opacity:i.opacity,canvas:i.canvas,blendMode:Fb.PSD.blendKlToPsd(i.mixModeStr),left:0,top:0})}let i=(await a("1MJD7")).writePsdBuffer(n);return new Blob([i],{type:"application/octet-stream"})}(p)},this.swapUiLeftRight=()=>{r="left"===r?"right":"left",e.embed||Pm.setItem("uiState",r),J()},this.resize(c,h),J();{Om.addEventListener(window,"resize",(()=>{this.resize(window.innerWidth,window.innerHeight)})),Om.addEventListener(window,"orientationchange",(()=>{this.resize(window.innerWidth,window.innerHeight)}));const t=Om.el({parent:document.body,css:{position:"fixed",left:"0",top:"0",right:"0",bottom:"0",pointerEvents:"none",zIndex:"-1",userSelect:"none"}});new ResizeObserver((()=>this.resize(window.innerWidth,window.innerHeight))).observe(t),Om.addEventListener(this.getEl(),"wheel",(t=>{t.preventDefault()}));const e=t=>{t.preventDefault()};window.addEventListener("gesturestart",e),window.addEventListener("gesturechange",e),window.addEventListener("gestureend",e)}}hv=a("dwTKp").getBundleURL("lrLBb")+a("kb8hZ").resolve("ll6eH"),Yx.isLoaded||(sv=uv,lv(Xx.glBrightnessContrast,Vb),lv(Xx.cropExtend,Wb),lv(Xx.glCurves,Kb),lv(Xx.flip,qb),lv(Xx.glHueSaturation,Zb),lv(Xx.invert,$b),lv(Xx.glPerspective,Jb),lv(Xx.resize,tv),lv(Xx.rotate,ev),lv(Xx.glTiltShift,nv),lv(Xx.transform,iv),lv(Xx.glBlur,rv),lv(Xx.glUnsharpMask,av),lv(Xx.toAlpha,ov),Yx.isLoaded=!0),(async()=>{let t,e=!1;async function n(){Om.removeEventListener(window,"DOMContentLoaded",n);let e=new Fb.ProjectStore,i=null;try{const t=await e.read();t&&(i=t.project)}catch(e){let n;"db-error"===e.message?n="Failed to access Browser Storage":"format-error"===e.message&&(n="Failed to restore from Browser Storage"),n&&setTimeout((function(){throw t&&t.out(n),new Error("Initial browser storage error, "+e)}),100)}!function(e,n){if(t)throw"onKlProjectObjLoaded called more than once";let i=document.getElementById("loading-screen");try{i.parentNode.removeChild(i)}catch(t){}const r=new Fb.SaveReminder(zm,!0,!0);t=new dv(e,{saveReminder:r,projectStore:n}),r.init(),e&&setTimeout((()=>{t.out(Vm("file-storage-restored"))}),100),document.body.appendChild(t.getEl())}(i,e)}Om.addEventListener(window,"DOMContentLoaded",(()=>{e=!0})),await Xm.setLanguage(Ym),e?n():Om.addEventListener(window,"DOMContentLoaded",n)})();
//# sourceMappingURL=index.8b095a55.js.map
